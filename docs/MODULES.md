# Modules / –ú–æ–¥—É–ª–∏

## Overview

–û–ø–∏—Å–∞–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –º–æ–¥—É–ª–µ–π –±–æ—Ç–∞ –∏ –∏—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è.

---

## 1. Captcha / –ö–∞–ø—á–∞

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ó–∞—â–∏—Ç–∞ –≥—Ä—É–ø–ø –æ—Ç —Å–ø–∞–º-–±–æ—Ç–æ–≤ –ø—É—Ç—ë–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.

### –§–∞–π–ª—ã
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `handlers/visual_captcha/visual_captcha_handler.py` | –•–µ–Ω–¥–ª–µ—Ä—ã –∫–∞–ø—á–∏ |
| `services/captcha_flow_logic.py` | –õ–æ–≥–∏–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è —Ä–µ—à–µ–Ω–∏–π |
| `services/visual_captcha_logic.py` | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞–ø—á–∏, Redis –æ–ø–µ—Ä–∞—Ü–∏–∏ |

### Pipeline

```
ChatJoinRequest
    ‚îÇ
    ‚îú‚îÄ‚îÄ load_captcha_settings() ‚Üí –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –ë–î
    ‚îÇ
    ‚îú‚îÄ‚îÄ should_require_captcha()
    ‚îÇ   ‚îú‚îÄ‚îÄ fallback_mode? ‚Üí –∞–≤—Ç–æ–æ–¥–æ–±—Ä–µ–Ω–∏–µ
    ‚îÇ   ‚îú‚îÄ‚îÄ captcha_join_enabled? ‚Üí –Ω—É–∂–Ω–∞ –∫–∞–ø—á–∞
    ‚îÇ   ‚îî‚îÄ‚îÄ captcha_invite_enabled? ‚Üí –∫–∞–ø—á–∞ –ø—Ä–∏ –∏–Ω–≤–∞–π—Ç–µ
    ‚îÇ
    ‚îú‚îÄ‚îÄ –ï—Å–ª–∏ –∫–∞–ø—á–∞ –ù–ï –Ω—É–∂–Ω–∞:
    ‚îÇ   ‚îú‚îÄ‚îÄ save_join_request() ‚Üí Redis
    ‚îÇ   ‚îî‚îÄ‚îÄ approve_chat_join_request()
    ‚îÇ
    ‚îî‚îÄ‚îÄ –ï—Å–ª–∏ –∫–∞–ø—á–∞ –Ω—É–∂–Ω–∞:
        ‚îú‚îÄ‚îÄ save_join_request() ‚Üí Redis
        ‚îú‚îÄ‚îÄ create_deeplink_for_captcha()
        ‚îî‚îÄ‚îÄ send_captcha_prompt() ‚Üí —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (ChatSettings)
| –ù–∞—Å—Ç—Ä–æ–π–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|----------|
| `captcha_join_enabled` | –ö–∞–ø—á–∞ –ø—Ä–∏ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–∏ |
| `captcha_invite_enabled` | –ö–∞–ø—á–∞ –ø—Ä–∏ –∏–Ω–≤–∞–π—Ç–µ |
| `captcha_timeout_seconds` | –¢–∞–π–º–∞—É—Ç (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 300) |
| `captcha_message_ttl_seconds` | TTL —Å–æ–æ–±—â–µ–Ω–∏—è (900) |
| `captcha_flood_threshold` | –ü–æ—Ä–æ–≥ –∞–Ω—Ç–∏—Ñ–ª—É–¥–∞ (5) |
| `captcha_flood_window_seconds` | –û–∫–Ω–æ –∞–Ω—Ç–∏—Ñ–ª—É–¥–∞ (180) |
| `captcha_flood_action` | –î–µ–π—Å—Ç–≤–∏–µ (warn/mute/ban) |

### Redis Keys
```python
f"captcha:{user_id}"                    # –î–∞–Ω–Ω—ã–µ –∫–∞–ø—á–∏
f"join_request:{user_id}:{group_id}"    # Pending request
f"captcha_passed:{user_id}:{chat_id}"   # –§–ª–∞–≥ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è
f"visual_captcha:{chat_id}"             # –°—Ç–∞—Ç—É—Å –≥—Ä—É–ø–ø—ã
```

---

## 2. Antispam / –ê–Ω—Ç–∏—Å–ø–∞–º

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º: —Å—Å—ã–ª–∫–∏, –ø–µ—Ä–µ—Å—ã–ª–∫–∏, —Ü–∏—Ç–∞—Ç—ã.

### –§–∞–π–ª—ã
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `handlers/antispam_handlers/antispam_filter_handler.py` | –§–∏–ª—å—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏–π |
| `handlers/antispam_handlers/antispam_settings_handler.py` | UI –Ω–∞—Å—Ç—Ä–æ–µ–∫ |
| `services/antispam/antispam_service.py` | –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ |
| `database/models_antispam.py` | –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö |
| `keyboards/antispam_keyboards.py` | –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã |

### –¢–∏–ø—ã –ø—Ä–∞–≤–∏–ª (RuleType)

| –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|----------|
| `TELEGRAM_LINK` | –°—Å—ã–ª–∫–∏ t.me, telegram.me, tg:// |
| `ANY_LINK` | –õ—é–±—ã–µ HTTP/HTTPS —Å—Å—ã–ª–∫–∏ |
| `FORWARD_CHANNEL` | –ü–µ—Ä–µ—Å—ã–ª–∫–∏ –∏–∑ –∫–∞–Ω–∞–ª–æ–≤ |
| `FORWARD_GROUP` | –ü–µ—Ä–µ—Å—ã–ª–∫–∏ –∏–∑ –≥—Ä—É–ø–ø |
| `FORWARD_USER` | –ü–µ—Ä–µ—Å—ã–ª–∫–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π |
| `FORWARD_BOT` | –ü–µ—Ä–µ—Å—ã–ª–∫–∏ –æ—Ç –±–æ—Ç–æ–≤ |
| `QUOTE_CHANNEL` | –¶–∏—Ç–∞—Ç—ã –∏–∑ –∫–∞–Ω–∞–ª–æ–≤ |
| `QUOTE_GROUP` | –¶–∏—Ç–∞—Ç—ã –∏–∑ –≥—Ä—É–ø–ø |
| `QUOTE_USER` | –¶–∏—Ç–∞—Ç—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π |
| `QUOTE_BOT` | –¶–∏—Ç–∞—Ç—ã –æ—Ç –±–æ—Ç–æ–≤ |

### –î–µ–π—Å—Ç–≤–∏—è (ActionType)

| –î–µ–π—Å—Ç–≤–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|
| `OFF` | –ü—Ä–∞–≤–∏–ª–æ –≤—ã–∫–ª—é—á–µ–Ω–æ |
| `DELETE` | –¢–æ–ª—å–∫–æ —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è |
| `WARN` | –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ |
| `KICK` | –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –∏–∑ –≥—Ä—É–ø–ø—ã |
| `RESTRICT` | –ú—É—Ç –Ω–∞ –≤—Ä–µ–º—è |
| `BAN` | –ë–∞–Ω –Ω–∞–≤—Å–µ–≥–¥–∞ |

### Pipeline —Ñ–∏–ª—å—Ç—Ä–∞

```
–°–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ
    ‚îÇ
    ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞: group/supergroup?
    ‚îú‚îÄ‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–≤–∏–ª –∏–∑ –ë–î
    ‚îÇ
    ‚îú‚îÄ‚îÄ check_links()
    ‚îÇ   ‚îú‚îÄ‚îÄ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ URL –∏–∑ —Ç–µ–∫—Å—Ç–∞
    ‚îÇ   ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ TELEGRAM_LINK
    ‚îÇ   ‚îî‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ ANY_LINK
    ‚îÇ
    ‚îú‚îÄ‚îÄ check_forwards()
    ‚îÇ   ‚îú‚îÄ‚îÄ forward_from_chat? ‚Üí FORWARD_CHANNEL/GROUP
    ‚îÇ   ‚îú‚îÄ‚îÄ forward_from.is_bot? ‚Üí FORWARD_BOT
    ‚îÇ   ‚îî‚îÄ‚îÄ forward_from? ‚Üí FORWARD_USER
    ‚îÇ
    ‚îú‚îÄ‚îÄ check_quotes()
    ‚îÇ   ‚îî‚îÄ‚îÄ –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø–µ—Ä–µ—Å—ã–ª–∫–∞–º
    ‚îÇ
    ‚îú‚îÄ‚îÄ check_whitelist() ‚Üí –∏—Å–∫–ª—é—á–µ–Ω–∏—è
    ‚îÇ
    ‚îî‚îÄ‚îÄ apply_action()
        ‚îú‚îÄ‚îÄ DELETE ‚Üí message.delete()
        ‚îú‚îÄ‚îÄ WARN ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
        ‚îú‚îÄ‚îÄ KICK ‚Üí bot.ban + bot.unban
        ‚îú‚îÄ‚îÄ RESTRICT ‚Üí bot.restrict_chat_member
        ‚îî‚îÄ‚îÄ BAN ‚Üí bot.ban_chat_member
```

### –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ (Whitelist)

| Scope | –ü—Ä–∏–º–µ—Ä—ã –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ |
|-------|-------------------|
| `TELEGRAM_LINK` | `t.me/mygroup`, `@channel` |
| `ANY_LINK` | `youtube.com`, `github.com` |
| `FORWARD` | `-1001234567890` (chat ID) |
| `QUOTE` | `-1001234567890` |

---

## 3. Content Filter / –§–∏–ª—å—Ç—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–º —Å–ª–æ–≤–∞–º —Å –æ–±—Ö–æ–¥–æ–º –æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏ (l33tspeak).

### –§–∞–π–ª—ã
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `handlers/content_filter/filter_handler.py` | –§–∏–ª—å—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –≥—Ä—É–ø–ø–∞—Ö |
| `handlers/content_filter/settings_handler.py` | UI –Ω–∞—Å—Ç—Ä–æ–µ–∫ (callback query) |
| `services/content_filter/text_normalizer.py` | –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ (l33tspeak) |
| `services/content_filter/word_filter.py` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ |
| `services/content_filter/scam_detector.py` | –≠–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –¥–µ—Ç–µ–∫—Ç–æ—Ä —Å–∫–∞–º–∞ |
| `services/content_filter/flood_detector.py` | –î–µ—Ç–µ–∫—Ç–æ—Ä –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å–æ–æ–±—â–µ–Ω–∏–π |
| `services/content_filter/referral_detector.py` | –î–µ—Ç–µ–∫—Ç–æ—Ä —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ —Å–ø–∞–º–∞ |
| `services/content_filter/filter_manager.py` | –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ |
| `database/models_content_filter.py` | –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö |
| `keyboards/content_filter_keyboards.py` | –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã |

### –ü–æ–¥–º–æ–¥—É–ª–∏

| –ü–æ–¥–º–æ–¥—É–ª—å | –û–ø–∏—Å–∞–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|-----------|----------|--------|
| Word Filter | –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å–ª–æ–≤–∞–º/—Ñ—Ä–∞–∑–∞–º | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω |
| Scam Detector | –≠–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∫–∞–º–∞ (15 —Å–∏–≥–Ω–∞–ª–æ–≤) | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω |
| Flood Detector | –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–ª—É–¥–∞ (Redis) | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω |
| Referral Detector | –î–µ—Ç–µ–∫—Ç–æ—Ä —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ —Å–ø–∞–º–∞ (@username) | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω |

### Text Normalizer - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–ø–∞–º–µ—Ä—ã –æ–±—Ö–æ–¥—è—Ç —Ñ–∏–ª—å—Ç—Ä—ã —á–µ—Ä–µ–∑:
- L33tspeak: `k0ka` –≤–º–µ—Å—Ç–æ `–∫–æ–∫–∞`
- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏: `–∫-–æ-–∫-–∞` –≤–º–µ—Å—Ç–æ `–∫–æ–∫–∞`
- –õ–∞—Ç–∏–Ω–∏—Ü—É: `w–∏—à–∫–∏` –≤–º–µ—Å—Ç–æ `–≤–∏—à–∫–∏`
- –ù–µ–≤–∏–¥–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã: `–∫–æ\u200b–∫–∞`

**–†–µ—à–µ–Ω–∏–µ:** TextNormalizer –ø—Ä–∏–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç –∫ –µ–¥–∏–Ω–æ–º—É –≤–∏–¥—É:

```python
normalizer = TextNormalizer()
normalizer.normalize("k0-k-@")  # ‚Üí "–∫–æ–∫–∞"
normalizer.normalize("w–∏—àki")   # ‚Üí "–≤–∏—à–∫–∏"
normalizer.normalize("–Ω@—Ä–∫0—Ç1–∫") # ‚Üí "–Ω–∞—Ä–∫–æ—Ç–∏–∫"
```

**–¢–∞–±–ª–∏—Ü–∞ –∑–∞–º–µ–Ω:**
| –°–∏–º–≤–æ–ª | –ó–∞–º–µ–Ω–∞ | –°–∏–º–≤–æ–ª | –ó–∞–º–µ–Ω–∞ |
|--------|--------|--------|--------|
| `0` | `–æ` | `w` | `–≤` |
| `1` | `–∏` | `@` | `–∞` |
| `3` | `–∑` | `$` | `—Å` |
| `4` | `—á` | `k` | `–∫` |

### Word Filter - –§–∏–ª—å—Ç—Ä —Å–ª–æ–≤

**–¢–∏–ø—ã —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π:**
| –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|-----|----------|--------|
| `word` | –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å–ª–æ–≤–∞ | "–Ω–∞—Ä–∫–æ—Ç–∏–∫" ‚â† "–Ω–∞—Ä–∫–æ—Ç–∏–∫–∏" |
| `phrase` | –ü–æ–¥—Å—Ç—Ä–æ–∫–∞ | "–∫–æ–∫" –Ω–∞–π–¥—ë—Ç—Å—è –≤ "–∫–æ–∫–∞–∏–Ω" |
| `regex` | –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ | `–Ω–∞—Ä–∫.?—Ç–∏–∫` |

### –î–µ–π—Å—Ç–≤–∏—è (action)
| –î–µ–π—Å—Ç–≤–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|
| `delete` | –¢–æ–ª—å–∫–æ —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è |
| `warn` | –£–¥–∞–ª–µ–Ω–∏–µ + –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ |
| `mute` | –£–¥–∞–ª–µ–Ω–∏–µ + –º—É—Ç –Ω–∞ –≤—Ä–µ–º—è |
| `kick` | –£–¥–∞–ª–µ–Ω–∏–µ + –∏—Å–∫–ª—é—á–µ–Ω–∏–µ |
| `ban` | –£–¥–∞–ª–µ–Ω–∏–µ + –±–∞–Ω |

### Pipeline —Ñ–∏–ª—å—Ç—Ä–∞

```
–°–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ
    ‚îÇ
    ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞: group/supergroup?
    ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞: –∞–≤—Ç–æ—Ä - –∞–¥–º–∏–Ω? ‚Üí –ø—Ä–æ–ø—É—Å–∫
    ‚îÇ
    ‚îú‚îÄ‚îÄ FilterManager.check_message()
    ‚îÇ   ‚îú‚îÄ‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≥—Ä—É–ø–ø—ã
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îú‚îÄ‚îÄ 1. FloodDetector.check() (—Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ö—ç—à–∞ (MD5)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—á—ë—Ç—á–∏–∫–∞ –≤ Redis
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å flood_max_repeats
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îú‚îÄ‚îÄ 2. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ (TextNormalizer)
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îú‚îÄ‚îÄ 3. WordFilter.check()
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ–≤ –∏–∑ –ë–î
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ whitelist
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ –ü–æ–∏—Å–∫ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îú‚îÄ‚îÄ 4. ScamDetector.check()
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ –ê–Ω–∞–ª–∏–∑ 15 —Å–∏–≥–Ω–∞–ª–æ–≤
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ –ü–æ–¥—Å—á—ë—Ç score
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å scam_sensitivity
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îî‚îÄ‚îÄ 5. ReferralDetector.check()
    ‚îÇ       ‚îú‚îÄ‚îÄ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ @username
    ‚îÇ       ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—á—ë—Ç—á–∏–∫–æ–≤ –≤ Redis
    ‚îÇ       ‚îî‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ unique_users
    ‚îÇ
    ‚îî‚îÄ‚îÄ apply_action()
        ‚îú‚îÄ‚îÄ delete ‚Üí message.delete()
        ‚îú‚îÄ‚îÄ warn ‚Üí –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
        ‚îú‚îÄ‚îÄ mute ‚Üí restrict_chat_member
        ‚îú‚îÄ‚îÄ kick ‚Üí ban + unban
        ‚îî‚îÄ‚îÄ ban ‚Üí ban_chat_member
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (ContentFilterSettings)
| –ù–∞—Å—Ç—Ä–æ–π–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | Default |
|-----------|----------|---------|
| `enabled` | –§–∏–ª—å—Ç—Ä –≤–∫–ª—é—á—ë–Ω | False |
| `word_filter_enabled` | –§–∏–ª—å—Ç—Ä —Å–ª–æ–≤ | True |
| `scam_detection_enabled` | –î–µ—Ç–µ–∫—Ç–æ—Ä —Å–∫–∞–º–∞ | True |
| `flood_detection_enabled` | –î–µ—Ç–µ–∫—Ç–æ—Ä —Ñ–ª—É–¥–∞ | True |
| `referral_detection_enabled` | –î–µ—Ç–µ–∫—Ç–æ—Ä —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ | False |
| `scam_sensitivity` | –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (40-90) | 60 |
| `flood_max_repeats` | –ú–∞–∫—Å. –ø–æ–≤—Ç–æ—Ä–æ–≤ –¥–ª—è —Ñ–ª—É–¥–∞ (1-50, —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ ‚úèÔ∏è) | 2 |
| `flood_time_window` | –û–∫–Ω–æ —Ñ–ª—É–¥–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (10-600, —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ ‚úèÔ∏è) | 60 |
| `default_action` | –î–µ–π—Å—Ç–≤–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | delete |
| `default_mute_duration` | –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º—É—Ç–∞ (–º–∏–Ω) | 1440 |
| `word_filter_action` | –î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è —Å–ª–æ–≤ (NULL=default) | NULL |
| `word_filter_mute_duration` | –ú—É—Ç –¥–ª—è —Å–ª–æ–≤ (NULL=default) | NULL |
| `flood_action` | –î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è —Ñ–ª—É–¥–∞ (NULL=default) | NULL |
| `flood_mute_duration` | –ú—É—Ç –¥–ª—è —Ñ–ª—É–¥–∞ (NULL=default) | NULL |
| `word_filter_normalize` | –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–ª—è —Å–ª–æ–≤ | True |

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å–ª–æ–≤
| –ù–∞—Å—Ç—Ä–æ–π–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | Default |
|-----------|----------|---------|
| `simple_words_enabled` | –ü—Ä–æ—Å—Ç—ã–µ —Å–ª–æ–≤–∞ –≤–∫–ª | True |
| `simple_words_action` | –î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö | delete |
| `simple_words_mute_duration` | –ú—É—Ç –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö (–º–∏–Ω) | NULL |
| `simple_words_mute_text` | –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –º—É—Ç–µ | NULL |
| `simple_words_ban_text` | –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –±–∞–Ω–µ | NULL |
| `simple_words_delete_delay` | –ó–∞–¥–µ—Ä–∂–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–µ–∫) | NULL |
| `simple_words_notification_delete_delay` | –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—Å–µ–∫) | NULL |
| `harmful_words_enabled` | –í—Ä–µ–¥–Ω—ã–µ —Å–ª–æ–≤–∞ –≤–∫–ª | True |
| `harmful_words_action` | –î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –≤—Ä–µ–¥–Ω—ã—Ö | ban |
| `harmful_words_mute_duration` | –ú—É—Ç –¥–ª—è –≤—Ä–µ–¥–Ω—ã—Ö (–º–∏–Ω) | NULL |
| `harmful_words_mute_text` | –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –º—É—Ç–µ | NULL |
| `harmful_words_ban_text` | –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –±–∞–Ω–µ | NULL |
| `harmful_words_delete_delay` | –ó–∞–¥–µ—Ä–∂–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–µ–∫) | NULL |
| `harmful_words_notification_delete_delay` | –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—Å–µ–∫) | NULL |
| `obfuscated_words_enabled` | –û–±—Ñ—É—Å–∫–∞—Ü–∏—è –≤–∫–ª | True |
| `obfuscated_words_action` | –î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏ | mute |
| `obfuscated_words_mute_duration` | –ú—É—Ç –¥–ª—è –æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏ (–º–∏–Ω) | 1440 |
| `obfuscated_words_mute_text` | –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –º—É—Ç–µ | NULL |
| `obfuscated_words_ban_text` | –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –±–∞–Ω–µ | NULL |
| `obfuscated_words_delete_delay` | –ó–∞–¥–µ—Ä–∂–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–µ–∫) | NULL |
| `obfuscated_words_notification_delete_delay` | –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—Å–µ–∫) | NULL |

**–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–ª–æ–≤:**
- **simple** ‚Äî —Ä–µ–∫–ª–∞–º–∞, —Å–ø–∞–º, –æ–±—ã—á–Ω—ã–µ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞
- **harmful** ‚Äî –Ω–∞—Ä–∫–æ—Ç–∏–∫–∏, –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
- **obfuscated** ‚Äî —Å–ª–æ–≤–∞ —Å –æ–±—Ñ—É—Å–∫–∞—Ü–∏–µ–π (l33tspeak): k0ka, w1—à–∫–∏

**–ö–∞—Å—Ç–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä `%user%` –¥–ª—è —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–∞—Ä—É—à–∏—Ç–µ–ª—è
- –ü—Ä–∏–º–µ—Ä: `%user% –ø–æ–ª—É—á–∏–ª –º—É—Ç –∑–∞ —Å–ø–∞–º`
- –ï—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç –±–æ—Ç–∞

**–ó–∞–¥–µ—Ä–∂–∫–∏:**
- `delete_delay` ‚Äî —á–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞—Ä—É—à–∏—Ç–µ–ª—è (0 = —Å—Ä–∞–∑—É)
- `notification_delete_delay` ‚Äî —á–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –∞–≤—Ç–æ—É–¥–∞–ª–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±–æ—Ç–∞ (NULL = –Ω–µ —É–¥–∞–ª—è—Ç—å)

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫
```
–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –§–∏–ª—å—Ç—Ä–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
‚îú‚îÄ‚îÄ –§–∏–ª—å—Ç—Ä —Å–ª–æ–≤ ‚úÖ/‚ùå + ‚öôÔ∏è (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ª–æ–≤)
‚îú‚îÄ‚îÄ –ê–Ω—Ç–∏—Å–∫–∞–º ‚úÖ/‚ùå + ‚öôÔ∏è (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω—Ç–∏—Å–∫–∞–º–∞: –ø–∞—Ç—Ç–µ—Ä–Ω—ã, —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –¥–µ–π—Å—Ç–≤–∏–µ)
‚îú‚îÄ‚îÄ –ê–Ω—Ç–∏—Ñ–ª—É–¥ ‚úÖ/‚ùå + ‚öôÔ∏è (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–ª—É–¥–∞: –ø–æ–≤—Ç–æ—Ä—ã, –æ–∫–Ω–æ, –¥–µ–π—Å—Ç–≤–∏–µ)
‚îú‚îÄ‚îÄ Referral spam ‚úÖ/‚ùå
‚îú‚îÄ‚îÄ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚úÖ/‚ùå
‚îî‚îÄ‚îÄ –ú–æ–¥—É–ª—å –≤–∫–ª/–≤—ã–∫–ª

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞ —Å–ª–æ–≤ (‚öôÔ∏è)
‚îú‚îÄ‚îÄ üìù –ü—Ä–æ—Å—Ç—ã–µ —Å–ª–æ–≤–∞ (sw) ‚úÖ/‚ùå + ‚öôÔ∏è
‚îú‚îÄ‚îÄ üíä –í—Ä–µ–¥–Ω—ã–µ —Å–ª–æ–≤–∞ (hw) ‚úÖ/‚ùå + ‚öôÔ∏è
‚îú‚îÄ‚îÄ üîÄ –û–±—Ñ—É—Å–∫–∞—Ü–∏—è (ow) ‚úÖ/‚ùå + ‚öôÔ∏è
‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥

–î–µ–π—Å—Ç–≤–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (‚öôÔ∏è)
‚îú‚îÄ‚îÄ üóëÔ∏è –£–¥–∞–ª–∏—Ç—å / üîá –ú—É—Ç / üö´ –ë–∞–Ω
‚îú‚îÄ‚îÄ ‚è±Ô∏è –í—Ä–µ–º—è –º—É—Ç–∞ (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –º—É—Ç)
‚îú‚îÄ‚îÄ üìì –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤
‚îú‚îÄ‚îÄ ‚öôÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ
‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (‚öôÔ∏è)
‚îú‚îÄ‚îÄ üìù –¢–µ–∫—Å—Ç –ø—Ä–∏ –º—É—Ç–µ (FSM –≤–≤–æ–¥, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ %user%)
‚îú‚îÄ‚îÄ üìù –¢–µ–∫—Å—Ç –ø—Ä–∏ –±–∞–Ω–µ (FSM –≤–≤–æ–¥, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ %user%)
‚îú‚îÄ‚îÄ ‚è±Ô∏è –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–∑–∞–¥–µ—Ä–∂–∫–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö: 30s, 5min, 1h)
‚îú‚îÄ‚îÄ üóëÔ∏è –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–∑–∞–¥–µ—Ä–∂–∫–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω—Ç–∏—Ñ–ª—É–¥–∞ (‚öôÔ∏è)
‚îú‚îÄ‚îÄ –ú–∞–∫—Å. –ø–æ–≤—Ç–æ—Ä–æ–≤: 2 / 3 / 5 / ‚úèÔ∏è (—Ä—É—á–Ω–æ–π –≤–≤–æ–¥ 1-50)
‚îú‚îÄ‚îÄ –û–∫–Ω–æ: 30—Å / 60—Å / 120—Å / ‚úèÔ∏è (—Ä—É—á–Ω–æ–π –≤–≤–æ–¥ 10-600)
‚îú‚îÄ‚îÄ –î–µ–π—Å—Ç–≤–∏–µ: –£–¥–∞–ª–∏—Ç—å / –ú—É—Ç / –ë–∞–Ω
‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω—Ç–∏—Å–∫–∞–º–∞ (‚öôÔ∏è)
‚îú‚îÄ‚îÄ üéØ –ü–∞—Ç—Ç–µ—Ä–Ω—ã (–¥–æ–±–∞–≤–∏—Ç—å, –∏–º–ø–æ—Ä—Ç, —Å–ø–∏—Å–æ–∫)
‚îú‚îÄ‚îÄ –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –í—ã—Å–æ–∫–∞—è/–°—Ä–µ–¥–Ω—è—è/–ù–∏–∑–∫–∞—è
‚îú‚îÄ‚îÄ –î–µ–π—Å—Ç–≤–∏–µ: –£–¥–∞–ª–∏—Ç—å / –ú—É—Ç / –ë–∞–Ω
‚îú‚îÄ‚îÄ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚úÖ/‚ùå
‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥
```

### Redis Keys (Content Filter)
```python
f"cf:flood:{chat_id}:{user_id}:count:{hash}"    # –°—á—ë—Ç—á–∏–∫ –ø–æ–≤—Ç–æ—Ä–æ–≤
f"cf:referral:{chat_id}:{username}:count"       # –°—á—ë—Ç—á–∏–∫ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π @username
f"cf:referral:{chat_id}:{username}:users"       # Set —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–¥–≤–∏–≥–∞—é—â–∏—Ö
```

### –ú–æ–¥–µ–ª–∏ –ë–î

```python
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞ –¥–ª—è –≥—Ä—É–ø–ø—ã
class ContentFilterSettings:
    chat_id: BigInteger (PK, FK ‚Üí groups)
    enabled: Boolean
    word_filter_enabled: Boolean
    scam_detection_enabled: Boolean
    flood_detection_enabled: Boolean
    scam_sensitivity: Integer (40-90)
    default_action: String
    default_mute_duration: Integer
    word_filter_action: String (NULL = use default)
    word_filter_mute_duration: Integer (NULL = use default)
    flood_action: String (NULL = use default)
    flood_mute_duration: Integer (NULL = use default)
    word_filter_normalize: Boolean (True = detect l33tspeak)

# –ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞
class FilterWord:
    id: Integer (PK)
    chat_id: BigInteger (FK)
    word: String  # –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–ª–æ–≤–æ
    normalized: String  # –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
    match_type: String (word/phrase/regex)
    action: String (None = default)
    action_duration: Integer
    category: String

# –ò—Å–∫–ª—é—á–µ–Ω–∏—è (whitelist)
class FilterWhitelist:
    id: Integer (PK)
    chat_id: BigInteger (FK)
    word: String
    normalized: String

# –õ–æ–≥ –Ω–∞—Ä—É—à–µ–Ω–∏–π
class FilterViolation:
    id: Integer (PK)
    chat_id: BigInteger (FK)
    user_id: BigInteger
    message_id: BigInteger
    detector_type: String
    trigger: String
    action_taken: String
    created_at: DateTime
```

---

## 4. Mute System / –°–∏—Å—Ç–µ–º–∞ –º—É—Ç–æ–≤

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏.

### –í–∏–¥—ã –º—É—Ç–æ–≤

#### 3.1 –ú—É—Ç –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
**–§–∞–π–ª—ã:**
- `handlers/bot_moderation_handlers/new_member_requested_to_join_mute_handlers.py`
- `services/risk_gate.py`

**–õ–æ–≥–∏–∫–∞:**
```
–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ ‚Üí classify_join_event()
    ‚îÇ
    ‚îú‚îÄ‚îÄ INVITE ‚Üí prepare_invite_flow()
    ‚îÇ   ‚îî‚îÄ‚îÄ –ê–Ω—Ç–∏—Ñ–ª—É–¥ –ø—Ä–æ–≤–µ—Ä–∫–∞
    ‚îÇ
    ‚îî‚îÄ‚îÄ evaluate_admission()
        ‚îî‚îÄ‚îÄ risk_gate ‚Üí –æ—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞
            ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è (Pyrogram)
            ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞
            ‚îî‚îÄ‚îÄ –ë–∞–ª–ª —Ä–∏—Å–∫–∞ 0-100
                ‚îú‚îÄ‚îÄ < 50 ‚Üí –ø—Ä–æ–ø—É—Å–∫
                ‚îî‚îÄ‚îÄ >= 50 ‚Üí –º—É—Ç
```

#### 3.2 –ú—É—Ç –ø–æ —Ä–µ–∞–∫—Ü–∏–∏
**–§–∞–π–ª—ã:**
- `handlers/mute_by_reaction/mute_by_reaction_handler.py`
- `services/mute_by_reaction_service/logic.py`

**–õ–æ–≥–∏–∫–∞:**
```
–†–µ–∞–∫—Ü–∏—è üîá –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
    ‚îÇ
    ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞: —Ä–µ–∞–∫—Ç–æ—Ä ‚Äî –∞–¥–º–∏–Ω?
    ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞: –∞–≤—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –Ω–µ –∞–¥–º–∏–Ω?
    ‚îÇ
    ‚îî‚îÄ‚îÄ restrict_chat_member()
        ‚îî‚îÄ‚îÄ –ú—É—Ç –Ω–∞ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ –≤—Ä–µ–º—è
```

#### 3.3 –ê–≤—Ç–æ–º—É—Ç —Å–∫–∞–º–º–µ—Ä–æ–≤
**–§–∞–π–ª—ã:**
- `handlers/auto_mute_scammers_handlers.py`
- `services/auto_mute_scammers_logic.py`
- `services/spammer_registry.py`

**–õ–æ–≥–∏–∫–∞:**
```
–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–∏
    ‚îÇ
    ‚îú‚îÄ‚îÄ –ü–æ–∏—Å–∫ –≤ spammers —Ç–∞–±–ª–∏—Ü–µ
    ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ scammer_tracker
    ‚îÇ
    ‚îî‚îÄ‚îÄ –ï—Å–ª–∏ –≤ —Ä–µ–µ—Å—Ç—Ä–µ —Å–ø–∞–º–º–µ—Ä–æ–≤ ‚Üí –∞–≤—Ç–æ–º—É—Ç
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º—É—Ç–æ–≤ (ChatSettings)
| –ù–∞—Å—Ç—Ä–æ–π–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|----------|
| `mute_new_members` | –ú—É—Ç–∏—Ç—å –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ |
| `auto_mute_scammers` | –ê–≤—Ç–æ–º—É—Ç —Å–∫–∞–º–º–µ—Ä–æ–≤ |
| `global_mute_enabled` | –ì–ª–æ–±–∞–ª—å–Ω—ã–π –º—É—Ç |
| `reaction_mute_enabled` | –ú—É—Ç –ø–æ —Ä–µ–∞–∫—Ü–∏–∏ |
| `reaction_mute_announce_enabled` | –ê–Ω–æ–Ω—Å –º—É—Ç–∞ |

---

## 4. Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –≥—Ä—É–ø–ø —á–µ—Ä–µ–∑ –õ–° –±–æ—Ç–∞.

### –§–∞–π–ª—ã
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `handlers/group_settings_handler/groups_settings_in_private_handler.py` | /settings –∫–æ–º–∞–Ω–¥–∞ |
| `services/groups_settings_in_private_logic.py` | –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ |
| `keyboards/group_settings_kb.py` | –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã |

### Flow

```
/settings –≤ –õ–°
    ‚îÇ
    ‚îú‚îÄ‚îÄ get_admin_groups() ‚Üí —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø
    ‚îÇ
    ‚îî‚îÄ‚îÄ –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø —Å –∫–Ω–æ–ø–∫–∞–º–∏

–í—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã
    ‚îÇ
    ‚îú‚îÄ‚îÄ check_granular_permissions() ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
    ‚îÇ
    ‚îî‚îÄ‚îÄ –ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫

–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    ‚îÇ
    ‚îú‚îÄ‚îÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ë–î
    ‚îî‚îÄ‚îÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
```python
async def check_granular_permissions(bot, user_id, chat_id, permission, session):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ø—Ä–∞–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
    - can_delete_messages
    - can_restrict_members
    - can_change_info
    - –∏ —Ç.–¥.
    """
```

---

## 5. Journal / –ñ—É—Ä–Ω–∞–ª –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –≥—Ä—É–ø–ø—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª/–≥—Ä—É–ø–ø—É.

### –§–∞–π–ª—ã
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `handlers/journal_link_handler.py` | –ü—Ä–∏–≤—è–∑–∫–∞ –∂—É—Ä–Ω–∞–ª–∞ |
| `handlers/bot_activity_journal/bot_activity_journal.py` | –û—Ç–ø—Ä–∞–≤–∫–∞ –ª–æ–≥–æ–≤ |
| `services/bot_activity_journal/bot_activity_journal_logic.py` | –õ–æ–≥–∏–∫–∞ |
| `services/group_journal_service.py` | –†–∞–±–æ—Ç–∞ —Å –ë–î |

### –¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π
- –ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫
- –£—á–∞—Å—Ç–Ω–∏–∫ –≤—ã—à–µ–ª/–∫–∏–∫–Ω—É—Ç
- –ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –∫–∞–ø—á–∏
- –¢–∞–π–º–∞—É—Ç –∫–∞–ø—á–∏
- –°—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ –∞–Ω—Ç–∏—Å–ø–∞–º
- –ú—É—Ç/—Ä–∞–∑–º—É—Ç

### –ü—Ä–∏–≤—è–∑–∫–∞ –∂—É—Ä–Ω–∞–ª–∞
```
/linkjournal ‚Üí –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
    ‚îÇ
–ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –∫–∞–Ω–∞–ª–∞ –∂—É—Ä–Ω–∞–ª–∞
    ‚îÇ
    ‚îú‚îÄ‚îÄ IsAdminWithChangeInfoFilter ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
    ‚îú‚îÄ‚îÄ link_journal_channel() ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
    ‚îî‚îÄ‚îÄ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
```

---

## 6. Broadcast / –†–∞—Å—Å—ã–ª–∫–∏

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ú–∞—Å—Å–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.

### –§–∞–π–ª—ã
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `handlers/broadcast_handlers/broadcast_handlers.py` | –ö–æ–º–∞–Ω–¥—ã —Ä–∞—Å—Å—ã–ª–∫–∏ |
| `services/broadcast_logic.py` | –õ–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ |

### Flow
```
/broadcast
    ‚îÇ
    ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞: —ç—Ç–æ –≤–ª–∞–¥–µ–ª–µ—Ü –±–æ—Ç–∞?
    ‚îú‚îÄ‚îÄ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    ‚îÇ
    ‚îî‚îÄ‚îÄ –¶–∏–∫–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        ‚îú‚îÄ‚îÄ –£—Å–ø–µ—Ö ‚Üí —Å—á—ë—Ç—á–∏–∫++
        ‚îî‚îÄ‚îÄ –û—à–∏–±–∫–∞ ‚Üí –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```

---

## 7. Risk Assessment / –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

### –§–∞–π–ª—ã
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `services/risk_gate.py` | –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ |
| `services/enhanced_profile_analyzer.py` | –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ |
| `services/account_age_estimator.py` | –û—Ü–µ–Ω–∫–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ |
| `services/pyrogram_client.py` | MTProto –∫–ª–∏–µ–Ω—Ç |

### –§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞

| –§–∞–∫—Ç–æ—Ä | –í–∫–ª–∞–¥ –≤ –±–∞–ª–ª |
|--------|--------------|
| –ù–µ—Ç —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è | +20-30 |
| –ú–æ–ª–æ–¥–æ–π –∞–∫–∫–∞—É–Ω—Ç (<30 –¥–Ω–µ–π) | +20-40 |
| –ù–µ—Ç username | +10 |
| –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–µ –∏–º—è | +10-20 |
| –í —Ä–µ–µ—Å—Ç—Ä–µ —Å–ø–∞–º–º–µ—Ä–æ–≤ | +50 |

### –ü–æ—Ä–æ–≥
- `risk_score < 50` ‚Üí –ø—Ä–æ–ø—É—Å–∫
- `risk_score >= 50` ‚Üí –º—É—Ç

### –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç –≤–æ–∑—Ä–∞—Å—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞

**–§–æ—Ä–º—É–ª–∞:**
```
age_days = (max_seen_id - user_id) / DAILY_GROWTH
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|----------|
| `DAILY_GROWTH` | 2,500,000 | –ü—Ä–∏—Ä–æ—Å—Ç user_id –≤ –¥–µ–Ω—å |
| `max_seen_id` | Redis: `telegram:max_seen_user_id` | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–∑–≤–µ—Å—Ç–Ω—ã–π ID |
| Fallback | 8,600,000,000 | –ï—Å–ª–∏ Redis –ø—É—Å—Ç–æ–π |

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –ü—Ä–∏ –∫–∞–∂–¥–æ–º join_request –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `update_max_seen_id()`
2. –ï—Å–ª–∏ –Ω–æ–≤—ã–π ID > —Ç–µ–∫—É—â–µ–≥–æ max ‚Üí –æ–±–Ω–æ–≤–ª—è–µ–º Redis
3. –ü—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç–∞: `(max - user_id) / 2.5M = –¥–Ω–∏`

**–ú–µ—Ç–æ–¥—ã –≤ `account_age_estimator.py`:**
- `get_dynamic_age_days(redis, user_id)` ‚Äî —Ä–∞—Å—á—ë—Ç –≤–æ–∑—Ä–∞—Å—Ç–∞
- `update_max_seen_id(redis, user_id)` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ max
- `is_young_account_dynamic(redis, user_id, threshold)` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞

---

## 8. Group Auto Sync / –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø –∏ –∞–¥–º–∏–Ω–æ–≤ –≤ –ë–î.

### –§–∞–π–ª—ã
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `middleware/group_auto_sync_middleware.py` | Middleware |
| `services/group_auto_sync.py` | –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ |

### –õ–æ–≥–∏–∫–∞
```
–õ—é–±–æ–µ —Å–æ–±—ã—Ç–∏–µ –∏–∑ –≥—Ä—É–ø–ø—ã
    ‚îÇ
    ‚îú‚îÄ‚îÄ _is_recently_synced() ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞
    ‚îÇ   ‚îî‚îÄ‚îÄ –ï—Å–ª–∏ –≤ –∫—ç—à–µ ‚Üí –ø—Ä–æ–ø—É—Å–∫
    ‚îÇ
    ‚îú‚îÄ‚îÄ ensure_group_exists()
    ‚îÇ   ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä—É–ø–ø—ã –≤ –ë–î
    ‚îÇ   ‚îú‚îÄ‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ—Ç
    ‚îÇ   ‚îî‚îÄ‚îÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ title –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è
    ‚îÇ
    ‚îú‚îÄ‚îÄ sync_group_admins()
    ‚îÇ   ‚îú‚îÄ‚îÄ bot.get_chat_administrators()
    ‚îÇ   ‚îú‚îÄ‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ User –∑–∞–ø–∏—Å–µ–π
    ‚îÇ   ‚îî‚îÄ‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ UserGroup —Å–≤—è–∑–µ–π
    ‚îÇ
    ‚îî‚îÄ‚îÄ _mark_as_synced() ‚Üí Redis TTL 5 –º–∏–Ω
```

---

*–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2025-12-08 (–¥–æ–±–∞–≤–ª–µ–Ω—ã –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç, –∑–∞–¥–µ—Ä–∂–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è, –∞–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)*