# Modules / –ú–æ–¥—É–ª–∏

## Overview

–û–ø–∏—Å–∞–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –º–æ–¥—É–ª–µ–π –±–æ—Ç–∞ –∏ –∏—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è.

---

## 1. Captcha / –ö–∞–ø—á–∞ (–†–ï–î–ò–ó–ê–ô–ù 2025-12)

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ó–∞—â–∏—Ç–∞ –≥—Ä—É–ø–ø –æ—Ç —Å–ø–∞–º-–±–æ—Ç–æ–≤ –ø—É—Ç—ë–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.

### –¢—Ä–∏ —Ä–µ–∂–∏–º–∞ –∫–∞–ø—á–∏

| –†–µ–∂–∏–º | –¢—Ä–∏–≥–≥–µ—Ä | –ö—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è | –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è |
|-------|---------|-------------------|------------|
| **Join Request Captcha** | `chat_join_request` | –í –õ–° –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é | Join Requests –≤ –≥—Ä—É–ø–ø–µ (–∑–∞–∫—Ä—ã—Ç–∞—è –≥—Ä—É–ø–ø–∞) |
| **Join Captcha** | `new_chat_members` (—Å–∞–º–æ–≤—Ö–æ–¥) | –í –≥—Ä—É–ø–ø—É ‚Üí deep link –≤ –õ–° | –û—Ç–∫—Ä—ã—Ç–∞—è –≥—Ä—É–ø–ø–∞ |
| **Invite Captcha** | `new_chat_members` (–∏–Ω–≤–∞–π—Ç) | –í –≥—Ä—É–ø–ø—É ‚Üí deep link –≤ –õ–° | –õ—é–±–∞—è –≥—Ä—É–ø–ø–∞, –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç |

### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã
- **–ó–∞–∫—Ä—ã—Ç–∞—è –≥—Ä—É–ø–ø–∞** (join request enabled) ‚Üí –∫–∞–ø—á–∞ —Å—Ä–∞–∑—É –≤ –õ–°
- **–û—Ç–∫—Ä—ã—Ç–∞—è –≥—Ä—É–ø–ø–∞** (join request disabled) ‚Üí –∫–∞–ø—á–∞ –≤ –≥—Ä—É–ø–ø–µ —Å –∫–Ω–æ–ø–∫–æ–π "–†–µ—à–∏—Ç—å –∫–∞–ø—á—É" ‚Üí deep link –≤ –õ–°
- **Invite Captcha** —Ä–∞–±–æ—Ç–∞–µ—Ç –í–°–ï–ì–î–ê, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≥—Ä—É–ø–ø—ã

### –§–∞–π–ª—ã

**–°–µ—Ä–≤–∏—Å—ã (services/captcha/):**
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `services/captcha/__init__.py` | –≠–∫—Å–ø–æ—Ä—Ç –º–æ–¥—É–ª—è |
| `services/captcha/settings_service.py` | CRUD –Ω–∞—Å—Ç—Ä–æ–µ–∫, CaptchaMode enum, CaptchaSettings dataclass |
| `services/captcha/flow_service.py` | –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏/–ø—Ä–æ–≤–µ—Ä–∫–∏ |
| `services/captcha/verification_service.py` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤, ownership check |
| `services/captcha/cleanup_service.py` | –û—á–∏—Å—Ç–∫–∞ –∫–∞–ø—á, –ª–∏–º–∏—Ç—ã, Redis |
| `services/captcha/dm_flow_service.py` | –õ–æ–≥–∏–∫–∞ –õ–° –∫–∞–ø—á–∏, deep links, Redis –æ–ø–µ—Ä–∞—Ü–∏–∏ |
| `services/captcha/reminder_service.py` | –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ —Ç–∞–π–º–∞—É—Ç—ã (asyncio.create_task) |

**–•–µ–Ω–¥–ª–µ—Ä—ã (handlers/captcha/):**
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `handlers/captcha/__init__.py` | –≠–∫—Å–ø–æ—Ä—Ç captcha_router |
| `handlers/captcha/captcha_coordinator.py` | **–ï–î–ò–ù–ê–Ø –¢–û–ß–ö–ê –í–•–û–î–ê** (chat_join_request, new_chat_members) |
| `handlers/captcha/captcha_callbacks.py` | Callback –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ (verify, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –¥–∏–∞–ª–æ–≥–∏) |
| `handlers/captcha/captcha_fsm_handler.py` | FSM –¥–ª—è deep link –∏ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –æ—Ç–≤–µ—Ç–∞ |
| `handlers/captcha/captcha_keyboards.py` | –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã (2 –∫–Ω–æ–ø–∫–∏ –≤ —Ä—è–¥) |
| `handlers/captcha/captcha_messages.py` | –¢–µ–∫—Å—Ç—ã —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–ø—á–∏ |

### Pipeline (–Ω–æ–≤—ã–π)

```
chat_join_request / new_chat_members
    ‚îÇ
    ‚îú‚îÄ‚îÄ captcha_coordinator.py (–µ–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞)
    ‚îÇ
    ‚îú‚îÄ‚îÄ check_and_restore_restriction() ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º—É—Ç–∞
    ‚îÇ   ‚îî‚îÄ‚îÄ –ï—Å–ª–∏ –µ—Å—Ç—å –º—É—Ç ‚Üí –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º, –æ—Ç–∫–ª–æ–Ω—è–µ–º
    ‚îÇ
    ‚îú‚îÄ‚îÄ determine_captcha_mode() ‚Üí –≤—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞
    ‚îÇ   ‚îú‚îÄ‚îÄ join_request ‚Üí VISUAL_DM (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω)
    ‚îÇ   ‚îú‚îÄ‚îÄ self_join ‚Üí JOIN_GROUP (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω)
    ‚îÇ   ‚îî‚îÄ‚îÄ invite ‚Üí INVITE_GROUP (–µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω)
    ‚îÇ
    ‚îî‚îÄ‚îÄ send_captcha()
        ‚îú‚îÄ‚îÄ cleanup_user_captcha() ‚Üí –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–π
        ‚îú‚îÄ‚îÄ enforce_captcha_limit() ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–∞
        ‚îú‚îÄ‚îÄ generate_visual_captcha() ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ
        ‚îî‚îÄ‚îÄ –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –õ–° –∏–ª–∏ –≥—Ä—É–ø–ø—É
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (ChatSettings)

**–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:**
| –ù–∞—Å—Ç—Ä–æ–π–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | Default |
|-----------|----------|---------|
| `visual_captcha_enabled` | Join Request Captcha (–õ–°) –≤–∫–ª/–≤—ã–∫–ª | False |
| `visual_captcha_timeout_seconds` | –¢–∞–π–º–∞—É—Ç Join Request Captcha | 120 |
| `join_captcha_timeout_seconds` | –¢–∞–π–º–∞—É—Ç Join Captcha | 120 |
| `invite_captcha_timeout_seconds` | –¢–∞–π–º–∞—É—Ç Invite Captcha | 120 |
| `captcha_max_pending` | –ú–∞–∫—Å. –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫–∞–ø—á | None |
| `captcha_overflow_action` | –î–µ–π—Å—Ç–≤–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ | None |

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤ (–ù–û–í–´–ï):**
| –ù–∞—Å—Ç—Ä–æ–π–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | Default |
|-----------|----------|---------|
| `captcha_manual_input_enabled` | –†—É—á–Ω–æ–π –≤–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞ | True |
| `captcha_button_count` | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–Ω–æ–ø–æ–∫ (4/6/9) | 6 |
| `captcha_max_attempts` | –ú–∞–∫—Å. –ø–æ–ø—ã—Ç–æ–∫ | 3 |
| `captcha_reminder_seconds` | –í—Ä–µ–º—è –¥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è (0=–≤—ã–∫–ª) | 60 |
| `captcha_dialog_cleanup_seconds` | –í—Ä–µ–º—è –¥–æ –æ—á–∏—Å—Ç–∫–∏ –¥–∏–∞–ª–æ–≥–∞ | 120 |

**Legacy –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏):**
| –ù–∞—Å—Ç—Ä–æ–π–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|----------|
| `captcha_join_enabled` | Join Captcha –≤–∫–ª/–≤—ã–∫–ª |
| `captcha_invite_enabled` | Invite Captcha –≤–∫–ª/–≤—ã–∫–ª |
| `captcha_timeout_seconds` | Legacy –æ–±—â–∏–π —Ç–∞–π–º–∞—É—Ç |
| `captcha_message_ttl_seconds` | TTL —Å–æ–æ–±—â–µ–Ω–∏—è |
| `captcha_flood_threshold` | –ü–æ—Ä–æ–≥ –∞–Ω—Ç–∏—Ñ–ª—É–¥–∞ |
| `captcha_flood_window_seconds` | –û–∫–Ω–æ –∞–Ω—Ç–∏—Ñ–ª—É–¥–∞ |
| `captcha_flood_action` | –î–µ–π—Å—Ç–≤–∏–µ –∞–Ω—Ç–∏—Ñ–ª—É–¥–∞ |

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫

```
‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–ø—á–∏
‚îú‚îÄ‚îÄ ‚úÖ/‚ùå Join Request Captcha (–õ–°)
‚îú‚îÄ‚îÄ ‚úÖ/‚ùå Join Captcha (–≥—Ä—É–ø–ø–∞, —Å–∞–º–æ–≤—Ö–æ–¥)
‚îú‚îÄ‚îÄ ‚úÖ/‚ùå Invite Captcha (–≥—Ä—É–ø–ø–∞, –∏–Ω–≤–∞–π—Ç)
‚îú‚îÄ‚îÄ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚îú‚îÄ‚îÄ üìä –ú–∞–∫—Å. –∫–∞–ø—á: X
‚îú‚îÄ‚îÄ ‚ö° –ü—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏: –¥–µ–π—Å—Ç–≤–∏–µ
‚îú‚îÄ‚îÄ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚îú‚îÄ‚îÄ üí¨ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤
‚îÇ   ‚îú‚îÄ‚îÄ ‚úÖ/‚ùå –†—É—á–Ω–æ–π –≤–≤–æ–¥
‚îÇ   ‚îú‚îÄ‚îÄ üî¢ –ö–Ω–æ–ø–æ–∫: 6
‚îÇ   ‚îú‚îÄ‚îÄ üîÑ –ü–æ–ø—ã—Ç–æ–∫: 3
‚îÇ   ‚îú‚îÄ‚îÄ üîî –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: 60 —Å–µ–∫
‚îÇ   ‚îî‚îÄ‚îÄ üßπ –ß–∏—Å—Ç–∫–∞: 120 —Å–µ–∫
‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥
```

### Redis Keys (–Ω–æ–≤—ã–µ)
```python
# –î–∞–Ω–Ω—ã–µ –∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞–ø—á–∏
f"captcha:data:{user_id}:{chat_id}"

# ID —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–∞–ø—á–µ–π
f"captcha:msg:{user_id}:{chat_id}"

# –°—á—ë—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫
f"captcha:attempts:{user_id}:{chat_id}"

# –í–ª–∞–¥–µ–ª–µ—Ü –∫–∞–ø—á–∏ (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–Ω–æ–ø–æ–∫)
f"captcha:owner:{chat_id}:{message_id}"
```

### –ó–∞—â–∏—Ç–∞ –æ—Ç –±–∞–≥–æ–≤

1. **–ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –º—É—Ç–∞** - –ø—Ä–æ–≤–µ—Ä–∫–∞ `UserRestriction` –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤—Ö–æ–¥–µ
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞** - `owner_id` –≤ callback_data
3. **–õ–∏–º–∏—Ç –∫–∞–ø—á** - `captcha_max_pending` + `overflow_action`
4. **–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö** - `cleanup_user_captcha()` –ø–µ—Ä–µ–¥ –Ω–æ–≤–æ–π

---

## 2. Antispam / –ê–Ω—Ç–∏—Å–ø–∞–º

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º: —Å—Å—ã–ª–∫–∏, –ø–µ—Ä–µ—Å—ã–ª–∫–∏, —Ü–∏—Ç–∞—Ç—ã.

### –§–∞–π–ª—ã
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `handlers/antispam_handlers/antispam_filter_handler.py` | –§–∏–ª—å—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏–π |
| `handlers/antispam_handlers/antispam_settings_handler.py` | UI –Ω–∞—Å—Ç—Ä–æ–µ–∫ |
| `services/antispam/antispam_service.py` | –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ |
| `database/models_antispam.py` | –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö |
| `keyboards/antispam_keyboards.py` | –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã |

### –¢–∏–ø—ã –ø—Ä–∞–≤–∏–ª (RuleType)

| –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----|----------|
| `TELEGRAM_LINK` | –°—Å—ã–ª–∫–∏ t.me, telegram.me, tg:// |
| `ANY_LINK` | –õ—é–±—ã–µ HTTP/HTTPS —Å—Å—ã–ª–∫–∏ |
| `FORWARD_CHANNEL` | –ü–µ—Ä–µ—Å—ã–ª–∫–∏ –∏–∑ –∫–∞–Ω–∞–ª–æ–≤ |
| `FORWARD_GROUP` | –ü–µ—Ä–µ—Å—ã–ª–∫–∏ –∏–∑ –≥—Ä—É–ø–ø |
| `FORWARD_USER` | –ü–µ—Ä–µ—Å—ã–ª–∫–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π |
| `FORWARD_BOT` | –ü–µ—Ä–µ—Å—ã–ª–∫–∏ –æ—Ç –±–æ—Ç–æ–≤ |
| `QUOTE_CHANNEL` | –¶–∏—Ç–∞—Ç—ã –∏–∑ –∫–∞–Ω–∞–ª–æ–≤ |
| `QUOTE_GROUP` | –¶–∏—Ç–∞—Ç—ã –∏–∑ –≥—Ä—É–ø–ø |
| `QUOTE_USER` | –¶–∏—Ç–∞—Ç—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π |
| `QUOTE_BOT` | –¶–∏—Ç–∞—Ç—ã –æ—Ç –±–æ—Ç–æ–≤ |

### –î–µ–π—Å—Ç–≤–∏—è (ActionType)

| –î–µ–π—Å—Ç–≤–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|
| `OFF` | –ü—Ä–∞–≤–∏–ª–æ –≤—ã–∫–ª—é—á–µ–Ω–æ |
| `DELETE` | –¢–æ–ª—å–∫–æ —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è |
| `WARN` | –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ |
| `KICK` | –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –∏–∑ –≥—Ä—É–ø–ø—ã |
| `RESTRICT` | –ú—É—Ç –Ω–∞ –≤—Ä–µ–º—è |
| `BAN` | –ë–∞–Ω –Ω–∞–≤—Å–µ–≥–¥–∞ |

### Pipeline —Ñ–∏–ª—å—Ç—Ä–∞

```
–°–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ
    ‚îÇ
    ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞: group/supergroup?
    ‚îú‚îÄ‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∞–≤–∏–ª –∏–∑ –ë–î
    ‚îÇ
    ‚îú‚îÄ‚îÄ check_links()
    ‚îÇ   ‚îú‚îÄ‚îÄ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ URL –∏–∑ —Ç–µ–∫—Å—Ç–∞
    ‚îÇ   ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ TELEGRAM_LINK
    ‚îÇ   ‚îî‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ ANY_LINK
    ‚îÇ
    ‚îú‚îÄ‚îÄ check_forwards()
    ‚îÇ   ‚îú‚îÄ‚îÄ forward_from_chat? ‚Üí FORWARD_CHANNEL/GROUP
    ‚îÇ   ‚îú‚îÄ‚îÄ forward_from.is_bot? ‚Üí FORWARD_BOT
    ‚îÇ   ‚îî‚îÄ‚îÄ forward_from? ‚Üí FORWARD_USER
    ‚îÇ
    ‚îú‚îÄ‚îÄ check_quotes()
    ‚îÇ   ‚îî‚îÄ‚îÄ –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø–µ—Ä–µ—Å—ã–ª–∫–∞–º
    ‚îÇ
    ‚îú‚îÄ‚îÄ check_whitelist() ‚Üí –∏—Å–∫–ª—é—á–µ–Ω–∏—è
    ‚îÇ
    ‚îî‚îÄ‚îÄ apply_action()
        ‚îú‚îÄ‚îÄ DELETE ‚Üí message.delete()
        ‚îú‚îÄ‚îÄ WARN ‚Üí –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
        ‚îú‚îÄ‚îÄ KICK ‚Üí bot.ban + bot.unban
        ‚îú‚îÄ‚îÄ RESTRICT ‚Üí bot.restrict_chat_member
        ‚îî‚îÄ‚îÄ BAN ‚Üí bot.ban_chat_member
```

### –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ (Whitelist)

| Scope | –ü—Ä–∏–º–µ—Ä—ã –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ |
|-------|-------------------|
| `TELEGRAM_LINK` | `t.me/mygroup`, `@channel` |
| `ANY_LINK` | `youtube.com`, `github.com` |
| `FORWARD` | `-1001234567890` (chat ID) |
| `QUOTE` | `-1001234567890` |

---

## 3. Content Filter / –§–∏–ª—å—Ç—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–º —Å–ª–æ–≤–∞–º —Å –æ–±—Ö–æ–¥–æ–º –æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏ (l33tspeak).

### –§–∞–π–ª—ã
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `handlers/content_filter/filter_handler.py` | –§–∏–ª—å—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –≥—Ä—É–ø–ø–∞—Ö |
| `handlers/content_filter/settings_handler.py` | UI –Ω–∞—Å—Ç—Ä–æ–µ–∫ (callback query) |
| `services/content_filter/text_normalizer.py` | –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ (l33tspeak) |
| `services/content_filter/word_filter.py` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ |
| `services/content_filter/scam_detector.py` | –≠–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –¥–µ—Ç–µ–∫—Ç–æ—Ä —Å–∫–∞–º–∞ |
| `services/content_filter/flood_detector.py` | –î–µ—Ç–µ–∫—Ç–æ—Ä –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å–æ–æ–±—â–µ–Ω–∏–π |
| `services/content_filter/referral_detector.py` | –î–µ—Ç–µ–∫—Ç–æ—Ä —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ —Å–ø–∞–º–∞ |
| `services/content_filter/filter_manager.py` | –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –≤—Å–µ—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤ |
| `database/models_content_filter.py` | –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö |
| `keyboards/content_filter_keyboards.py` | –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã |

### –ü–æ–¥–º–æ–¥—É–ª–∏

| –ü–æ–¥–º–æ–¥—É–ª—å | –û–ø–∏—Å–∞–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|-----------|----------|--------|
| Word Filter | –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å–ª–æ–≤–∞–º/—Ñ—Ä–∞–∑–∞–º | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω |
| Scam Detector | –≠–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∫–∞–º–∞ (4 –º–µ—Ç–æ–¥–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏ + –∫–∞—Ç–µ–≥–æ—Ä–∏–∏) | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω |
| Flood Detector | –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ–ª—É–¥–∞ (Redis) ‚Äî –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ, –ª—é–±—ã–µ, –º–µ–¥–∏–∞ | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω |
| Message Cleanup | –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –∏ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω |
| Referral Detector | –î–µ—Ç–µ–∫—Ç–æ—Ä —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ —Å–ø–∞–º–∞ (@username) | ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω |

### Text Normalizer - –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–ø–∞–º–µ—Ä—ã –æ–±—Ö–æ–¥—è—Ç —Ñ–∏–ª—å—Ç—Ä—ã —á–µ—Ä–µ–∑:
- L33tspeak: `k0ka` –≤–º–µ—Å—Ç–æ `–∫–æ–∫–∞`
- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏: `–∫-–æ-–∫-–∞` –≤–º–µ—Å—Ç–æ `–∫–æ–∫–∞`
- –õ–∞—Ç–∏–Ω–∏—Ü—É: `—à–∏shk–∏` (–ª–∞—Ç–∏–Ω—Å–∫–∏–µ s, h, k –≤–º–µ—Å—Ç–æ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã)
- –ù–µ–≤–∏–¥–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã: `–∫–æ\u200b–∫–∞`
- **Combining Marks:** `—àÃ∂uÃ∂—àÃ∂–∫Ã∂uÃ∂` (–∑–∞—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ), `MÕüÕûnÕüÕûoÕüÕûgÕüÕûoÕüÕûeÕüÕû` (–ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ)
- **Unicode –≤–∞—Ä–∏–∞–Ω—Ç—ã:** `‚ìö‚ìû‚ìö‚ìê` (circled), `ÔΩãÔΩèÔΩãÔΩÅ` (fullwidth), `ùê§ùê®ùê§ùêö` (math bold)
- **Small Caps:** `·¥ã·¥è·¥ã·¥Ä`
- **Block Elements:** `‚ñëC‚ñëo‚ñëc‚ñëo`, `‚ñí`, `‚ñì`

**–†–µ—à–µ–Ω–∏–µ:** TextNormalizer –ø—Ä–∏–≤–æ–¥–∏—Ç —Ç–µ–∫—Å—Ç –∫ –µ–¥–∏–Ω–æ–º—É –≤–∏–¥—É:

```python
normalizer = TextNormalizer()
normalizer.normalize("k0-k-@")      # ‚Üí "–∫–æ–∫–∞"
normalizer.normalize("—à1—àk1")       # ‚Üí "—à–∏—à–∫–∏" (1‚Üí–∏, k‚Üí–∫)
normalizer.normalize("–Ω@—Ä–∫0—Ç1–∫")    # ‚Üí "–Ω–∞—Ä–∫–æ—Ç–∏–∫"
normalizer.normalize("—àÃ∂uÃ∂—àÃ∂–∫Ã∂uÃ∂")      # ‚Üí "—à—É—à–∫—É" (–∑–∞—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ —É–¥–∞–ª—è–µ—Ç—Å—è, u‚Üí—É)
normalizer.normalize("‚ìö‚ìû‚ìö‚ìê")        # ‚Üí "–∫–æ–∫–∞" (circled ‚Üí –æ–±—ã—á–Ω—ã–µ)
normalizer.normalize("·¥ã·¥è·¥ã·¥Ä")        # ‚Üí "–∫–æ–∫–∞" (small caps)
```

**–≠—Ç–∞–ø—ã –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏:**
1. **NFKD** ‚Äî —Ä–∞—Å–∫–ª–∞–¥–∫–∞ Unicode (fullwidth, circled, math ‚Üí –æ–±—ã—á–Ω—ã–µ)
2. **Lowercase** ‚Äî –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
3. **Combining Marks** ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞—á—ë—Ä–∫–∏–≤–∞–Ω–∏–π, –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–π (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ Mn, Mc)
4. **Invisible chars** ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ zero-width —Å–∏–º–≤–æ–ª–æ–≤
5. **Separators** ‚Äî —É–¥–∞–ª–µ–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–π –º–µ–∂–¥—É –±—É–∫–≤–∞–º–∏ (-, ‚ñë, ‚Ä¢, –∏ —Ç.–¥.)
6. **Char map** ‚Äî –∑–∞–º–µ–Ω–∞ –ø–æ—Ö–æ–∂–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ (l33tspeak, small caps)

**–¢–∞–±–ª–∏—Ü–∞ –∑–∞–º–µ–Ω:**
| –°–∏–º–≤–æ–ª | –ó–∞–º–µ–Ω–∞ | –°–∏–º–≤–æ–ª | –ó–∞–º–µ–Ω–∞ |
|--------|--------|--------|--------|
| `0` | `–æ` | `1` | `–∏` |
| `3` | `–∑` | `@` | `–∞` |
| `4` | `—á` | `$` | `—Å` |
| `k` | `–∫` | `u` | `—É` |
| `·¥ã` | `–∫` | `·¥è` | `–æ` |
| `·¥Ä` | `–∞` | `·¥ç` | `–º` |

### Word Filter - –§–∏–ª—å—Ç—Ä —Å–ª–æ–≤

**–¢–∏–ø—ã —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π:**
| –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|-----|----------|--------|
| `word` | –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å–ª–æ–≤–∞ | "–Ω–∞—Ä–∫–æ—Ç–∏–∫" ‚â† "–Ω–∞—Ä–∫–æ—Ç–∏–∫–∏" |
| `phrase` | –ü–æ–¥—Å—Ç—Ä–æ–∫–∞ | "–∫–æ–∫" –Ω–∞–π–¥—ë—Ç—Å—è –≤ "–∫–æ–∫–∞–∏–Ω" |
| `regex` | –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ | `–Ω–∞—Ä–∫.?—Ç–∏–∫` |

### –î–µ–π—Å—Ç–≤–∏—è (action)
| –î–µ–π—Å—Ç–≤–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|
| `delete` | –¢–æ–ª—å–∫–æ —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è |
| `warn` | –£–¥–∞–ª–µ–Ω–∏–µ + –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ |
| `mute` | –£–¥–∞–ª–µ–Ω–∏–µ + –º—É—Ç –Ω–∞ –≤—Ä–µ–º—è |
| `kick` | –£–¥–∞–ª–µ–Ω–∏–µ + –∏—Å–∫–ª—é—á–µ–Ω–∏–µ |
| `ban` | –£–¥–∞–ª–µ–Ω–∏–µ + –±–∞–Ω |

### Scam Detector - 4 –º–µ—Ç–æ–¥–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–ø–∞–º–µ—Ä—ã –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä—É—é—Ç —Å–∫–∞–º-—Å–æ–æ–±—â–µ–Ω–∏—è, –æ–±—Ö–æ–¥—è —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤.

**–†–µ—à–µ–Ω–∏–µ:** 4 –º–µ—Ç–æ–¥–∞ –¥–µ—Ç–µ–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ:

| –ú–µ—Ç–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ | –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ |
|-------|----------|------------|
| **Keywords** | –¢–æ—á–Ω–æ–µ –≤—Ö–æ–∂–¥–µ–Ω–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ | –ë–∞–∑–æ–≤–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è: "–Ω–∞—Ä–∫–æ—Ç–∏–∫–∏", "drugs" |
| **Fuzzy** | –ù–µ—á—ë—Ç–∫–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ (SequenceMatcher, –ø–æ—Ä–æ–≥ 0.8) | –û–ø–µ—á–∞—Ç–∫–∏: "narkotik" ‚Üí "–Ω–∞—Ä–∫–æ—Ç–∏–∫" |
| **N-grams** | –ë–∏–≥—Ä–∞–º–º—ã/—Ç—Ä–∏–≥—Ä–∞–º–º—ã —Å –ø–æ—Ä–æ–≥–æ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è 0.5 | –ü–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∫–∏: "–ø—Ä–æ–¥–∞—é —Ç–æ–≤–∞—Ä" |
| **Categories** | –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ –∏–∑ –ë–î —Å –≤–µ—Å–∞–º–∏ | –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã |

**–§—É–Ω–∫—Ü–∏–∏ –≤ `scam_detector.py`:**
```python
def fuzzy_match(text: str, pattern: str, threshold: float = 0.8) -> bool:
    """–ù–µ—á—ë—Ç–∫–æ–µ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ SequenceMatcher."""

def extract_ngrams(text: str, n: int = 2) -> Set[str]:
    """–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –±–∏–≥—Ä–∞–º–º/—Ç—Ä–∏–≥—Ä–∞–º–º –∏–∑ —Ç–µ–∫—Å—Ç–∞."""

def ngram_match(text_ngrams: Set[str], pattern_ngrams: Set[str], min_overlap: float = 0.5) -> bool:
    """–°—Ä–∞–≤–Ω–µ–Ω–∏–µ n-–≥—Ä–∞–º–º —Å –ø–æ—Ä–æ–≥–æ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è."""
```

### –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ (Signal Categories)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏ —Å–∫–∞–º–∞ —Å –≤–µ—Å–∞–º–∏.

**–ú–æ–¥–µ–ª—å –ë–î:**
```python
class ScamSignalCategory:
    id: Integer (PK)
    chat_id: BigInteger (FK ‚Üí groups)
    category_name: String  # –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    keywords: Text  # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
    weight: Integer  # –í–µ—Å –ø—Ä–∏ –ø–æ–¥—Å—á—ë—Ç–µ score (default: 25)
    enabled: Boolean  # –í–∫–ª—é—á–µ–Ω–∞/–≤—ã–∫–ª—é—á–µ–Ω–∞
    created_at: DateTime
```

**UI —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```
–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω—Ç–∏—Å–∫–∞–º–∞ ‚Üí üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤
‚îú‚îÄ‚îÄ ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é
‚îÇ   ‚îú‚îÄ‚îÄ –í–≤–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏—è (FSM)
‚îÇ   ‚îî‚îÄ‚îÄ –í–≤–æ–¥ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (FSM)
‚îú‚îÄ‚îÄ [–ö–∞—Ç–µ–≥–æ—Ä–∏—è 1] ‚úÖ/‚ùå
‚îÇ   ‚îú‚îÄ‚îÄ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
‚îÇ   ‚îú‚îÄ‚îÄ –í–∫–ª/–í—ã–∫–ª
‚îÇ   ‚îî‚îÄ‚îÄ –£–¥–∞–ª–∏—Ç—å
‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥
```

**–ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**
1. –°–æ–∑–¥–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é "–ù–∞—Ä–∫–æ—Ç–∏–∫–∏"
2. –î–æ–±–∞–≤–∏—Ç—å –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞: `drugs, –Ω–∞—Ä–∫–æ—Ç–∞, weed, hashish, cocaine, crystal`
3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤–µ—Å: 40 –±–∞–ª–ª–æ–≤
4. –ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ª—é–±–æ–≥–æ –∫–ª—é—á–µ–≤–æ–≥–æ —Å–ª–æ–≤–∞ ‚Äî +40 –∫ score

### Pipeline —Ñ–∏–ª—å—Ç—Ä–∞

```
–°–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ
    ‚îÇ
    ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞: group/supergroup?
    ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞: –∞–≤—Ç–æ—Ä - –∞–¥–º–∏–Ω? ‚Üí –ø—Ä–æ–ø—É—Å–∫
    ‚îÇ
    ‚îú‚îÄ‚îÄ FilterManager.check_message()
    ‚îÇ   ‚îú‚îÄ‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≥—Ä—É–ø–ø—ã
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îú‚îÄ‚îÄ 1. FloodDetector.check() (—Å–∞–º—ã–π –±—ã—Å—Ç—Ä—ã–π)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ö—ç—à–∞ (MD5)
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—á—ë—Ç—á–∏–∫–∞ –≤ Redis
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å flood_max_repeats
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îú‚îÄ‚îÄ 2. –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ (TextNormalizer)
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îú‚îÄ‚îÄ 3. WordFilter.check()
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª–æ–≤ –∏–∑ –ë–î
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ whitelist
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ –ü–æ–∏—Å–∫ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îú‚îÄ‚îÄ 4. ScamDetector.check()
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ –ê–Ω–∞–ª–∏–∑ 15 —Å–∏–≥–Ω–∞–ª–æ–≤
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ –ü–æ–¥—Å—á—ë—Ç score
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å scam_sensitivity
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îî‚îÄ‚îÄ 5. ReferralDetector.check()
    ‚îÇ       ‚îú‚îÄ‚îÄ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ @username
    ‚îÇ       ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—á—ë—Ç—á–∏–∫–æ–≤ –≤ Redis
    ‚îÇ       ‚îî‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ unique_users
    ‚îÇ
    ‚îî‚îÄ‚îÄ apply_action()
        ‚îú‚îÄ‚îÄ delete ‚Üí message.delete()
        ‚îú‚îÄ‚îÄ warn ‚Üí –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
        ‚îú‚îÄ‚îÄ mute ‚Üí restrict_chat_member
        ‚îú‚îÄ‚îÄ kick ‚Üí ban + unban
        ‚îî‚îÄ‚îÄ ban ‚Üí ban_chat_member
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (ContentFilterSettings)
| –ù–∞—Å—Ç—Ä–æ–π–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | Default |
|-----------|----------|---------|
| `enabled` | –§–∏–ª—å—Ç—Ä –≤–∫–ª—é—á—ë–Ω | False |
| `word_filter_enabled` | –§–∏–ª—å—Ç—Ä —Å–ª–æ–≤ | True |
| `scam_detection_enabled` | –î–µ—Ç–µ–∫—Ç–æ—Ä —Å–∫–∞–º–∞ | True |
| `flood_detection_enabled` | –î–µ—Ç–µ–∫—Ç–æ—Ä —Ñ–ª—É–¥–∞ | True |
| `referral_detection_enabled` | –î–µ—Ç–µ–∫—Ç–æ—Ä —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ | False |
| `scam_sensitivity` | –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (40-90) | 60 |
| `flood_max_repeats` | –ú–∞–∫—Å. –ø–æ–≤—Ç–æ—Ä–æ–≤ –¥–ª—è —Ñ–ª—É–¥–∞ (1-50, —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ ‚úèÔ∏è) | 2 |
| `flood_time_window` | –û–∫–Ω–æ —Ñ–ª—É–¥–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (10-600, —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ ‚úèÔ∏è) | 60 |
| `default_action` | –î–µ–π—Å—Ç–≤–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é | delete |
| `default_mute_duration` | –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º—É—Ç–∞ (–º–∏–Ω) | 1440 |
| `word_filter_action` | –î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è —Å–ª–æ–≤ (NULL=default) | NULL |
| `word_filter_mute_duration` | –ú—É—Ç –¥–ª—è —Å–ª–æ–≤ (NULL=default) | NULL |
| `flood_action` | –î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è —Ñ–ª—É–¥–∞ (NULL=default) | NULL |
| `flood_mute_duration` | –ú—É—Ç –¥–ª—è —Ñ–ª—É–¥–∞ (NULL=default) | NULL |
| `flood_mute_text` | –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –º—É—Ç–µ –∑–∞ —Ñ–ª—É–¥ | NULL |
| `flood_ban_text` | –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –±–∞–Ω–µ –∑–∞ —Ñ–ª—É–¥ | NULL |
| `flood_warn_text` | –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∑–∞ —Ñ–ª—É–¥ | NULL |
| `flood_detect_any_messages` | –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ª—é–±—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–¥—Ä—è–¥ | False |
| `flood_any_max_messages` | –ú–∞–∫—Å. —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ª—é–±—ã—Ö | 5 |
| `flood_any_time_window` | –û–∫–Ω–æ –¥–ª—è –ª—é–±—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (—Å–µ–∫) | 10 |
| `flood_detect_media` | –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ–¥–∏–∞-—Ñ–ª—É–¥ | False |
| `word_filter_normalize` | –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–ª—è —Å–ª–æ–≤ | True |
| `delete_user_commands` | –£–¥–∞–ª—è—Ç—å –∫–æ–º–∞–Ω–¥—ã –æ—Ç –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π | False |
| `delete_system_messages` | –£–¥–∞–ª—è—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è | False |

#### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π —Å–ª–æ–≤
| –ù–∞—Å—Ç—Ä–æ–π–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | Default |
|-----------|----------|---------|
| `simple_words_enabled` | –ü—Ä–æ—Å—Ç—ã–µ —Å–ª–æ–≤–∞ –≤–∫–ª | True |
| `simple_words_action` | –î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö | delete |
| `simple_words_mute_duration` | –ú—É—Ç –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö (–º–∏–Ω) | NULL |
| `simple_words_mute_text` | –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –º—É—Ç–µ | NULL |
| `simple_words_ban_text` | –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –±–∞–Ω–µ | NULL |
| `simple_words_delete_delay` | –ó–∞–¥–µ—Ä–∂–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–µ–∫) | NULL |
| `simple_words_notification_delete_delay` | –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—Å–µ–∫) | NULL |
| `harmful_words_enabled` | –í—Ä–µ–¥–Ω—ã–µ —Å–ª–æ–≤–∞ –≤–∫–ª | True |
| `harmful_words_action` | –î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –≤—Ä–µ–¥–Ω—ã—Ö | ban |
| `harmful_words_mute_duration` | –ú—É—Ç –¥–ª—è –≤—Ä–µ–¥–Ω—ã—Ö (–º–∏–Ω) | NULL |
| `harmful_words_mute_text` | –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –º—É—Ç–µ | NULL |
| `harmful_words_ban_text` | –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –±–∞–Ω–µ | NULL |
| `harmful_words_delete_delay` | –ó–∞–¥–µ—Ä–∂–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–µ–∫) | NULL |
| `harmful_words_notification_delete_delay` | –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—Å–µ–∫) | NULL |
| `obfuscated_words_enabled` | –û–±—Ñ—É—Å–∫–∞—Ü–∏—è –≤–∫–ª | True |
| `obfuscated_words_action` | –î–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏ | mute |
| `obfuscated_words_mute_duration` | –ú—É—Ç –¥–ª—è –æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏ (–º–∏–Ω) | 1440 |
| `obfuscated_words_mute_text` | –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –º—É—Ç–µ | NULL |
| `obfuscated_words_ban_text` | –ö–∞—Å—Ç–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –±–∞–Ω–µ | NULL |
| `obfuscated_words_delete_delay` | –ó–∞–¥–µ—Ä–∂–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è (—Å–µ–∫) | NULL |
| `obfuscated_words_notification_delete_delay` | –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (—Å–µ–∫) | NULL |

**–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–ª–æ–≤:**
- **simple** ‚Äî —Ä–µ–∫–ª–∞–º–∞, —Å–ø–∞–º, –æ–±—ã—á–Ω—ã–µ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞
- **harmful** ‚Äî –Ω–∞—Ä–∫–æ—Ç–∏–∫–∏, –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
- **obfuscated** ‚Äî —Å–ª–æ–≤–∞ —Å –æ–±—Ñ—É—Å–∫–∞—Ü–∏–µ–π (l33tspeak): k0ka, w1—à–∫–∏

**–ö–∞—Å—Ç–æ–º–Ω—ã–π —Ç–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä `%user%` –¥–ª—è —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–∞—Ä—É—à–∏—Ç–µ–ª—è
- –ü—Ä–∏–º–µ—Ä: `%user% –ø–æ–ª—É—á–∏–ª –º—É—Ç –∑–∞ —Å–ø–∞–º`
- –ï—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç –±–æ—Ç–∞

**–ó–∞–¥–µ—Ä–∂–∫–∏:**
- `delete_delay` ‚Äî —á–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ —É–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞—Ä—É—à–∏—Ç–µ–ª—è (0 = —Å—Ä–∞–∑—É)
- `notification_delete_delay` ‚Äî —á–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –∞–≤—Ç–æ—É–¥–∞–ª–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±–æ—Ç–∞ (NULL = –Ω–µ —É–¥–∞–ª—è—Ç—å)

#### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫
```
–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –§–∏–ª—å—Ç—Ä–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
‚îú‚îÄ‚îÄ –§–∏–ª—å—Ç—Ä —Å–ª–æ–≤ ‚úÖ/‚ùå + ‚öôÔ∏è (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ª–æ–≤)
‚îú‚îÄ‚îÄ –ê–Ω—Ç–∏—Å–∫–∞–º ‚úÖ/‚ùå + ‚öôÔ∏è (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω—Ç–∏—Å–∫–∞–º–∞: –ø–∞—Ç—Ç–µ—Ä–Ω—ã, —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –¥–µ–π—Å—Ç–≤–∏–µ)
‚îú‚îÄ‚îÄ –ê–Ω—Ç–∏—Ñ–ª—É–¥ ‚úÖ/‚ùå + ‚öôÔ∏è (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–ª—É–¥–∞: –ø–æ–≤—Ç–æ—Ä—ã, –æ–∫–Ω–æ, –¥–µ–π—Å—Ç–≤–∏–µ)
‚îú‚îÄ‚îÄ Referral spam ‚úÖ/‚ùå
‚îú‚îÄ‚îÄ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚úÖ/‚ùå
‚îî‚îÄ‚îÄ –ú–æ–¥—É–ª—å –≤–∫–ª/–≤—ã–∫–ª

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞ —Å–ª–æ–≤ (‚öôÔ∏è)
‚îú‚îÄ‚îÄ üìù –ü—Ä–æ—Å—Ç—ã–µ —Å–ª–æ–≤–∞ (sw) ‚úÖ/‚ùå + ‚öôÔ∏è
‚îú‚îÄ‚îÄ üíä –í—Ä–µ–¥–Ω—ã–µ —Å–ª–æ–≤–∞ (hw) ‚úÖ/‚ùå + ‚öôÔ∏è
‚îú‚îÄ‚îÄ üîÄ –û–±—Ñ—É—Å–∫–∞—Ü–∏—è (ow) ‚úÖ/‚ùå + ‚öôÔ∏è
‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥

–î–µ–π—Å—Ç–≤–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (‚öôÔ∏è)
‚îú‚îÄ‚îÄ üóëÔ∏è –£–¥–∞–ª–∏—Ç—å / üîá –ú—É—Ç / üö´ –ë–∞–Ω
‚îú‚îÄ‚îÄ ‚è±Ô∏è –í—Ä–µ–º—è –º—É—Ç–∞ (–µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –º—É—Ç)
‚îú‚îÄ‚îÄ üìì –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤
‚îú‚îÄ‚îÄ ‚öôÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ
‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (‚öôÔ∏è)
‚îú‚îÄ‚îÄ üìù –¢–µ–∫—Å—Ç –ø—Ä–∏ –º—É—Ç–µ (FSM –≤–≤–æ–¥, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ %user%)
‚îú‚îÄ‚îÄ üìù –¢–µ–∫—Å—Ç –ø—Ä–∏ –±–∞–Ω–µ (FSM –≤–≤–æ–¥, –ø–æ–¥–¥–µ—Ä–∂–∫–∞ %user%)
‚îú‚îÄ‚îÄ ‚è±Ô∏è –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–∑–∞–¥–µ—Ä–∂–∫–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö: 30s, 5min, 1h)
‚îú‚îÄ‚îÄ üóëÔ∏è –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–∑–∞–¥–µ—Ä–∂–∫–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö)
‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω—Ç–∏—Ñ–ª—É–¥–∞ (‚öôÔ∏è)
‚îú‚îÄ‚îÄ –ú–∞–∫—Å. –ø–æ–≤—Ç–æ—Ä–æ–≤: 2 / 3 / 5 / ‚úèÔ∏è (—Ä—É—á–Ω–æ–π –≤–≤–æ–¥ 1-50)
‚îú‚îÄ‚îÄ –û–∫–Ω–æ: 30—Å / 60—Å / 120—Å / ‚úèÔ∏è (—Ä—É—á–Ω–æ–π –≤–≤–æ–¥ 10-600)
‚îú‚îÄ‚îÄ üì± –õ—é–±—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è ‚úÖ/‚ùå + ‚öôÔ∏è (–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å max/window)
‚îú‚îÄ‚îÄ üñºÔ∏è –ú–µ–¥–∏–∞-—Ñ–ª—É–¥ ‚úÖ/‚ùå
‚îú‚îÄ‚îÄ –î–µ–π—Å—Ç–≤–∏–µ: –£–¥–∞–ª–∏—Ç—å / –ú—É—Ç / –ë–∞–Ω
‚îú‚îÄ‚îÄ ‚öôÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ (—Ç–µ–∫—Å—Ç –º—É—Ç–∞/–±–∞–Ω–∞, –∑–∞–¥–µ—Ä–∂–∫–∏)
‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥

–£–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π (üóëÔ∏è)
‚îú‚îÄ‚îÄ ü§ñ –£–¥–∞–ª—è—Ç—å –∫–æ–º–∞–Ω–¥—ã ‚úÖ/‚ùå (–∫–æ–º–∞–Ω–¥—ã –æ—Ç –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
‚îú‚îÄ‚îÄ üì¢ –£–¥–∞–ª—è—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ ‚úÖ/‚ùå (–≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ, –≤—ã—Ö–æ–¥, –∑–∞–∫—Ä–µ–ø)
‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–Ω—Ç–∏—Å–∫–∞–º–∞ (‚öôÔ∏è)
‚îú‚îÄ‚îÄ üéØ –ü–∞—Ç—Ç–µ—Ä–Ω—ã (–¥–æ–±–∞–≤–∏—Ç—å, –∏–º–ø–æ—Ä—Ç, —Å–ø–∏—Å–æ–∫)
‚îú‚îÄ‚îÄ üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ (–¥–æ–±–∞–≤–∏—Ç—å, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, —É–¥–∞–ª–∏—Ç—å)
‚îú‚îÄ‚îÄ –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –í—ã—Å–æ–∫–∞—è/–°—Ä–µ–¥–Ω—è—è/–ù–∏–∑–∫–∞—è
‚îú‚îÄ‚îÄ –î–µ–π—Å—Ç–≤–∏–µ: –£–¥–∞–ª–∏—Ç—å / –ú—É—Ç / –ë–∞–Ω
‚îú‚îÄ‚îÄ ‚öôÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ (—Ç–µ–∫—Å—Ç –º—É—Ç–∞/–±–∞–Ω–∞, –∑–∞–¥–µ—Ä–∂–∫–∏)
‚îú‚îÄ‚îÄ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚úÖ/‚ùå
‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥
```

### –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–Ω—Ç–∏—Ñ–ª—É–¥

**–†–µ–∂–∏–º—ã –¥–µ—Ç–µ–∫—Ü–∏–∏:**
| –†–µ–∂–∏–º | –û–ø–∏—Å–∞–Ω–∏–µ | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ |
|-------|----------|-----------|
| –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ | –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–¥—Ä—è–¥ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) | `flood_max_repeats`, `flood_time_window` |
| –õ—é–±—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è | –õ—é–±—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–¥—Ä—è–¥ (–Ω–µ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ) | `flood_any_max_messages`, `flood_any_time_window` |
| –ú–µ–¥–∏–∞-—Ñ–ª—É–¥ | –§–æ—Ç–æ, —Å—Ç–∏–∫–µ—Ä—ã, –≤–∏–¥–µ–æ, –≥–æ–ª–æ—Å–æ–≤—ã–µ, –≤–∏–¥–µ–æ–∫—Ä—É–∂–∫–∏ | –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ "–ª—é–±—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π" |

**–¢–∏–ø—ã –º–µ–¥–∏–∞ –¥–ª—è –¥–µ—Ç–µ–∫—Ü–∏–∏:**
- `photo` ‚Äî —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏
- `sticker` ‚Äî —Å—Ç–∏–∫–µ—Ä—ã
- `video` ‚Äî –≤–∏–¥–µ–æ
- `voice` ‚Äî –≥–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- `video_note` ‚Äî –≤–∏–¥–µ–æ–∫—Ä—É–∂–∫–∏

### –ú–æ–¥—É–ª—å —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑ –≥—Ä—É–ø–ø—ã.

**–§—É–Ω–∫—Ü–∏–∏:**
| –§—É–Ω–∫—Ü–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ | –£–¥–∞–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—ã (`/start`, `/help` –∏ —Ç.–¥.) –æ—Ç –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ö–æ–º–∞–Ω–¥—ã –æ—Ç –∞–¥–º–∏–Ω–æ–≤ —É–¥–∞–ª—è—é—Ç—Å—è, –Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è. |
| –£–¥–∞–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö | –£–¥–∞–ª—è–µ—Ç —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ, –≤—ã—Ö–æ–¥, –∑–∞–∫—Ä–µ–ø). |

**–õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:**
```
–°–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ
    ‚îÇ
    ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞: —ç—Ç–æ –∫–æ–º–∞–Ω–¥–∞? (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å /)
    ‚îÇ   ‚îú‚îÄ‚îÄ delete_user_commands=True –ò –ù–ï –∞–¥–º–∏–Ω ‚Üí —É–¥–∞–ª–∏—Ç—å, –ø—Ä–µ—Ä–≤–∞—Ç—å
    ‚îÇ   ‚îî‚îÄ‚îÄ delete_user_commands=True –ò –∞–¥–º–∏–Ω ‚Üí —É–¥–∞–ª–∏—Ç—å, –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É
    ‚îÇ
    ‚îî‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞: —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ?
        ‚îî‚îÄ‚îÄ delete_system_messages=True ‚Üí —É–¥–∞–ª–∏—Ç—å
```

### Redis Keys (Content Filter)
```python
f"cf:flood:{chat_id}:{user_id}:count:{hash}"    # –°—á—ë—Ç—á–∏–∫ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö
f"cf:flood:{chat_id}:{user_id}:any_count"       # –°—á—ë—Ç—á–∏–∫ –ª—é–±—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
f"cf:flood:{chat_id}:{user_id}:media_count"     # –°—á—ë—Ç—á–∏–∫ –º–µ–¥–∏–∞
f"cf:referral:{chat_id}:{username}:count"       # –°—á—ë—Ç—á–∏–∫ —É–ø–æ–º–∏–Ω–∞–Ω–∏–π @username
f"cf:referral:{chat_id}:{username}:users"       # Set —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–¥–≤–∏–≥–∞—é—â–∏—Ö
```

### –ú–æ–¥–µ–ª–∏ –ë–î

```python
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞ –¥–ª—è –≥—Ä—É–ø–ø—ã
class ContentFilterSettings:
    chat_id: BigInteger (PK, FK ‚Üí groups)
    enabled: Boolean
    word_filter_enabled: Boolean
    scam_detection_enabled: Boolean
    flood_detection_enabled: Boolean
    scam_sensitivity: Integer (40-90)
    default_action: String
    default_mute_duration: Integer
    word_filter_action: String (NULL = use default)
    word_filter_mute_duration: Integer (NULL = use default)
    flood_action: String (NULL = use default)
    flood_mute_duration: Integer (NULL = use default)
    word_filter_normalize: Boolean (True = detect l33tspeak)

# –ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞
class FilterWord:
    id: Integer (PK)
    chat_id: BigInteger (FK)
    word: String  # –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ —Å–ª–æ–≤–æ
    normalized: String  # –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
    match_type: String (word/phrase/regex)
    action: String (None = default)
    action_duration: Integer
    category: String

# –ò—Å–∫–ª—é—á–µ–Ω–∏—è (whitelist)
class FilterWhitelist:
    id: Integer (PK)
    chat_id: BigInteger (FK)
    word: String
    normalized: String

# –õ–æ–≥ –Ω–∞—Ä—É—à–µ–Ω–∏–π
class FilterViolation:
    id: Integer (PK)
    chat_id: BigInteger (FK)
    user_id: BigInteger
    message_id: BigInteger
    detector_type: String
    trigger: String
    action_taken: String
    created_at: DateTime
```

---

## 4. Message Management / –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ –≤ –≥—Ä—É–ø–ø–µ:
- –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ (–æ—Ç –∞–¥–º–∏–Ω–æ–≤ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- –£–¥–∞–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–≤—Ö–æ–¥, –≤—ã—Ö–æ–¥, –∑–∞–∫—Ä–µ–ø, –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–æ—Ç–æ)
- –†–µ–ø–∏–Ω (–∞–≤—Ç–æ–∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ) ‚Äî –∑–∞—â–∏—Ç–∞ –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

### –§–∞–π–ª—ã
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `handlers/message_management/__init__.py` | –ú–æ–¥—É–ª—å–Ω—ã–π —Ä–æ—É—Ç–µ—Ä |
| `handlers/message_management/settings_handler.py` | UI –Ω–∞—Å—Ç—Ä–æ–µ–∫ (callback query) |
| `handlers/message_management/command_handler.py` | –ö–æ–º–∞–Ω–¥—ã `/repin`, `/unrepin` |
| `handlers/message_management/filter_handler.py` | –õ–æ–≥–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–∞) |
| `services/message_management_service.py` | CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ |
| `keyboards/message_management_keyboards.py` | –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã |
| `database/models_message_management.py` | –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö |

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (MessageManagementSettings)
| –ù–∞—Å—Ç—Ä–æ–π–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | Default |
|-----------|----------|---------|
| `delete_admin_commands` | –£–¥–∞–ª—è—Ç—å –∫–æ–º–∞–Ω–¥—ã –æ—Ç –∞–¥–º–∏–Ω–æ–≤ | False |
| `delete_user_commands` | –£–¥–∞–ª—è—Ç—å –∫–æ–º–∞–Ω–¥—ã –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π | False |
| `delete_join_messages` | –£–¥–∞–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ –≤—Ö–æ–¥–µ | False |
| `delete_leave_messages` | –£–¥–∞–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ –≤—ã—Ö–æ–¥–µ | False |
| `delete_pin_messages` | –£–¥–∞–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∑–∞–∫—Ä–µ–ø–µ | False |
| `delete_chat_photo_messages` | –£–¥–∞–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–æ—Ç–æ/–Ω–∞–∑–≤–∞–Ω–∏—è | False |
| `repin_enabled` | –í–∫–ª—é—á—ë–Ω –ª–∏ –∞–≤—Ç–æ–∑–∞–∫—Ä–µ–ø | False |
| `repin_message_id` | ID —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ–∑–∞–∫—Ä–µ–ø–∞ | NULL |

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ–Ω—é
```
üì® –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
‚îú‚îÄ‚îÄ ü§ñ –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ ‚úÖ/‚ùå
‚îÇ   ‚îú‚îÄ‚îÄ üëë –ê–¥–º–∏–Ω—ã: ‚úÖ/‚ùå
‚îÇ   ‚îî‚îÄ‚îÄ üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: ‚úÖ/‚ùå
‚îú‚îÄ‚îÄ üó®Ô∏è –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è ‚úÖ/‚ùå
‚îÇ   ‚îú‚îÄ‚îÄ ‚û°Ô∏è –í—Ö–æ–¥ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ‚úÖ/‚ùå
‚îÇ   ‚îú‚îÄ‚îÄ ‚¨ÖÔ∏è –í—ã—Ö–æ–¥ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ‚úÖ/‚ùå
‚îÇ   ‚îú‚îÄ‚îÄ üìå –ó–∞–∫—Ä–µ–ø —Å–æ–æ–±—â–µ–Ω–∏–π: ‚úÖ/‚ùå
‚îÇ   ‚îî‚îÄ‚îÄ üñºÔ∏è –§–æ—Ç–æ/–Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã: ‚úÖ/‚ùå
‚îú‚îÄ‚îÄ üìå –†–µ–ø–∏–Ω (–∞–≤—Ç–æ–∑–∞–∫—Ä–µ–ø) ‚úÖ/‚ùå
‚îÇ   ‚îú‚îÄ‚îÄ üîÑ –°—Ç–∞—Ç—É—Å: ‚úÖ/‚ùå
‚îÇ   ‚îî‚îÄ‚îÄ üìù –°–æ–æ–±—â–µ–Ω–∏–µ: ID –∏–ª–∏ "–Ω–µ –∑–∞–¥–∞–Ω–æ"
‚îî‚îÄ‚îÄ üîô –ù–∞–∑–∞–¥
```

### –†–µ–ø–∏–Ω (–∞–≤—Ç–æ–∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ó–∞—â–∏—Ç–∞ –∑–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–µ—Ä–µ–∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏—è –¥—Ä—É–≥–∏–º–∏.

**–ö–æ–º–∞–Ω–¥—ã:**
| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `/repin` | –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–∑–∞–∫—Ä–µ–ø–∞ (–æ—Ç–≤–µ—Ç–æ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ) |
| `/unrepin` | –û—Ç–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–∑–∞–∫—Ä–µ–ø |

**–õ–æ–≥–∏–∫–∞:**
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–∫—Ä–µ–ø–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
    ‚îÇ
    ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞: –æ—Ç —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞? ‚Üí –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å
    ‚îÇ
    ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞: repin_enabled = True?
    ‚îÇ
    ‚îî‚îÄ‚îÄ –ï—Å–ª–∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ –¥—Ä—É–≥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:
        ‚îî‚îÄ‚îÄ bot.pin_chat_message(repin_message_id)
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- –ó–∞–∫—Ä–µ–ø—ã –æ—Ç —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è
- –ö–æ–º–∞–Ω–¥—ã `/repin` –∏ `/unrepin` –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∞–º
- –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ —Ä–µ–ø–∏–Ω–∞ –±–µ–∑ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ

### Pipeline —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

```
–°–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ (group_message_coordinator.py)
    ‚îÇ
    ‚îú‚îÄ‚îÄ –®–ê–ì 0: MESSAGE MANAGEMENT - —Å–∏—Å—Ç–µ–º–Ω—ã–µ + —Ä–µ–ø–∏–Ω
    ‚îÇ   ‚îú‚îÄ‚îÄ is_system_message? ‚Üí process_system_message()
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ –£–¥–∞–ª–∏—Ç—å –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
    ‚îÇ   ‚îî‚îÄ‚îÄ pinned_message? ‚Üí process_pin_event()
    ‚îÇ       ‚îî‚îÄ‚îÄ –†–µ–ø–∏–Ω –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
    ‚îÇ
    ‚îú‚îÄ‚îÄ –®–ê–ì 0.5: MESSAGE MANAGEMENT - –∫–æ–º–∞–Ω–¥—ã
    ‚îÇ   ‚îú‚îÄ‚îÄ is_command_message? ‚Üí process_command_message()
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ is_admin? ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å delete_admin_commands
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ –Ω–µ –∞–¥–º–∏–Ω? ‚Üí –ø—Ä–æ–≤–µ—Ä–∏—Ç—å delete_user_commands
    ‚îÇ   ‚îî‚îÄ‚îÄ –£–¥–∞–ª–∏—Ç—å –µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ
    ‚îÇ
    ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞: –∞–≤—Ç–æ—Ä - –∞–¥–º–∏–Ω? ‚Üí –ø—Ä–æ–ø—É—Å–∫ CF/AS
    ‚îÇ
    ‚îú‚îÄ‚îÄ –®–ê–ì 1: Content Filter
    ‚îÇ
    ‚îî‚îÄ‚îÄ –®–ê–ì 2: Antispam
```

### Callback Data —Ñ–æ—Ä–º–∞—Ç
```
mm:m:{chat_id}          # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
mm:cmd:{chat_id}        # –ú–µ–Ω—é —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥
mm:sys:{chat_id}        # –ú–µ–Ω—é —Å–∏—Å—Ç–µ–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
mm:repin:{chat_id}      # –ú–µ–Ω—é —Ä–µ–ø–∏–Ω–∞
mm:t:adm:{chat_id}      # Toggle: —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –∞–¥–º–∏–Ω–æ–≤
mm:t:usr:{chat_id}      # Toggle: —É–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
mm:t:join:{chat_id}     # Toggle: —É–¥–∞–ª–µ–Ω–∏–µ –≤—Ö–æ–¥–∞
mm:t:leave:{chat_id}    # Toggle: —É–¥–∞–ª–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–∞
mm:t:pin:{chat_id}      # Toggle: —É–¥–∞–ª–µ–Ω–∏–µ –∑–∞–∫—Ä–µ–ø–∞
mm:t:photo:{chat_id}    # Toggle: —É–¥–∞–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ/–Ω–∞–∑–≤–∞–Ω–∏—è
mm:t:repin:{chat_id}    # Toggle: —Ä–µ–ø–∏–Ω –≤–∫–ª/–≤—ã–∫–ª
mm:noop                 # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ (–Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞—é—Ç)
```

---

## 5. Mute System / –°–∏—Å—Ç–µ–º–∞ –º—É—Ç–æ–≤

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Å–ø–æ—Å–æ–±–∞–º–∏.

### –í–∏–¥—ã –º—É—Ç–æ–≤

#### 5.1 –ú—É—Ç –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
**–§–∞–π–ª—ã:**
- `handlers/bot_moderation_handlers/new_member_requested_to_join_mute_handlers.py`
- `services/risk_gate.py`

**–õ–æ–≥–∏–∫–∞:**
```
–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ ‚Üí classify_join_event()
    ‚îÇ
    ‚îú‚îÄ‚îÄ INVITE ‚Üí prepare_invite_flow()
    ‚îÇ   ‚îî‚îÄ‚îÄ –ê–Ω—Ç–∏—Ñ–ª—É–¥ –ø—Ä–æ–≤–µ—Ä–∫–∞
    ‚îÇ
    ‚îî‚îÄ‚îÄ evaluate_admission()
        ‚îî‚îÄ‚îÄ risk_gate ‚Üí –æ—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞
            ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è (Pyrogram)
            ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞
            ‚îî‚îÄ‚îÄ –ë–∞–ª–ª —Ä–∏—Å–∫–∞ 0-100
                ‚îú‚îÄ‚îÄ < 50 ‚Üí –ø—Ä–æ–ø—É—Å–∫
                ‚îî‚îÄ‚îÄ >= 50 ‚Üí –º—É—Ç
```

#### 5.2 –ú—É—Ç –ø–æ —Ä–µ–∞–∫—Ü–∏–∏
**–§–∞–π–ª—ã:**
- `handlers/mute_by_reaction/mute_by_reaction_handler.py`
- `services/mute_by_reaction_service/logic.py`

**–õ–æ–≥–∏–∫–∞:**
```
–†–µ–∞–∫—Ü–∏—è üîá –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
    ‚îÇ
    ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞: —Ä–µ–∞–∫—Ç–æ—Ä ‚Äî –∞–¥–º–∏–Ω?
    ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞: –∞–≤—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –Ω–µ –∞–¥–º–∏–Ω?
    ‚îÇ
    ‚îî‚îÄ‚îÄ restrict_chat_member()
        ‚îî‚îÄ‚îÄ –ú—É—Ç –Ω–∞ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ –≤—Ä–µ–º—è
```

#### 5.3 –ê–≤—Ç–æ–º—É—Ç —Å–∫–∞–º–º–µ—Ä–æ–≤
**–§–∞–π–ª—ã:**
- `handlers/auto_mute_scammers_handlers.py`
- `services/auto_mute_scammers_logic.py`
- `services/enhanced_profile_analyzer.py` ‚Äî –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ñ–∏–ª—è (—Ñ–æ—Ç–æ + –≤–æ–∑—Ä–∞—Å—Ç)
- `services/spammer_registry.py`

**–õ–æ–≥–∏–∫–∞ (–æ–±–Ω–æ–≤–ª–µ–Ω–æ 2025-12-19):**
```
–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–∏ (auto_mute_scammer_on_join)
    ‚îÇ
    ‚îú‚îÄ‚îÄ –ü–†–ò–û–†–ò–¢–ï–¢ 1: –§–ª–∞–≥ –∞–≤—Ç–æ–º—É—Ç–∞ –∏–∑ Redis (captcha flow)
    ‚îÇ   ‚îî‚îÄ‚îÄ auto_mute_scammer:{user_id}:{chat_id} = "1" ‚Üí –ú–£–¢
    ‚îÇ
    ‚îú‚îÄ‚îÄ –ü–†–ò–û–†–ò–¢–ï–¢ 2: –£—Ä–æ–≤–µ–Ω—å —Å–∫–∞–º–∞ –≤ –ë–î (scammer_tracker)
    ‚îÇ   ‚îî‚îÄ‚îÄ scam_level >= 50 ‚Üí –ú–£–¢
    ‚îÇ
    ‚îî‚îÄ‚îÄ –ü–†–ò–û–†–ò–¢–ï–¢ 3: –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ñ–∏–ª—è (enhanced_profile_analyzer)
        ‚îú‚îÄ‚îÄ –ï–°–¢–¨ —Ñ–æ—Ç–æ ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ–º –¢–û–õ–¨–ö–û –≤–æ–∑—Ä–∞—Å—Ç —Ñ–æ—Ç–æ
        ‚îÇ   ‚îî‚îÄ‚îÄ –í–°–ï —Ñ–æ—Ç–æ < 15 –¥–Ω–µ–π ‚Üí –ú–£–¢ (is_suspicious=True)
        ‚îÇ
        ‚îî‚îÄ‚îÄ –ù–ï–¢ —Ñ–æ—Ç–æ ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑—Ä–∞—Å—Ç –∞–∫–∫–∞—É–Ω—Ç–∞
            ‚îî‚îÄ‚îÄ –ê–∫–∫–∞—É–Ω—Ç < 30 –¥–Ω–µ–π ‚Üí –ú–£–¢ (is_suspicious=True)
```

**–í–ê–ñ–ù–û:** –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç–∞ —Ñ–æ—Ç–æ –Ω–∞–¥ –≤–æ–∑—Ä–∞—Å—Ç–æ–º –∞–∫–∫–∞—É–Ω—Ç–∞!
–≠—Ç–æ –∏—Å–ø—Ä–∞–≤–ª—è–µ—Ç –±–∞–≥, –∫–æ–≥–¥–∞ —Å–∫–∞–º–º–µ—Ä —Å –∞–∫–∫–∞—É–Ω—Ç–æ–º 35 –¥–Ω–µ–π –∏ —Ñ–æ—Ç–æ 0 –¥–Ω–µ–π –ø—Ä–æ—Ö–æ–¥–∏–ª.

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º—É—Ç–æ–≤ (ChatSettings)
| –ù–∞—Å—Ç—Ä–æ–π–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|----------|
| `mute_new_members` | –ú—É—Ç–∏—Ç—å –Ω–æ–≤—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ |
| `auto_mute_scammers` | –ê–≤—Ç–æ–º—É—Ç —Å–∫–∞–º–º–µ—Ä–æ–≤ |
| `global_mute_enabled` | –ì–ª–æ–±–∞–ª—å–Ω—ã–π –º—É—Ç |
| `reaction_mute_enabled` | –ú—É—Ç –ø–æ —Ä–µ–∞–∫—Ü–∏–∏ |
| `reaction_mute_announce_enabled` | –ê–Ω–æ–Ω—Å –º—É—Ç–∞ |

#### 5.4 Restriction Service ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –º—É—Ç–æ–≤ –ø–æ—Å–ª–µ rejoin

**–§–∞–π–ª—ã:**
- `services/restriction_service.py` ‚Äî —Å–µ—Ä–≤–∏—Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:**
–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–º—É—á–µ–Ω –∏ –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ –≥—Ä—É–ø–ø—ã, –∞ –∑–∞—Ç–µ–º –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `approve_chat_join_request()` (–∫–∞–ø—á–∞ –∏–ª–∏ –∏–Ω–≤–∞–π—Ç), Telegram API –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–∏–º–∞–µ—Ç –≤—Å–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω—ã–µ –ø—Ä–∞–≤–∞, –æ–±—Ö–æ–¥—è –Ω–∞–∫–∞–∑–∞–Ω–∏–µ.

**–†–µ—à–µ–Ω–∏–µ:**
–°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –º—É—Ç—ã –∏ –±–∞–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—É `user_restrictions`. –ü–æ—Å–ª–µ –æ–¥–æ–±—Ä–µ–Ω–∏—è join request –ø—Ä–æ–≤–µ—Ä—è–µ–º –ë–î –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram API.

**–§—É–Ω–∫—Ü–∏–∏:**
| –§—É–Ω–∫—Ü–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `save_restriction()` | –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –º—É—Ç/–±–∞–Ω –≤ –ë–î (—Å–æ–∑–¥–∞—ë—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç) |
| `get_active_restriction()` | –ü–æ–ª—É—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ (–ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ä–æ–∫) |
| `deactivate_restriction()` | –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ (–ø—Ä–∏ —Ä–∞–∑–º—É—Ç–µ) |
| `restore_restriction()` | –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram API |
| `check_and_restore_restriction()` | –ö–æ–º–±–∏–Ω–∞—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è |

**Pipeline:**
```
1. –ê–Ω—Ç–∏—Å–ø–∞–º/ContentFilter/RiskGate –º—É—Ç–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
       ‚îÇ
       ‚îú‚îÄ‚îÄ bot.restrict_chat_member()  ‚Äî –º—É—Ç –≤ Telegram
       ‚îî‚îÄ‚îÄ save_restriction()          ‚Äî —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î

2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ –≥—Ä—É–ø–ø—ã
       ‚îÇ
       ‚îî‚îÄ‚îÄ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –æ—Å—Ç–∞—ë—Ç—Å—è –≤ –ë–î, is_active=True)

3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ö–æ–¥–∏—Ç —á–µ—Ä–µ–∑ –∫–∞–ø—á—É
       ‚îÇ
       ‚îú‚îÄ‚îÄ approve_chat_join_request() ‚Äî Telegram —Å–Ω–∏–º–∞–µ—Ç –º—É—Ç!
       ‚îÇ
       ‚îî‚îÄ‚îÄ check_and_restore_restriction()
           ‚îú‚îÄ‚îÄ get_active_restriction() ‚Äî –∏—â–µ–º –≤ –ë–î
           ‚îî‚îÄ‚îÄ restore_restriction()    ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º—É—Ç
```

**–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:**
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑:
- `handlers/antispam_handlers/antispam_filter_handler.py` ‚Äî –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º—É—Ç–∞
- `handlers/content_filter/filter_handler.py` ‚Äî –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º—É—Ç–∞/–±–∞–Ω–∞
- `services/auto_mute_scammers_logic.py` ‚Äî –ø—Ä–∏ –∞–≤—Ç–æ–º—É—Ç–µ —Å–∫–∞–º–º–µ—Ä–æ–≤

–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑:
- `services/visual_captcha_logic.py` ‚Äî –ø–æ—Å–ª–µ `approve_chat_join_request()`

---

## 6. Settings / –ù–∞—Å—Ç—Ä–æ–π–∫–∏

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –≥—Ä—É–ø–ø —á–µ—Ä–µ–∑ –õ–° –±–æ—Ç–∞.

### –§–∞–π–ª—ã
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `handlers/group_settings_handler/groups_settings_in_private_handler.py` | /settings –∫–æ–º–∞–Ω–¥–∞ |
| `services/groups_settings_in_private_logic.py` | –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ |
| `keyboards/group_settings_kb.py` | –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã |

### Flow

```
/settings –≤ –õ–°
    ‚îÇ
    ‚îú‚îÄ‚îÄ get_admin_groups() ‚Üí —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø
    ‚îÇ
    ‚îî‚îÄ‚îÄ –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø —Å –∫–Ω–æ–ø–∫–∞–º–∏

–í—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã
    ‚îÇ
    ‚îú‚îÄ‚îÄ check_granular_permissions() ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
    ‚îÇ
    ‚îî‚îÄ‚îÄ –ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫

–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    ‚îÇ
    ‚îú‚îÄ‚îÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤ –ë–î
    ‚îî‚îÄ‚îÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
```python
async def check_granular_permissions(bot, user_id, chat_id, permission, session):
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –ø—Ä–∞–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
    - can_delete_messages
    - can_restrict_members
    - can_change_info
    - –∏ —Ç.–¥.
    """
```

---

## 7. Journal / –ñ—É—Ä–Ω–∞–ª –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –≥—Ä—É–ø–ø—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–∞–Ω–∞–ª/–≥—Ä—É–ø–ø—É.

### –§–∞–π–ª—ã
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `handlers/journal_link_handler.py` | –ü—Ä–∏–≤—è–∑–∫–∞ –∂—É—Ä–Ω–∞–ª–∞ |
| `handlers/bot_activity_journal/bot_activity_journal.py` | –û—Ç–ø—Ä–∞–≤–∫–∞ –ª–æ–≥–æ–≤ |
| `services/bot_activity_journal/bot_activity_journal_logic.py` | –õ–æ–≥–∏–∫–∞ |
| `services/group_journal_service.py` | –†–∞–±–æ—Ç–∞ —Å –ë–î |

### –¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π
- –ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫
- –£—á–∞—Å—Ç–Ω–∏–∫ –≤—ã—à–µ–ª/–∫–∏–∫–Ω—É—Ç
- –ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –∫–∞–ø—á–∏
- –¢–∞–π–º–∞—É—Ç –∫–∞–ø—á–∏
- –°—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ –∞–Ω—Ç–∏—Å–ø–∞–º
- –ú—É—Ç/—Ä–∞–∑–º—É—Ç

### –ü—Ä–∏–≤—è–∑–∫–∞ –∂—É—Ä–Ω–∞–ª–∞
```
/linkjournal ‚Üí –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
    ‚îÇ
–ü–µ—Ä–µ—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–∑ –∫–∞–Ω–∞–ª–∞ –∂—É—Ä–Ω–∞–ª–∞
    ‚îÇ
    ‚îú‚îÄ‚îÄ IsAdminWithChangeInfoFilter ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤
    ‚îú‚îÄ‚îÄ link_journal_channel() ‚Üí —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
    ‚îî‚îÄ‚îÄ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
```

---

## 8. Broadcast / –†–∞—Å—Å—ã–ª–∫–∏

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ú–∞—Å—Å–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.

### –§–∞–π–ª—ã
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `handlers/broadcast_handlers/broadcast_handlers.py` | –ö–æ–º–∞–Ω–¥—ã —Ä–∞—Å—Å—ã–ª–∫–∏ |
| `services/broadcast_logic.py` | –õ–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ |

### Flow
```
/broadcast
    ‚îÇ
    ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞: —ç—Ç–æ –≤–ª–∞–¥–µ–ª–µ—Ü –±–æ—Ç–∞?
    ‚îú‚îÄ‚îÄ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    ‚îÇ
    ‚îî‚îÄ‚îÄ –¶–∏–∫–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        ‚îú‚îÄ‚îÄ –£—Å–ø–µ—Ö ‚Üí —Å—á—ë—Ç—á–∏–∫++
        ‚îî‚îÄ‚îÄ –û—à–∏–±–∫–∞ ‚Üí –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
```

---

## 9. Risk Assessment / –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

### –§–∞–π–ª—ã
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `services/risk_gate.py` | –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ (–¥–ª—è –∫–∞–ø—á–∏) |
| `services/enhanced_profile_analyzer.py` | –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ (–¥–ª—è –∞–≤—Ç–æ–º—É—Ç–∞) |
| `services/account_age_estimator.py` | –û—Ü–µ–Ω–∫–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ –ø–æ user_id |
| `services/pyrogram_client.py` | MTProto –∫–ª–∏–µ–Ω—Ç (–¥–∞—Ç—ã —Ñ–æ—Ç–æ) |

### –õ–æ–≥–∏–∫–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ (–æ–±–Ω–æ–≤–ª–µ–Ω–æ 2025-12-19)

**enhanced_profile_analyzer.py** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ `auto_mute_scammer_on_join()`:

```
analyze_user_profile_enhanced()
    ‚îÇ
    ‚îú‚îÄ‚îÄ –ï–°–¢–¨ —Ñ–æ—Ç–æ?
    ‚îÇ   ‚îú‚îÄ‚îÄ –î–ê ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ–º –¢–û–õ–¨–ö–û –≤–æ–∑—Ä–∞—Å—Ç —Ñ–æ—Ç–æ (–ü–†–ò–û–†–ò–¢–ï–¢!)
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ –í–°–ï —Ñ–æ—Ç–æ < 15 –¥–Ω–µ–π ‚Üí is_suspicious=True, risk_score=100
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ –•–æ—Ç—è –±—ã –æ–¥–Ω–æ —Ñ–æ—Ç–æ >= 15 –¥–Ω–µ–π ‚Üí is_suspicious=False
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îî‚îÄ‚îÄ –í–æ–∑—Ä–∞—Å—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ –ù–ï —É—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ!
    ‚îÇ
    ‚îî‚îÄ‚îÄ –ù–ï–¢ —Ñ–æ—Ç–æ?
        ‚îî‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑—Ä–∞—Å—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ (–ó–ê–ü–ê–°–ù–û–ô)
            ‚îî‚îÄ‚îÄ –ê–∫–∫–∞—É–Ω—Ç < 30 –¥–Ω–µ–π ‚Üí is_suspicious=True, risk_score=100
```

### –§–∞–∫—Ç–æ—Ä—ã —Ä–∏—Å–∫–∞

| –§–∞–∫—Ç–æ—Ä | –£—Å–ª–æ–≤–∏–µ | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|--------|---------|-----------|
| –í–°–ï —Ñ–æ—Ç–æ < 15 –¥–Ω–µ–π | –ï—Å—Ç—å —Ñ–æ—Ç–æ | is_suspicious=True (100 –±–∞–ª–ª–æ–≤) |
| –ê–∫–∫–∞—É–Ω—Ç < 30 –¥–Ω–µ–π | –ù–µ—Ç —Ñ–æ—Ç–æ | is_suspicious=True (100 –±–∞–ª–ª–æ–≤) |
| –í —Ä–µ–µ—Å—Ç—Ä–µ —Å–ø–∞–º–º–µ—Ä–æ–≤ | scam_level >= 50 | –ú—É—Ç (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2) |
| –§–ª–∞–≥ –∞–≤—Ç–æ–º—É—Ç–∞ –≤ Redis | auto_mute_scammer:{user_id} | –ú—É—Ç (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1) |

### –ü–æ—Ä–æ–≥
- `is_suspicious = False` ‚Üí –ø—Ä–æ–ø—É—Å–∫
- `is_suspicious = True` ‚Üí –º—É—Ç

### –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç –≤–æ–∑—Ä–∞—Å—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞

**–§–æ—Ä–º—É–ª–∞:**
```
age_days = (max_seen_id - user_id) / DAILY_GROWTH
```

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ |
|----------|----------|----------|
| `DAILY_GROWTH` | 2,500,000 | –ü—Ä–∏—Ä–æ—Å—Ç user_id –≤ –¥–µ–Ω—å |
| `max_seen_id` | Redis: `telegram:max_seen_user_id` | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–∑–≤–µ—Å—Ç–Ω—ã–π ID |
| Fallback | 8,600,000,000 | –ï—Å–ª–∏ Redis –ø—É—Å—Ç–æ–π |

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
1. –ü—Ä–∏ –∫–∞–∂–¥–æ–º join_request –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `update_max_seen_id()`
2. –ï—Å–ª–∏ –Ω–æ–≤—ã–π ID > —Ç–µ–∫—É—â–µ–≥–æ max ‚Üí –æ–±–Ω–æ–≤–ª—è–µ–º Redis
3. –ü—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç–∞: `(max - user_id) / 2.5M = –¥–Ω–∏`

**–ú–µ—Ç–æ–¥—ã –≤ `account_age_estimator.py`:**
- `get_dynamic_age_days(redis, user_id)` ‚Äî —Ä–∞—Å—á—ë—Ç –≤–æ–∑—Ä–∞—Å—Ç–∞
- `update_max_seen_id(redis, user_id)` ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ max
- `is_young_account_dynamic(redis, user_id, threshold)` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞

---

## 10. Profile Monitor / –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ—Ñ–∏–ª–µ–π

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ü–û–°–õ–ï –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è –≤ –≥—Ä—É–ø–ø—É:
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–º–µ–Ω–∏, username, —Ñ–æ—Ç–æ
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º—É—Ç –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –∂—É—Ä–Ω–∞–ª –≥—Ä—É–ø–ø—ã —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–µ–π—Å—Ç–≤–∏–π

### –§–∞–π–ª—ã
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `handlers/profile_monitor/__init__.py` | –ú–æ–¥—É–ª—å–Ω—ã–π —Ä–æ—É—Ç–µ—Ä |
| `handlers/profile_monitor/monitor_handler.py` | –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π (–≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–∞) |
| `handlers/profile_monitor/callbacks_handler.py` | –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π (–ú—É—Ç/–ë–∞–Ω/–ö–∏–∫/–í –≥—Ä—É–ø–ø—É/–û–ö) |
| `handlers/profile_monitor/settings_handler.py` | UI –Ω–∞—Å—Ç—Ä–æ–µ–∫ |
| `services/profile_monitor/profile_monitor_service.py` | –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ |
| `keyboards/profile_monitor_kb.py` | –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã |
| `database/models_profile_monitor.py` | –ú–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö |

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∞–≤—Ç–æ–º—É—Ç–∞

**–ö—Ä–∏—Ç–µ—Ä–∏–π 1: –°–º–µ–Ω–∞ –∏–º–µ–Ω–∏ + —Å–º–µ–Ω–∞ —Ñ–æ—Ç–æ**
```
–°–º–µ–Ω–∞ –∏–º–µ–Ω–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 24—á + —Å–º–µ–Ω–∞ —Ñ–æ—Ç–æ –≤ —Ç–µ—á–µ–Ω–∏–µ 24—á + —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω
    ‚Üí –ú—É—Ç –Ω–∞–≤—Å–µ–≥–¥–∞ + —É–¥–∞–ª–µ–Ω–∏–µ –í–°–ï–• —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π 2: –°–º–µ–Ω–∞ –∏–º–µ–Ω–∏ + –±—ã—Å—Ç—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è**
```
–°–º–µ–Ω–∞ –∏–º–µ–Ω–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 24—á + —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã
    ‚Üí –ú—É—Ç –Ω–∞–≤—Å–µ–≥–¥–∞ + —É–¥–∞–ª–µ–Ω–∏–µ –í–°–ï–• —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

**–ö—Ä–∏—Ç–µ—Ä–∏–π 3: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ + –±—ã—Å—Ç—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è**
```
–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ç–æ (–Ω–µ –±—ã–ª–æ ‚Üí —Å—Ç–∞–ª–æ) + —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    ‚Üí –ú—É—Ç –Ω–∞–≤—Å–µ–≥–¥–∞ + —É–¥–∞–ª–µ–Ω–∏–µ –í–°–ï–• —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```
–†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ë–ï–ó —Ñ–æ—Ç–æ –ø—Ä–∏ –≤—Ö–æ–¥–µ.

**–ö—Ä–∏—Ç–µ—Ä–∏–π 4: –°–≤–µ–∂–µ–µ —Ñ–æ—Ç–æ + —Å–º–µ–Ω–∞ –∏–º–µ–Ω–∏ + –±—ã—Å—Ç—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–ù–û–í–´–ô 2025-12-21)**
```
–°–≤–µ–∂–µ–µ —Ñ–æ—Ç–æ (<N –¥–Ω–µ–π) + —Å–º–µ–Ω–∞ –∏–º–µ–Ω–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 24—á + —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω
    ‚Üí –ú—É—Ç –Ω–∞–≤—Å–µ–≥–¥–∞ + —É–¥–∞–ª–µ–Ω–∏–µ –í–°–ï–• —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```
–ü–æ—Ä–æ–≥ —Å–≤–µ–∂–µ—Å—Ç–∏ —Ñ–æ—Ç–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è: 1 –¥–µ–Ω—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é), 3, 7 –∏–ª–∏ 14 –¥–Ω–µ–π.

**–ö—Ä–∏—Ç–µ—Ä–∏–π 5: –°–≤–µ–∂–µ–µ —Ñ–æ—Ç–æ + –±—ã—Å—Ç—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–ù–û–í–´–ô 2025-12-21)**
```
–°–≤–µ–∂–µ–µ —Ñ–æ—Ç–æ (<N –¥–Ω–µ–π) + —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –º–∏–Ω –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞
    ‚Üí –ú—É—Ç –Ω–∞–≤—Å–µ–≥–¥–∞ + —É–¥–∞–ª–µ–Ω–∏–µ –í–°–ï–• —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```
–°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –µ—Å–ª–∏ –í–°–ï —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è —Å–≤–µ–∂–µ–µ –ø–æ—Ä–æ–≥–∞.

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å–≤–µ–∂–µ—Å—Ç—å —Ñ–æ—Ç–æ (–∫—Ä–∏—Ç–µ—Ä–∏–∏ 4,5). –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ ‚Üí –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –≤–æ–∑—Ä–∞—Å—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ (–∫—Ä–∏—Ç–µ—Ä–∏–π 3).

–í—Å–µ –∫—Ä–∏—Ç–µ—Ä–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ. –ö—Ä–∏—Ç–µ—Ä–∏–π 1 —Å–∞–º—ã–π —Å—Ç—Ä–æ–≥–∏–π (–∏–º—è + —Ñ–æ—Ç–æ), –∫—Ä–∏—Ç–µ—Ä–∏–∏ 4,5 ‚Äî –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —Å–ø–∞–º–º–µ—Ä–æ–≤ —Å–æ —Å–≤–µ–∂–∏–º–∏ —Ñ–æ—Ç–æ.

### –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

**–í –∂—É—Ä–Ω–∞–ª (–¥–ª—è –∞–¥–º–∏–Ω–æ–≤):** –ü–æ–¥—Ä–æ–±–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å –∫–Ω–æ–ø–∫–∞–º–∏ –¥–µ–π—Å—Ç–≤–∏–π (–ú—É—Ç/–ë–∞–Ω/–ö–∏–∫/–í –≥—Ä—É–ø–ø—É/–û–ö).

**–í –≥—Ä—É–ø–ø—É (–¥–ª—è –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤):** –ü—Ä–æ—Å—Ç—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ —Å–º–µ–Ω–µ –∏–º–µ–Ω–∏:
```
üìù –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–µ–Ω–∏–ª –∏–º—è

–ë—ã–ª–æ: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤
–°—Ç–∞–ª–æ: John Doe

üìã –ò—Å—Ç–æ—Ä–∏—è –∏–º—ë–Ω:
‚Ä¢ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤ (01.01.2025)
‚Ä¢ John Doe (13.12.2025)
```
–û–ø—Ü–∏—è –≤–∫–ª—é—á–∞–µ—Ç—Å—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–∫–ª—é—á–µ–Ω–∞).

### –°–æ–∑–¥–∞–Ω–∏–µ —Å–Ω–∞–ø—à–æ—Ç–∞ –ø—Ä–æ—Ñ–∏–ª—è

**–û—Å–Ω–æ–≤–Ω–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π (–æ–±–Ω–æ–≤–ª–µ–Ω–æ 2025-12-18):**
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å—Ç—É–ø–∞–µ—Ç –≤ –≥—Ä—É–ø–ø—É (chat_member_updated)
    ‚îÇ
    ‚îî‚îÄ‚îÄ new_member_requested_to_join_mute_handlers.py: MANUAL_MUTE_HANDLER()
        ‚îÇ
        ‚îú‚îÄ‚îÄ –î–µ—Ç–µ–∫—Ç: LEFT/KICKED ‚Üí MEMBER
        ‚îÇ
        ‚îî‚îÄ‚îÄ create_snapshot_on_join()
            ‚îú‚îÄ‚îÄ –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è (Pyrogram)
            ‚îú‚îÄ‚îÄ has_photo, account_age_days
            ‚îî‚îÄ‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–Ω–∞–ø—à–æ—Ç–∞ —Å joined_at = NOW
                (–ü—Ä–∏ rejoin ‚Äî –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ joined_at –Ω–∞ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è)
```

**FALLBACK —Å—Ü–µ–Ω–∞—Ä–∏–π:**
–ï—Å–ª–∏ —Å–Ω–∞–ø—à–æ—Ç –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω –ø—Ä–∏ –≤—Ö–æ–¥–µ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å—Ç—É–ø–∏–ª –¥–æ –≤–∫–ª—é—á–µ–Ω–∏—è –º–æ–¥—É–ª—è),
—Å–Ω–∞–ø—à–æ—Ç —Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –≤ `monitor_handler.py`.

### Pipeline –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

```
–°–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ (—á–µ—Ä–µ–∑ group_message_coordinator)
    ‚îÇ
    ‚îú‚îÄ‚îÄ –®–ê–ì 3: PROFILE MONITOR
    ‚îÇ
    ‚îú‚îÄ‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –º–æ–¥—É–ª—è
    ‚îÇ   ‚îî‚îÄ‚îÄ enabled = False? ‚Üí –≤—ã—Ö–æ–¥
    ‚îÇ
    ‚îú‚îÄ‚îÄ –°–Ω–∞–ø—à–æ—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?
    ‚îÇ   ‚îî‚îÄ‚îÄ –ù–ï–¢ ‚Üí _handle_first_message() [FALLBACK]
    ‚îÇ       ‚îú‚îÄ‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ —Å–Ω–∞–ø—à–æ—Ç–∞ (joined_at = now)
    ‚îÇ       ‚îî‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–º—É—Ç–∞
    ‚îÇ
    ‚îî‚îÄ‚îÄ –°–Ω–∞–ø—à–æ—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?
        ‚îî‚îÄ‚îÄ –î–ê ‚Üí check_profile_changes()
            ‚îú‚îÄ‚îÄ –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ñ–∏–ª—è
            ‚îú‚îÄ‚îÄ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–æ —Å–Ω–∞–ø—à–æ—Ç–æ–º
            ‚îÇ
            ‚îú‚îÄ‚îÄ –ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞–π–¥–µ–Ω—ã?
            ‚îÇ   ‚îú‚îÄ‚îÄ –î–ê ‚Üí log_profile_change()
            ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ profile_change_logs
            ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ send_journal_notification()
            ‚îÇ   ‚îÇ
            ‚îÇ   ‚îî‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ–º—É—Ç–∞
            ‚îÇ       ‚îú‚îÄ‚îÄ –°–º–µ–Ω–∞ –∏–º–µ–Ω–∏ < 24—á?
            ‚îÇ       ‚îú‚îÄ‚îÄ –°–º–µ–Ω–∞ —Ñ–æ—Ç–æ < 24—á? (–∫—Ä–∏—Ç–µ—Ä–∏–π 1)
            ‚îÇ       ‚îî‚îÄ‚îÄ –°–æ–æ–±—â–µ–Ω–∏–µ < 20 –º–∏–Ω –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã?
            ‚îÇ           ‚Üí apply_auto_mute()
            ‚îÇ
            ‚îî‚îÄ‚îÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–Ω–∞–ø—à–æ—Ç–∞
```

### –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –∂—É—Ä–Ω–∞–ª

**–ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
```
üìä –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è

üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @username (123456789)
üìù –¢–∏–ø: –°–º–µ–Ω–∞ –∏–º–µ–Ω–∏
üìÖ –í—Ä–µ–º—è: 2025-01-01 12:30:45

–ë—ã–ª–æ: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤
–°—Ç–∞–ª–æ: John Doe

[üîá –ú—É—Ç] [üö´ –ë–∞–Ω] [üë¢ –ö–∏–∫]
[üì¢ –í –≥—Ä—É–ø–ø—É] [‚úÖ –û–ö]
```

**–ü–æ—Å–ª–µ –∞–≤—Ç–æ–º—É—Ç–∞:**
```
üîí –ê–≤—Ç–æ–º—É—Ç: —Å–º–µ–Ω–∞ –∏–º–µ–Ω–∏

üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: @username (123456789)
üìù –ü—Ä–∏—á–∏–Ω–∞: –°–º–µ–Ω–∞ –∏–º–µ–Ω–∏ + —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ç–µ—á–µ–Ω–∏–µ 20 –º–∏–Ω
üìÖ –í—Ä–µ–º—è: 2025-01-01 12:30:45
üóëÔ∏è –£–¥–∞–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: 5

[üîä –†–∞–∑–º—É—Ç] [üö´ –ë–∞–Ω]
[üì¢ –í –≥—Ä—É–ø–ø—É] [‚úÖ –û–ö]
```

### –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π

| –ö–Ω–æ–ø–∫–∞ | –î–µ–π—Å—Ç–≤–∏–µ |
|--------|----------|
| üîá –ú—É—Ç | –ú—É—Ç –Ω–∞–≤—Å–µ–≥–¥–∞ |
| üö´ –ë–∞–Ω | –ë–∞–Ω –Ω–∞–≤—Å–µ–≥–¥–∞ |
| üë¢ –ö–∏–∫ | –ò—Å–∫–ª—é—á–µ–Ω–∏–µ (–±–µ–∑ –±–∞–Ω–∞) |
| üîä –†–∞–∑–º—É—Ç | –°–Ω—è—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è |
| üì¢ –í –≥—Ä—É–ø–ø—É | –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –≥—Ä—É–ø–ø—É |
| ‚úÖ –û–ö | –ó–∞–∫—Ä—ã—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ |

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (ProfileMonitorSettings)

| –ù–∞—Å—Ç—Ä–æ–π–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | Default |
|-----------|----------|---------|
| `enabled` | –ú–æ–¥—É–ª—å –≤–∫–ª—é—á—ë–Ω | False |
| `log_name_changes` | –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–º–µ–Ω–∏ | True |
| `log_username_changes` | –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è username | True |
| `log_photo_changes` | –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–æ—Ç–æ | True |
| `send_to_journal` | –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –∂—É—Ä–Ω–∞–ª | True |
| `auto_mute_young_no_photo` | –ê–≤—Ç–æ–º—É—Ç: –º–æ–ª–æ–¥–æ–π –∞–∫–∫–∞—É–Ω—Ç –±–µ–∑ —Ñ–æ—Ç–æ | True |
| `auto_mute_name_change` | –ê–≤—Ç–æ–º—É—Ç: —Å–º–µ–Ω–∞ –∏–º–µ–Ω–∏ + –±—ã—Å—Ç—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è | True |
| `delete_messages_on_mute` | –£–¥–∞–ª—è—Ç—å –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –∞–≤—Ç–æ–º—É—Ç–µ | True |
| `account_age_threshold_days` | –ü–æ—Ä–æ–≥ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ (–¥–Ω–∏) | 15 |
| `photo_freshness_threshold_days` | –ü–æ—Ä–æ–≥ —Å–≤–µ–∂–µ—Å—Ç–∏ —Ñ–æ—Ç–æ (–¥–Ω–∏) –¥–ª—è –∫—Ä–∏—Ç–µ—Ä–∏–µ–≤ 4,5 | 1 |
| `name_change_window_hours` | –û–∫–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–º–µ–Ω—ã –∏–º–µ–Ω–∏ (—á–∞—Å—ã) | 24 |
| `first_message_window_minutes` | –û–∫–Ω–æ "–±—ã—Å—Ç—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π" (–º–∏–Ω—É—Ç—ã) | 30 |

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫

```
üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ—Ñ–∏–ª–µ–π
‚îú‚îÄ‚îÄ üü¢/üî¥ –í–∫–ª—é—á–∏—Ç—å/–í—ã–∫–ª—é—á–∏—Ç—å
‚îú‚îÄ‚îÄ üìù –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ ‚úÖ/‚ùå –ò–º–µ–Ω–∞
‚îÇ   ‚îú‚îÄ‚îÄ ‚úÖ/‚ùå Username
‚îÇ   ‚îú‚îÄ‚îÄ ‚úÖ/‚ùå –§–æ—Ç–æ
‚îÇ   ‚îî‚îÄ‚îÄ ‚úÖ/‚ùå –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –∂—É—Ä–Ω–∞–ª
‚îú‚îÄ‚îÄ ‚ö° –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º—É—Ç–∞
‚îÇ   ‚îú‚îÄ‚îÄ ‚úÖ/‚ùå –ú—É—Ç: –Ω–µ—Ç —Ñ–æ—Ç–æ + –º–æ–ª–æ–¥–æ–π –∞–∫–∫–∞—É–Ω—Ç
‚îÇ   ‚îú‚îÄ‚îÄ üìÖ –ü–æ—Ä–æ–≥ –∞–∫–∫–∞—É–Ω—Ç–∞: 15 –¥–Ω–µ–π (7/15/30/60/90)
‚îÇ   ‚îú‚îÄ‚îÄ üì∏ –ü–æ—Ä–æ–≥ —Ñ–æ—Ç–æ: 1 –¥–µ–Ω—å (1/3/7/14)
‚îÇ   ‚îú‚îÄ‚îÄ ‚úÖ/‚ùå –ú—É—Ç: —Å–º–µ–Ω–∞ –∏–º–µ–Ω–∏ + –±—ã—Å—Ç—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ ‚úÖ/‚ùå –£–¥–∞–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —Å–ø–∞–º–º–µ—Ä–æ–≤
‚îî‚îÄ‚îÄ ‚óÄÔ∏è –ù–∞–∑–∞–¥
```

### Callback Data —Ñ–æ—Ä–º–∞—Ç

```
pm_settings_main:{chat_id}           # –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫
pm_toggle:{on|off}:{chat_id}         # –í–∫–ª/–≤—ã–∫–ª –º–æ–¥—É–ª—è
pm_settings_log:{chat_id}            # –ú–µ–Ω—é –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
pm_settings_mute:{chat_id}           # –ú–µ–Ω—é –∞–≤—Ç–æ–º—É—Ç–∞
pm_log_name:{on|off}:{chat_id}       # Toggle: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–º—ë–Ω
pm_log_username:{on|off}:{chat_id}   # Toggle: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ username
pm_log_photo:{on|off}:{chat_id}      # Toggle: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–æ—Ç–æ
pm_send_journal:{on|off}:{chat_id}   # Toggle: –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ –∂—É—Ä–Ω–∞–ª
pm_mute_young:{on|off}:{chat_id}     # Toggle: –∞–≤—Ç–æ–º—É—Ç –º–æ–ª–æ–¥—ã—Ö
pm_mute_name:{on|off}:{chat_id}      # Toggle: –∞–≤—Ç–æ–º—É—Ç –ø—Ä–∏ —Å–º–µ–Ω–µ –∏–º–µ–Ω–∏
pm_delete_msgs:{on|off}:{chat_id}    # Toggle: —É–¥–∞–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π
pm_age_threshold:{chat_id}           # –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –ø–æ—Ä–æ–≥–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞
pm_set_age:{days}:{chat_id}          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ä–æ–≥–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞
pm_photo_fresh_threshold:{chat_id}   # –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –ø–æ—Ä–æ–≥–∞ —Å–≤–µ–∂–µ—Å—Ç–∏ —Ñ–æ—Ç–æ
pm_set_photo_fresh:{days}:{chat_id}  # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ—Ä–æ–≥–∞ —Å–≤–µ–∂–µ—Å—Ç–∏ —Ñ–æ—Ç–æ

# –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –≤ –∂—É—Ä–Ω–∞–ª–µ
pm_mute:{chat_id}:{user_id}:{log_id}       # –ú—É—Ç
pm_ban:{chat_id}:{user_id}:{log_id}        # –ë–∞–Ω
pm_kick:{chat_id}:{user_id}:{log_id}       # –ö–∏–∫
pm_unmute:{chat_id}:{user_id}:{log_id}     # –†–∞–∑–º—É—Ç
pm_send_group:{chat_id}:{user_id}:{log_id} # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É
pm_ok:{chat_id}:{user_id}:{log_id}         # –û–ö (–∑–∞–∫—Ä—ã—Ç—å)
```

### –ú–æ–¥–µ–ª–∏ –ë–î

```python
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥—É–ª—è –¥–ª—è –≥—Ä—É–ø–ø—ã
class ProfileMonitorSettings:
    chat_id: BigInteger (PK, FK ‚Üí groups)
    enabled: Boolean
    log_name_changes: Boolean
    log_username_changes: Boolean
    log_photo_changes: Boolean
    send_to_journal: Boolean
    auto_mute_young_no_photo: Boolean
    auto_mute_name_change: Boolean
    delete_messages_on_mute: Boolean
    account_age_threshold_days: Integer (default: 15)
    photo_freshness_threshold_days: Integer (default: 1)
    name_change_window_hours: Integer (default: 24)
    first_message_window_minutes: Integer (default: 30)

# –°–Ω–∞–ø—à–æ—Ç –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
class ProfileSnapshot:
    id: Integer (PK)
    chat_id: BigInteger (FK ‚Üí groups)
    user_id: BigInteger
    first_name: String
    last_name: String (nullable)
    username: String (nullable)
    has_photo: Boolean
    photo_file_id: String (nullable)
    first_message_at: DateTime
    created_at: DateTime
    updated_at: DateTime

# –õ–æ–≥ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ—Ñ–∏–ª—è
class ProfileChangeLog:
    id: Integer (PK)
    chat_id: BigInteger (FK ‚Üí groups)
    user_id: BigInteger
    change_type: String (name/username/photo)
    old_value: String (nullable)
    new_value: String (nullable)
    detected_at: DateTime
    auto_action_taken: String (nullable)
    manual_action_taken: String (nullable)
    manual_action_by: BigInteger (nullable)
    manual_action_at: DateTime (nullable)
    journal_message_sent: Boolean
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

**–í—ã–∑–æ–≤ –∏–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–∞:**
```python
# bot/handlers/group_message_coordinator.py
# –ü–æ—Å–ª–µ ContentFilter –∏ Antispam

# –®–ê–ì 3: PROFILE MONITOR
await _process_profile_monitor(message, session)
```

**–ö–Ω–æ–ø–∫–∞ –≤ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫:**
```python
# bot/handlers/group_settings_handler/groups_settings_in_private_handler.py
InlineKeyboardButton(
    text="üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ—Ñ–∏–ª–µ–π",
    callback_data=f"pm_settings_main:{chat_id}"
)
```

---

## 11. Group Auto Sync / –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø –∏ –∞–¥–º–∏–Ω–æ–≤ –≤ –ë–î.

### –§–∞–π–ª—ã
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `middleware/group_auto_sync_middleware.py` | Middleware |
| `services/group_auto_sync.py` | –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ |

### –õ–æ–≥–∏–∫–∞
```
–õ—é–±–æ–µ —Å–æ–±—ã—Ç–∏–µ –∏–∑ –≥—Ä—É–ø–ø—ã
    ‚îÇ
    ‚îú‚îÄ‚îÄ _is_recently_synced() ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫—ç—à–∞
    ‚îÇ   ‚îî‚îÄ‚îÄ –ï—Å–ª–∏ –≤ –∫—ç—à–µ ‚Üí –ø—Ä–æ–ø—É—Å–∫
    ‚îÇ
    ‚îú‚îÄ‚îÄ ensure_group_exists()
    ‚îÇ   ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä—É–ø–ø—ã –≤ –ë–î
    ‚îÇ   ‚îú‚îÄ‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ –µ—Å–ª–∏ –Ω–µ—Ç
    ‚îÇ   ‚îî‚îÄ‚îÄ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ title –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è
    ‚îÇ
    ‚îú‚îÄ‚îÄ sync_group_admins()
    ‚îÇ   ‚îú‚îÄ‚îÄ bot.get_chat_administrators()
    ‚îÇ   ‚îú‚îÄ‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ User –∑–∞–ø–∏—Å–µ–π
    ‚îÇ   ‚îî‚îÄ‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ UserGroup —Å–≤—è–∑–µ–π
    ‚îÇ
    ‚îî‚îÄ‚îÄ _mark_as_synced() ‚Üí Redis TTL 5 –º–∏–Ω
```

---

## 12. User Statistics / –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ö–æ–º–∞–Ω–¥–∞ `/stat` –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –≥—Ä—É–ø–ø–µ.
–î–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –∏ —Å–æ–∑–¥–∞—Ç–µ–ª—é –≥—Ä—É–ø–ø—ã.

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
```
/stat           ‚Äî –ø–æ —Ä–µ–ø–ª–∞—é –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
/stat 123456789 ‚Äî –ø–æ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```

### –í—ã–≤–æ–¥–∏–º–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
- –ü–µ—Ä–≤—ã–π –≤—Ö–æ–¥ –≤ –≥—Ä—É–ø–ø—É
- –í–æ–∑—Ä–∞—Å—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ Telegram
- Premium —Å—Ç–∞—Ç—É—Å
- –ù–∞–ª–∏—á–∏–µ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π
- –î–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- –ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞—Ä—É—à–µ–Ω–∏–π

### –§–∞–π–ª—ã
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `handlers/user_stats_handler.py` | –•–µ–Ω–¥–ª–µ—Ä –∫–æ–º–∞–Ω–¥—ã /stat |
| `services/user_stats_service.py` | –°–µ—Ä–≤–∏—Å –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ |
| `database/models_user_stats.py` | –ú–æ–¥–µ–ª—å UserStatistics |

### –õ–æ–≥–∏–∫–∞
```
/stat –≤ –≥—Ä—É–ø–ø–µ
    ‚îÇ
    ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∞
    ‚îÇ   ‚îî‚îÄ‚îÄ –ï—Å–ª–∏ –Ω–µ –∞–¥–º–∏–Ω ‚Üí –æ—Ç–∫–∞–∑
    ‚îÇ
    ‚îú‚îÄ‚îÄ –ü–æ–ª—É—á–µ–Ω–∏–µ user_id
    ‚îÇ   ‚îú‚îÄ‚îÄ –ò–∑ —Ä–µ–ø–ª–∞—è
    ‚îÇ   ‚îî‚îÄ‚îÄ –ò–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–∞ –∫–æ–º–∞–Ω–¥—ã
    ‚îÇ
    ‚îú‚îÄ‚îÄ –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö
    ‚îÇ   ‚îú‚îÄ‚îÄ profile_snapshots ‚Üí joined_at, account_age
    ‚îÇ   ‚îú‚îÄ‚îÄ user_statistics ‚Üí message_count, active_days
    ‚îÇ   ‚îî‚îÄ‚îÄ filter_violations ‚Üí COUNT –Ω–∞—Ä—É—à–µ–Ω–∏–π
    ‚îÇ
    ‚îú‚îÄ‚îÄ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –õ–° –∞–¥–º–∏–Ω—É
    ‚îÇ   ‚îî‚îÄ‚îÄ –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—Ç ‚Üí –∫–Ω–æ–ø–∫–∞ "–ù–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥"
    ‚îÇ
    ‚îî‚îÄ‚îÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø–µ (—É–¥–∞–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫)
```

### –¢–∞–±–ª–∏—Ü–∞ user_statistics
| –ö–æ–ª–æ–Ω–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| id | INTEGER PK | –ê–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç |
| chat_id | BIGINT | ID –≥—Ä—É–ø–ø—ã |
| user_id | BIGINT | ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è |
| message_count | INTEGER | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π |
| last_message_at | DATETIME | –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è |
| active_days | INTEGER | –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –¥–Ω–∏ —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏ |
| last_active_date | DATETIME | –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –¥–Ω—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ |

**–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á:** `(chat_id, user_id)`

### –ò–Ω–∫—Ä–µ–º–µ–Ω—Ç —Å—á—ë—Ç—á–∏–∫–æ–≤
–°—á—ë—Ç—á–∏–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ `group_message_coordinator.py` –ø—Ä–∏ –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏:
- `message_count += 1`
- `last_message_at = NOW()`
- `active_days += 1` –µ—Å–ª–∏ `last_active_date != today`

---

---

## 13. HTML Utils / –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è HTML

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML –¥–ª—è Telegram —Å–æ–æ–±—â–µ–Ω–∏–π.
–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫–∏ `TelegramBadRequest: Unsupported start tag`.

### –§–∞–π–ª—ã
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `bot/utils/html_utils.py` | –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML |
| `tests/unit/test_html_utils.py` | Unit-—Ç–µ—Å—Ç—ã (20 —Ç–µ—Å—Ç–æ–≤) |
| `tests/integration/test_telegram_html.py` | –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º Telegram API |

### –§—É–Ω–∫—Ü–∏–∏

| –§—É–Ω–∫—Ü–∏—è | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `validate_telegram_html(text)` | –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å HTML, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `(is_valid, errors)` |
| `escape_html(text)` | –≠–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç `<`, `>`, `&` –≤ `&lt;`, `&gt;`, `&amp;` |
| `safe_format_html(template, **kwargs)` | –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —à–∞–±–ª–æ–Ω —Å –∞–≤—Ç–æ-—ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∑–Ω–∞—á–µ–Ω–∏–π |
| `validate_and_log(text, context)` | –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∏ –ª–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫–∏ |

### –ü—Ä–æ–±–ª–µ–º–∞ –∏ —Ä–µ—à–µ–Ω–∏–µ

**–ü—Ä–æ–±–ª–µ–º–∞:** Telegram –ø–∞—Ä—Å–∏—Ç HTML –∏ –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É –Ω–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ç–µ–≥–∏.
```python
# –≠—Ç–æ –≤—ã–∑–æ–≤–µ—Ç TelegramBadRequest:
text = "–ü–æ—Ä–æ–≥: <5 –¥–Ω–µ–π"  # <5 –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ—Ç—Å—è –∫–∞–∫ —Ç–µ–≥
```

**–†–µ—à–µ–Ω–∏–µ:**
```python
from bot.utils.html_utils import escape_html, validate_telegram_html

# –í–∞—Ä–∏–∞–Ω—Ç 1: —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
text = f"–ü–æ—Ä–æ–≥: {escape_html('<5')} –¥–Ω–µ–π"  # "–ü–æ—Ä–æ–≥: &lt;5 –¥–Ω–µ–π"

# –í–∞—Ä–∏–∞–Ω—Ç 2: —Ä—É—á–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —à–∞–±–ª–æ–Ω–µ
text = f"–ü–æ—Ä–æ–≥: &lt;{threshold} –¥–Ω–µ–π"

# –í–∞—Ä–∏–∞–Ω—Ç 3: –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
is_valid, errors = validate_telegram_html(text)
if not is_valid:
    logger.error(f"HTML errors: {errors}")
```

### –†–∞–∑—Ä–µ—à—ë–Ω–Ω—ã–µ —Ç–µ–≥–∏ Telegram
```
<b>, <strong>     ‚Äî –∂–∏—Ä–Ω—ã–π
<i>, <em>         ‚Äî –∫—É—Ä—Å–∏–≤
<u>, <ins>        ‚Äî –ø–æ–¥—á—ë—Ä–∫–Ω—É—Ç—ã–π
<s>, <strike>, <del> ‚Äî –∑–∞—á—ë—Ä–∫–Ω—É—Ç—ã–π
<span>, <tg-spoiler> ‚Äî spoiler
<a href="">       ‚Äî —Å—Å—ã–ª–∫–∏
<code>, <pre>     ‚Äî –∫–æ–¥
<blockquote>      ‚Äî —Ü–∏—Ç–∞—Ç–∞
<tg-emoji>        ‚Äî –∫–∞—Å—Ç–æ–º–Ω—ã–µ —ç–º–æ–¥–∑–∏
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã

–¢–µ—Å—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ HTML:

```bash
# –ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
pytest tests/integration/test_telegram_html.py -v
```

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:**
- `.env.test` —Å `TEST_BOT_TOKEN` –∏ `TEST_CHAT_ID`
- –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–¥–º–∏–Ω–æ–º –≤ —Ç–µ—Å—Ç–æ–≤–æ–π –≥—Ä—É–ø–ø–µ

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:**
- –ë–∞–∑–æ–≤—ã–µ HTML —Ç–µ–≥–∏ —Ä–∞–±–æ—Ç–∞—é—Ç
- –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –ù–µ—ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π `<` —Å —Ü–∏—Ñ—Ä–æ–π –≤—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫—É
- –†–µ–∞–ª—å–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã –∏–∑ –±–æ—Ç–∞ (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–≤—Ç–æ–º—É—Ç–∞) —Ä–∞–±–æ—Ç–∞—é—Ç

---

## 14. Settings Export/Import / –≠–∫—Å–ø–æ—Ä—Ç –∏ –∏–º–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫

### –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≥—Ä—É–ø–ø—ã –≤ JSON —Ñ–∞–π–ª –∏ –∏–º–ø–æ—Ä—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ —Ñ–∞–π–ª–∞ –≤ –¥—Ä—É–≥—É—é –≥—Ä—É–ø–ø—É.
–ü–æ–∑–≤–æ–ª—è–µ—Ç –±—ã—Å—Ç—Ä–æ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –º–µ–∂–¥—É –≥—Ä—É–ø–ø–∞–º–∏.

### –î–æ—Å—Ç—É–ø
**–¢–æ–ª—å–∫–æ –¥–ª—è:**
- –í–ª–∞–¥–µ–ª—å—Ü–∞ –≥—Ä—É–ø–ø—ã (creator)
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å–æ –í–°–ï–ú–ò –ø—Ä–∞–≤–∞–º–∏

### –ö–æ–º–∞–Ω–¥—ã
| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `/export_settings` | –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä—É–ø–ø—ã –≤ JSON —Ñ–∞–π–ª |
| `/import_settings` | –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ JSON —Ñ–∞–π–ª–∞ |

### –§–∞–π–ª—ã

**–°–µ—Ä–≤–∏—Å—ã (services/settings_export/):**
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `services/settings_export/__init__.py` | –≠–∫—Å–ø–æ—Ä—Ç –º–æ–¥—É–ª—è |
| `services/settings_export/export_service.py` | –õ–æ–≥–∏–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞/–∏–º–ø–æ—Ä—Ç–∞, TABLE_REGISTRY |
| `services/settings_export/permissions.py` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ (owner / full admin) |

**–•–µ–Ω–¥–ª–µ—Ä—ã (handlers/settings_export/):**
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `handlers/settings_export/__init__.py` | –≠–∫—Å–ø–æ—Ä—Ç —Ä–æ—É—Ç–µ—Ä–∞ |
| `handlers/settings_export/export_handlers.py` | –ö–æ–º–∞–Ω–¥–∞ /export_settings, callbacks |
| `handlers/settings_export/import_handlers.py` | –ö–æ–º–∞–Ω–¥–∞ /import_settings, FSM |

**–ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã:**
| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|------|------------|
| `keyboards/settings_export_kb.py` | –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –≤—ã–±–æ—Ä–∞ –≥—Ä—É–ø–ø—ã, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è |

### –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã–µ —Ç–∞–±–ª–∏—Ü—ã (TABLE_REGISTRY)

| –¢–∞–±–ª–∏—Ü–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `chat_settings` | –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä—É–ø–ø—ã (–∫–∞–ø—á–∞, –º—É—Ç—ã, —Ñ–∏–ª—å—Ç—Ä—ã) |
| `captcha_settings` | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–ø—á–∏ |
| `content_filter_settings` | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ñ–∏–ª—å—Ç—Ä–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ |
| `profile_monitor_settings` | –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø—Ä–æ—Ñ–∏–ª–µ–π |
| `filter_words` | –ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ |
| `filter_whitelist` | –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ —Å–ª–æ–≤ |
| `scam_patterns` | –ü–∞—Ç—Ç–µ—Ä–Ω—ã —Å–∫–∞–º–∞ |
| `scam_signal_categories` | –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–∏–≥–Ω–∞–ª–æ–≤ —Å–∫–∞–º–∞ |
| `antispam_rules` | –ü—Ä–∞–≤–∏–ª–∞ –∞–Ω—Ç–∏—Å–ø–∞–º–∞ |
| `antispam_whitelist` | –ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫ –∞–Ω—Ç–∏—Å–ø–∞–º–∞ |

### –†–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç—å

–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã –≤ —ç–∫—Å–ø–æ—Ä—Ç:
```python
# services/settings_export/export_service.py
TABLE_REGISTRY.append(TableConfig(
    model=NewModel,
    key_name='new_model',
    chat_id_column='chat_id',
    is_settings=True,  # –∏–ª–∏ False –¥–ª—è data-—Ç–∞–±–ª–∏—Ü
))
```

### Pipeline —ç–∫—Å–ø–æ—Ä—Ç–∞

```
/export_settings
    ‚îÇ
    ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑–æ–≤–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ (ALLOWED_USER_IDS)
    ‚îÇ
    ‚îú‚îÄ‚îÄ get_admin_groups() ‚Üí —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    ‚îÇ
    ‚îú‚îÄ‚îÄ can_export_import_settings() ‚Üí —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≥—Ä—É–ø–ø
    ‚îÇ   ‚îî‚îÄ‚îÄ –¢–æ–ª—å–∫–æ owner –∏–ª–∏ full admin
    ‚îÇ
    ‚îú‚îÄ‚îÄ –í—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã ‚Üí callback export_select:{chat_id}
    ‚îÇ
    ‚îî‚îÄ‚îÄ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Üí callback export_confirm:{chat_id}
        ‚îÇ
        ‚îú‚îÄ‚îÄ export_group_settings(session, chat_id)
        ‚îÇ   ‚îú‚îÄ‚îÄ –ß—Ç–µ–Ω–∏–µ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü –∏–∑ TABLE_REGISTRY
        ‚îÇ   ‚îî‚îÄ‚îÄ –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤ —Å–ª–æ–≤–∞—Ä—å
        ‚îÇ
        ‚îú‚îÄ‚îÄ serialize_settings_to_json() ‚Üí JSON —Å—Ç—Ä–æ–∫–∞
        ‚îÇ
        ‚îî‚îÄ‚îÄ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ –≤ –õ–°
```

### Pipeline –∏–º–ø–æ—Ä—Ç–∞

```
/import_settings
    ‚îÇ
    ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
    ‚îÇ
    ‚îú‚îÄ‚îÄ –í—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã ‚Üí callback import_select:{chat_id}
    ‚îÇ
    ‚îú‚îÄ‚îÄ FSM: ImportSettingsStates.waiting_for_file
    ‚îÇ   ‚îî‚îÄ‚îÄ –û–∂–∏–¥–∞–Ω–∏–µ JSON —Ñ–∞–π–ª–∞
    ‚îÇ
    ‚îú‚îÄ‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
    ‚îÇ   ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ (.json)
    ‚îÇ   ‚îú‚îÄ‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ (< 1 –ú–ë)
    ‚îÇ   ‚îú‚îÄ‚îÄ deserialize_settings_from_json()
    ‚îÇ   ‚îî‚îÄ‚îÄ validate_import_data() ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
    ‚îÇ
    ‚îú‚îÄ‚îÄ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ‚Üí callback import_confirm:{chat_id}
    ‚îÇ
    ‚îî‚îÄ‚îÄ import_group_settings(session, chat_id, data, user_id)
        ‚îú‚îÄ‚îÄ –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∑–∞–ø–∏—Å–µ–π (–µ—Å–ª–∏ –Ω–µ merge)
        ‚îú‚îÄ‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π –∏–∑ JSON
        ‚îî‚îÄ‚îÄ Commit
```

### –§–æ—Ä–º–∞—Ç JSON —Ñ–∞–π–ª–∞

```json
{
  "export_version": "1.0",
  "exported_at": "2025-12-21T15:30:00",
  "source_chat_id": -1001234567890,
  "data": {
    "chat_settings": {
      "captcha_join_enabled": true,
      "captcha_timeout_seconds": 300,
      ...
    },
    "filter_words": [
      {"word": "—Å–ø–∞–º", "normalized": "—Å–ø–∞–º", "match_type": "word", "category": "simple"},
      ...
    ],
    "antispam_rules": [
      {"rule_type": "TELEGRAM_LINK", "action": "DELETE", "delete_message": true},
      ...
    ],
    ...
  }
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ (permissions.py)

**–¢—Ä–µ–±—É–µ–º—ã–µ –ø—Ä–∞–≤–∞ –¥–ª—è full admin:**
- `can_manage_chat`
- `can_delete_messages`
- `can_restrict_members`
- `can_promote_members`
- `can_change_info`
- `can_invite_users`

**–í—Å–µ –ø—Ä–∞–≤–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∫–ª—é—á–µ–Ω—ã!**

### Callback Data —Ñ–æ—Ä–º–∞—Ç

```
export_select:{chat_id}    # –í—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
export_confirm:{chat_id}   # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —ç–∫—Å–ø–æ—Ä—Ç–∞
export_cancel              # –û—Ç–º–µ–Ω–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞

import_select:{chat_id}    # –í—ã–±–æ—Ä –≥—Ä—É–ø–ø—ã –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
import_confirm:{chat_id}   # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–∞
import_cancel              # –û—Ç–º–µ–Ω–∞ –∏–º–ø–æ—Ä—Ç–∞
```

### FSM States

```python
class ImportSettingsStates(StatesGroup):
    waiting_for_file = State()  # –û–∂–∏–¥–∞–Ω–∏–µ JSON —Ñ–∞–π–ª–∞
```

---

*–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: 2025-12-21 (–¥–æ–±–∞–≤–ª–µ–Ω —Ä–∞–∑–¥–µ–ª Export/Import, –∫—Ä–∏—Ç–µ—Ä–∏–∏ –∞–≤—Ç–æ–º—É—Ç–∞ 4,5, HTML utils)*