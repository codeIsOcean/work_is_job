# ============================================================
# МОДЕЛИ БАЗЫ ДАННЫХ ДЛЯ МОДУЛЯ КРОСС-ГРУППОВОЙ ДЕТЕКЦИИ
# ============================================================
# Этот файл содержит SQLAlchemy модели для детекции скамеров
# которые действуют в нескольких группах бота одновременно.
#
# Критерии детекции (ВСЕ должны выполниться):
# 1. Вход в 2+ группы в настраиваемом интервале
# 2. Смена профиля (имя ИЛИ фото) в настраиваемом окне
# 3. Сообщения в 2+ группах в настраиваемом интервале
# ============================================================

# Импортируем Column для определения колонок таблицы
from sqlalchemy import Column
# Импортируем типы данных для колонок
from sqlalchemy import Integer, BigInteger, Boolean, DateTime, Text, String
# Импортируем Index для создания индексов (ускорение поиска)
from sqlalchemy import Index
# Импортируем JSON для хранения структурированных данных
from sqlalchemy.dialects.postgresql import JSONB
# Импортируем ENUM для типизированных значений
from sqlalchemy.dialects.postgresql import ENUM
# Импортируем enum из стандартной библиотеки для определения типов
import enum

# Импортируем базовый класс Base и функцию utcnow из основных моделей
# Base — базовый класс от которого наследуются все модели
# utcnow — функция возвращающая текущее UTC время
from bot.database.models import Base, utcnow


# ============================================================
# ENUM: ТИП ДЕЙСТВИЯ ПРИ ДЕТЕКЦИИ
# ============================================================
# Определяет какое действие применяется при обнаружении скамера
# ВАЖНО: Имена в нижнем регистре чтобы соответствовать PostgreSQL ENUM
class CrossGroupActionType(enum.Enum):
    # Удалить сообщения во всех группах
    delete = "delete"
    # Замутить во всех группах
    mute = "mute"
    # Забанить во всех группах
    ban = "ban"
    # Кикнуть из всех групп
    kick = "kick"


# ============================================================
# ENUM: ТИП ИЗМЕНЕНИЯ ПРОФИЛЯ
# ============================================================
# Определяет что именно изменилось в профиле пользователя
# ВАЖНО: Имена в нижнем регистре чтобы соответствовать PostgreSQL ENUM
class ProfileChangeType(enum.Enum):
    # Изменилось имя (first_name или last_name)
    name = "name"
    # Изменилось фото профиля
    photo = "photo"
    # Изменилось и имя, и фото
    both = "both"


# ============================================================
# МОДЕЛЬ: ГЛОБАЛЬНЫЕ НАСТРОЙКИ КРОСС-ГРУППОВОЙ ДЕТЕКЦИИ
# ============================================================
# Singleton таблица — одна запись для всего бота
# Хранит все настройки модуля детекции
class CrossGroupScammerSettings(Base):
    # Имя таблицы в базе данных PostgreSQL
    __tablename__ = 'cross_group_scammer_settings'

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY: Фиксированный ID (singleton — всегда 1)
    # ─────────────────────────────────────────────────────────
    # Используем id=1 как единственную запись
    id = Column(Integer, primary_key=True, default=1)

    # ─────────────────────────────────────────────────────────
    # ГЛОБАЛЬНЫЙ ПЕРЕКЛЮЧАТЕЛЬ МОДУЛЯ
    # ─────────────────────────────────────────────────────────
    # True = модуль включён, False = выключен
    # По умолчанию выключен — админ должен явно включить
    enabled = Column(Boolean, default=False, nullable=False)

    # ─────────────────────────────────────────────────────────
    # КРИТЕРИЙ 1: ИНТЕРВАЛ ВХОДОВ В ГРУППЫ
    # ─────────────────────────────────────────────────────────
    # Временное окно для трекинга входов (в секундах)
    # По умолчанию 24 часа (86400 секунд)
    # Если пользователь вошёл в 2+ группы за это время → подозрительно
    join_interval_seconds = Column(Integer, default=86400, nullable=False)

    # ─────────────────────────────────────────────────────────
    # КРИТЕРИЙ 2: ОКНО СМЕНЫ ПРОФИЛЯ
    # ─────────────────────────────────────────────────────────
    # Временное окно для трекинга смены профиля (в секундах)
    # По умолчанию 12 часов (43200 секунд)
    # Если профиль сменился в течение этого времени после входа → подозрительно
    profile_change_window_seconds = Column(Integer, default=43200, nullable=False)

    # ─────────────────────────────────────────────────────────
    # КРИТЕРИЙ 3: ИНТЕРВАЛ СООБЩЕНИЙ
    # ─────────────────────────────────────────────────────────
    # Временное окно для трекинга сообщений (в секундах)
    # По умолчанию 1 час (3600 секунд)
    # Если сообщения в 2+ группах за это время → детекция срабатывает
    message_interval_seconds = Column(Integer, default=3600, nullable=False)

    # ─────────────────────────────────────────────────────────
    # МИНИМАЛЬНОЕ КОЛИЧЕСТВО ГРУПП
    # ─────────────────────────────────────────────────────────
    # Сколько групп должно быть затронуто для срабатывания
    # По умолчанию 2 — минимум для кросс-групповой детекции
    min_groups = Column(Integer, default=2, nullable=False)

    # ─────────────────────────────────────────────────────────
    # НАСТРОЙКИ ДЕЙСТВИЙ ПРИ ДЕТЕКЦИИ
    # ─────────────────────────────────────────────────────────
    # Тип действия при обнаружении кросс-группового скамера
    # По умолчанию мут навсегда
    action_type = Column(
        ENUM(CrossGroupActionType, name='cross_group_action_type', create_type=False),
        default=CrossGroupActionType.mute,
        nullable=False
    )

    # Длительность мута в минутах (0 = навсегда)
    # Используется только если action_type = MUTE
    mute_duration_minutes = Column(Integer, default=0, nullable=False)

    # Задержка перед удалением сообщений (в секундах)
    # 0 = удалять сразу
    delete_delay_seconds = Column(Integer, default=0, nullable=False)

    # Задержка перед применением мута (в секундах)
    # 0 = мутить сразу
    mute_delay_seconds = Column(Integer, default=0, nullable=False)

    # Задержка перед отправкой уведомления (в секундах)
    # 0 = отправлять сразу
    notification_delay_seconds = Column(Integer, default=0, nullable=False)

    # ─────────────────────────────────────────────────────────
    # НАСТРОЙКИ УВЕДОМЛЕНИЙ
    # ─────────────────────────────────────────────────────────
    # Текст уведомления о действии (опционально)
    # Если NULL — используется стандартный текст
    notification_text = Column(Text, nullable=True)

    # Отправлять ли уведомления в журнал группы
    send_to_journal = Column(Boolean, default=True, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ИСКЛЮЧЁННЫЕ ГРУППЫ (БЕЛЫЙ СПИСОК)
    # ─────────────────────────────────────────────────────────
    # Список chat_id групп которые исключены из детекции
    # Формат: [chat_id1, chat_id2, ...]
    excluded_groups = Column(JSONB, default=list, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ВРЕМЕННЫЕ МЕТКИ
    # ─────────────────────────────────────────────────────────
    # Когда настройки были созданы
    created_at = Column(DateTime, default=utcnow, nullable=False)

    # Когда настройки были последний раз обновлены
    # onupdate=utcnow автоматически обновляет при изменении записи
    updated_at = Column(DateTime, default=utcnow, onupdate=utcnow, nullable=False)


# ============================================================
# МОДЕЛЬ: АКТИВНОСТЬ ПОЛЬЗОВАТЕЛЯ В ГРУППАХ
# ============================================================
# Отслеживает кросс-групповую активность каждого пользователя
# Одна запись на пользователя — хранит данные обо всех группах
class CrossGroupUserActivity(Base):
    # Имя таблицы в базе данных
    __tablename__ = 'cross_group_user_activity'

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY: ID пользователя
    # ─────────────────────────────────────────────────────────
    # Каждый пользователь имеет одну запись в таблице
    # BigInteger для поддержки больших Telegram ID
    user_id = Column(BigInteger, primary_key=True)

    # ─────────────────────────────────────────────────────────
    # ТРЕКИНГ ВХОДОВ В ГРУППЫ
    # ─────────────────────────────────────────────────────────
    # JSON объект с информацией о входах в группы
    # Формат: {
    #   "chat_id": {
    #     "joined_at": "2026-01-17T12:00:00",
    #     "group_title": "Название группы"
    #   },
    #   ...
    # }
    groups_joined = Column(JSONB, default=dict, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ТРЕКИНГ СМЕНЫ ПРОФИЛЯ
    # ─────────────────────────────────────────────────────────
    # Когда профиль был изменён (NULL если не менялся)
    profile_changed_at = Column(DateTime, nullable=True)

    # Тип изменения профиля (имя, фото, оба)
    profile_change_type = Column(
        ENUM(ProfileChangeType, name='profile_change_type', create_type=False),
        nullable=True
    )

    # Оригинальное имя до изменения
    original_name = Column(String(512), nullable=True)

    # Оригинальный ID фото до изменения
    original_photo_id = Column(String(256), nullable=True)

    # ─────────────────────────────────────────────────────────
    # ТРЕКИНГ СООБЩЕНИЙ
    # ─────────────────────────────────────────────────────────
    # JSON объект с информацией о сообщениях в группах
    # Формат: {
    #   "chat_id": {
    #     "last_message_at": "2026-01-17T12:30:00",
    #     "message_count": 5
    #   },
    #   ...
    # }
    messages_in_groups = Column(JSONB, default=dict, nullable=False)

    # ─────────────────────────────────────────────────────────
    # СТАТУС ДЕТЕКЦИИ
    # ─────────────────────────────────────────────────────────
    # Помечен ли пользователь как подозрительный
    is_flagged = Column(Boolean, default=False, nullable=False)

    # Когда пользователь был помечен как подозрительный
    flagged_at = Column(DateTime, nullable=True)

    # Было ли применено действие
    action_taken = Column(Boolean, default=False, nullable=False)

    # В каких группах было применено действие
    # Формат: [chat_id1, chat_id2, ...]
    actioned_groups = Column(JSONB, default=list, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ВРЕМЕННЫЕ МЕТКИ
    # ─────────────────────────────────────────────────────────
    # Когда запись была создана
    created_at = Column(DateTime, default=utcnow, nullable=False)

    # Когда запись была последний раз обновлена
    updated_at = Column(DateTime, default=utcnow, onupdate=utcnow, nullable=False)


# ============================================================
# МОДЕЛЬ: ЛОГ ДЕТЕКЦИЙ
# ============================================================
# Записывает каждый случай детекции кросс-группового скамера
# Используется для истории и журнала активности
class CrossGroupDetectionLog(Base):
    # Имя таблицы в базе данных
    __tablename__ = 'cross_group_detection_logs'

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY: Автоинкрементный ID
    # ─────────────────────────────────────────────────────────
    id = Column(Integer, primary_key=True, autoincrement=True)

    # ─────────────────────────────────────────────────────────
    # ИДЕНТИФИКАТОР ПОЛЬЗОВАТЕЛЯ
    # ─────────────────────────────────────────────────────────
    # ID пользователя который был обнаружен как кросс-групповой скамер
    user_id = Column(BigInteger, nullable=False, index=True)

    # ─────────────────────────────────────────────────────────
    # ВРЕМЯ ДЕТЕКЦИИ
    # ─────────────────────────────────────────────────────────
    # Когда была произведена детекция
    detected_at = Column(DateTime, default=utcnow, nullable=False, index=True)

    # ─────────────────────────────────────────────────────────
    # ИНФОРМАЦИЯ О ГРУППАХ
    # ─────────────────────────────────────────────────────────
    # JSON объект с информацией о затронутых группах
    # Формат: {
    #   "chat_id": {
    #     "group_title": "Название",
    #     "joined_at": "2026-01-17T12:00:00",
    #     "message_at": "2026-01-17T12:30:00"
    #   },
    #   ...
    # }
    groups_involved = Column(JSONB, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ИНФОРМАЦИЯ ОБ ИЗМЕНЕНИЯХ ПРОФИЛЯ
    # ─────────────────────────────────────────────────────────
    # JSON объект с информацией об изменениях профиля
    # Формат: {
    #   "change_type": "name",
    #   "old_value": "Старое имя",
    #   "new_value": "Новое имя",
    #   "changed_at": "2026-01-17T12:15:00"
    # }
    profile_changes = Column(JSONB, nullable=True)

    # ─────────────────────────────────────────────────────────
    # ПРИМЕНЕННОЕ ДЕЙСТВИЕ
    # ─────────────────────────────────────────────────────────
    # Какое действие было применено при детекции
    action_type = Column(
        ENUM(CrossGroupActionType, name='cross_group_action_type', create_type=False),
        nullable=False
    )

    # ─────────────────────────────────────────────────────────
    # СООБЩЕНИЯ В ЖУРНАЛЕ
    # ─────────────────────────────────────────────────────────
    # ID сообщений которые были отправлены в журналы групп
    # Формат: {"chat_id": message_id, ...}
    journal_message_ids = Column(JSONB, default=dict, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ДОПОЛНИТЕЛЬНЫЕ ДАННЫЕ
    # ─────────────────────────────────────────────────────────
    # Имя пользователя на момент детекции (для истории)
    user_name = Column(String(512), nullable=True)

    # Username (@username) на момент детекции
    username = Column(String(256), nullable=True)

    # ─────────────────────────────────────────────────────────
    # ИНДЕКСЫ
    # ─────────────────────────────────────────────────────────
    __table_args__ = (
        # Индекс для поиска детекций пользователя
        Index('ix_cross_group_detection_user', 'user_id'),
        # Индекс для поиска детекций по дате
        Index('ix_cross_group_detection_date', 'detected_at'),
    )