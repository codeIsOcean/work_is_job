# ============================================================
# МОДЕЛИ БАЗЫ ДАННЫХ ДЛЯ МОДУЛЯ CONTENT FILTER
# ============================================================
# Этот файл содержит все SQLAlchemy модели для фильтрации контента:
# - ContentFilterSettings: настройки модуля для каждой группы
# - FilterWord: запрещённые слова/фразы
# - FilterWhitelist: исключения (слова которые НЕ фильтровать)
# - FilterViolation: логи всех срабатываний фильтра
# - ScamPattern: кастомные паттерны для детектора скама
# ============================================================

# Импортируем Column для определения колонок таблицы
from sqlalchemy import Column
# Импортируем типы данных для колонок
from sqlalchemy import Integer, String, BigInteger, Boolean, DateTime, Text
# Импортируем ForeignKey для связей между таблицами
from sqlalchemy import ForeignKey
# Импортируем Index для создания индексов (ускорение поиска)
from sqlalchemy import Index
# Импортируем UniqueConstraint для уникальных ограничений
from sqlalchemy import UniqueConstraint
# Импортируем relationship для связей ORM
from sqlalchemy.orm import relationship

# Импортируем базовый класс Base и функцию utcnow из основных моделей
# Base - базовый класс от которого наследуются все модели
# utcnow - функция возвращающая текущее UTC время
from bot.database.models import Base, utcnow


# ============================================================
# МОДЕЛЬ: НАСТРОЙКИ CONTENT FILTER ДЛЯ ГРУППЫ
# ============================================================
# Хранит все настройки модуля фильтрации для конкретной группы
# Каждая группа имеет свои независимые настройки (мультитенантность)
class ContentFilterSettings(Base):
    # Имя таблицы в базе данных PostgreSQL
    __tablename__ = 'content_filter_settings'

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY: ID группы (chat_id)
    # ─────────────────────────────────────────────────────────
    # Используем chat_id как первичный ключ (одна запись на группу)
    # ForeignKey связывает с таблицей groups
    # ondelete="CASCADE" - при удалении группы удаляются и настройки
    chat_id = Column(
        BigInteger,
        ForeignKey("groups.chat_id", ondelete="CASCADE"),
        primary_key=True
    )

    # ─────────────────────────────────────────────────────────
    # ГЛОБАЛЬНЫЙ ПЕРЕКЛЮЧАТЕЛЬ МОДУЛЯ
    # ─────────────────────────────────────────────────────────
    # True = модуль включён, False = выключен
    # По умолчанию выключен - админ должен явно включить
    enabled = Column(Boolean, default=False, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ПЕРЕКЛЮЧАТЕЛИ ПОДМОДУЛЕЙ
    # ─────────────────────────────────────────────────────────
    # Каждый подмодуль можно включить/выключить отдельно

    # Фильтр запрещённых слов (word_filter.py)
    # По умолчанию включён если модуль активен
    word_filter_enabled = Column(Boolean, default=True, nullable=False)

    # Детектор скама по эвристике (scam_detector.py)
    # По умолчанию включён - ловит "1200$ в неделю" и подобное
    scam_detection_enabled = Column(Boolean, default=True, nullable=False)

    # Детектор повторяющихся сообщений (flood_detector.py)
    # По умолчанию включён - ловит спам одинаковыми сообщениями
    flood_detection_enabled = Column(Boolean, default=True, nullable=False)

    # Детектор referral спама (referral_detector.py)
    # По умолчанию ВЫКЛЮЧЕН - требует настройки
    # Ловит когда много людей упоминают один @username
    referral_detection_enabled = Column(Boolean, default=False, nullable=False)

    # ─────────────────────────────────────────────────────────
    # НАСТРОЙКИ SCAM DETECTOR
    # ─────────────────────────────────────────────────────────
    # Порог чувствительности для эвристики скама (в баллах)
    # Чем ниже порог - тем строже фильтр (больше срабатываний)
    # 40 = высокая чувствительность (много срабатываний)
    # 60 = средняя (рекомендуется)
    # 90 = низкая (только явный скам)
    scam_sensitivity = Column(Integer, default=60, nullable=False)

    # ─────────────────────────────────────────────────────────
    # НАСТРОЙКИ FLOOD DETECTOR
    # ─────────────────────────────────────────────────────────
    # Максимальное количество одинаковых сообщений до срабатывания
    # Если пользователь отправил >= flood_max_repeats одинаковых - это флуд
    flood_max_repeats = Column(Integer, default=2, nullable=False)

    # Временное окно в секундах для подсчёта повторов
    # Считаем повторы только за последние flood_time_window секунд
    flood_time_window = Column(Integer, default=60, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ДЕЙСТВИЕ ПО УМОЛЧАНИЮ
    # ─────────────────────────────────────────────────────────
    # Что делать при срабатывании фильтра:
    # - "delete" = только удалить сообщение
    # - "warn" = удалить + предупреждение
    # - "mute" = удалить + мут на default_mute_duration минут
    # - "kick" = удалить + кик из группы
    # - "ban" = удалить + бан навсегда
    default_action = Column(String(20), default='delete', nullable=False)

    # Длительность мута по умолчанию в МИНУТАХ
    # Используется когда default_action = "mute"
    # 1440 минут = 24 часа
    default_mute_duration = Column(Integer, default=1440, nullable=False)

    # ─────────────────────────────────────────────────────────
    # РАЗДЕЛЬНЫЕ ДЕЙСТВИЯ ДЛЯ ПОДМОДУЛЕЙ
    # ─────────────────────────────────────────────────────────
    # Если NULL - используется default_action
    # Если задано - переопределяет действие для этого подмодуля

    # Действие для запрещённых слов (word_filter)
    word_filter_action = Column(String(20), nullable=True)
    # Длительность мута для запрещённых слов
    word_filter_mute_duration = Column(Integer, nullable=True)

    # Действие для антифлуда (flood_detector)
    flood_action = Column(String(20), nullable=True)
    # Длительность мута для антифлуда
    flood_mute_duration = Column(Integer, nullable=True)

    # ─────────────────────────────────────────────────────────
    # НАСТРОЙКИ НОРМАЛИЗАТОРА ДЛЯ ЗАПРЕЩЁННЫХ СЛОВ
    # ─────────────────────────────────────────────────────────
    # True = применять TextNormalizer к словам (обход l33tspeak)
    # False = искать слова как есть (без нормализации)
    word_filter_normalize = Column(Boolean, default=True, nullable=False)

    # ─────────────────────────────────────────────────────────
    # КАТЕГОРИИ СЛОВ: ПРОСТЫЕ (simple)
    # ─────────────────────────────────────────────────────────
    # Категория для рекламы, спама и подобного
    # По умолчанию: только удалять
    simple_words_enabled = Column(Boolean, default=True, nullable=True)
    simple_words_action = Column(String(20), default='delete', nullable=True)
    simple_words_mute_duration = Column(Integer, nullable=True)
    # Кастомный текст уведомления при муте (%user% = имя нарушителя)
    simple_words_mute_text = Column(String(500), nullable=True)
    # Кастомный текст уведомления при бане (%user% = имя нарушителя)
    simple_words_ban_text = Column(String(500), nullable=True)
    # Задержка перед удалением сообщения нарушителя (в секундах)
    simple_words_delete_delay = Column(Integer, nullable=True)
    # Через сколько секунд удалять уведомление бота (NULL = не удалять)
    simple_words_notification_delete_delay = Column(Integer, nullable=True)

    # ─────────────────────────────────────────────────────────
    # КАТЕГОРИИ СЛОВ: ВРЕДНЫЕ (harmful)
    # ─────────────────────────────────────────────────────────
    # Категория для наркотиков, запрещённого контента
    # По умолчанию: бан
    harmful_words_enabled = Column(Boolean, default=True, nullable=True)
    harmful_words_action = Column(String(20), default='ban', nullable=True)
    harmful_words_mute_duration = Column(Integer, nullable=True)
    # Кастомный текст уведомления при муте (%user% = имя нарушителя)
    harmful_words_mute_text = Column(String(500), nullable=True)
    # Кастомный текст уведомления при бане (%user% = имя нарушителя)
    harmful_words_ban_text = Column(String(500), nullable=True)
    # Задержка перед удалением сообщения нарушителя (в секундах)
    harmful_words_delete_delay = Column(Integer, nullable=True)
    # Через сколько секунд удалять уведомление бота (NULL = не удалять)
    harmful_words_notification_delete_delay = Column(Integer, nullable=True)

    # ─────────────────────────────────────────────────────────
    # КАТЕГОРИИ СЛОВ: ОБФУСКАЦИЯ (obfuscated)
    # ─────────────────────────────────────────────────────────
    # Категория для l33tspeak обходов (k0ka, w1шки)
    # По умолчанию: мут на 24 часа
    obfuscated_words_enabled = Column(Boolean, default=True, nullable=True)
    obfuscated_words_action = Column(String(20), default='mute', nullable=True)
    obfuscated_words_mute_duration = Column(Integer, default=1440, nullable=True)
    # Кастомный текст уведомления при муте (%user% = имя нарушителя)
    obfuscated_words_mute_text = Column(String(500), nullable=True)
    # Кастомный текст уведомления при бане (%user% = имя нарушителя)
    obfuscated_words_ban_text = Column(String(500), nullable=True)
    # Задержка перед удалением сообщения нарушителя (в секундах)
    obfuscated_words_delete_delay = Column(Integer, nullable=True)
    # Через сколько секунд удалять уведомление бота (NULL = не удалять)
    obfuscated_words_notification_delete_delay = Column(Integer, nullable=True)

    # ─────────────────────────────────────────────────────────
    # ЛОГИРОВАНИЕ
    # ─────────────────────────────────────────────────────────
    # Отправлять ли уведомления о срабатываниях в лог-канал группы
    # True = отправлять в GroupJournalChannel если он привязан
    log_violations = Column(Boolean, default=True, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ВРЕМЕННЫЕ МЕТКИ
    # ─────────────────────────────────────────────────────────
    # Когда настройки были созданы
    created_at = Column(DateTime, default=utcnow, nullable=False)

    # Когда настройки были последний раз обновлены
    # onupdate=utcnow автоматически обновляет при изменении записи
    updated_at = Column(DateTime, default=utcnow, onupdate=utcnow, nullable=False)

    # ─────────────────────────────────────────────────────────
    # СВЯЗИ ORM
    # ─────────────────────────────────────────────────────────
    # Связь с таблицей Group для удобного доступа к данным группы
    group = relationship("Group", backref="content_filter_settings")


# ============================================================
# МОДЕЛЬ: ЗАПРЕЩЁННЫЕ СЛОВА/ФРАЗЫ
# ============================================================
# Хранит список запрещённых слов для каждой группы
# Каждая группа имеет свой независимый список (мультитенантность)
class FilterWord(Base):
    # Имя таблицы в базе данных
    __tablename__ = 'filter_words'

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY: Автоинкрементный ID
    # ─────────────────────────────────────────────────────────
    id = Column(Integer, primary_key=True, autoincrement=True)

    # ─────────────────────────────────────────────────────────
    # FOREIGN KEY: ID группы
    # ─────────────────────────────────────────────────────────
    # Привязка слова к конкретной группе
    # index=True для быстрого поиска слов по группе
    chat_id = Column(
        BigInteger,
        ForeignKey("groups.chat_id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )

    # ─────────────────────────────────────────────────────────
    # СЛОВО/ФРАЗА
    # ─────────────────────────────────────────────────────────
    # Оригинальное слово или фраза как её ввёл админ
    # Максимум 500 символов (достаточно для фраз)
    word = Column(String(500), nullable=False)

    # Нормализованная версия слова для поиска
    # Приведена к нижнему регистру, без спецсимволов
    # Используется для сравнения с нормализованным текстом сообщения
    normalized = Column(String(500), nullable=False, index=True)

    # ─────────────────────────────────────────────────────────
    # ТИП СОВПАДЕНИЯ
    # ─────────────────────────────────────────────────────────
    # Как искать это слово в тексте:
    # - "word" = как отдельное слово (с границами)
    # - "phrase" = как подстроку (может быть частью слова)
    # - "regex" = как регулярное выражение (для продвинутых)
    match_type = Column(String(20), default='word', nullable=False)

    # ─────────────────────────────────────────────────────────
    # ИНДИВИДУАЛЬНОЕ ДЕЙСТВИЕ (опционально)
    # ─────────────────────────────────────────────────────────
    # Если NULL - используется default_action из ContentFilterSettings
    # Если задано - переопределяет действие для этого конкретного слова
    # Например: слово "наркотик" -> ban, слово "дурак" -> warn
    action = Column(String(20), nullable=True)

    # Длительность мута/бана для этого слова (в минутах)
    # Если NULL - используется default_mute_duration из настроек
    action_duration = Column(Integer, nullable=True)

    # ─────────────────────────────────────────────────────────
    # КАТЕГОРИЯ (для группировки)
    # ─────────────────────────────────────────────────────────
    # Позволяет группировать слова по категориям:
    # - "profanity" = мат
    # - "drugs" = наркотики
    # - "spam" = спам-слова
    # - "custom" = пользовательские
    # NULL = без категории
    category = Column(String(50), nullable=True)

    # ─────────────────────────────────────────────────────────
    # АУДИТ
    # ─────────────────────────────────────────────────────────
    # ID пользователя (админа) который добавил это слово
    # Для отслеживания кто что добавлял
    created_by = Column(BigInteger, nullable=False)

    # Когда слово было добавлено
    created_at = Column(DateTime, default=utcnow, nullable=False)

    # ─────────────────────────────────────────────────────────
    # СВЯЗИ ORM
    # ─────────────────────────────────────────────────────────
    # Связь с таблицей Group
    group = relationship("Group", backref="filter_words")

    # ─────────────────────────────────────────────────────────
    # ОГРАНИЧЕНИЯ И ИНДЕКСЫ
    # ─────────────────────────────────────────────────────────
    __table_args__ = (
        # Уникальное ограничение: одно слово один раз в группе
        # Нельзя добавить одно и то же слово дважды в одну группу
        UniqueConstraint('chat_id', 'word', name='uq_filter_chat_word'),

        # Составной индекс для быстрого поиска по группе и нормализованному слову
        # Ускоряет запросы типа: SELECT * FROM filter_words WHERE chat_id=X AND normalized=Y
        Index('ix_filter_words_chat_normalized', 'chat_id', 'normalized'),
    )


# ============================================================
# МОДЕЛЬ: БЕЛЫЙ СПИСОК (ИСКЛЮЧЕНИЯ)
# ============================================================
# Слова которые НЕ нужно фильтровать, даже если они похожи на запрещённые
# Пример: "анализ" не должен срабатывать на паттерн "анал"
class FilterWhitelist(Base):
    # Имя таблицы в базе данных
    __tablename__ = 'filter_whitelist'

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY
    # ─────────────────────────────────────────────────────────
    id = Column(Integer, primary_key=True, autoincrement=True)

    # ─────────────────────────────────────────────────────────
    # FOREIGN KEY: ID группы
    # ─────────────────────────────────────────────────────────
    chat_id = Column(
        BigInteger,
        ForeignKey("groups.chat_id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )

    # ─────────────────────────────────────────────────────────
    # СЛОВО-ИСКЛЮЧЕНИЕ
    # ─────────────────────────────────────────────────────────
    # Оригинальное слово
    word = Column(String(500), nullable=False)

    # Нормализованная версия для сравнения
    normalized = Column(String(500), nullable=False)

    # ─────────────────────────────────────────────────────────
    # АУДИТ
    # ─────────────────────────────────────────────────────────
    # Кто добавил это исключение
    added_by = Column(BigInteger, nullable=False)

    # Когда добавлено
    added_at = Column(DateTime, default=utcnow, nullable=False)

    # ─────────────────────────────────────────────────────────
    # СВЯЗИ ORM
    # ─────────────────────────────────────────────────────────
    group = relationship("Group", backref="filter_whitelist")

    # ─────────────────────────────────────────────────────────
    # ОГРАНИЧЕНИЯ
    # ─────────────────────────────────────────────────────────
    __table_args__ = (
        # Одно слово-исключение один раз в группе
        UniqueConstraint('chat_id', 'word', name='uq_whitelist_chat_word'),
    )


# ============================================================
# МОДЕЛЬ: ЛОГИ НАРУШЕНИЙ
# ============================================================
# Записывает каждое срабатывание фильтра для аналитики и аудита
# Позволяет видеть: кто нарушал, что писал, какое действие применили
class FilterViolation(Base):
    # Имя таблицы в базе данных
    __tablename__ = 'filter_violations'

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY
    # ─────────────────────────────────────────────────────────
    id = Column(Integer, primary_key=True, autoincrement=True)

    # ─────────────────────────────────────────────────────────
    # ИДЕНТИФИКАТОРЫ
    # ─────────────────────────────────────────────────────────
    # ID группы где произошло нарушение
    chat_id = Column(
        BigInteger,
        ForeignKey("groups.chat_id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )

    # ID пользователя который нарушил
    user_id = Column(BigInteger, nullable=False, index=True)

    # ─────────────────────────────────────────────────────────
    # ДЕТАЛИ СРАБАТЫВАНИЯ
    # ─────────────────────────────────────────────────────────
    # Какой подмодуль сработал:
    # - "word_filter" = запрещённое слово
    # - "scam_detector" = эвристика скама
    # - "flood_detector" = повторяющиеся сообщения
    # - "referral_detector" = спам @username
    detector_type = Column(String(30), nullable=False)

    # Что именно сработало (зависит от detector_type):
    # - для word_filter: само слово которое нашли
    # - для scam_detector: описание сработавших эвристик
    # - для flood_detector: "flood x3" (количество повторов)
    # - для referral_detector: "@username"
    trigger = Column(String(500), nullable=True)

    # Итоговый скор (только для scam_detector)
    # Сколько баллов набрало сообщение по эвристике
    scam_score = Column(Integer, nullable=True)

    # ─────────────────────────────────────────────────────────
    # ОРИГИНАЛЬНОЕ СООБЩЕНИЕ
    # ─────────────────────────────────────────────────────────
    # Текст сообщения (первые 1000 символов для экономии места)
    # Text вместо String для неограниченной длины
    message_text = Column(Text, nullable=True)

    # ID сообщения в Telegram (для возможной ссылки)
    message_id = Column(BigInteger, nullable=True)

    # ─────────────────────────────────────────────────────────
    # ПРИМЕНЁННОЕ ДЕЙСТВИЕ
    # ─────────────────────────────────────────────────────────
    # Что сделали с нарушителем: delete, warn, mute, kick, ban
    action_taken = Column(String(20), nullable=False)

    # ─────────────────────────────────────────────────────────
    # ВРЕМЕННАЯ МЕТКА
    # ─────────────────────────────────────────────────────────
    # Когда произошло нарушение
    # index=True для быстрой сортировки по дате
    created_at = Column(DateTime, default=utcnow, nullable=False, index=True)

    # ─────────────────────────────────────────────────────────
    # СВЯЗИ ORM
    # ─────────────────────────────────────────────────────────
    group = relationship("Group", backref="filter_violations")

    # ─────────────────────────────────────────────────────────
    # ИНДЕКСЫ
    # ─────────────────────────────────────────────────────────
    __table_args__ = (
        # Составной индекс для поиска нарушений пользователя в группе
        # Ускоряет: "сколько раз user_id нарушал в chat_id"
        Index('ix_violations_chat_user', 'chat_id', 'user_id'),

        # Составной индекс для поиска нарушений по дате в группе
        # Ускоряет: "все нарушения в chat_id за последний час"
        Index('ix_violations_chat_date', 'chat_id', 'created_at'),
    )


# ============================================================
# МОДЕЛЬ: КАСТОМНЫЕ ПАТТЕРНЫ СКАМА
# ============================================================
# Хранит паттерны для детектора скама (scam_detector.py)
# Каждая группа может добавлять свои паттерны характерные для их тематики
# Например: финансовый скам, крипто-скам, наркотики и т.д.
#
# Логика работы:
# 1. Детектор получает сообщение
# 2. Проверяет текст на совпадение с каждым паттерном группы
# 3. Суммирует веса (weight) всех сработавших паттернов
# 4. Если сумма >= порога чувствительности (scam_sensitivity) → СКАМ
class ScamPattern(Base):
    # Имя таблицы в базе данных
    __tablename__ = 'scam_patterns'

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY: Автоинкрементный ID
    # ─────────────────────────────────────────────────────────
    id = Column(Integer, primary_key=True, autoincrement=True)

    # ─────────────────────────────────────────────────────────
    # FOREIGN KEY: ID группы
    # ─────────────────────────────────────────────────────────
    # Привязка паттерна к конкретной группе
    # index=True для быстрого поиска всех паттернов группы
    chat_id = Column(
        BigInteger,
        ForeignKey("groups.chat_id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )

    # ─────────────────────────────────────────────────────────
    # ПАТТЕРН (текст для поиска)
    # ─────────────────────────────────────────────────────────
    # Оригинальный паттерн как его ввёл админ
    # Может быть словом, фразой или regex
    # Максимум 500 символов
    pattern = Column(String(500), nullable=False)

    # Нормализованная версия паттерна для поиска
    # Приведена к нижнему регистру, без лишних пробелов
    # Используется для сравнения с нормализованным текстом
    normalized = Column(String(500), nullable=False, index=True)

    # ─────────────────────────────────────────────────────────
    # ТИП ПАТТЕРНА
    # ─────────────────────────────────────────────────────────
    # Как искать этот паттерн в тексте:
    # - "word" = как отдельное слово (с границами слова)
    #   Пример: "заработок" найдёт "заработок", но НЕ "безработок"
    # - "phrase" = как подстроку (в любом месте текста)
    #   Пример: "гарантированный доход" найдёт фразу в любом контексте
    # - "regex" = как регулярное выражение (для продвинутых)
    #   Пример: "\d+\s*\$" найдёт "100$", "500 $", "1000$"
    pattern_type = Column(String(20), default='phrase', nullable=False)

    # ─────────────────────────────────────────────────────────
    # ВЕС ПАТТЕРНА (влияет на скор)
    # ─────────────────────────────────────────────────────────
    # Сколько баллов добавить к скору если паттерн сработал
    # Рекомендуемые значения:
    # - 10-15 = слабый сигнал (одно слово, часто встречается)
    # - 20-30 = средний сигнал (характерная фраза)
    # - 35-50 = сильный сигнал (явный скам)
    # По умолчанию 25 - средний вес для фразы
    weight = Column(Integer, default=25, nullable=False)

    # ─────────────────────────────────────────────────────────
    # КАТЕГОРИЯ (для группировки и фильтрации)
    # ─────────────────────────────────────────────────────────
    # Позволяет группировать паттерны по типу скама:
    # - "money" = финансовый скам (заработок, доход, инвестиции)
    # - "crypto" = крипто-скам (USDT, BTC, wallet, airdrop)
    # - "gambling" = казино/ставки (букмекер, слив, сигналы)
    # - "drugs" = наркотики (закладки, клады, сленг)
    # - "adult" = 18+ контент
    # - "other" = прочее
    # NULL = без категории
    category = Column(String(50), nullable=True)

    # ─────────────────────────────────────────────────────────
    # АКТИВНОСТЬ ПАТТЕРНА
    # ─────────────────────────────────────────────────────────
    # True = паттерн активен и используется при проверке
    # False = паттерн временно отключён (не удалён, но не проверяется)
    # Позволяет "приглушить" паттерн без удаления
    is_active = Column(Boolean, default=True, nullable=False)

    # ─────────────────────────────────────────────────────────
    # СТАТИСТИКА СРАБАТЫВАНИЙ
    # ─────────────────────────────────────────────────────────
    # Сколько раз этот паттерн сработал (для аналитики)
    # Позволяет видеть какие паттерны полезны, а какие нет
    triggers_count = Column(Integer, default=0, nullable=False)

    # Когда последний раз сработал (для актуальности)
    last_triggered_at = Column(DateTime, nullable=True)

    # ─────────────────────────────────────────────────────────
    # АУДИТ
    # ─────────────────────────────────────────────────────────
    # ID пользователя (админа) который добавил этот паттерн
    created_by = Column(BigInteger, nullable=False)

    # Когда паттерн был добавлен
    created_at = Column(DateTime, default=utcnow, nullable=False)

    # ─────────────────────────────────────────────────────────
    # СВЯЗИ ORM
    # ─────────────────────────────────────────────────────────
    # Связь с таблицей Group для удобного доступа
    group = relationship("Group", backref="scam_patterns")

    # ─────────────────────────────────────────────────────────
    # ОГРАНИЧЕНИЯ И ИНДЕКСЫ
    # ─────────────────────────────────────────────────────────
    __table_args__ = (
        # Уникальное ограничение: один паттерн один раз в группе
        # Нельзя добавить одинаковый паттерн дважды в одну группу
        UniqueConstraint('chat_id', 'pattern', name='uq_scam_pattern_chat_pattern'),

        # Составной индекс для поиска активных паттернов группы
        # Ускоряет: SELECT * FROM scam_patterns WHERE chat_id=X AND is_active=True
        Index('ix_scam_patterns_chat_active', 'chat_id', 'is_active'),
    )