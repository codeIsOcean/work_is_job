# ============================================================
# МОДЕЛИ БАЗЫ ДАННЫХ ДЛЯ МОДУЛЯ CONTENT FILTER
# ============================================================
# Этот файл содержит все SQLAlchemy модели для фильтрации контента:
# - ContentFilterSettings: настройки модуля для каждой группы
# - FilterWord: запрещённые слова/фразы
# - FilterWhitelist: исключения (слова которые НЕ фильтровать)
# - FilterViolation: логи всех срабатываний фильтра
# - ScamPattern: кастомные паттерны для детектора скама
# - ScamSignalCategory: категории сигналов (ключевые слова)
# - ScamScoreThreshold: пороги баллов для градации действий
# - CustomSpamSection: кастомные разделы спама (такси, жильё и т.д.)
# - CustomSectionPattern: паттерны кастомных разделов
# ============================================================

# Импортируем Column для определения колонок таблицы
from sqlalchemy import Column
# Импортируем типы данных для колонок
from sqlalchemy import Integer, String, BigInteger, Boolean, DateTime, Text
# Импортируем ForeignKey для связей между таблицами
from sqlalchemy import ForeignKey
# Импортируем Index для создания индексов (ускорение поиска)
from sqlalchemy import Index
# Импортируем UniqueConstraint для уникальных ограничений
from sqlalchemy import UniqueConstraint
# Импортируем relationship для связей ORM
from sqlalchemy.orm import relationship

# Импортируем базовый класс Base и функцию utcnow из основных моделей
# Base - базовый класс от которого наследуются все модели
# utcnow - функция возвращающая текущее UTC время
from bot.database.models import Base, utcnow

# Импортируем миксин для автоматического экспорта моделей
from bot.database.exportable_mixin import ExportableMixin


# ============================================================
# МОДЕЛЬ: НАСТРОЙКИ CONTENT FILTER ДЛЯ ГРУППЫ
# ============================================================
# Хранит все настройки модуля фильтрации для конкретной группы
# Каждая группа имеет свои независимые настройки (мультитенантность)
class ContentFilterSettings(Base, ExportableMixin):
    # Имя таблицы в базе данных PostgreSQL
    __tablename__ = 'content_filter_settings'

    # ─── Настройки экспорта ───
    __export_key__ = 'content_filter_settings'
    __export_is_settings__ = True
    __export_order__ = 100

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY: ID группы (chat_id)
    # ─────────────────────────────────────────────────────────
    # Используем chat_id как первичный ключ (одна запись на группу)
    # ForeignKey связывает с таблицей groups
    # ondelete="CASCADE" - при удалении группы удаляются и настройки
    chat_id = Column(
        BigInteger,
        ForeignKey("groups.chat_id", ondelete="CASCADE"),
        primary_key=True
    )

    # ─────────────────────────────────────────────────────────
    # ГЛОБАЛЬНЫЙ ПЕРЕКЛЮЧАТЕЛЬ МОДУЛЯ
    # ─────────────────────────────────────────────────────────
    # True = модуль включён, False = выключен
    # По умолчанию выключен - админ должен явно включить
    enabled = Column(Boolean, default=False, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ПЕРЕКЛЮЧАТЕЛИ ПОДМОДУЛЕЙ
    # ─────────────────────────────────────────────────────────
    # Каждый подмодуль можно включить/выключить отдельно

    # Фильтр запрещённых слов (word_filter.py)
    # По умолчанию включён если модуль активен
    word_filter_enabled = Column(Boolean, default=True, nullable=False)

    # Детектор скама по эвристике (scam_detector.py)
    # По умолчанию включён - ловит "1200$ в неделю" и подобное
    scam_detection_enabled = Column(Boolean, default=True, nullable=False)

    # Детектор повторяющихся сообщений (flood_detector.py)
    # По умолчанию включён - ловит спам одинаковыми сообщениями
    flood_detection_enabled = Column(Boolean, default=True, nullable=False)

    # Детектор referral спама (referral_detector.py)
    # По умолчанию ВЫКЛЮЧЕН - требует настройки
    # Ловит когда много людей упоминают один @username
    referral_detection_enabled = Column(Boolean, default=False, nullable=False)

    # ─────────────────────────────────────────────────────────
    # НАСТРОЙКИ SCAM DETECTOR
    # ─────────────────────────────────────────────────────────
    # Порог чувствительности для эвристики скама (в баллах)
    # Чем ниже порог - тем строже фильтр (больше срабатываний)
    # 40 = высокая чувствительность (много срабатываний)
    # 60 = средняя (рекомендуется)
    # 90 = низкая (только явный скам)
    scam_sensitivity = Column(Integer, default=60, nullable=False)

    # Действие при обнаружении скама (delete/warn/mute/kick/ban)
    # Если NULL - используется default_action
    scam_action = Column(String(20), nullable=True)
    # Длительность мута для скама в минутах
    scam_mute_duration = Column(Integer, nullable=True)
    # Кастомный текст уведомления при муте (%user% = имя нарушителя)
    scam_mute_text = Column(String(500), nullable=True)
    # Кастомный текст уведомления при бане (%user% = имя нарушителя)
    scam_ban_text = Column(String(500), nullable=True)
    # Задержка перед удалением сообщения нарушителя (в секундах)
    scam_delete_delay = Column(Integer, nullable=True)
    # Через сколько секунд удалять уведомление бота (NULL = не удалять)
    scam_notification_delete_delay = Column(Integer, nullable=True)

    # ─────────────────────────────────────────────────────────
    # НАСТРОЙКИ FLOOD DETECTOR
    # ─────────────────────────────────────────────────────────
    # Максимальное количество одинаковых сообщений до срабатывания
    # Если пользователь отправил >= flood_max_repeats одинаковых - это флуд
    flood_max_repeats = Column(Integer, default=2, nullable=False)

    # Временное окно в секундах для подсчёта повторов
    # Считаем повторы только за последние flood_time_window секунд
    flood_time_window = Column(Integer, default=60, nullable=False)

    # ─────────────────────────────────────────────────────────
    # РАСШИРЕННЫЙ АНТИФЛУД: ЛЮБЫЕ СООБЩЕНИЯ
    # ─────────────────────────────────────────────────────────
    # Включить детекцию любых сообщений подряд (не только одинаковых)
    # Если пользователь шлёт много сообщений подряд быстро - это флуд
    flood_detect_any_messages = Column(Boolean, default=False, nullable=False)
    # Максимум любых сообщений за временное окно
    flood_any_max_messages = Column(Integer, default=5, nullable=False)
    # Временное окно для подсчёта любых сообщений (секунды)
    flood_any_time_window = Column(Integer, default=10, nullable=False)

    # ─────────────────────────────────────────────────────────
    # РАСШИРЕННЫЙ АНТИФЛУД: МЕДИА
    # ─────────────────────────────────────────────────────────
    # Включить детекцию медиа-флуда (фото, стикеры, видео, войсы)
    # Проверяет каждый тип медиа отдельно
    flood_detect_media = Column(Boolean, default=False, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ДЕЙСТВИЕ ПО УМОЛЧАНИЮ
    # ─────────────────────────────────────────────────────────
    # Что делать при срабатывании фильтра:
    # - "delete" = только удалить сообщение
    # - "warn" = удалить + предупреждение
    # - "mute" = удалить + мут на default_mute_duration минут
    # - "kick" = удалить + кик из группы
    # - "ban" = удалить + бан навсегда
    default_action = Column(String(20), default='delete', nullable=False)

    # Длительность мута по умолчанию в МИНУТАХ
    # Используется когда default_action = "mute"
    # 1440 минут = 24 часа
    default_mute_duration = Column(Integer, default=1440, nullable=False)

    # ─────────────────────────────────────────────────────────
    # РАЗДЕЛЬНЫЕ ДЕЙСТВИЯ ДЛЯ ПОДМОДУЛЕЙ
    # ─────────────────────────────────────────────────────────
    # Если NULL - используется default_action
    # Если задано - переопределяет действие для этого подмодуля

    # Действие для запрещённых слов (word_filter)
    word_filter_action = Column(String(20), nullable=True)
    # Длительность мута для запрещённых слов
    word_filter_mute_duration = Column(Integer, nullable=True)

    # Действие для антифлуда (flood_detector)
    flood_action = Column(String(20), nullable=True)
    # Длительность мута для антифлуда
    flood_mute_duration = Column(Integer, nullable=True)
    # Кастомный текст уведомления при муте (%user% = имя нарушителя)
    flood_mute_text = Column(String(500), nullable=True)
    # Кастомный текст уведомления при бане (%user% = имя нарушителя)
    flood_ban_text = Column(String(500), nullable=True)
    # Кастомный текст уведомления при предупреждении (%user% = имя нарушителя)
    flood_warn_text = Column(String(500), nullable=True)
    # Задержка перед удалением сообщения нарушителя (в секундах)
    flood_delete_delay = Column(Integer, nullable=True)
    # Через сколько секунд удалять уведомление бота (NULL = не удалять)
    flood_notification_delete_delay = Column(Integer, nullable=True)

    # Удалять ли флуд-сообщения нарушителя
    # True = удалять все сообщения флуда (по умолчанию)
    # False = не удалять, только применить действие (мут/бан/предупреждение)
    flood_delete_messages = Column(Boolean, default=True, nullable=False)

    # ─────────────────────────────────────────────────────────
    # НАСТРОЙКИ НОРМАЛИЗАТОРА ДЛЯ ЗАПРЕЩЁННЫХ СЛОВ
    # ─────────────────────────────────────────────────────────
    # True = применять TextNormalizer к словам (обход l33tspeak)
    # False = искать слова как есть (без нормализации)
    word_filter_normalize = Column(Boolean, default=True, nullable=False)

    # ─────────────────────────────────────────────────────────
    # КАТЕГОРИИ СЛОВ: ПРОСТЫЕ (simple)
    # ─────────────────────────────────────────────────────────
    # Категория для рекламы, спама и подобного
    # По умолчанию: только удалять
    simple_words_enabled = Column(Boolean, default=True, nullable=True)
    simple_words_action = Column(String(20), default='delete', nullable=True)
    simple_words_mute_duration = Column(Integer, nullable=True)
    # Кастомный текст уведомления при муте (%user% = имя нарушителя)
    simple_words_mute_text = Column(String(500), nullable=True)
    # Кастомный текст уведомления при бане (%user% = имя нарушителя)
    simple_words_ban_text = Column(String(500), nullable=True)
    # Задержка перед удалением сообщения нарушителя (в секундах)
    simple_words_delete_delay = Column(Integer, nullable=True)
    # Через сколько секунд удалять уведомление бота (NULL = не удалять)
    simple_words_notification_delete_delay = Column(Integer, nullable=True)

    # ─────────────────────────────────────────────────────────
    # КАТЕГОРИИ СЛОВ: ВРЕДНЫЕ (harmful)
    # ─────────────────────────────────────────────────────────
    # Категория для наркотиков, запрещённого контента
    # По умолчанию: бан
    harmful_words_enabled = Column(Boolean, default=True, nullable=True)
    harmful_words_action = Column(String(20), default='ban', nullable=True)
    harmful_words_mute_duration = Column(Integer, nullable=True)
    # Кастомный текст уведомления при муте (%user% = имя нарушителя)
    harmful_words_mute_text = Column(String(500), nullable=True)
    # Кастомный текст уведомления при бане (%user% = имя нарушителя)
    harmful_words_ban_text = Column(String(500), nullable=True)
    # Задержка перед удалением сообщения нарушителя (в секундах)
    harmful_words_delete_delay = Column(Integer, nullable=True)
    # Через сколько секунд удалять уведомление бота (NULL = не удалять)
    harmful_words_notification_delete_delay = Column(Integer, nullable=True)

    # ─────────────────────────────────────────────────────────
    # КАТЕГОРИИ СЛОВ: ОБФУСКАЦИЯ (obfuscated)
    # ─────────────────────────────────────────────────────────
    # Категория для l33tspeak обходов (k0ka, w1шки)
    # По умолчанию: мут на 24 часа
    obfuscated_words_enabled = Column(Boolean, default=True, nullable=True)
    obfuscated_words_action = Column(String(20), default='mute', nullable=True)
    obfuscated_words_mute_duration = Column(Integer, default=1440, nullable=True)
    # Кастомный текст уведомления при муте (%user% = имя нарушителя)
    obfuscated_words_mute_text = Column(String(500), nullable=True)
    # Кастомный текст уведомления при бане (%user% = имя нарушителя)
    obfuscated_words_ban_text = Column(String(500), nullable=True)
    # Задержка перед удалением сообщения нарушителя (в секундах)
    obfuscated_words_delete_delay = Column(Integer, nullable=True)
    # Через сколько секунд удалять уведомление бота (NULL = не удалять)
    obfuscated_words_notification_delete_delay = Column(Integer, nullable=True)

    # ─────────────────────────────────────────────────────────
    # ЛОГИРОВАНИЕ
    # ─────────────────────────────────────────────────────────
    # Отправлять ли уведомления о срабатываниях в лог-канал группы
    # True = отправлять в GroupJournalChannel если он привязан
    log_violations = Column(Boolean, default=True, nullable=False)

    # ─────────────────────────────────────────────────────────
    # МОДУЛЬ УДАЛЕНИЯ СООБЩЕНИЙ
    # ─────────────────────────────────────────────────────────
    # Удалять команды от обычных пользователей (/start, /help, /settings и т.д.)
    delete_user_commands = Column(Boolean, default=False, nullable=False)
    # Удалять системные сообщения (вход/выход участников, закреплённые и т.д.)
    delete_system_messages = Column(Boolean, default=False, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ВРЕМЕННЫЕ МЕТКИ
    # ─────────────────────────────────────────────────────────
    # Когда настройки были созданы
    created_at = Column(DateTime, default=utcnow, nullable=False)

    # Когда настройки были последний раз обновлены
    # onupdate=utcnow автоматически обновляет при изменении записи
    updated_at = Column(DateTime, default=utcnow, onupdate=utcnow, nullable=False)

    # ─────────────────────────────────────────────────────────
    # СВЯЗИ ORM
    # ─────────────────────────────────────────────────────────
    # Связь с таблицей Group для удобного доступа к данным группы
    group = relationship("Group", backref="content_filter_settings")


# ============================================================
# МОДЕЛЬ: ЗАПРЕЩЁННЫЕ СЛОВА/ФРАЗЫ
# ============================================================
# Хранит список запрещённых слов для каждой группы
# Каждая группа имеет свой независимый список (мультитенантность)
class FilterWord(Base, ExportableMixin):
    # Имя таблицы в базе данных
    __tablename__ = 'filter_words'

    # ─── Настройки экспорта ───
    __export_key__ = 'filter_words'
    __export_order__ = 410

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY: Автоинкрементный ID
    # ─────────────────────────────────────────────────────────
    id = Column(Integer, primary_key=True, autoincrement=True)

    # ─────────────────────────────────────────────────────────
    # FOREIGN KEY: ID группы
    # ─────────────────────────────────────────────────────────
    # Привязка слова к конкретной группе
    # index=True для быстрого поиска слов по группе
    chat_id = Column(
        BigInteger,
        ForeignKey("groups.chat_id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )

    # ─────────────────────────────────────────────────────────
    # СЛОВО/ФРАЗА
    # ─────────────────────────────────────────────────────────
    # Оригинальное слово или фраза как её ввёл админ
    # Максимум 500 символов (достаточно для фраз)
    word = Column(String(500), nullable=False)

    # Нормализованная версия слова для поиска
    # Приведена к нижнему регистру, без спецсимволов
    # Используется для сравнения с нормализованным текстом сообщения
    normalized = Column(String(500), nullable=False, index=True)

    # ─────────────────────────────────────────────────────────
    # ТИП СОВПАДЕНИЯ
    # ─────────────────────────────────────────────────────────
    # Как искать это слово в тексте:
    # - "word" = как отдельное слово (с границами)
    # - "phrase" = как подстроку (может быть частью слова)
    # - "regex" = как регулярное выражение (для продвинутых)
    match_type = Column(String(20), default='word', nullable=False)

    # ─────────────────────────────────────────────────────────
    # ИНДИВИДУАЛЬНОЕ ДЕЙСТВИЕ (опционально)
    # ─────────────────────────────────────────────────────────
    # Если NULL - используется default_action из ContentFilterSettings
    # Если задано - переопределяет действие для этого конкретного слова
    # Например: слово "наркотик" -> ban, слово "дурак" -> warn
    action = Column(String(20), nullable=True)

    # Длительность мута/бана для этого слова (в минутах)
    # Если NULL - используется default_mute_duration из настроек
    action_duration = Column(Integer, nullable=True)

    # ─────────────────────────────────────────────────────────
    # КАТЕГОРИЯ (для группировки)
    # ─────────────────────────────────────────────────────────
    # Позволяет группировать слова по категориям:
    # - "profanity" = мат
    # - "drugs" = наркотики
    # - "spam" = спам-слова
    # - "custom" = пользовательские
    # NULL = без категории
    category = Column(String(50), nullable=True)

    # ─────────────────────────────────────────────────────────
    # АУДИТ
    # ─────────────────────────────────────────────────────────
    # ID пользователя (админа) который добавил это слово
    # Для отслеживания кто что добавлял
    created_by = Column(BigInteger, nullable=False)

    # Когда слово было добавлено
    created_at = Column(DateTime, default=utcnow, nullable=False)

    # ─────────────────────────────────────────────────────────
    # СВЯЗИ ORM
    # ─────────────────────────────────────────────────────────
    # Связь с таблицей Group
    group = relationship("Group", backref="filter_words")

    # ─────────────────────────────────────────────────────────
    # ОГРАНИЧЕНИЯ И ИНДЕКСЫ
    # ─────────────────────────────────────────────────────────
    __table_args__ = (
        # Уникальное ограничение: одно слово один раз в группе
        # Нельзя добавить одно и то же слово дважды в одну группу
        UniqueConstraint('chat_id', 'word', name='uq_filter_chat_word'),

        # Составной индекс для быстрого поиска по группе и нормализованному слову
        # Ускоряет запросы типа: SELECT * FROM filter_words WHERE chat_id=X AND normalized=Y
        Index('ix_filter_words_chat_normalized', 'chat_id', 'normalized'),
    )


# ============================================================
# МОДЕЛЬ: БЕЛЫЙ СПИСОК (ИСКЛЮЧЕНИЯ)
# ============================================================
# Слова которые НЕ нужно фильтровать, даже если они похожи на запрещённые
# Пример: "анализ" не должен срабатывать на паттерн "анал"
class FilterWhitelist(Base, ExportableMixin):
    # Имя таблицы в базе данных
    __tablename__ = 'filter_whitelist'

    # ─── Настройки экспорта ───
    __export_key__ = 'filter_whitelist'
    __export_order__ = 411

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY
    # ─────────────────────────────────────────────────────────
    id = Column(Integer, primary_key=True, autoincrement=True)

    # ─────────────────────────────────────────────────────────
    # FOREIGN KEY: ID группы
    # ─────────────────────────────────────────────────────────
    chat_id = Column(
        BigInteger,
        ForeignKey("groups.chat_id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )

    # ─────────────────────────────────────────────────────────
    # СЛОВО-ИСКЛЮЧЕНИЕ
    # ─────────────────────────────────────────────────────────
    # Оригинальное слово
    word = Column(String(500), nullable=False)

    # Нормализованная версия для сравнения
    normalized = Column(String(500), nullable=False)

    # ─────────────────────────────────────────────────────────
    # АУДИТ
    # ─────────────────────────────────────────────────────────
    # Кто добавил это исключение
    added_by = Column(BigInteger, nullable=False)

    # Когда добавлено
    added_at = Column(DateTime, default=utcnow, nullable=False)

    # ─────────────────────────────────────────────────────────
    # СВЯЗИ ORM
    # ─────────────────────────────────────────────────────────
    group = relationship("Group", backref="filter_whitelist")

    # ─────────────────────────────────────────────────────────
    # ОГРАНИЧЕНИЯ
    # ─────────────────────────────────────────────────────────
    __table_args__ = (
        # Одно слово-исключение один раз в группе
        UniqueConstraint('chat_id', 'word', name='uq_whitelist_chat_word'),
    )


# ============================================================
# МОДЕЛЬ: ЛОГИ НАРУШЕНИЙ
# ============================================================
# Записывает каждое срабатывание фильтра для аналитики и аудита
# Позволяет видеть: кто нарушал, что писал, какое действие применили
class FilterViolation(Base):
    # Имя таблицы в базе данных
    __tablename__ = 'filter_violations'

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY
    # ─────────────────────────────────────────────────────────
    id = Column(Integer, primary_key=True, autoincrement=True)

    # ─────────────────────────────────────────────────────────
    # ИДЕНТИФИКАТОРЫ
    # ─────────────────────────────────────────────────────────
    # ID группы где произошло нарушение
    chat_id = Column(
        BigInteger,
        ForeignKey("groups.chat_id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )

    # ID пользователя который нарушил
    user_id = Column(BigInteger, nullable=False, index=True)

    # ─────────────────────────────────────────────────────────
    # ДЕТАЛИ СРАБАТЫВАНИЯ
    # ─────────────────────────────────────────────────────────
    # Какой подмодуль сработал:
    # - "word_filter" = запрещённое слово
    # - "scam_detector" = эвристика скама
    # - "flood_detector" = повторяющиеся сообщения
    # - "referral_detector" = спам @username
    detector_type = Column(String(30), nullable=False)

    # Что именно сработало (зависит от detector_type):
    # - для word_filter: само слово которое нашли
    # - для scam_detector: описание сработавших эвристик
    # - для flood_detector: "flood x3" (количество повторов)
    # - для referral_detector: "@username"
    trigger = Column(String(500), nullable=True)

    # Итоговый скор (только для scam_detector)
    # Сколько баллов набрало сообщение по эвристике
    scam_score = Column(Integer, nullable=True)

    # ─────────────────────────────────────────────────────────
    # ОРИГИНАЛЬНОЕ СООБЩЕНИЕ
    # ─────────────────────────────────────────────────────────
    # Текст сообщения (первые 1000 символов для экономии места)
    # Text вместо String для неограниченной длины
    message_text = Column(Text, nullable=True)

    # ID сообщения в Telegram (для возможной ссылки)
    message_id = Column(BigInteger, nullable=True)

    # ─────────────────────────────────────────────────────────
    # ПРИМЕНЁННОЕ ДЕЙСТВИЕ
    # ─────────────────────────────────────────────────────────
    # Что сделали с нарушителем: delete, warn, mute, kick, ban
    action_taken = Column(String(20), nullable=False)

    # ─────────────────────────────────────────────────────────
    # ВРЕМЕННАЯ МЕТКА
    # ─────────────────────────────────────────────────────────
    # Когда произошло нарушение
    # index=True для быстрой сортировки по дате
    created_at = Column(DateTime, default=utcnow, nullable=False, index=True)

    # ─────────────────────────────────────────────────────────
    # СВЯЗИ ORM
    # ─────────────────────────────────────────────────────────
    group = relationship("Group", backref="filter_violations")

    # ─────────────────────────────────────────────────────────
    # ИНДЕКСЫ
    # ─────────────────────────────────────────────────────────
    __table_args__ = (
        # Составной индекс для поиска нарушений пользователя в группе
        # Ускоряет: "сколько раз user_id нарушал в chat_id"
        Index('ix_violations_chat_user', 'chat_id', 'user_id'),

        # Составной индекс для поиска нарушений по дате в группе
        # Ускоряет: "все нарушения в chat_id за последний час"
        Index('ix_violations_chat_date', 'chat_id', 'created_at'),
    )


# ============================================================
# МОДЕЛЬ: КАСТОМНЫЕ ПАТТЕРНЫ СКАМА
# ============================================================
# Хранит паттерны для детектора скама (scam_detector.py)
# Каждая группа может добавлять свои паттерны характерные для их тематики
# Например: финансовый скам, крипто-скам, наркотики и т.д.
#
# Логика работы:
# 1. Детектор получает сообщение
# 2. Проверяет текст на совпадение с каждым паттерном группы
# 3. Суммирует веса (weight) всех сработавших паттернов
# 4. Если сумма >= порога чувствительности (scam_sensitivity) → СКАМ
class ScamPattern(Base, ExportableMixin):
    # Имя таблицы в базе данных
    __tablename__ = 'scam_patterns'

    # ─── Настройки экспорта ───
    __export_key__ = 'scam_patterns'
    __export_order__ = 420

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY: Автоинкрементный ID
    # ─────────────────────────────────────────────────────────
    id = Column(Integer, primary_key=True, autoincrement=True)

    # ─────────────────────────────────────────────────────────
    # FOREIGN KEY: ID группы
    # ─────────────────────────────────────────────────────────
    # Привязка паттерна к конкретной группе
    # index=True для быстрого поиска всех паттернов группы
    chat_id = Column(
        BigInteger,
        ForeignKey("groups.chat_id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )

    # ─────────────────────────────────────────────────────────
    # ПАТТЕРН (текст для поиска)
    # ─────────────────────────────────────────────────────────
    # Оригинальный паттерн как его ввёл админ
    # Может быть словом, фразой или regex
    # Максимум 500 символов
    pattern = Column(String(500), nullable=False)

    # Нормализованная версия паттерна для поиска
    # Приведена к нижнему регистру, без лишних пробелов
    # Используется для сравнения с нормализованным текстом
    normalized = Column(String(500), nullable=False, index=True)

    # ─────────────────────────────────────────────────────────
    # ТИП ПАТТЕРНА
    # ─────────────────────────────────────────────────────────
    # Как искать этот паттерн в тексте:
    # - "word" = как отдельное слово (с границами слова)
    #   Пример: "заработок" найдёт "заработок", но НЕ "безработок"
    # - "phrase" = как подстроку (в любом месте текста)
    #   Пример: "гарантированный доход" найдёт фразу в любом контексте
    # - "regex" = как регулярное выражение (для продвинутых)
    #   Пример: "\d+\s*\$" найдёт "100$", "500 $", "1000$"
    pattern_type = Column(String(20), default='phrase', nullable=False)

    # ─────────────────────────────────────────────────────────
    # ВЕС ПАТТЕРНА (влияет на скор)
    # ─────────────────────────────────────────────────────────
    # Сколько баллов добавить к скору если паттерн сработал
    # Рекомендуемые значения:
    # - 10-15 = слабый сигнал (одно слово, часто встречается)
    # - 20-30 = средний сигнал (характерная фраза)
    # - 35-50 = сильный сигнал (явный скам)
    # По умолчанию 25 - средний вес для фразы
    weight = Column(Integer, default=25, nullable=False)

    # ─────────────────────────────────────────────────────────
    # КАТЕГОРИЯ (для группировки и фильтрации)
    # ─────────────────────────────────────────────────────────
    # Позволяет группировать паттерны по типу скама:
    # - "money" = финансовый скам (заработок, доход, инвестиции)
    # - "crypto" = крипто-скам (USDT, BTC, wallet, airdrop)
    # - "gambling" = казино/ставки (букмекер, слив, сигналы)
    # - "drugs" = наркотики (закладки, клады, сленг)
    # - "adult" = 18+ контент
    # - "other" = прочее
    # NULL = без категории
    category = Column(String(50), nullable=True)

    # ─────────────────────────────────────────────────────────
    # АКТИВНОСТЬ ПАТТЕРНА
    # ─────────────────────────────────────────────────────────
    # True = паттерн активен и используется при проверке
    # False = паттерн временно отключён (не удалён, но не проверяется)
    # Позволяет "приглушить" паттерн без удаления
    is_active = Column(Boolean, default=True, nullable=False)

    # ─────────────────────────────────────────────────────────
    # СТАТИСТИКА СРАБАТЫВАНИЙ
    # ─────────────────────────────────────────────────────────
    # Сколько раз этот паттерн сработал (для аналитики)
    # Позволяет видеть какие паттерны полезны, а какие нет
    triggers_count = Column(Integer, default=0, nullable=False)

    # Когда последний раз сработал (для актуальности)
    last_triggered_at = Column(DateTime, nullable=True)

    # ─────────────────────────────────────────────────────────
    # АУДИТ
    # ─────────────────────────────────────────────────────────
    # ID пользователя (админа) который добавил этот паттерн
    created_by = Column(BigInteger, nullable=False)

    # Когда паттерн был добавлен
    created_at = Column(DateTime, default=utcnow, nullable=False)

    # ─────────────────────────────────────────────────────────
    # СВЯЗИ ORM
    # ─────────────────────────────────────────────────────────
    # Связь с таблицей Group для удобного доступа
    group = relationship("Group", backref="scam_patterns")

    # ─────────────────────────────────────────────────────────
    # ОГРАНИЧЕНИЯ И ИНДЕКСЫ
    # ─────────────────────────────────────────────────────────
    __table_args__ = (
        # Уникальное ограничение: один паттерн один раз в группе
        # Нельзя добавить одинаковый паттерн дважды в одну группу
        UniqueConstraint('chat_id', 'pattern', name='uq_scam_pattern_chat_pattern'),

        # Составной индекс для поиска активных паттернов группы
        # Ускоряет: SELECT * FROM scam_patterns WHERE chat_id=X AND is_active=True
        Index('ix_scam_patterns_chat_active', 'chat_id', 'is_active'),
    )


# ============================================================
# МОДЕЛЬ: КАТЕГОРИИ СИГНАЛОВ СКАМА
# ============================================================
# Хранит категории ключевых слов для детекции скама
# Каждая группа может создавать свои категории:
# - "Наркотики" → [drugs, cocaine, weed, hashish...]
# - "Контакты" → [whatsapp, telegram, viber...]
# - "Деньги" → [crypto, bitcoin, usdt...]
#
# При проверке сообщения:
# 1. Для каждой активной категории группы
# 2. Проверяем наличие любого ключевого слова в тексте
# 3. Если найдено → добавляем weight баллов к скору
# 4. Если суммарный скор >= scam_sensitivity → СКАМ
class ScamSignalCategory(Base, ExportableMixin):
    # Имя таблицы в базе данных
    __tablename__ = 'scam_signal_categories'

    # ─── Настройки экспорта ───
    __export_key__ = 'scam_signal_categories'
    __export_order__ = 421

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY: Автоинкрементный ID
    # ─────────────────────────────────────────────────────────
    id = Column(Integer, primary_key=True, autoincrement=True)

    # ─────────────────────────────────────────────────────────
    # FOREIGN KEY: ID группы
    # ─────────────────────────────────────────────────────────
    # Привязка категории к конкретной группе
    # index=True для быстрого поиска всех категорий группы
    chat_id = Column(
        BigInteger,
        ForeignKey("groups.chat_id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )

    # ─────────────────────────────────────────────────────────
    # НАЗВАНИЕ КАТЕГОРИИ
    # ─────────────────────────────────────────────────────────
    # Отображаемое имя категории (например: "Наркотики", "Контакты")
    # Показывается в UI настроек
    category_name = Column(String(100), nullable=False)

    # ─────────────────────────────────────────────────────────
    # КЛЮЧЕВЫЕ СЛОВА
    # ─────────────────────────────────────────────────────────
    # Список ключевых слов через запятую
    # Пример: "drugs,cocaine,weed,hashish,crystal"
    # При проверке: если ЛЮБОЕ слово найдено в тексте → категория сработала
    keywords = Column(Text, nullable=False, default='')

    # ─────────────────────────────────────────────────────────
    # ВЕС КАТЕГОРИИ
    # ─────────────────────────────────────────────────────────
    # Сколько баллов добавить к скору если категория сработала
    # Рекомендуемые значения:
    # - 15-20 = слабый сигнал (часто встречающиеся слова)
    # - 25-35 = средний сигнал
    # - 40-50 = сильный сигнал (явный скам)
    weight = Column(Integer, default=25, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ФЛАГ АКТИВНОСТИ
    # ─────────────────────────────────────────────────────────
    # True = категория активна и проверяется
    # False = категория временно отключена (не удалена)
    enabled = Column(Boolean, default=True, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ВРЕМЕННЫЕ МЕТКИ
    # ─────────────────────────────────────────────────────────
    # Когда категория была создана
    created_at = Column(DateTime, default=utcnow, nullable=False)

    # Когда категория была последний раз обновлена
    updated_at = Column(DateTime, default=utcnow, onupdate=utcnow, nullable=False)

    # ─────────────────────────────────────────────────────────
    # АУДИТ
    # ─────────────────────────────────────────────────────────
    # ID админа который создал категорию
    created_by = Column(BigInteger, nullable=True)

    # ─────────────────────────────────────────────────────────
    # СВЯЗИ ORM
    # ─────────────────────────────────────────────────────────
    # Связь с таблицей Group для удобного доступа
    group = relationship("Group", backref="scam_signal_categories")


# ============================================================
# МОДЕЛЬ: ПОРОГИ БАЛЛОВ СКАМА
# ============================================================
# Хранит пороги баллов для градации действий по скору
# Позволяет задавать разные действия для разных диапазонов баллов:
# - 100-299 баллов → delete (только удалить)
# - 300-399 баллов → mute 1 час
# - 400+ баллов → ban (явный скам)
#
# Логика работы:
# 1. ScamDetector считает итоговый score
# 2. Ищем порог где min_score <= score <= max_score
# 3. Если найден → применяем action из порога
# 4. Если НЕ найден → используем scam_action из ContentFilterSettings
class ScamScoreThreshold(Base, ExportableMixin):
    # Имя таблицы в базе данных
    __tablename__ = 'scam_score_thresholds'

    # ─── Настройки экспорта ───
    __export_key__ = 'scam_score_thresholds'
    __export_order__ = 422

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY: Автоинкрементный ID
    # ─────────────────────────────────────────────────────────
    id = Column(Integer, primary_key=True, autoincrement=True)

    # ─────────────────────────────────────────────────────────
    # FOREIGN KEY: ID группы
    # ─────────────────────────────────────────────────────────
    # Привязка порога к конкретной группе
    # index=True для быстрого поиска всех порогов группы
    chat_id = Column(
        BigInteger,
        ForeignKey("groups.chat_id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )

    # ─────────────────────────────────────────────────────────
    # ДИАПАЗОН БАЛЛОВ
    # ─────────────────────────────────────────────────────────
    # Минимальный порог баллов (включительно)
    # Пример: min_score=100 означает score >= 100
    min_score = Column(Integer, nullable=False)

    # Максимальный порог баллов (включительно)
    # NULL = без верхнего ограничения (100+)
    # Пример: max_score=299 означает score <= 299
    max_score = Column(Integer, nullable=True)

    # ─────────────────────────────────────────────────────────
    # ДЕЙСТВИЕ ПРИ СРАБАТЫВАНИИ
    # ─────────────────────────────────────────────────────────
    # Что делать если score попадает в этот диапазон:
    # - "delete" = только удалить сообщение
    # - "mute" = удалить + замутить
    # - "kick" = удалить + кикнуть
    # - "ban" = удалить + забанить
    action = Column(String(20), default='delete', nullable=False)

    # Длительность мута в минутах (только для action='mute')
    # NULL = использовать default из ContentFilterSettings
    # 60 = 1 час, 1440 = 24 часа
    mute_duration = Column(Integer, nullable=True)

    # ─────────────────────────────────────────────────────────
    # АКТИВНОСТЬ ПОРОГА
    # ─────────────────────────────────────────────────────────
    # True = порог активен и используется
    # False = порог отключён (не удалён, но не применяется)
    enabled = Column(Boolean, default=True, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ПРИОРИТЕТ ПОРОГА
    # ─────────────────────────────────────────────────────────
    # Порядок проверки порогов (меньше = проверяется раньше)
    # Если несколько порогов подходят - выбирается с меньшим priority
    priority = Column(Integer, default=0, nullable=False)

    # ─────────────────────────────────────────────────────────
    # МЕТАДАННЫЕ
    # ─────────────────────────────────────────────────────────
    # Описание порога для UI (опционально)
    # Пример: "Низкий скор - только удаление"
    description = Column(String(200), nullable=True)

    # Когда порог был создан
    created_at = Column(DateTime, default=utcnow, nullable=False)

    # Когда порог был последний раз обновлён
    updated_at = Column(DateTime, default=utcnow, onupdate=utcnow, nullable=False)

    # ID админа который создал порог
    created_by = Column(BigInteger, nullable=True)

    # ─────────────────────────────────────────────────────────
    # СВЯЗИ ORM
    # ─────────────────────────────────────────────────────────
    # Связь с таблицей Group для удобного доступа
    group = relationship("Group", backref="scam_score_thresholds")

    # ─────────────────────────────────────────────────────────
    # ИНДЕКСЫ
    # ─────────────────────────────────────────────────────────
    __table_args__ = (
        # Индекс для поиска активных порогов группы с сортировкой по приоритету
        Index('ix_scam_thresholds_chat_enabled', 'chat_id', 'enabled'),
    )


# ============================================================
# МОДЕЛЬ: КАСТОМНЫЙ РАЗДЕЛ СПАМА
# ============================================================
# Позволяет создавать отдельные разделы для разных типов спама:
# - "Такси" — реклама такси, извозчиков
# - "Жильё" — аренда/продажа недвижимости
# - "Наркотики" — запрещённые вещества
#
# Каждый раздел имеет:
# - Свои паттерны (CustomSectionPattern)
# - Свой порог срабатывания
# - Своё действие (delete, mute, ban, forward+delete)
# - Опционально: канал для пересылки
class CustomSpamSection(Base, ExportableMixin):
    # Имя таблицы в базе данных
    __tablename__ = 'custom_spam_sections'

    # ─── Настройки экспорта ───
    # Родительская модель для CustomSectionPattern и CustomSectionThreshold
    __export_key__ = 'custom_spam_sections'
    __export_order__ = 200  # Импортируется раньше дочерних

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY: Автоинкрементный ID
    # ─────────────────────────────────────────────────────────
    id = Column(Integer, primary_key=True, autoincrement=True)

    # ─────────────────────────────────────────────────────────
    # FOREIGN KEY: ID группы
    # ─────────────────────────────────────────────────────────
    # Привязка раздела к конкретной группе
    # index=True для быстрого поиска всех разделов группы
    chat_id = Column(
        BigInteger,
        ForeignKey("groups.chat_id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )

    # ─────────────────────────────────────────────────────────
    # НАЗВАНИЕ РАЗДЕЛА
    # ─────────────────────────────────────────────────────────
    # Отображаемое имя раздела (например: "Такси", "Жильё")
    # Показывается в UI настроек
    name = Column(String(100), nullable=False)

    # Описание раздела (опционально)
    description = Column(String(500), nullable=True)

    # ─────────────────────────────────────────────────────────
    # АКТИВНОСТЬ РАЗДЕЛА
    # ─────────────────────────────────────────────────────────
    # True = раздел активен и проверяется
    # False = раздел временно отключён (не удалён)
    enabled = Column(Boolean, default=True, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ПОРОГ ЧУВСТВИТЕЛЬНОСТИ
    # ─────────────────────────────────────────────────────────
    # Минимальный скор для срабатывания раздела
    # Аналогично scam_sensitivity в ContentFilterSettings
    threshold = Column(Integer, default=60, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ДЕЙСТВИЕ ПРИ СРАБАТЫВАНИИ
    # ─────────────────────────────────────────────────────────
    # Что делать при срабатывании:
    # - "delete" = только удалить сообщение
    # - "mute" = удалить + замутить
    # - "kick" = удалить + кикнуть
    # - "ban" = удалить + забанить
    # - "forward_delete" = переслать в канал + удалить
    action = Column(String(30), default='delete', nullable=False)

    # Длительность мута в минутах (только для action='mute')
    mute_duration = Column(Integer, nullable=True)

    # ─────────────────────────────────────────────────────────
    # ПЕРЕСЫЛКА В КАНАЛ
    # ─────────────────────────────────────────────────────────
    # ID канала куда пересылать сообщения (для action='forward_delete')
    # NULL = не пересылать
    forward_channel_id = Column(BigInteger, nullable=True)

    # ─────────────────────────────────────────────────────────
    # ОПЦИИ ПЕРЕСЫЛКИ ПО ДЕЙСТВИЯМ
    # ─────────────────────────────────────────────────────────
    # Пересылать ли в канал при каждом типе действия
    # Позволяет включать пересылку независимо для delete/mute/ban

    # True = пересылать сообщение в канал при действии "удалить"
    forward_on_delete = Column(Boolean, default=False, nullable=False)
    # True = пересылать сообщение в канал при действии "мут"
    forward_on_mute = Column(Boolean, default=False, nullable=False)
    # True = пересылать сообщение в канал при действии "бан"
    forward_on_ban = Column(Boolean, default=False, nullable=False)

    # ─────────────────────────────────────────────────────────
    # КАСТОМНЫЕ ТЕКСТЫ УВЕДОМЛЕНИЙ
    # ─────────────────────────────────────────────────────────
    # Текст при муте (%user% = имя нарушителя)
    mute_text = Column(String(500), nullable=True)
    # Текст при бане
    ban_text = Column(String(500), nullable=True)

    # ─────────────────────────────────────────────────────────
    # ЗАДЕРЖКИ
    # ─────────────────────────────────────────────────────────
    # Задержка перед удалением сообщения нарушителя (в секундах)
    delete_delay = Column(Integer, nullable=True)
    # Через сколько секунд удалять уведомление бота (NULL = не удалять)
    notification_delete_delay = Column(Integer, nullable=True)

    # ─────────────────────────────────────────────────────────
    # ЛОГИРОВАНИЕ
    # ─────────────────────────────────────────────────────────
    # Отправлять ли уведомления о срабатываниях в журнал группы
    log_violations = Column(Boolean, default=True, nullable=False)

    # ─────────────────────────────────────────────────────────
    # CAS (COMBOT ANTI-SPAM) ИНТЕГРАЦИЯ
    # ─────────────────────────────────────────────────────────
    # True = проверять пользователя в базе CAS при срабатывании раздела
    # CAS — бесплатная глобальная база забаненных спамеров Telegram
    # API: https://api.cas.chat/check?user_id=XXX
    # Если пользователь в CAS — применяется действие раздела (action)
    cas_enabled = Column(Boolean, default=False, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ГЛОБАЛЬНАЯ БАЗА СПАММЕРОВ
    # ─────────────────────────────────────────────────────────
    # True = добавлять нарушителя в глобальную БД спаммеров бота
    # Это позволяет мутить/банить спаммера во всех группах где бот админ
    # Используется вместе со SpammerRecord из mute_models.py
    add_to_spammer_db = Column(Boolean, default=False, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ВРЕМЕННЫЕ МЕТКИ
    # ─────────────────────────────────────────────────────────
    # Когда раздел был создан
    created_at = Column(DateTime, default=utcnow, nullable=False)
    # Когда раздел был последний раз обновлён
    updated_at = Column(DateTime, default=utcnow, onupdate=utcnow, nullable=False)

    # ─────────────────────────────────────────────────────────
    # АУДИТ
    # ─────────────────────────────────────────────────────────
    # ID админа который создал раздел
    created_by = Column(BigInteger, nullable=True)

    # ─────────────────────────────────────────────────────────
    # СВЯЗИ ORM
    # ─────────────────────────────────────────────────────────
    # Связь с таблицей Group
    group = relationship("Group", backref="custom_spam_sections")
    # Связь с паттернами раздела
    patterns = relationship(
        "CustomSectionPattern",
        back_populates="section",
        cascade="all, delete-orphan"
    )
    # Связь с порогами баллов раздела
    thresholds = relationship(
        "CustomSectionThreshold",
        back_populates="section",
        cascade="all, delete-orphan"
    )

    # ─────────────────────────────────────────────────────────
    # ОГРАНИЧЕНИЯ И ИНДЕКСЫ
    # ─────────────────────────────────────────────────────────
    __table_args__ = (
        # Уникальное ограничение: одно название раздела один раз в группе
        UniqueConstraint('chat_id', 'name', name='uq_custom_section_chat_name'),
        # Индекс для поиска активных разделов группы
        Index('ix_custom_sections_chat_enabled', 'chat_id', 'enabled'),
    )


# ============================================================
# МОДЕЛЬ: ПАТТЕРН КАСТОМНОГО РАЗДЕЛА
# ============================================================
# Хранит паттерны для кастомных разделов спама.
# Аналогично ScamPattern, но привязан к разделу.
class CustomSectionPattern(Base, ExportableMixin):
    # Имя таблицы в базе данных
    __tablename__ = 'custom_section_patterns'

    # ─── Настройки экспорта ───
    # Дочерняя модель - привязана к CustomSpamSection через section_id
    __export_key__ = 'custom_section_patterns'
    __export_order__ = 300  # Импортируется после родителя
    __export_parent_key__ = 'custom_spam_sections'
    __export_parent_column__ = 'section_id'

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY: Автоинкрементный ID
    # ─────────────────────────────────────────────────────────
    id = Column(Integer, primary_key=True, autoincrement=True)

    # ─────────────────────────────────────────────────────────
    # FOREIGN KEY: ID раздела
    # ─────────────────────────────────────────────────────────
    # Привязка паттерна к конкретному разделу
    # ondelete=CASCADE - при удалении раздела удаляются и паттерны
    section_id = Column(
        Integer,
        ForeignKey("custom_spam_sections.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )

    # ─────────────────────────────────────────────────────────
    # ПАТТЕРН (текст для поиска)
    # ─────────────────────────────────────────────────────────
    # Оригинальный паттерн как его ввёл админ
    # Может быть словом, фразой или regex
    pattern = Column(String(500), nullable=False)

    # Нормализованная версия паттерна для поиска
    # Приведена к нижнему регистру, без лишних пробелов
    normalized = Column(String(500), nullable=False, index=True)

    # ─────────────────────────────────────────────────────────
    # ТИП ПАТТЕРНА
    # ─────────────────────────────────────────────────────────
    # Как искать этот паттерн в тексте:
    # - "word" = как отдельное слово (с границами слова)
    # - "phrase" = как подстроку (в любом месте текста)
    # - "regex" = как регулярное выражение
    pattern_type = Column(String(20), default='phrase', nullable=False)

    # ─────────────────────────────────────────────────────────
    # ВЕС ПАТТЕРНА (влияет на скор)
    # ─────────────────────────────────────────────────────────
    # Сколько баллов добавить к скору если паттерн сработал
    # По умолчанию 25 - средний вес для фразы
    weight = Column(Integer, default=25, nullable=False)

    # ─────────────────────────────────────────────────────────
    # АКТИВНОСТЬ ПАТТЕРНА
    # ─────────────────────────────────────────────────────────
    # True = паттерн активен и используется при проверке
    # False = паттерн временно отключён
    is_active = Column(Boolean, default=True, nullable=False)

    # ─────────────────────────────────────────────────────────
    # СТАТИСТИКА СРАБАТЫВАНИЙ
    # ─────────────────────────────────────────────────────────
    # Сколько раз этот паттерн сработал
    triggers_count = Column(Integer, default=0, nullable=False)
    # Когда последний раз сработал
    last_triggered_at = Column(DateTime, nullable=True)

    # ─────────────────────────────────────────────────────────
    # ВРЕМЕННЫЕ МЕТКИ
    # ─────────────────────────────────────────────────────────
    # Когда паттерн был добавлен
    created_at = Column(DateTime, default=utcnow, nullable=False)

    # ─────────────────────────────────────────────────────────
    # АУДИТ
    # ─────────────────────────────────────────────────────────
    # ID пользователя который добавил этот паттерн
    created_by = Column(BigInteger, nullable=True)

    # ─────────────────────────────────────────────────────────
    # СВЯЗИ ORM
    # ─────────────────────────────────────────────────────────
    # Связь с разделом
    section = relationship("CustomSpamSection", back_populates="patterns")

    # ─────────────────────────────────────────────────────────
    # ОГРАНИЧЕНИЯ И ИНДЕКСЫ
    # ─────────────────────────────────────────────────────────
    __table_args__ = (
        # Уникальное ограничение: один паттерн один раз в разделе
        UniqueConstraint('section_id', 'pattern', name='uq_section_pattern'),
        # Составной индекс для поиска активных паттернов раздела
        Index('ix_section_patterns_section_active', 'section_id', 'is_active'),
    )


# ============================================================
# ПОРОГИ БАЛЛОВ ДЛЯ КАСТОМНЫХ РАЗДЕЛОВ
# ============================================================
# Аналог ScamScoreThreshold но для CustomSpamSection
#
# Позволяет задать разные действия для разных диапазонов скора:
# - 100-199 баллов → удалить
# - 200-299 баллов → мут
# - 300+ баллов → бан
#
# Логика работы:
# 1. CustomSectionChecker считает итоговый score для раздела
# 2. Ищем порог где min_score <= score <= max_score
# 3. Если найден → применяем action из порога
# 4. Если НЕ найден → используем action из CustomSpamSection
class CustomSectionThreshold(Base, ExportableMixin):
    # Имя таблицы в базе данных
    __tablename__ = 'custom_section_thresholds'

    # ─── Настройки экспорта ───
    # Дочерняя модель - привязана к CustomSpamSection через section_id
    __export_key__ = 'custom_section_thresholds'
    __export_order__ = 301  # Импортируется после родителя
    __export_parent_key__ = 'custom_spam_sections'
    __export_parent_column__ = 'section_id'

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY: Автоинкрементный ID
    # ─────────────────────────────────────────────────────────
    id = Column(Integer, primary_key=True, autoincrement=True)

    # ─────────────────────────────────────────────────────────
    # FOREIGN KEY: ID раздела
    # ─────────────────────────────────────────────────────────
    # Привязка порога к конкретному разделу
    # ondelete=CASCADE - при удалении раздела удаляются и пороги
    section_id = Column(
        Integer,
        ForeignKey("custom_spam_sections.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )

    # ─────────────────────────────────────────────────────────
    # ДИАПАЗОН БАЛЛОВ
    # ─────────────────────────────────────────────────────────
    # Минимальный порог баллов (включительно)
    # Пример: min_score=100 означает score >= 100
    min_score = Column(Integer, nullable=False)

    # Максимальный порог баллов (включительно)
    # NULL = без верхнего ограничения (∞)
    # Пример: max_score=199 означает score <= 199
    max_score = Column(Integer, nullable=True)

    # ─────────────────────────────────────────────────────────
    # ДЕЙСТВИЕ ПРИ СРАБАТЫВАНИИ
    # ─────────────────────────────────────────────────────────
    # Что делать если score попадает в этот диапазон:
    # - "delete" = только удалить сообщение
    # - "mute" = удалить + замутить
    # - "ban" = удалить + забанить
    action = Column(String(20), default='delete', nullable=False)

    # Длительность мута в минутах (только для action='mute')
    # 60 = 1 час, 1440 = 24 часа
    mute_duration = Column(Integer, nullable=True)

    # ─────────────────────────────────────────────────────────
    # АКТИВНОСТЬ ПОРОГА
    # ─────────────────────────────────────────────────────────
    # True = порог активен и используется
    # False = порог отключён (не удалён, но не применяется)
    enabled = Column(Boolean, default=True, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ВРЕМЕННЫЕ МЕТКИ
    # ─────────────────────────────────────────────────────────
    created_at = Column(DateTime, default=utcnow, nullable=False)

    # ID пользователя который создал порог
    created_by = Column(BigInteger, nullable=True)

    # ─────────────────────────────────────────────────────────
    # СВЯЗИ ORM
    # ─────────────────────────────────────────────────────────
    section = relationship("CustomSpamSection", back_populates="thresholds")

    # ─────────────────────────────────────────────────────────
    # ОГРАНИЧЕНИЯ
    # ─────────────────────────────────────────────────────────
    __table_args__ = (
        # Индекс для быстрого поиска активных порогов раздела
        Index('ix_section_thresholds_section_enabled', 'section_id', 'enabled'),
    )


# ============================================================
# ПЕРЕОПРЕДЕЛЕНИЕ БАЗОВЫХ СИГНАЛОВ (УБИРАЕМ ХАРДКОД)
# ============================================================
# Позволяет группам настраивать поведение базовых SCAM_SIGNALS
# из scam_detector.py вместо использования хардкоженных значений.
#
# Базовые сигналы: money_amount, income_period, easy_money и т.д.
# Для каждого сигнала можно:
# - Включить/выключить (enabled)
# - Изменить вес (weight_override)
#
# Если переопределения нет - используется значение из кода.
class BaseSignalOverride(Base):
    # Имя таблицы в базе данных
    __tablename__ = 'base_signal_overrides'

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY: Автоинкрементный ID
    # ─────────────────────────────────────────────────────────
    id = Column(Integer, primary_key=True, autoincrement=True)

    # ─────────────────────────────────────────────────────────
    # FOREIGN KEY: ID группы
    # ─────────────────────────────────────────────────────────
    # Привязка настройки к конкретной группе
    chat_id = Column(
        BigInteger,
        ForeignKey("groups.chat_id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )

    # ─────────────────────────────────────────────────────────
    # НАЗВАНИЕ СИГНАЛА
    # ─────────────────────────────────────────────────────────
    # Имя сигнала из SCAM_SIGNALS (например: "money_amount", "crypto")
    signal_name = Column(String(50), nullable=False)

    # ─────────────────────────────────────────────────────────
    # ПЕРЕОПРЕДЕЛЁННЫЙ ВЕС
    # ─────────────────────────────────────────────────────────
    # Если не NULL — используется вместо хардкоженного веса
    # NULL означает "использовать стандартный вес"
    weight_override = Column(Integer, nullable=True)

    # ─────────────────────────────────────────────────────────
    # АКТИВНОСТЬ СИГНАЛА
    # ─────────────────────────────────────────────────────────
    # False = сигнал отключён для этой группы
    # True = сигнал активен (по умолчанию)
    enabled = Column(Boolean, default=True, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ВРЕМЕННЫЕ МЕТКИ
    # ─────────────────────────────────────────────────────────
    created_at = Column(DateTime, default=utcnow, nullable=False)
    updated_at = Column(DateTime, default=utcnow, onupdate=utcnow, nullable=False)

    # ID пользователя который создал/изменил настройку
    updated_by = Column(BigInteger, nullable=True)

    # ─────────────────────────────────────────────────────────
    # СВЯЗИ ORM
    # ─────────────────────────────────────────────────────────
    group = relationship("Group", backref="base_signal_overrides")

    # ─────────────────────────────────────────────────────────
    # ОГРАНИЧЕНИЯ
    # ─────────────────────────────────────────────────────────
    __table_args__ = (
        # Уникальное ограничение: один сигнал один раз для группы
        UniqueConstraint('chat_id', 'signal_name', name='uq_chat_signal'),
        # Индекс для быстрого поиска настроек группы
        Index('ix_base_signal_overrides_chat', 'chat_id'),
    )