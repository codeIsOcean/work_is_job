# ============================================================
# МОДЕЛЬ СТАТИСТИКИ ПОЛЬЗОВАТЕЛЕЙ В ГРУППАХ
# ============================================================
# Этот файл содержит модель UserStatistics для хранения счётчиков
# сообщений и дней активности пользователей.
#
# ВАЖНО: Эта таблица ПОЛНОСТЬЮ ИЗОЛИРОВАНА от profile_snapshots!
# Мы только ЧИТАЕМ из profile_snapshots (joined_at, first_message_at),
# но НИКОГДА не модифицируем profile_snapshots из этого модуля.
#
# Используется командой /stat для вывода статистики пользователя.
# ============================================================

# Импортируем Column для определения колонок таблицы
from sqlalchemy import Column
# Импортируем типы данных для колонок
from sqlalchemy import Integer, BigInteger, DateTime
# Импортируем UniqueConstraint для уникального ограничения
from sqlalchemy import UniqueConstraint
# Импортируем Index для создания индексов (ускорение поиска)
from sqlalchemy import Index

# Импортируем базовый класс Base и функцию utcnow из основных моделей
# Base - базовый класс от которого наследуются все модели
# utcnow - функция возвращающая текущее UTC время (naive datetime)
from bot.database.models import Base, utcnow


# ============================================================
# МОДЕЛЬ: СТАТИСТИКА ПОЛЬЗОВАТЕЛЯ В ГРУППЕ
# ============================================================
# Хранит счётчики сообщений и дней активности для каждого
# пользователя в каждой группе отдельно.
# Одна запись = один пользователь в одной группе.
class UserStatistics(Base):
    """
    Статистика пользователя в конкретной группе.

    Отдельная таблица для изоляции от profile_snapshots.
    Это позволяет безопасно разрабатывать функционал /stat
    без риска поломки модуля Profile Monitor.
    """

    # Имя таблицы в базе данных PostgreSQL
    __tablename__ = "user_statistics"

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY: Автоинкрементный ID
    # ─────────────────────────────────────────────────────────
    # Используем автоинкрементный ID как первичный ключ
    # Это стандартный подход для таблиц с составным уникальным ключом
    id = Column(Integer, primary_key=True, index=True)

    # ─────────────────────────────────────────────────────────
    # ИДЕНТИФИКАТОРЫ: chat_id + user_id
    # ─────────────────────────────────────────────────────────
    # ID группы где считаем статистику
    # Индекс для быстрого поиска по группе
    chat_id = Column(BigInteger, nullable=False, index=True)

    # ID пользователя которому принадлежит статистика
    # Индекс для быстрого поиска по пользователю
    user_id = Column(BigInteger, nullable=False, index=True)

    # ─────────────────────────────────────────────────────────
    # СЧЁТЧИКИ СООБЩЕНИЙ
    # ─────────────────────────────────────────────────────────
    # Общее количество сообщений от пользователя в группе
    # Инкрементируется при каждом сообщении в group_message_coordinator
    # default=0 - начинаем с нуля
    message_count = Column(Integer, default=0, nullable=False)

    # Время последнего сообщения от пользователя
    # Обновляется при каждом сообщении
    # nullable=True - может быть NULL если ещё не было сообщений
    last_message_at = Column(DateTime, nullable=True)

    # ─────────────────────────────────────────────────────────
    # ДНИ АКТИВНОСТИ
    # ─────────────────────────────────────────────────────────
    # Количество уникальных дней когда пользователь писал сообщения
    # Например: писал 3 дня из 10 → active_days = 3
    # Используется для определения "постоянных" участников
    active_days = Column(Integer, default=0, nullable=False)

    # Дата последнего дня активности (для подсчёта уникальных дней)
    # Если last_active_date != сегодня → увеличиваем active_days
    # Храним только дату без времени (но используем DateTime для совместимости)
    last_active_date = Column(DateTime, nullable=True)

    # ─────────────────────────────────────────────────────────
    # ВРЕМЕННЫЕ МЕТКИ
    # ─────────────────────────────────────────────────────────
    # Когда запись была создана (первое сообщение пользователя)
    created_at = Column(DateTime, default=utcnow, nullable=False)

    # Когда запись была последний раз обновлена
    # onupdate=utcnow автоматически обновляет при любом UPDATE
    updated_at = Column(DateTime, default=utcnow, onupdate=utcnow, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ОГРАНИЧЕНИЯ И ИНДЕКСЫ
    # ─────────────────────────────────────────────────────────
    __table_args__ = (
        # Уникальное ограничение: один пользователь - одна запись в группе
        # Предотвращает дубликаты и обеспечивает целостность данных
        UniqueConstraint('chat_id', 'user_id', name='uq_user_statistics_chat_user'),

        # Составной индекс для быстрого поиска по chat_id + user_id
        # Ускоряет основной запрос: "статистика пользователя X в группе Y"
        Index('ix_user_statistics_chat_user', 'chat_id', 'user_id'),
    )

    def __repr__(self):
        """Строковое представление для отладки."""
        return (
            f"<UserStatistics("
            f"chat_id={self.chat_id}, "
            f"user_id={self.user_id}, "
            f"messages={self.message_count}, "
            f"active_days={self.active_days}"
            f")>"
        )