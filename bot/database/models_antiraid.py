# ============================================================
# МОДЕЛИ БАЗЫ ДАННЫХ ДЛЯ МОДУЛЯ ANTI-RAID
# ============================================================
# Этот файл содержит все SQLAlchemy модели для модуля Anti-Raid:
# - AntiRaidSettings: настройки модуля для каждой группы
# - AntiRaidNamePattern: паттерны имён для бана при входе
#
# Модуль Anti-Raid защищает группу от:
# 1. Частых входов/выходов (join/exit abuse)
# 2. Бана по паттернам имени (name pattern ban)
# 3. Массовых вступлений (mass join / raid)
# 4. Массовых инвайтов (mass invite)
# 5. Массовых реакций (mass reaction)
# ============================================================

# Импортируем Column для определения колонок таблицы
from sqlalchemy import Column
# Импортируем типы данных для колонок
from sqlalchemy import Integer, String, BigInteger, Boolean, DateTime
# Импортируем ForeignKey для связей между таблицами
from sqlalchemy import ForeignKey
# Импортируем Index для создания индексов (ускорение поиска)
from sqlalchemy import Index
# Импортируем func для SQL функций (now(), etc.)
from sqlalchemy import func

# Импортируем базовый класс Base из основных моделей
# Base - базовый класс от которого наследуются все модели
from bot.database.models import Base

# Импортируем миксин для автоматического экспорта моделей
# ExportableMixin позволяет экспортировать/импортировать настройки между группами
from bot.database.exportable_mixin import ExportableMixin


# ============================================================
# МОДЕЛЬ: НАСТРОЙКИ ANTI-RAID ДЛЯ ГРУППЫ
# ============================================================
# Хранит все настройки модуля Anti-Raid для конкретной группы
# Каждая группа имеет свои независимые настройки (per-group)
# Все числовые параметры настраиваемые — БЕЗ ХАРДКОДА!
class AntiRaidSettings(Base, ExportableMixin):
    # Имя таблицы в базе данных PostgreSQL
    __tablename__ = 'antiraid_settings'

    # ─── Настройки экспорта ───
    # Ключ в JSON файле экспорта
    __export_key__ = 'antiraid_settings'
    # Порядок экспорта: 120 — после основных настроек (100), перед данными (200+)
    __export_order__ = 120
    # True = одна запись на группу (настройки)
    __export_is_settings__ = True

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY: уникальный идентификатор записи
    # ─────────────────────────────────────────────────────────
    id = Column(Integer, primary_key=True)

    # ─────────────────────────────────────────────────────────
    # CHAT_ID: идентификатор группы
    # ─────────────────────────────────────────────────────────
    # Уникальный — одна запись настроек на группу
    # Индексируем для быстрого поиска по группе
    chat_id = Column(
        BigInteger,
        unique=True,
        nullable=False,
        index=True
    )

    # ═══════════════════════════════════════════════════════════
    # РАЗДЕЛ 1: ЧАСТЫЕ ВХОДЫ/ВЫХОДЫ (JOIN/EXIT ABUSE)
    # ═══════════════════════════════════════════════════════════
    # Защита от ботов которые быстро входят-выходят
    # чтобы "засветить" имя (с рекламой) в приветствии

    # Включён ли этот компонент защиты
    # По умолчанию выключен — админ должен явно включить
    join_exit_enabled = Column(
        Boolean,
        server_default='false',
        nullable=False
    )

    # Временное окно в секундах для подсчёта событий
    # Дефолт: 60 секунд — события за последнюю минуту
    # Админ может изменить через UI
    join_exit_window = Column(
        Integer,
        server_default='60',
        nullable=False
    )

    # Порог срабатывания — макс. событий (входов+выходов) за окно
    # Дефолт: 3 события — 3 входа/выхода за минуту = точно бот
    # Админ может изменить через UI
    join_exit_threshold = Column(
        Integer,
        server_default='3',
        nullable=False
    )

    # Действие при срабатывании: 'kick', 'ban', 'mute'
    # Дефолт: 'ban' — бан чтобы не вернулся
    join_exit_action = Column(
        String(20),
        server_default='ban',
        nullable=False
    )

    # Длительность бана в часах (0 = навсегда)
    # Дефолт: 168 часов (7 дней)
    # Админ может изменить через UI
    join_exit_ban_duration = Column(
        Integer,
        server_default='168',
        nullable=False
    )

    # ═══════════════════════════════════════════════════════════
    # РАЗДЕЛ 2: БАН ПО ПАТТЕРНАМ ИМЕНИ (NAME PATTERN BAN)
    # ═══════════════════════════════════════════════════════════
    # Мгновенный бан при входе если имя содержит запрещённые паттерны
    # Паттерны хранятся в отдельной таблице AntiRaidNamePattern

    # Включён ли этот компонент защиты
    # По умолчанию выключен — админ должен добавить паттерны и включить
    name_pattern_enabled = Column(
        Boolean,
        server_default='false',
        nullable=False
    )

    # Действие при срабатывании: 'kick', 'ban'
    # Дефолт: 'ban' — педо-контент = перманент
    name_pattern_action = Column(
        String(20),
        server_default='ban',
        nullable=False
    )

    # Длительность бана в часах (0 = навсегда)
    # Дефолт: 0 (навсегда) — педо-контент не прощаем
    name_pattern_ban_duration = Column(
        Integer,
        server_default='0',
        nullable=False
    )

    # ═══════════════════════════════════════════════════════════
    # РАЗДЕЛ 3: МАССОВЫЕ ВСТУПЛЕНИЯ (MASS JOIN / RAID)
    # ═══════════════════════════════════════════════════════════
    # Защита от рейдов — когда много юзеров вступают одновременно
    # v2: при превышении порога включается "режим защиты" — все новые вступления = бан

    # Включён ли этот компонент защиты
    mass_join_enabled = Column(
        Boolean,
        server_default='false',
        nullable=False
    )

    # Временное окно в секундах для подсчёта вступлений
    # Дефолт: 60 секунд
    mass_join_window = Column(
        Integer,
        server_default='60',
        nullable=False
    )

    # Порог срабатывания — макс. вступлений за окно
    # Дефолт: 10 вступлений за минуту = рейд
    mass_join_threshold = Column(
        Integer,
        server_default='10',
        nullable=False
    )

    # Действие при рейде: 'ban', 'kick', 'slowmode', 'lock', 'notify'
    # - ban: забанить всех участников рейда (рекомендуется)
    # - kick: кикнуть без бана
    # - slowmode: включить режим медленных сообщений
    # - lock: закрыть группу для новых участников
    # - notify: только уведомить админов
    # Дефолт: 'ban' — банить рейдеров
    mass_join_action = Column(
        String(20),
        server_default='ban',
        nullable=False
    )

    # Длительность режима защиты в секундах
    # После детекции рейда все новые вступления банятся в течение этого времени
    # Дефолт: 180 секунд (3 минуты)
    # Админ может изменить через UI
    mass_join_protection_duration = Column(
        Integer,
        server_default='180',
        nullable=False
    )

    # Длительность бана при рейде в часах (0 = навсегда)
    # Дефолт: 0 (перманентный бан для рейдеров)
    # Админ может изменить через UI
    mass_join_ban_duration = Column(
        Integer,
        server_default='0',
        nullable=False
    )

    # Значение slowmode в секундах (для action='slowmode')
    # Дефолт: 60 секунд — замедлить атаку
    mass_join_slowmode = Column(
        Integer,
        server_default='60',
        nullable=False
    )

    # Авто-снятие ограничений через N минут (0 = вручную)
    # Дефолт: 30 минут — автоматически вернуть нормальный режим
    mass_join_auto_unlock = Column(
        Integer,
        server_default='30',
        nullable=False
    )

    # ═══════════════════════════════════════════════════════════
    # РАЗДЕЛ 4: МАССОВЫЕ ИНВАЙТЫ (MASS INVITE)
    # ═══════════════════════════════════════════════════════════
    # Защита от юзера который приглашает слишком много людей

    # Включён ли этот компонент защиты
    mass_invite_enabled = Column(
        Boolean,
        server_default='false',
        nullable=False
    )

    # Временное окно в секундах для подсчёта инвайтов
    # Дефолт: 300 секунд (5 минут) — инвайты медленнее чем joins
    mass_invite_window = Column(
        Integer,
        server_default='300',
        nullable=False
    )

    # Порог срабатывания — макс. инвайтов от одного юзера за окно
    # Дефолт: 5 инвайтов за 5 минут = подозрительно
    mass_invite_threshold = Column(
        Integer,
        server_default='5',
        nullable=False
    )

    # Действие при срабатывании: 'warn', 'kick', 'ban'
    # Дефолт: 'warn' — сначала предупреждение
    mass_invite_action = Column(
        String(20),
        server_default='warn',
        nullable=False
    )

    # Длительность бана в часах (для action='ban', 0 = навсегда)
    # Дефолт: 24 часа
    mass_invite_ban_duration = Column(
        Integer,
        server_default='24',
        nullable=False
    )

    # ═══════════════════════════════════════════════════════════
    # РАЗДЕЛ 5: МАССОВЫЕ РЕАКЦИИ (MASS REACTION)
    # ═══════════════════════════════════════════════════════════
    # Защита от спама реакциями
    # v2: Паттерн спаммера — ставит по 1 реакции на разные сообщения (идёт вниз по чату)
    # Цель спаммера: чтобы авторы сообщений увидели уведомление и зашли в профиль

    # Включён ли этот компонент защиты
    mass_reaction_enabled = Column(
        Boolean,
        server_default='false',
        nullable=False
    )

    # Временное окно в секундах для подсчёта реакций
    # Дефолт: 60 секунд
    mass_reaction_window = Column(
        Integer,
        server_default='60',
        nullable=False
    )

    # Порог срабатывания — на сколько РАЗНЫХ сообщений за окно
    # Паттерн спаммера: ставит по 1 реакции на разные сообщения
    # Дефолт: 5 разных сообщений за окно = спам реакциями
    # Админ может изменить через UI
    mass_reaction_threshold = Column(
        Integer,
        server_default='5',
        nullable=False
    )

    # Действие при срабатывании: 'ban', 'kick', 'mute', 'warn'
    # - ban: забанить спаммера (рекомендуется)
    # - kick: кикнуть без бана
    # - mute: временно ограничить
    # - warn: только предупреждение
    # Дефолт: 'ban' — банить спаммеров реакциями
    mass_reaction_action = Column(
        String(20),
        server_default='ban',
        nullable=False
    )

    # Длительность бана в часах (для action='ban', 0 = навсегда)
    # Дефолт: 0 (перманентный бан для спаммеров)
    # Админ может изменить через UI
    mass_reaction_ban_duration = Column(
        Integer,
        server_default='0',
        nullable=False
    )

    # ═══════════════════════════════════════════════════════════
    # СЛУЖЕБНЫЕ ПОЛЯ
    # ═══════════════════════════════════════════════════════════

    # Дата создания записи (автоматически при INSERT)
    created_at = Column(
        DateTime,
        server_default=func.now(),
        nullable=False
    )

    # Дата последнего обновления (автоматически при UPDATE)
    updated_at = Column(
        DateTime,
        onupdate=func.now(),
        nullable=True
    )

    def __repr__(self) -> str:
        """Строковое представление для отладки."""
        return f"<AntiRaidSettings chat_id={self.chat_id}>"


# ============================================================
# МОДЕЛЬ: ПАТТЕРНЫ ИМЁН ДЛЯ БАНА ПРИ ВХОДЕ
# ============================================================
# Хранит паттерны для проверки имён при входе в группу
# Если имя юзера матчит паттерн — мгновенный бан
# Паттерны настраиваемые через UI (без хардкода!)
class AntiRaidNamePattern(Base, ExportableMixin):
    # Имя таблицы в базе данных PostgreSQL
    __tablename__ = 'antiraid_name_patterns'

    # ─── Настройки экспорта ───
    # Ключ в JSON файле экспорта
    __export_key__ = 'antiraid_name_patterns'
    # Порядок экспорта: 420 — после настроек (120), как данные
    __export_order__ = 420
    # False = много записей на группу (паттерны)
    __export_is_settings__ = False

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY: уникальный идентификатор паттерна
    # ─────────────────────────────────────────────────────────
    id = Column(Integer, primary_key=True)

    # ─────────────────────────────────────────────────────────
    # CHAT_ID: идентификатор группы
    # ─────────────────────────────────────────────────────────
    # Паттерны привязаны к конкретной группе (per-group)
    # Индексируем для быстрого поиска по группе
    chat_id = Column(
        BigInteger,
        nullable=False,
        index=True
    )

    # ─────────────────────────────────────────────────────────
    # ПАТТЕРН: текст или regex для проверки имени
    # ─────────────────────────────────────────────────────────
    # Пример: "детск", "педо", "cp" — то что ищем в имени
    # Будет применяться нормализация перед сравнением
    pattern = Column(
        String(255),
        nullable=False
    )

    # ─────────────────────────────────────────────────────────
    # ТИП ПАТТЕРНА: как проверять совпадение
    # ─────────────────────────────────────────────────────────
    # 'contains' — имя содержит паттерн (с нормализацией)
    # 'regex' — имя матчит regex
    # 'exact' — точное совпадение (редко используется)
    # Дефолт: 'contains' — самый частый случай
    pattern_type = Column(
        String(20),
        server_default='contains',
        nullable=False
    )

    # ─────────────────────────────────────────────────────────
    # ВКЛЮЧЁН ЛИ ПАТТЕРН
    # ─────────────────────────────────────────────────────────
    # Можно временно отключить паттерн без удаления
    is_enabled = Column(
        Boolean,
        server_default='true',
        nullable=False
    )

    # ─────────────────────────────────────────────────────────
    # КТО ДОБАВИЛ (опционально)
    # ─────────────────────────────────────────────────────────
    # user_id админа который добавил паттерн
    created_by = Column(
        BigInteger,
        nullable=True
    )

    # ─────────────────────────────────────────────────────────
    # ДАТА СОЗДАНИЯ
    # ─────────────────────────────────────────────────────────
    created_at = Column(
        DateTime,
        server_default=func.now(),
        nullable=False
    )

    # ─────────────────────────────────────────────────────────
    # ИНДЕКСЫ
    # ─────────────────────────────────────────────────────────
    # Составной индекс для быстрого поиска активных паттернов группы
    __table_args__ = (
        Index('ix_antiraid_name_patterns_chat_enabled', 'chat_id', 'is_enabled'),
    )

    def __repr__(self) -> str:
        """Строковое представление для отладки."""
        return f"<AntiRaidNamePattern id={self.id} chat_id={self.chat_id} pattern='{self.pattern}'>"
