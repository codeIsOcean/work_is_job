# ============================================================
# МОДЕЛИ БАЗЫ ДАННЫХ ДЛЯ МОДУЛЯ SCAM MEDIA (ФИЛЬТР ФОТО)
# ============================================================
# Этот файл содержит SQLAlchemy модели для фильтрации скам-фото:
# - ScamMediaSettings: настройки модуля для каждой группы
# - BannedImageHash: хеши запрещённых изображений
#
# Модуль использует perceptual hashing (pHash, dHash) для
# обнаружения скам-фото даже после изменения размера/сжатия.
#
# ВАЖНО: Это ОТДЕЛЬНЫЙ модуль, НЕ часть content_filter!
# Интеграция через group_message_coordinator.py
# ============================================================

# Импортируем Column для определения колонок таблицы
from sqlalchemy import Column
# Импортируем типы данных для колонок
from sqlalchemy import Integer, String, BigInteger, Boolean, DateTime, Text
# Импортируем ForeignKey для связей между таблицами
from sqlalchemy import ForeignKey
# Импортируем Index для создания индексов (ускорение поиска)
from sqlalchemy import Index

# Импортируем базовый класс Base и функцию utcnow из основных моделей
# Base - базовый класс от которого наследуются все модели
# utcnow - функция возвращающая текущее UTC время
from bot.database.models import Base, utcnow

# Импортируем миксин для автоматического экспорта моделей
from bot.database.exportable_mixin import ExportableMixin


# ============================================================
# МОДЕЛЬ: НАСТРОЙКИ SCAM MEDIA ДЛЯ ГРУППЫ
# ============================================================
# Хранит настройки модуля фильтрации скам-фото для конкретной группы
# Каждая группа имеет свои независимые настройки (мультитенантность)
class ScamMediaSettings(Base, ExportableMixin):
    # Имя таблицы в базе данных PostgreSQL
    __tablename__ = 'scam_media_settings'

    # ─── Настройки экспорта ───
    __export_key__ = 'scam_media_settings'
    __export_is_settings__ = True
    __export_order__ = 120

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY: ID группы (chat_id)
    # ─────────────────────────────────────────────────────────
    # Используем chat_id как первичный ключ (одна запись на группу)
    # ForeignKey связывает с таблицей groups
    # ondelete="CASCADE" - при удалении группы удаляются и настройки
    chat_id = Column(
        BigInteger,
        ForeignKey("groups.chat_id", ondelete="CASCADE"),
        primary_key=True
    )

    # ─────────────────────────────────────────────────────────
    # ГЛОБАЛЬНЫЙ ПЕРЕКЛЮЧАТЕЛЬ МОДУЛЯ
    # ─────────────────────────────────────────────────────────
    # True = модуль включён, False = выключен
    # По умолчанию выключен - админ должен явно включить
    enabled = Column(Boolean, default=False, nullable=False)

    # ─────────────────────────────────────────────────────────
    # РЕЖИМ БАЗЫ ХЕШЕЙ: ГЛОБАЛЬНЫЙ ИЛИ ЛОКАЛЬНЫЙ
    # ─────────────────────────────────────────────────────────
    # True = использовать глобальную базу (хеши работают во ВСЕХ группах)
    # False = использовать только локальную базу (хеши только для этой группы)
    # По умолчанию локальный режим - безопаснее
    use_global_hashes = Column(Boolean, default=False, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ДЕЙСТВИЕ ПРИ ОБНАРУЖЕНИИ СКАМ-ФОТО
    # ─────────────────────────────────────────────────────────
    # Что делать при срабатывании фильтра:
    # - "delete" = только удалить сообщение
    # - "delete_warn" = удалить + предупреждение
    # - "delete_mute" = удалить + мут на mute_duration секунд
    # - "delete_ban" = удалить + бан на ban_duration секунд (0 = навсегда)
    action = Column(String(20), default='delete_mute', nullable=False)

    # ─────────────────────────────────────────────────────────
    # ДЛИТЕЛЬНОСТЬ МУТА (В СЕКУНДАХ)
    # ─────────────────────────────────────────────────────────
    # Используется когда action = "delete_mute"
    # 86400 секунд = 24 часа (значение по умолчанию)
    # 0 = навсегда (перманентный мут)
    # Админ может ввести любое значение через UI
    mute_duration = Column(Integer, default=86400, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ДЛИТЕЛЬНОСТЬ БАНА (В СЕКУНДАХ)
    # ─────────────────────────────────────────────────────────
    # Используется когда action = "delete_ban"
    # 0 = навсегда (перманентный бан) - значение по умолчанию
    # Админ может ввести любое значение через UI
    ban_duration = Column(Integer, default=0, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ПОРОГ ПОХОЖЕСТИ (HAMMING DISTANCE)
    # ─────────────────────────────────────────────────────────
    # Максимальное расстояние Хэмминга для считания фото похожими
    # Чем меньше значение - тем строже совпадение
    # 0 = только точное совпадение хешей
    # 5 = небольшие изменения (рекомендуется)
    # 10 = умеренные изменения (сжатие, ресайз)
    # 15+ = значительные изменения (может давать false positives)
    # Админ может изменить через UI
    threshold = Column(Integer, default=10, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ПРОВЕРКА ПРЕВЬЮ ВИДЕО
    # ─────────────────────────────────────────────────────────
    # True = проверять thumbnail видео на совпадение с базой
    # False = проверять только фото, игнорировать превью видео
    # По умолчанию включено - скамеры часто шлют видео с теми же превью
    check_thumbnails = Column(Boolean, default=True, nullable=False)

    # ─────────────────────────────────────────────────────────
    # КАСТОМНЫЕ ТЕКСТЫ УВЕДОМЛЕНИЙ
    # ─────────────────────────────────────────────────────────
    # %user% будет заменён на имя/ссылку на нарушителя
    # %duration% будет заменён на время мута/бана
    # NULL = использовать текст по умолчанию

    # Текст при муте (action = "delete_mute")
    mute_text = Column(String(500), nullable=True)

    # Текст при бане (action = "delete_ban")
    ban_text = Column(String(500), nullable=True)

    # Текст предупреждения (action = "delete_warn")
    warn_text = Column(String(500), nullable=True)

    # ─────────────────────────────────────────────────────────
    # АВТОУДАЛЕНИЕ СИСТЕМНЫХ СООБЩЕНИЙ
    # ─────────────────────────────────────────────────────────
    # Через сколько секунд удалять уведомление бота
    # NULL = не удалять автоматически
    # Админ может задать любое значение через UI
    notification_delete_delay = Column(Integer, nullable=True)

    # ─────────────────────────────────────────────────────────
    # ДОБАВЛЕНИЕ В ГЛОБАЛЬНУЮ БД СКАММЕРОВ
    # ─────────────────────────────────────────────────────────
    # True = добавлять нарушителя в глобальную БД скаммеров
    # False = не добавлять (только локальное действие)
    # По умолчанию включено - помогает другим группам
    add_to_scammer_db = Column(Boolean, default=True, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ЛОГИРОВАНИЕ В ЖУРНАЛ
    # ─────────────────────────────────────────────────────────
    # True = отправлять записи о срабатываниях в журнал группы
    # False = не логировать (тихий режим)
    log_to_journal = Column(Boolean, default=True, nullable=False)


# ============================================================
# МОДЕЛЬ: ХЕШИ ЗАПРЕЩЁННЫХ ИЗОБРАЖЕНИЙ
# ============================================================
# Хранит perceptual hash (pHash + dHash) скам-изображений
# Используется для сравнения входящих фото с базой запрещённых
class BannedImageHash(Base, ExportableMixin):
    # Имя таблицы в базе данных PostgreSQL
    __tablename__ = 'banned_image_hashes'

    # ─── Настройки экспорта ───
    # Экспортируются только локальные хеши (где chat_id != NULL)
    __export_key__ = 'banned_image_hashes'
    __export_order__ = 440
    __export_exclude__ = ('id', 'added_at', 'added_by_user_id', 'added_by_username',
                          'matches_count', 'last_match_at')

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY: Автоинкрементный ID
    # ─────────────────────────────────────────────────────────
    id = Column(Integer, primary_key=True, autoincrement=True)

    # ─────────────────────────────────────────────────────────
    # PERCEPTUAL HASH (pHash)
    # ─────────────────────────────────────────────────────────
    # 64-битный хеш изображения в hex формате (16 символов)
    # pHash устойчив к ресайзу, сжатию, небольшим изменениям
    # Индекс для быстрого поиска
    phash = Column(String(16), nullable=False, index=True)

    # ─────────────────────────────────────────────────────────
    # DIFFERENCE HASH (dHash)
    # ─────────────────────────────────────────────────────────
    # 64-битный хеш изображения в hex формате (16 символов)
    # dHash дополняет pHash, ловит другие типы изменений
    # Вместе pHash + dHash дают лучшее покрытие
    # Может быть NULL если используется только pHash
    dhash = Column(String(16), nullable=True, index=True)

    # ─────────────────────────────────────────────────────────
    # РЕЖИМ: ГЛОБАЛЬНЫЙ ИЛИ ЛОКАЛЬНЫЙ
    # ─────────────────────────────────────────────────────────
    # True = хеш работает во ВСЕХ группах где включён глобальный режим
    # False = хеш работает только в группе chat_id
    is_global = Column(Boolean, default=False, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ID ГРУППЫ (для локальных хешей)
    # ─────────────────────────────────────────────────────────
    # chat_id группы где был добавлен хеш
    # NULL = глобальный хеш (is_global = True)
    # ForeignKey НЕ используем - группа может быть удалена, хеш остаётся
    chat_id = Column(BigInteger, nullable=True, index=True)

    # ─────────────────────────────────────────────────────────
    # КТО ДОБАВИЛ ХЕШ
    # ─────────────────────────────────────────────────────────
    # user_id админа который добавил фото в базу
    added_by_user_id = Column(BigInteger, nullable=False)

    # username админа (может быть NULL если нет username)
    added_by_username = Column(String(255), nullable=True)

    # ─────────────────────────────────────────────────────────
    # ДАТА ДОБАВЛЕНИЯ
    # ─────────────────────────────────────────────────────────
    # UTC timestamp когда хеш был добавлен в базу
    added_at = Column(DateTime, default=utcnow, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ОПИСАНИЕ (ОПЦИОНАЛЬНО)
    # ─────────────────────────────────────────────────────────
    # Текстовое описание что это за фото
    # Например: "VIP Kazashki spam", "Narcotics ad"
    # Помогает админам понимать что в базе
    description = Column(String(255), nullable=True)

    # ─────────────────────────────────────────────────────────
    # ДЕТЕКЦИЯ ЛОГО (ОПЦИОНАЛЬНО)
    # ─────────────────────────────────────────────────────────
    # Если это хеш для области лого, а не всего изображения
    # NULL = хеш всего изображения
    # 'top_left', 'top_right', 'bottom_left', 'bottom_right',
    # 'top_center', 'bottom_center' = хеш конкретной области
    logo_region = Column(String(20), nullable=True)

    # ─────────────────────────────────────────────────────────
    # СТАТИСТИКА: КОЛИЧЕСТВО СРАБАТЫВАНИЙ
    # ─────────────────────────────────────────────────────────
    # Счётчик сколько раз этот хеш сработал
    # Помогает понять какие фото чаще используют скамеры
    matches_count = Column(Integer, default=0, nullable=False)

    # ─────────────────────────────────────────────────────────
    # СТАТИСТИКА: ПОСЛЕДНЕЕ СРАБАТЫВАНИЕ
    # ─────────────────────────────────────────────────────────
    # UTC timestamp последнего срабатывания
    # NULL = ещё ни разу не сработал
    # Используется для очистки неактивных хешей (90+ дней)
    last_match_at = Column(DateTime, nullable=True)

    # ─────────────────────────────────────────────────────────
    # ИНДЕКСЫ ДЛЯ БЫСТРОГО ПОИСКА
    # ─────────────────────────────────────────────────────────
    # Составной индекс для поиска локальных хешей группы
    __table_args__ = (
        Index('ix_banned_image_hashes_chat_global', 'chat_id', 'is_global'),
    )


# ============================================================
# МОДЕЛЬ: ЛОГ СРАБАТЫВАНИЙ ФИЛЬТРА (ДЛЯ АНАЛИТИКИ)
# ============================================================
# Хранит историю всех срабатываний для аналитики и отчётов
# Можно использовать для уведомлений о неактивных хешах
class ScamMediaViolation(Base):
    # Имя таблицы в базе данных PostgreSQL
    __tablename__ = 'scam_media_violations'

    # ─────────────────────────────────────────────────────────
    # PRIMARY KEY: Автоинкрементный ID
    # ─────────────────────────────────────────────────────────
    id = Column(Integer, primary_key=True, autoincrement=True)

    # ─────────────────────────────────────────────────────────
    # ССЫЛКА НА СРАБОТАВШИЙ ХЕШ
    # ─────────────────────────────────────────────────────────
    # ID хеша который сработал
    # ForeignKey с CASCADE - при удалении хеша удаляются и логи
    hash_id = Column(
        Integer,
        ForeignKey("banned_image_hashes.id", ondelete="CASCADE"),
        nullable=False,
        index=True
    )

    # ─────────────────────────────────────────────────────────
    # ГРУППА ГДЕ ПРОИЗОШЛО СРАБАТЫВАНИЕ
    # ─────────────────────────────────────────────────────────
    chat_id = Column(BigInteger, nullable=False, index=True)

    # ─────────────────────────────────────────────────────────
    # НАРУШИТЕЛЬ
    # ─────────────────────────────────────────────────────────
    # user_id отправителя скам-фото
    user_id = Column(BigInteger, nullable=False, index=True)

    # username нарушителя (может быть NULL)
    username = Column(String(255), nullable=True)

    # Полное имя нарушителя
    full_name = Column(String(255), nullable=True)

    # ─────────────────────────────────────────────────────────
    # ИНФОРМАЦИЯ О СООБЩЕНИИ
    # ─────────────────────────────────────────────────────────
    # ID сообщения которое было удалено
    message_id = Column(BigInteger, nullable=True)

    # ─────────────────────────────────────────────────────────
    # РЕЗУЛЬТАТ СРАВНЕНИЯ
    # ─────────────────────────────────────────────────────────
    # Расстояние Хэмминга между хешами (0 = точное совпадение)
    hamming_distance = Column(Integer, nullable=False)

    # ─────────────────────────────────────────────────────────
    # ПРИМЕНЁННОЕ ДЕЙСТВИЕ
    # ─────────────────────────────────────────────────────────
    # Какое действие было применено (delete/delete_warn/delete_mute/delete_ban)
    action_taken = Column(String(20), nullable=False)

    # ─────────────────────────────────────────────────────────
    # ДАТА СРАБАТЫВАНИЯ
    # ─────────────────────────────────────────────────────────
    created_at = Column(DateTime, default=utcnow, nullable=False, index=True)

    # ─────────────────────────────────────────────────────────
    # ИНДЕКСЫ ДЛЯ АНАЛИТИКИ
    # ─────────────────────────────────────────────────────────
    __table_args__ = (
        # Индекс для поиска нарушений пользователя в группе
        Index('ix_scam_media_violations_chat_user', 'chat_id', 'user_id'),
    )
