# ============================================================
# GROUP MESSAGE COORDINATOR - Ğ•Ğ”Ğ˜ĞĞĞ¯ Ğ¢ĞĞ§ĞšĞ Ğ’Ğ¥ĞĞ”Ğ
# ============================================================
# Ğ­Ñ‚Ğ¾Ñ‚ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ¾Ñ€ Ñ€ĞµÑˆĞ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñƒ ĞºĞ¾Ğ½Ñ„Ğ»Ğ¸ĞºÑ‚Ğ° Ñ…ĞµĞ½Ğ´Ğ»ĞµÑ€Ğ¾Ğ² Ğ² aiogram 3.x:
# ĞºĞ¾Ğ³Ğ´Ğ° Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ…ĞµĞ½Ğ´Ğ»ĞµÑ€Ğ¾Ğ² Ğ¸Ğ¼ĞµÑÑ‚ Ğ¾Ğ´Ğ¸Ğ½Ğ°ĞºĞ¾Ğ²Ñ‹Ğ¹ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ (message + group),
# Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ÑÑ. ĞšĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ¾Ñ€ Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµÑ‚ Ğ¸Ñ… Ğ² Ğ¾Ğ´Ğ¸Ğ½.
#
# ĞŸĞ¾Ñ€ÑĞ´Ğ¾Ğº Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹:
# 1. ContentFilter (ÑĞ»Ğ¾Ğ²Ğ°, ÑĞºĞ°Ğ¼, Ñ„Ğ»ÑƒĞ´) - ĞµÑĞ»Ğ¸ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ», Antispam Ğ½Ğµ Ğ½ÑƒĞ¶ĞµĞ½
# 2. Antispam (ÑÑÑ‹Ğ»ĞºĞ¸, Ğ¿ĞµÑ€ĞµÑÑ‹Ğ»ĞºĞ¸, Ñ†Ğ¸Ñ‚Ğ°Ñ‚Ñ‹) - Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ CF Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ğ»
#
# Ğ­Ñ‚Ğ¾ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½ "Single Entry Point" / "Message Coordinator"
# ============================================================

# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Optional Ğ´Ğ»Ñ Ñ‚Ğ¸Ğ¿Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
from typing import Optional

# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Router Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ĞµĞ´Ğ¸Ğ½Ğ¾Ğ³Ğ¾ Ñ€Ğ¾ÑƒÑ‚ĞµÑ€Ğ°
from aiogram import Router, F
# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ¸Ğ¿Ñ‹ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
from aiogram.types import Message
# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ Telegram API
from aiogram.exceptions import TelegramAPIError
# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ»Ğ¾Ğ³Ğ³ĞµÑ€
import logging
# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ asyncio Ğ´Ğ»Ñ Ğ°ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ´Ğ°Ñ‡ (Ğ°Ğ²Ñ‚Ğ¾ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹)
import asyncio

# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ¸Ğ¿Ñ‹ SQLAlchemy
from sqlalchemy.ext.asyncio import AsyncSession

# ============================================================
# Ğ˜ĞœĞŸĞĞ Ğ¢ Ğ›ĞĞ“Ğ˜ĞšĞ˜ Ğ˜Ğ— Ğ¡Ğ£Ğ©Ğ•Ğ¡Ğ¢Ğ’Ğ£Ğ®Ğ©Ğ˜Ğ¥ ĞœĞĞ”Ğ£Ğ›Ğ•Ğ™
# ============================================================

# ContentFilter - Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ FilterManager Ğ¸ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹
from bot.services.content_filter import FilterManager
# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ Ğ¸Ğ· filter_handler
from bot.handlers.content_filter.filter_handler import (
    _apply_action as content_filter_apply_action,
    _send_journal_log as content_filter_send_journal_log,
    _filter_manager
)
# CrossMessageService - Ğ½Ğ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ¸Ğµ ÑĞºĞ¾Ñ€Ğ° Ñ‡ĞµÑ€ĞµĞ· Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
from bot.services.content_filter.cross_message_service import (
    CrossMessageService,
    get_cross_message_service,
    create_cross_message_service
)

# Antispam - Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¸ Ñ‚Ğ¸Ğ¿Ñ‹
from bot.services.antispam import check_message_for_spam, AntiSpamDecision
# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ¸Ğ¿Ñ‹ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹
from bot.database.models_antispam import ActionType
# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ¸Ğ· antispam_filter_handler
from bot.handlers.antispam_handlers.antispam_filter_handler import (
    schedule_message_deletion,
    get_warning_ttl,
    is_user_admin,
    # Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñ‹ Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ¶ÑƒÑ€Ğ½Ğ°Ğ»Ğ°
    create_journal_action_keyboard
)
# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² Ğ¶ÑƒÑ€Ğ½Ğ°Ğ» Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹
from bot.services.group_journal_service import send_journal_event

# MessageManagement - Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
from bot.handlers.message_management.filter_handler import (
    process_command_message,
    process_system_message,
    process_pin_event,
    is_system_message,
    is_command_message
)

# ProfileMonitor - Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ
from bot.handlers.profile_monitor.monitor_handler import (
    process_message_profile_check
)
# ProfileMonitor - Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ñ‚Ñ€ĞµĞºĞ¸Ğ½Ğ³Ğ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ
from bot.services.profile_monitor import track_user_message

# ĞšÑ€Ğ¾ÑÑ-Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¾Ğ²Ğ°Ñ Ğ´ĞµÑ‚ĞµĞºÑ†Ğ¸Ñ - Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ñ‚Ñ€ĞµĞºĞ¸Ğ½Ğ³Ğ° Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
from bot.services.cross_group.detection_service import (
    track_user_message as cross_group_track_message,
    check_cross_group_detection,
)
# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ´ĞµÑ‚ĞµĞºÑ†Ğ¸Ğ¸
from bot.services.cross_group.action_service import apply_cross_group_action

# UserStats - Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¸Ğ½ĞºÑ€ĞµĞ¼ĞµĞ½Ñ‚Ğ° ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
from bot.services.user_stats_service import increment_message_count

# ScamMedia - Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ ÑĞºĞ°Ğ¼-Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğ¹
from bot.handlers.scam_media import check_message_for_scam_media
# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½ÑƒÑ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ñ Ğ¼ĞµĞ´Ğ¸Ğ°
from bot.handlers.scam_media.filter_handler import has_media

# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ğ´Ğ»Ñ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ°Ğ² (Ğ¼ÑƒÑ‚) Ğ¸ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€
from aiogram.types import ChatPermissions, InlineKeyboardMarkup, InlineKeyboardButton
# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ ÑĞ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½ĞµĞ¼
from datetime import timedelta
# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¹
from aiogram.exceptions import TelegramBadRequest, TelegramForbiddenError

# ============================================================
# Ğ˜ĞœĞŸĞĞ Ğ¢ REDIS Ğ”Ğ›Ğ¯ ĞšĞ­Ğ¨Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ¯ ĞĞ’Ğ¢ĞĞ ĞĞ’ Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ™
# ============================================================
# ĞÑƒĞ¶Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ¼ÑƒÑ‚Ğ° Ğ¿Ğ¾ Ñ€ĞµĞ°ĞºÑ†Ğ¸ÑĞ¼: Telegram API Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‘Ñ‚ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ°
# ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ² ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¸ Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¸, Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ¼Ñƒ ĞºÑÑˆĞ¸Ñ€ÑƒĞµĞ¼ message_id â†’ user_id
from bot.services.redis_conn import redis
import inspect

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ»Ğ¾Ğ³Ğ³ĞµÑ€ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¼Ğ¾Ğ´ÑƒĞ»Ñ
logger = logging.getLogger(__name__)

# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ñ€Ğ¾ÑƒÑ‚ĞµÑ€ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ¾Ñ€Ğ°
# Ğ­Ñ‚Ğ¾Ñ‚ Ñ€Ğ¾ÑƒÑ‚ĞµÑ€ Ğ·Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚ content_filter_router Ğ¸ antispam_filter_router
group_message_coordinator_router = Router(name='group_message_coordinator')


# ============================================================
# Ğ’Ğ¡ĞŸĞĞœĞĞ“ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ«Ğ• Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜
# ============================================================

async def _is_admin(bot, chat_id: int, user_id: int) -> bool:
    """
    ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼.

    Ğ­Ñ‚Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ²Ñ‹Ğ½ĞµÑĞµĞ½Ğ° Ğ² Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½ÑƒÑ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑÑ‚ÑŒÑÑ
    Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ· Ğ´Ğ»Ñ Ğ¾Ğ±Ğ¾Ğ¸Ñ… Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ² (Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ).

    Args:
        bot: Ğ­ĞºĞ·ĞµĞ¼Ğ¿Ğ»ÑÑ€ Ğ±Ğ¾Ñ‚Ğ°
        chat_id: ID Ñ‡Ğ°Ñ‚Ğ°
        user_id: ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ

    Returns:
        bool: True ĞµÑĞ»Ğ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½, False ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚
    """
    try:
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğµ Ğ² Ñ‡Ğ°Ñ‚Ğµ
        member = await bot.get_chat_member(chat_id, user_id)
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ: creator Ğ¸Ğ»Ğ¸ administrator
        return member.status in ('creator', 'administrator')
    except TelegramAPIError as e:
        # ĞÑˆĞ¸Ğ±ĞºĞ° API - Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸ ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ½Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½ (Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´)
        logger.warning(
            f"[COORDINATOR] ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°: {e}, "
            f"chat={chat_id}, user={user_id}"
        )
        return False


# ============================================================
# ĞšĞ­Ğ¨Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ• ĞĞ’Ğ¢ĞĞ ĞĞ’ Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ™ Ğ”Ğ›Ğ¯ ĞœĞ£Ğ¢Ğ ĞŸĞ Ğ Ğ•ĞĞšĞ¦Ğ˜Ğ¯Ğœ
# ============================================================
# Telegram Bot API Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‘Ñ‚ Ğ¾Ğ±ÑŠĞµĞºÑ‚ message Ğ² ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¸ Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¸,
# Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ message_id. ĞŸĞ¾ÑÑ‚Ğ¾Ğ¼Ñƒ Ğ½ÑƒĞ¶Ğ½Ğ¾ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğ² ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
# Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ Ğ·Ğ½Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ³Ğ¾ Ğ¼ÑƒÑ‚Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğ¸ Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¸.

# ĞšĞ»ÑÑ‡ Redis Ğ´Ğ»Ñ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
# Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚: msg_author:{chat_id}:{message_id} â†’ user_id
MSG_AUTHOR_CACHE_KEY = "msg_author:{chat_id}:{message_id}"

# TTL ĞºÑÑˆĞ°: 24 Ñ‡Ğ°ÑĞ° (Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¸ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ ÑÑ‚Ğ°Ğ²ÑÑ‚ Ğ² Ñ‚ĞµÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ½Ñ)
MSG_AUTHOR_CACHE_TTL = 24 * 60 * 60  # 86400 ÑĞµĞºÑƒĞ½Ğ´


async def cache_message_author(chat_id: int, message_id: int, user_id: int) -> None:
    """
    ĞšÑÑˆĞ¸Ñ€ÑƒĞµÑ‚ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ² Redis Ğ´Ğ»Ñ Ğ¼ÑƒÑ‚Ğ° Ğ¿Ğ¾ Ñ€ĞµĞ°ĞºÑ†Ğ¸ÑĞ¼.

    ĞšĞ¾Ğ³Ğ´Ğ° Ğ°Ğ´Ğ¼Ğ¸Ğ½ ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ Ñ€ĞµĞ°ĞºÑ†Ğ¸Ñ Ğ½Ğ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ, Telegram Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‘Ñ‚
    Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ± Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ. Ğ­Ñ‚Ğ° Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ÑĞµÑ‚ ÑĞ²ÑĞ·ÑŒ
    message_id â†’ user_id Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ Ğ·Ğ½Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ³Ğ¾ Ğ¼ÑƒÑ‚Ğ¸Ñ‚ÑŒ.

    Args:
        chat_id: ID Ñ‡Ğ°Ñ‚Ğ° (Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹)
        message_id: ID ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
        user_id: ID Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
    """
    try:
        # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ ĞºĞ»ÑÑ‡ Redis
        cache_key = MSG_AUTHOR_CACHE_KEY.format(chat_id=chat_id, message_id=message_id)

        # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ user_id Ğ² Redis Ñ TTL 24 Ñ‡Ğ°ÑĞ°
        set_result = redis.setex(cache_key, MSG_AUTHOR_CACHE_TTL, str(user_id))

        # Redis Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ async Ğ¸Ğ»Ğ¸ sync - Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¾Ğ±Ğ° ÑĞ»ÑƒÑ‡Ğ°Ñ
        if inspect.isawaitable(set_result):
            await set_result

        # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğµ ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ (debug ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ·Ğ°ÑĞ¾Ñ€ÑÑ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸)
        logger.debug(
            f"[COORDINATOR] ğŸ“ Ğ—Ğ°ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ»Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ°: chat={chat_id}, "
            f"msg={message_id}, user={user_id}"
        )
    except Exception as e:
        # ĞÑˆĞ¸Ğ±ĞºĞ° ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ½Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºÑƒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
        # ĞŸÑ€Ğ¾ÑÑ‚Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ warning - Ğ¼ÑƒÑ‚ Ğ¿Ğ¾ Ñ€ĞµĞ°ĞºÑ†Ğ¸ÑĞ¼ Ğ½Ğµ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
        logger.warning(f"[COORDINATOR] ĞÑˆĞ¸Ğ±ĞºĞ° ĞºÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ: {e}")


# ============================================================
# ĞĞ¡ĞĞĞ’ĞĞĞ™ ĞšĞĞĞ Ğ”Ğ˜ĞĞĞ¢ĞĞ 
# ============================================================

@group_message_coordinator_router.message(
    # Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€: Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ğ¸ ÑÑƒĞ¿ĞµÑ€Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹
    F.chat.type.in_({"group", "supergroup"})
)
async def group_message_handler(
    message: Message,
    session: AsyncSession
) -> None:
    """
    Ğ•Ğ´Ğ¸Ğ½Ñ‹Ğ¹ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸Ğº ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°Ñ….

    ĞšĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ¸Ñ€ÑƒĞµÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñƒ Ğ²ÑĞµÑ… Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²:
    1. ContentFilter (ÑĞ»Ğ¾Ğ²Ğ°, ÑĞºĞ°Ğ¼, Ñ„Ğ»ÑƒĞ´)
    2. Antispam (ÑÑÑ‹Ğ»ĞºĞ¸, Ğ¿ĞµÑ€ĞµÑÑ‹Ğ»ĞºĞ¸, Ñ†Ğ¸Ñ‚Ğ°Ñ‚Ñ‹)

    Ğ•ÑĞ»Ğ¸ ContentFilter ÑÑ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ - Antispam Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ.
    Ğ­Ñ‚Ğ¾ Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ¾: ĞµÑĞ»Ğ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑƒĞ¶Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾ (ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾/Ğ½Ğ°ĞºĞ°Ğ·Ğ°Ğ½),
    Ğ½ĞµÑ‚ ÑĞ¼Ñ‹ÑĞ»Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑÑ‚ÑŒ ĞµĞ³Ğ¾ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾.

    Args:
        message: Ğ’Ñ…Ğ¾Ğ´ÑÑ‰ĞµĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
        session: Ğ¡ĞµÑÑĞ¸Ñ Ğ‘Ğ” (Ğ¸Ğ½Ğ¶ĞµĞºÑ‚Ğ¸Ñ‚ÑÑ middleware)
    """
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ: Ğ•ÑÑ‚ÑŒ Ğ»Ğ¸ Ğ°Ğ²Ñ‚Ğ¾Ñ€ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¾Ñ‚ ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ² Ğ¸Ğ»Ğ¸ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ³ÑƒÑ‚ Ğ½Ğµ Ğ¸Ğ¼ĞµÑ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ°
    if not message.from_user:
        # ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ±ĞµĞ· Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ°
        return

    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ID Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    chat_id = message.chat.id
    user_id = message.from_user.id

    # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‡Ñ‚Ğ¾ ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ¾Ñ€ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ» ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
    logger.info(
        f"[COORDINATOR] ğŸ“¥ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ: chat={chat_id}, user={user_id}, "
        f"text={message.text[:50] if message.text else 'N/A'}..."
    )

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # USER STATISTICS: Ğ˜Ğ½ĞºÑ€ĞµĞ¼ĞµĞ½Ñ‚ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ğ¡Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ğ’Ğ¡Ğ• ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ² (Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸)
    # ĞÑˆĞ¸Ğ±ĞºĞ¸ Ğ¸Ğ½ĞºÑ€ĞµĞ¼ĞµĞ½Ñ‚Ğ° Ğ½Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒÑÑ‚ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¿Ğ¾Ñ‚Ğ¾Ğº (Ğ»Ğ¾Ğ²ÑÑ‚ÑÑ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸)
    await increment_message_count(session, chat_id, user_id)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ĞšĞ­Ğ¨Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ• ĞĞ’Ğ¢ĞĞ Ğ Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ¯ Ğ”Ğ›Ğ¯ ĞœĞ£Ğ¢Ğ ĞŸĞ Ğ Ğ•ĞĞšĞ¦Ğ˜Ğ¯Ğœ
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Telegram Bot API Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ‘Ñ‚ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ² ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¸ Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¸,
    # Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ¼Ñƒ ĞºÑÑˆĞ¸Ñ€ÑƒĞµĞ¼ message_id â†’ user_id Ğ´Ğ»Ñ Ğ¿Ğ¾ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ³Ğ¾ Ğ¼ÑƒÑ‚Ğ°
    await cache_message_author(chat_id, message.message_id, user_id)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ğ¨ĞĞ“ 0: MESSAGE MANAGEMENT - ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¸ Ñ€ĞµĞ¿Ğ¸Ğ½
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ÑÑ‚ÑÑ Ğ”Ğ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ°,
    # Ñ‚.Ğº. Ğ¾Ğ½Ğ¸ Ğ¼Ğ¾Ğ³ÑƒÑ‚ ÑƒĞ´Ğ°Ğ»ÑÑ‚ÑŒÑÑ Ğ½ĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ Ğ¾Ñ‚ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ°

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€ĞµĞ¿Ğ¸Ğ½ (Ğ°Ğ²Ñ‚Ğ¾Ğ·Ğ°ĞºÑ€ĞµĞ¿) - ÑÑ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ½Ğ° ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ Ğ·Ğ°ĞºÑ€ĞµĞ¿Ğ»ĞµĞ½Ğ¸Ñ
    if is_system_message(message):
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ·Ğ°ĞºÑ€ĞµĞ¿ Ğ´Ğ»Ñ Ñ€ĞµĞ¿Ğ¸Ğ½Ğ°
        await process_pin_event(message, session)

        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ»Ğ¸ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
        if await process_system_message(message, session):
            logger.info(f"[COORDINATOR] Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾ MessageManagement")
            return

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ: ĞĞ²Ñ‚Ğ¾Ñ€ - Ğ°Ğ´Ğ¼Ğ¸Ğ½? (Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ ĞĞ”Ğ˜Ğ Ñ€Ğ°Ğ· Ğ´Ğ»Ñ Ğ²ÑĞµÑ… Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ¾Ğ²)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ĞĞ´Ğ¼Ğ¸Ğ½Ñ‹ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ²ĞµÑ€Ğ³Ğ°ÑÑ‚ÑÑ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ ContentFilter Ğ¸ Antispam
    # ĞĞ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ delete_admin_commands

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ°Ğ½Ğ¾Ğ½Ğ¸Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° (Ğ¿Ğ¸ÑˆĞµÑ‚ Ğ¾Ñ‚ Ğ¸Ğ¼ĞµĞ½Ğ¸ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹)
    # Ğ•ÑĞ»Ğ¸ sender_chat == chat, ÑÑ‚Ğ¾ Ğ°Ğ½Ğ¾Ğ½Ğ¸Ğ¼Ğ½Ñ‹Ğ¹ Ğ°Ğ´Ğ¼Ğ¸Ğ½ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹
    is_anonymous_admin = (
        message.sender_chat is not None
        and message.sender_chat.id == chat_id
    )

    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° Ñ‡ĞµÑ€ĞµĞ· API
    is_admin = is_anonymous_admin or await _is_admin(message.bot, chat_id, user_id)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ğ¨ĞĞ“ 0.5: MESSAGE MANAGEMENT - ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ğ˜ Ğ´Ğ»Ñ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¾Ğ² (ĞµÑĞ»Ğ¸ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ delete_admin_commands)
    if is_command_message(message):
        if await process_command_message(message, session):
            logger.info(f"[COORDINATOR] ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ° MessageManagement")
            return

    # ĞĞ´Ğ¼Ğ¸Ğ½Ñ‹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ÑÑ‚ÑÑ Ğ´Ğ»Ñ ContentFilter Ğ¸ Antispam
    if is_admin:
        admin_type = "Ğ°Ğ½Ğ¾Ğ½Ğ¸Ğ¼Ğ½Ñ‹Ğ¹" if is_anonymous_admin else "Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğ¹"
        logger.info(f"[COORDINATOR] ğŸ‘‘ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_id} - {admin_type} Ğ°Ğ´Ğ¼Ğ¸Ğ½, Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ CF/AS")
        return

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ğ¢Ğ Ğ•ĞšĞ˜ĞĞ“ Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ™ Ğ”Ğ›Ğ¯ PROFILE MONITOR
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ message_id Ğ² Redis Ğ´Ğ»Ñ Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾Ğ³Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ
    # Ğ•ÑĞ»Ğ¸ Profile Monitor Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶Ğ¸Ñ‚ Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ,
    # Ğ¾Ğ½ ÑĞ¼Ğ¾Ğ¶ĞµÑ‚ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    try:
        await track_user_message(chat_id, user_id, message.message_id)
    except Exception as e:
        # ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‚Ñ€ĞµĞºĞ¸Ğ½Ğ³Ğ° Ğ½Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ° Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºÑƒ
        logger.warning(f"[COORDINATOR] ĞÑˆĞ¸Ğ±ĞºĞ° Ñ‚Ñ€ĞµĞºĞ¸Ğ½Ğ³Ğ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ: {e}")

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ĞšĞ ĞĞ¡Ğ¡-Ğ“Ğ Ğ£ĞŸĞŸĞĞ’ĞĞ¯ Ğ”Ğ•Ğ¢Ğ•ĞšĞ¦Ğ˜Ğ¯: Ñ‚Ñ€ĞµĞºĞ¸Ğ½Ğ³ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ñ„Ğ°ĞºÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ»Ñ Ğ´ĞµÑ‚ĞµĞºÑ†Ğ¸Ğ¸
    # ÑĞºĞ°Ğ¼ĞµÑ€Ğ¾Ğ², Ğ¿Ğ¸ÑˆÑƒÑ‰Ğ¸Ñ… Ğ² Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ³Ñ€ÑƒĞ¿Ğ¿ Ğ±Ğ¾Ñ‚Ğ°
    try:
        # Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ñ„Ğ°ĞºÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ
        await cross_group_track_message(
            session=session,
            user_id=user_id,
            chat_id=chat_id,
            message_id=message.message_id,
        )
        # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ñ€ĞµĞºĞ¸Ğ½Ğ³ (debug Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ·Ğ°ÑĞ¾Ñ€ÑÑ‚ÑŒ Ğ»Ğ¾Ğ³Ğ¸)
        logger.debug(f"[CROSS_GROUP] Tracked message: user={user_id} chat={chat_id}")
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´ĞµÑ‚ĞµĞºÑ†Ğ¸Ñ (ÑÑ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ĞµÑĞ»Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ñ‹ Ğ²ÑĞµ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ñ)
        detection_result = await check_cross_group_detection(
            session=session,
            user_id=user_id,
        )
        # Ğ•ÑĞ»Ğ¸ Ğ´ĞµÑ‚ĞµĞºÑ†Ğ¸Ñ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»Ğ° â€” Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ
        if detection_result:
            # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´ĞµÑ‚ĞµĞºÑ†Ğ¸Ñ ÑĞºĞ°Ğ¼ĞµÑ€Ğ°
            logger.warning(
                f"[CROSS_GROUP] DETECTED SCAMMER on MESSAGE: "
                f"user={user_id} groups={detection_result.get('groups', [])}"
            )
            # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ¼Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ´Ğ»Ñ Ğ¶ÑƒÑ€Ğ½Ğ°Ğ»Ğ°
            user_name = message.from_user.full_name if message.from_user else None
            user_username = message.from_user.username if message.from_user else None

            # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ²Ğ¾ Ğ²ÑĞµÑ… Ğ·Ğ°Ñ‚Ñ€Ğ¾Ğ½ÑƒÑ‚Ñ‹Ñ… Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°Ñ…
            await apply_cross_group_action(
                session=session,
                bot=message.bot,
                user_id=user_id,
                detection_data=detection_result,
                user_name=user_name,
                username=user_username,
            )
    except Exception as e:
        # ĞÑˆĞ¸Ğ±ĞºĞ¸ ĞºÑ€Ğ¾ÑÑ-Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¾Ğ²Ğ¾Ğ¹ Ğ´ĞµÑ‚ĞµĞºÑ†Ğ¸Ğ¸ Ğ½Ğµ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ Ğ»Ğ¾Ğ¼Ğ°Ñ‚ÑŒ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ñ„Ğ»Ğ¾Ñƒ
        logger.error(f"[CROSS_GROUP] Error in message tracking: {e}")

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ğ¨ĞĞ“ 1: CONTENT FILTER (ÑĞ»Ğ¾Ğ²Ğ°, ÑĞºĞ°Ğ¼, Ñ„Ğ»ÑƒĞ´)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· ContentFilter
    content_filter_triggered = await _process_content_filter(message, session)

    # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ ContentFilter
    # ĞĞ• Ğ¿Ñ€ĞµÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ - Antispam Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ½ĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾
    if content_filter_triggered:
        logger.info(f"[COORDINATOR] ContentFilter ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ», Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ Antispam")

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ğ¨ĞĞ“ 2: SCAM MEDIA FILTER (ÑĞºĞ°Ğ¼-Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ pHash)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· ScamMediaFilter ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ Ğ¼ĞµĞ´Ğ¸Ğ°
    # Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„Ğ»Ğ°Ğ³ Ğ´Ğ»Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
    scam_media_triggered = False
    if await has_media(message):
        scam_media_triggered = await _process_scam_media(message, session)
        # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ ScamMedia
        # ĞĞ• Ğ¿Ñ€ĞµÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ - Antispam Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ½ĞµĞ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾
        if scam_media_triggered:
            logger.info(f"[COORDINATOR] ScamMedia ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ», Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ Antispam")

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ğ¨ĞĞ“ 3: ANTISPAM (ÑÑÑ‹Ğ»ĞºĞ¸, Ğ¿ĞµÑ€ĞµÑÑ‹Ğ»ĞºĞ¸, Ñ†Ğ¸Ñ‚Ğ°Ñ‚Ñ‹)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ContentFilter Ğ½Ğµ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ» - Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Antispam
    antispam_triggered = await _process_antispam(message, session)

    # Ğ•ÑĞ»Ğ¸ Antispam ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ» - Profile Monitor Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼
    if antispam_triggered:
        logger.info(f"[COORDINATOR] Antispam ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ», Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ ProfileMonitor")
        return

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ğ¨ĞĞ“ 4: PROFILE MONITOR (Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ)
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ContentFilter Ğ¸ Antispam Ğ½Ğµ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»Ğ¸ - Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Profile Monitor
    # Ğ­Ñ‚Ğ¾Ñ‚ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¼ÑƒÑ‚
    await _process_profile_monitor(message, session)


# ============================================================
# ĞĞ‘Ğ ĞĞ‘ĞĞ¢ĞšĞ CONTENT FILTER
# ============================================================

async def _process_content_filter(
    message: Message,
    session: AsyncSession
) -> bool:
    """
    ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· ContentFilter.

    Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ° Ğ¸Ğ· filter_handler.py Ñ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸ÑĞ¼Ğ¸.

    Args:
        message: Ğ’Ñ…Ğ¾Ğ´ÑÑ‰ĞµĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
        session: Ğ¡ĞµÑÑĞ¸Ñ Ğ‘Ğ”

    Returns:
        bool: True ĞµÑĞ»Ğ¸ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ», False ĞµÑĞ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½
    """
    chat_id = message.chat.id
    user_id = message.from_user.id

    try:
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ²ÑĞµĞ¼Ğ¸ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ğ¼Ğ¸ ContentFilter
        result = await _filter_manager.check_message(message, session)

        # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
        logger.info(
            f"[COORDINATOR/CF] ğŸ” Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚: chat={chat_id}, "
            f"should_act={result.should_act}, detector={result.detector_type}, "
            f"trigger={result.trigger}"
        )

        # Ğ•ÑĞ»Ğ¸ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ½Ğµ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ» - Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞºÑ€Ğ¾ÑÑ-ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´ĞµÑ‚ĞµĞºÑ†Ğ¸Ñ
        if not result.should_act:
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # ĞšĞ ĞĞ¡Ğ¡-Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ• Ğ”Ğ•Ğ¢Ğ•ĞšĞ¦Ğ˜Ğ¯: Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¡Ğ’ĞĞ˜ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹
            # ĞĞ• Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ accumulated_score Ğ¸Ğ· Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ¾Ğ²!
            # Ğ’Ğ¼ĞµÑÑ‚Ğ¾ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ check_patterns() ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚
            # Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½ÑƒÑ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ cross_message_patterns
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            cross_msg_triggered = await _process_cross_message_detection(
                message=message,
                session=session
            )
            if cross_msg_triggered:
                return True
            return False

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ¤Ğ˜Ğ›Ğ¬Ğ¢Ğ  Ğ¡Ğ ĞĞ‘ĞĞ¢ĞĞ› - Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        logger.info(
            f"[COORDINATOR/CF] âš¡ Ğ¡Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ğµ: chat={chat_id}, user={user_id}, "
            f"detector={result.detector_type}, trigger={result.trigger}, "
            f"action={result.action}"
        )

        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ñ‹Ñ… Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹
        settings = await _filter_manager.get_or_create_settings(chat_id, session)

        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ (delete, warn, mute, ban)
        await content_filter_apply_action(message, result, settings, session)

        # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ°Ñ€ÑƒÑˆĞµĞ½Ğ¸Ğµ Ğ² Ğ‘Ğ”
        await _filter_manager.log_violation(message, result, session)

        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğµ Ğ² Ğ¶ÑƒÑ€Ğ½Ğ°Ğ» Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ (ĞµÑĞ»Ğ¸ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾)
        if settings.log_violations:
            await content_filter_send_journal_log(message, result, session)

        # Ğ¤Ğ¸Ğ»ÑŒÑ‚Ñ€ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»
        return True

    except Exception as e:
        # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ, Ğ½Ğ¾ Ğ½Ğµ Ğ¿Ğ°Ğ´Ğ°ĞµĞ¼
        logger.exception(
            f"[COORDINATOR/CF] ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸: {e}, "
            f"chat={chat_id}, user={user_id}"
        )
        # ĞŸÑ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ½Ğµ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»
        return False


# ============================================================
# ĞĞ‘Ğ ĞĞ‘ĞĞ¢ĞšĞ ĞšĞ ĞĞ¡Ğ¡-Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ• Ğ”Ğ•Ğ¢Ğ•ĞšĞ¦Ğ˜Ğ˜
# ============================================================

async def _process_cross_message_detection(
    message: Message,
    session: AsyncSession
) -> bool:
    """
    ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ĞºÑ€Ğ¾ÑÑ-ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´ĞµÑ‚ĞµĞºÑ†Ğ¸Ñ Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ Ğ¡Ğ’ĞĞ˜Ğ¥ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğ¾Ğ².

    ĞĞ• Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ accumulated_score Ğ¸Ğ· Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ¾Ğ²!
    Ğ’Ğ¼ĞµÑÑ‚Ğ¾ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ²Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ check_patterns() ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ñ‚ĞµĞºÑÑ‚
    Ğ¿Ğ¾ ĞĞ¢Ğ”Ğ•Ğ›Ğ¬ĞĞĞ™ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğµ cross_message_patterns.

    Args:
        message: Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
        session: Ğ¡ĞµÑÑĞ¸Ñ Ğ‘Ğ”

    Returns:
        bool: True ĞµÑĞ»Ğ¸ cross_message_threshold Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞµĞ½, False Ğ¸Ğ½Ğ°Ñ‡Ğµ
    """
    chat_id = message.chat.id
    user_id = message.from_user.id

    try:
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ContentFilter Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ¹ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        settings = await _filter_manager.get_or_create_settings(chat_id, session)

        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ° Ğ»Ğ¸ ĞºÑ€Ğ¾ÑÑ-ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´ĞµÑ‚ĞµĞºÑ†Ğ¸Ñ
        if not getattr(settings, 'cross_message_enabled', False):
            return False

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ CrossMessageService
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        cross_msg_service = get_cross_message_service()
        if not cross_msg_service:
            # Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ½Ğµ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ â€” Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ
            # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ‚Ğ¾Ñ‚ Ğ¶Ğµ Redis Ñ‡Ñ‚Ğ¾ Ğ¸ Ğ´Ğ»Ñ flood_detector
            if redis:
                cross_msg_service = create_cross_message_service(redis)
            else:
                logger.warning("[COORDINATOR/CM] Redis Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ´Ğ»Ñ CrossMessageService")
                return False

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ñ‚ĞµĞºÑÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        text = message.text or message.caption or ''
        if not text.strip():
            # ĞĞµÑ‚ Ñ‚ĞµĞºÑÑ‚Ğ° â€” Ğ½ĞµÑ‡ĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑÑ‚ÑŒ
            return False

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ĞºÑ€Ğ¾ÑÑ-ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´ĞµÑ‚ĞµĞºÑ†Ğ¸Ğ¸
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        window_seconds = getattr(settings, 'cross_message_window_seconds', 7200)
        threshold = getattr(settings, 'cross_message_threshold', 100)
        action = getattr(settings, 'cross_message_action', 'mute') or 'mute'

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‚ĞµĞºÑÑ‚ Ğ¿Ğ¾ Ğ¡Ğ’ĞĞ˜Ğœ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğ°Ğ¼ (ĞĞ• Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ¾Ğ²!)
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        result = await cross_msg_service.check_patterns(
            chat_id=chat_id,
            user_id=user_id,
            message_id=message.message_id,
            text=text,
            session=session,
            window_seconds=window_seconds,
            threshold=threshold
        )

        # Ğ•ÑĞ»Ğ¸ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ â€” Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ¸Ğ¼
        if result.score == 0:
            return False

        # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ¸Ğµ
        logger.info(
            f"[COORDINATOR/CM] ğŸ“Š ĞĞ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ¸Ğµ: chat={chat_id}, user={user_id}, "
            f"+{result.score} Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ², total={result.total_score}/{threshold}, "
            f"matched={len(result.matched_patterns)}"
        )

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ñ€Ğ¾Ğ³ ĞĞ• Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞµĞ½ â€” Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ¸Ğ¼
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if not result.threshold_exceeded:
            return False

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # ĞŸĞĞ ĞĞ“ ĞŸĞ Ğ•Ğ’Ğ«Ğ¨Ğ•Ğ â€” Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        logger.warning(
            f"[COORDINATOR/CM] âš¡ CROSS-MESSAGE THRESHOLD EXCEEDED: "
            f"chat={chat_id}, user={user_id}, total={result.total_score}, "
            f"action={action}, matched_patterns={result.matched_patterns}"
        )

        # Ğ’ĞĞ–ĞĞ: Ğ¡Ğ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ, ĞŸĞĞ¢ĞĞœ ÑĞ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº!
        # reset_score ÑƒĞ´Ğ°Ğ»ÑĞµÑ‚ Ğ²ÑĞµ ĞºĞ»ÑÑ‡Ğ¸ Redis Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ history
        history = await cross_msg_service.get_history(chat_id, user_id)

        # Ğ¢ĞµĞ¿ĞµÑ€ÑŒ ÑĞ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ ÑÑ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¾
        await cross_msg_service.reset_score(chat_id, user_id)

        # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ
        await _apply_cross_message_action(
            message=message,
            session=session,
            action=action,
            total_score=result.total_score,
            messages_count=len(history) if history else 1,
            history=history or [],
            settings=settings,
            message_ids=result.message_ids,
            matched_patterns=result.matched_patterns
        )

        return True

    except Exception as e:
        logger.exception(
            f"[COORDINATOR/CM] ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸: {e}, "
            f"chat={chat_id}, user={user_id}"
        )
        return False


async def _apply_cross_message_action(
    message: Message,
    session: AsyncSession,
    action: str,
    total_score: int,
    messages_count: int,
    history: list,
    settings,
    message_ids: list = None,
    matched_patterns: list = None
) -> None:
    """
    ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ¿Ñ€Ğ¸ Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞµĞ½Ğ¸Ğ¸ cross_message_threshold.

    Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ° Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ:
    1. Ğ˜Ñ‰ĞµĞ¼ Ğ¿Ğ¾Ñ€Ğ¾Ğ³ (CrossMessageThreshold) Ğ³Ğ´Ğµ min_score <= total_score <= max_score
    2. Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ñ€Ğ¾Ğ³ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ â€” Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ action Ğ¸ mute_duration Ğ¸Ğ· Ğ¿Ğ¾Ñ€Ğ¾Ğ³Ğ°
    3. Ğ•ÑĞ»Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ â€” Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ action Ğ¸Ğ· Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ° Ğ¸ default_mute_duration Ğ¸Ğ· Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº

    Args:
        message: ĞŸĞ¾ÑĞ»ĞµĞ´Ğ½ĞµĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
        session: Ğ¡ĞµÑÑĞ¸Ñ Ğ‘Ğ”
        action: Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ (mute/ban/kick)
        total_score: ĞĞ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ score
        messages_count: ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ² Ğ½Ğ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ¸Ğ¸
        history: Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
        settings: ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ContentFilter
        message_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ID ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ´Ğ»Ñ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ
        matched_patterns: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ²ÑˆĞ¸Ñ… Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğ¾Ğ²
    """
    chat_id = message.chat.id
    user_id = message.from_user.id
    bot = message.bot

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ĞŸĞĞ˜Ğ¡Ğš ĞŸĞĞ ĞĞ“Ğ Ğ”Ğ›Ğ¯ Ğ”ĞĞĞĞĞ“Ğ Ğ¡ĞšĞĞ Ğ
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ ÑĞµÑ€Ğ²Ğ¸Ñ Ğ·Ğ´ĞµÑÑŒ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ñ‚ÑŒ Ñ†Ğ¸ĞºĞ»Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ğ¸Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¾Ğ²
    from bot.services.content_filter.cross_message_service import get_cross_message_service

    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞµÑ€Ğ²Ğ¸Ñ (ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ÑÑ Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ°Ñ€Ñ‚Ğµ Ğ±Ğ¾Ñ‚Ğ°)
    cross_msg_service = get_cross_message_service()

    # ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ´Ğ»Ñ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ğ¸ Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ Ğ¼ÑƒÑ‚Ğ°
    # ĞŸĞ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ±ĞµÑ€Ñ‘Ğ¼ Ğ¸Ğ· Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ° Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº
    final_action = action
    mute_duration = getattr(settings, 'default_mute_duration', 1440)
    threshold_info = None  # Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ¾Ñ€Ğ¾Ğ³Ğµ Ğ´Ğ»Ñ Ğ¶ÑƒÑ€Ğ½Ğ°Ğ»Ğ°

    # Ğ˜Ñ‰ĞµĞ¼ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğ¹ Ğ¿Ğ¾Ñ€Ğ¾Ğ³ ĞµÑĞ»Ğ¸ ÑĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½
    if cross_msg_service:
        try:
            threshold = await cross_msg_service.get_threshold_for_score(
                chat_id=chat_id,
                score=total_score,
                session=session
            )

            # Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ñ€Ğ¾Ğ³ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ â€” Ğ¿ĞµÑ€ĞµĞ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ action Ğ¸ mute_duration
            if threshold:
                final_action = threshold.action
                # Ğ”Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ¼ÑƒÑ‚Ğ° Ğ±ĞµÑ€Ñ‘Ğ¼ Ğ¸Ğ· Ğ¿Ğ¾Ñ€Ğ¾Ğ³Ğ° (ĞµÑĞ»Ğ¸ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ°)
                if threshold.mute_duration is not None:
                    mute_duration = threshold.mute_duration

                # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ¾Ñ€Ğ¾Ğ³Ğµ Ğ´Ğ»Ñ Ğ¶ÑƒÑ€Ğ½Ğ°Ğ»Ğ°
                threshold_info = {
                    'id': threshold.id,
                    'min_score': threshold.min_score,
                    'max_score': threshold.max_score,
                    'action': threshold.action,
                    'mute_duration': threshold.mute_duration,
                    'description': threshold.description
                }

                logger.info(
                    f"[COORDINATOR/CM] ĞŸĞ¾Ñ€Ğ¾Ğ³ #{threshold.id} Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ñ‘Ğ½: "
                    f"score={total_score} â†’ {threshold.min_score}-{threshold.max_score or 'âˆ'}, "
                    f"action={final_action}, duration={mute_duration}"
                )
        except Exception as e:
            # ĞŸÑ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ Ğ¿Ğ¾Ğ¸ÑĞºĞ° Ğ¿Ğ¾Ñ€Ğ¾Ğ³Ğ° â€” Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚Ñ‹
            logger.warning(
                f"[COORDINATOR/CM] ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ğ¾Ğ¸ÑĞºĞ° Ğ¿Ğ¾Ñ€Ğ¾Ğ³Ğ°: {e}, "
                f"Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ default action={action}"
            )

    try:
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ•: MUTE
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if final_action == 'mute':
            permissions = ChatPermissions(
                can_send_messages=False,
                can_send_media_messages=False,
                can_send_polls=False,
                can_send_other_messages=False,
                can_add_web_page_previews=False,
                can_change_info=False,
                can_invite_users=False,
                can_pin_messages=False,
            )

            await bot.restrict_chat_member(
                chat_id,
                user_id,
                permissions=permissions,
                until_date=timedelta(minutes=mute_duration)
            )

            logger.info(
                f"[COORDINATOR/CM] ğŸ”‡ ĞœÑƒÑ‚ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ñ‘Ğ½: user={user_id}, "
                f"duration={mute_duration} Ğ¼Ğ¸Ğ½, score={total_score}"
            )

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ•: BAN
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        elif final_action == 'ban':
            await bot.ban_chat_member(chat_id, user_id)
            logger.info(
                f"[COORDINATOR/CM] ğŸš« Ğ‘Ğ°Ğ½ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ñ‘Ğ½: user={user_id}, score={total_score}"
            )

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ•: KICK
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        elif final_action == 'kick':
            await bot.ban_chat_member(chat_id, user_id)
            await bot.unban_chat_member(chat_id, user_id)
            logger.info(
                f"[COORDINATOR/CM] ğŸ‘¢ ĞšĞ¸Ğº Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ñ‘Ğ½: user={user_id}, score={total_score}"
            )

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # ĞĞ¢ĞŸĞ ĞĞ’Ğ›Ğ¯Ğ•Ğœ Ğ£Ğ’Ğ•Ğ”ĞĞœĞ›Ğ•ĞĞ˜Ğ• Ğ’ Ğ“Ğ Ğ£ĞŸĞŸĞ£
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚ĞµĞºÑÑ‚ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ
        user_mention = message.from_user.mention_html()

        # Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ¼ÑƒÑ‚Ğ° Ğ´Ğ»Ñ Ñ‚ĞµĞºÑÑ‚Ğ°
        duration_text = ""
        if final_action == 'mute':
            days = mute_duration // 1440
            remaining = mute_duration % 1440
            hours = remaining // 60
            minutes = remaining % 60

            if days > 0:
                duration_text = f"{days}Ğ´"
                if hours > 0:
                    duration_text += f" {hours}Ñ‡"
            elif hours > 0:
                duration_text = f"{hours}Ñ‡"
                if minutes > 0:
                    duration_text += f" {minutes}Ğ¼Ğ¸Ğ½"
            else:
                duration_text = f"{minutes}Ğ¼Ğ¸Ğ½"

        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ°ÑÑ‚Ğ¾Ğ¼Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚ Ğ¸Ğ· Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº Ğ¸Ğ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¹
        notification_text = None
        if final_action == 'mute':
            custom_text = getattr(settings, 'cross_message_mute_text', None)
            if custom_text:
                # Ğ—Ğ°Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¿Ğ»ĞµĞ¹ÑÑ…Ğ¾Ğ»Ğ´ĞµÑ€Ñ‹
                notification_text = custom_text.replace('%user%', user_mention)
                notification_text = notification_text.replace('%time%', duration_text)
            else:
                # Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚ Ğ¿Ñ€Ğ¸ Ğ¼ÑƒÑ‚Ğµ
                notification_text = (
                    f"ğŸ”‡ {user_mention} Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ğ» Ğ¼ÑƒÑ‚ Ğ½Ğ° {duration_text}.\n"
                    f"ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: Ğ½Ğ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ½Ğ°Ñ€ÑƒÑˆĞµĞ½Ğ¸Ñ (ĞºÑ€Ğ¾ÑÑ-ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´ĞµÑ‚ĞµĞºÑ†Ğ¸Ñ)"
                )

        elif final_action == 'ban':
            custom_text = getattr(settings, 'cross_message_ban_text', None)
            if custom_text:
                notification_text = custom_text.replace('%user%', user_mention)
            else:
                # Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚ Ğ¿Ñ€Ğ¸ Ğ±Ğ°Ğ½Ğµ
                notification_text = (
                    f"ğŸš« {user_mention} Ğ·Ğ°Ğ±Ğ°Ğ½ĞµĞ½.\n"
                    f"ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: Ğ½Ğ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ½Ğ°Ñ€ÑƒÑˆĞµĞ½Ğ¸Ñ (ĞºÑ€Ğ¾ÑÑ-ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´ĞµÑ‚ĞµĞºÑ†Ğ¸Ñ)"
                )

        elif final_action == 'kick':
            notification_text = (
                f"ğŸ‘¢ {user_mention} Ğ¸ÑĞºĞ»ÑÑ‡Ñ‘Ğ½ Ğ¸Ğ· Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹.\n"
                f"ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: Ğ½Ğ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ½Ğ°Ñ€ÑƒÑˆĞµĞ½Ğ¸Ñ (ĞºÑ€Ğ¾ÑÑ-ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´ĞµÑ‚ĞµĞºÑ†Ğ¸Ñ)"
            )

        # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ
        sent_notification = None
        if notification_text:
            try:
                sent_notification = await message.answer(notification_text, parse_mode="HTML")
                logger.info(f"[COORDINATOR/CM] ğŸ“¢ Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ")
            except Exception as e:
                logger.warning(f"[COORDINATOR/CM] ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ: {e}")

        # ĞŸĞ»Ğ°Ğ½Ğ¸Ñ€ÑƒĞµĞ¼ Ğ°Ğ²Ñ‚Ğ¾ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ ĞµÑĞ»Ğ¸ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ° Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ°
        notification_delay = getattr(settings, 'cross_message_notification_delete_delay', None)
        if sent_notification and notification_delay and notification_delay > 0:
            async def _delete_notification():
                try:
                    await asyncio.sleep(notification_delay)
                    await bot.delete_message(chat_id, sent_notification.message_id)
                    logger.info(
                        f"[COORDINATOR/CM] ğŸ”” Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ²Ñ‚Ğ¾ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾ Ñ‡ĞµÑ€ĞµĞ· {notification_delay} ÑĞµĞº"
                    )
                except Exception:
                    pass  # Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¾Ğ³Ğ»Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ ÑƒĞ¶Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾
            asyncio.create_task(_delete_notification())

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ£Ğ”ĞĞ›Ğ¯Ğ•Ğœ Ğ’Ğ¡Ğ• ĞĞĞšĞĞŸĞ›Ğ•ĞĞĞ«Ğ• Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ¯
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        deleted_count = 0
        if message_ids:
            for msg_id in message_ids:
                try:
                    await bot.delete_message(chat_id, msg_id)
                    deleted_count += 1
                except Exception:
                    pass  # Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¾Ğ³Ğ»Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ ÑƒĞ¶Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾

            logger.info(
                f"[COORDINATOR/CM] ğŸ—‘ï¸ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹: {deleted_count}/{len(message_ids)}"
            )

        # Ğ¢Ğ°ĞºĞ¶Ğµ ÑƒĞ´Ğ°Ğ»ÑĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰ĞµĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ (ĞµÑĞ»Ğ¸ Ğ½Ğµ Ğ² ÑĞ¿Ğ¸ÑĞºĞµ)
        if not message_ids or message.message_id not in message_ids:
            try:
                await message.delete()
                deleted_count += 1
            except Exception:
                pass

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # ĞĞ¢ĞŸĞ ĞĞ’Ğ›Ğ¯Ğ•Ğœ Ğ’ Ğ–Ğ£Ğ ĞĞĞ›
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if getattr(settings, 'log_violations', True):
            # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
            group_title = message.chat.title or "Ğ‘ĞµĞ· Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ"
            # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ ÑÑÑ‹Ğ»ĞºÑƒ Ğ½Ğ° Ğ³Ñ€ÑƒĞ¿Ğ¿Ñƒ (ĞµÑĞ»Ğ¸ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ğ°Ñ) Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ
            if message.chat.username:
                group_link = f'<a href="https://t.me/{message.chat.username}">{group_title}</a>'
            else:
                group_link = f"<b>{group_title}</b>"

            # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚ĞµĞºÑÑ‚ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ²ÑˆĞ¸Ñ… Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğ¾Ğ²
            patterns_text = ""
            if matched_patterns:
                # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ´Ğ¾ 10 Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ñ‚Ñ‹ ĞºĞ°Ñ€Ñ‚Ğ¸Ğ½Ñ‹
                for i, p in enumerate(matched_patterns[:10], 1):
                    p_pattern = p.get('pattern', '')[:40]
                    p_weight = p.get('weight', 0)
                    p_method = p.get('method', '')
                    patterns_text += f"  â€¢ Â«{p_pattern}Â» +{p_weight} [{p_method}]\n"

            # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ - ĞŸĞĞ›ĞĞ«Ğ™ Ğ¢Ğ•ĞšĞ¡Ğ¢
            history_text = ""
            if history:
                # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ²ÑĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ¸Ğ· Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¸ (Ğ´Ğ¾ 10)
                for i, h in enumerate(history[-10:], 1):
                    # Ğ‘ĞµÑ€Ñ‘Ğ¼ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ, Ğ¾Ğ±Ñ€ĞµĞ·Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ > 200 ÑĞ¸Ğ¼Ğ²Ğ¾Ğ»Ğ¾Ğ²
                    full_text = h.get('text', h.get('preview', ''))
                    if len(full_text) > 200:
                        full_text = full_text[:200] + "..."
                    h_score = h.get('score', 0)
                    history_text += f"\n<b>Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ {i}</b> (+{h_score}):\n<i>{full_text}</i>\n"

            # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ Ñ Ğ´ĞµÑ‚Ğ°Ğ»ÑĞ¼Ğ¸
            action_names = {
                'mute': 'ğŸ”‡ ĞœÑƒÑ‚',
                'ban': 'ğŸš« Ğ‘Ğ°Ğ½',
                'kick': 'ğŸ‘¢ ĞšĞ¸Ğº'
            }
            # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ final_action (Ğ¸Ğ· Ğ¿Ğ¾Ñ€Ğ¾Ğ³Ğ° Ğ¸Ğ»Ğ¸ Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚)
            action_name = action_names.get(final_action, final_action)

            # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ¼ÑƒÑ‚Ğ° ĞµÑĞ»Ğ¸ ÑÑ‚Ğ¾ Ğ¼ÑƒÑ‚
            if final_action == 'mute':
                # Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ mute_duration (Ğ¸Ğ· Ğ¿Ğ¾Ñ€Ğ¾Ğ³Ğ° Ğ¸Ğ»Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº)
                mute_mins = mute_duration
                # Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼Ğ¾
                if mute_mins >= 1440:
                    mute_time_str = f"{mute_mins // 1440} Ğ´Ğ½."
                elif mute_mins >= 60:
                    mute_time_str = f"{mute_mins // 60} Ñ‡."
                else:
                    mute_time_str = f"{mute_mins} Ğ¼Ğ¸Ğ½."
                action_name += f" Ğ½Ğ° {mute_time_str}"

            # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ğ¿Ğ¾Ñ€Ğ¾Ğ³Ğµ (ĞµÑĞ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½)
            threshold_text = ""
            if threshold_info:
                min_s = threshold_info['min_score']
                max_s = threshold_info['max_score'] or 'âˆ'
                th_desc = threshold_info.get('description') or ''
                threshold_text = f"\nğŸ“ ĞŸĞ¾Ñ€Ğ¾Ğ³: {min_s}-{max_s} Ğ±Ğ°Ğ»Ğ»Ğ¾Ğ²"
                if th_desc:
                    threshold_text += f" ({th_desc})"

            # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ¿Ğ¾Ñ€Ğ¾Ğ³ Ğ¸ Ğ¾ĞºĞ½Ğ¾ Ğ¸Ğ· Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº
            threshold = getattr(settings, 'cross_message_threshold', 100)
            window_mins = getattr(settings, 'cross_message_window', 7200) // 60

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ñ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸ÑĞ¼Ğ¸
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # Callback data Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚: cm:action:chat_id:user_id
            # cm = cross message (ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹ Ğ¿Ñ€ĞµÑ„Ğ¸ĞºÑ Ğ´Ğ»Ñ 64 Ğ±Ğ°Ğ¹Ñ‚ Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ°)
            keyboard = InlineKeyboardMarkup(inline_keyboard=[
                [
                    # ĞšĞ½Ğ¾Ğ¿ĞºĞ° Ñ€Ğ°Ğ·Ğ¼ÑƒÑ‚Ğ¸Ñ‚ÑŒ/Ñ€Ğ°Ğ·Ğ±Ğ°Ğ½Ğ¸Ñ‚ÑŒ (Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ)
                    InlineKeyboardButton(
                        text="ğŸ”“ Ğ Ğ°Ğ·Ğ¼ÑƒÑ‚Ğ¸Ñ‚ÑŒ" if action == 'mute' else "ğŸ”“ Ğ Ğ°Ğ·Ğ±Ğ°Ğ½Ğ¸Ñ‚ÑŒ",
                        callback_data=f"cm:unmute:{chat_id}:{user_id}"
                    ),
                    # ĞšĞ½Ğ¾Ğ¿ĞºĞ° Ğ¼ÑƒÑ‚ Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ°
                    InlineKeyboardButton(
                        text="ğŸ”‡ ĞœÑƒÑ‚ Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ°",
                        callback_data=f"cm:permmute:{chat_id}:{user_id}"
                    ),
                ],
                [
                    # ĞšĞ½Ğ¾Ğ¿ĞºĞ° Ğ±Ğ°Ğ½ Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ°
                    InlineKeyboardButton(
                        text="ğŸš« Ğ‘Ğ°Ğ½",
                        callback_data=f"cm:ban:{chat_id}:{user_id}"
                    ),
                    # ĞšĞ½Ğ¾Ğ¿ĞºĞ° OK (Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ, ÑƒĞ´Ğ°Ğ»ÑĞµÑ‚ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸)
                    InlineKeyboardButton(
                        text="âœ… OK",
                        callback_data=f"cm:ok:{chat_id}:{user_id}"
                    ),
                ]
            ])

            await send_journal_event(
                bot=bot,
                session=session,
                group_id=chat_id,
                message_text=(
                    f"ğŸ“Š <b>ĞšÑ€Ğ¾ÑÑ-ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´ĞµÑ‚ĞµĞºÑ†Ğ¸Ñ</b> #crossmsg\n\n"
                    f"ğŸ‘¥ Ğ“Ñ€ÑƒĞ¿Ğ¿Ğ°: {group_link} [<code>{chat_id}</code>]\n"
                    f"ğŸ‘¤ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: {message.from_user.mention_html()} "
                    f"[<code>{user_id}</code>]\n\n"
                    f"ğŸ“ˆ ĞĞ°ĞºĞ¾Ğ¿Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ ÑĞºĞ¾Ñ€: <b>{total_score}</b> (Ğ¿Ğ¾Ñ€Ğ¾Ğ³: {threshold})\n"
                    f"ğŸ“ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ² Ğ¾ĞºĞ½Ğµ: {messages_count} (Ğ¾ĞºĞ½Ğ¾: {window_mins} Ğ¼Ğ¸Ğ½)\n"
                    f"ğŸ—‘ï¸ Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹: {deleted_count}\n"
                    f"âš¡ Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ: {action_name}{threshold_text}\n\n"
                    f"ğŸ¯ <b>Ğ¡Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ²ÑˆĞ¸Ğµ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹:</b>\n{patterns_text if patterns_text else '  (Ğ¸Ğ· Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ¾Ğ²)'}\n"
                    f"ğŸ“œ <b>Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ:</b>{history_text if history_text else ' (Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…)'}"
                ),
                reply_markup=keyboard
            )

    except TelegramBadRequest as e:
        logger.error(f"[COORDINATOR/CM] TelegramBadRequest: {e}")
    except TelegramForbiddenError as e:
        logger.error(f"[COORDINATOR/CM] TelegramForbiddenError: {e}")
    except Exception as e:
        logger.exception(f"[COORDINATOR/CM] ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ: {e}")


# ============================================================
# ĞĞ‘Ğ ĞĞ‘ĞĞ¢ĞšĞ SCAM MEDIA
# ============================================================

async def _process_scam_media(
    message: Message,
    session: AsyncSession
) -> bool:
    """
    ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· ScamMediaFilter.

    ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ Ğ½Ğ° ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ğµ Ñ Ğ±Ğ°Ğ·Ğ¾Ğ¹ ÑĞºĞ°Ğ¼-Ñ…ĞµÑˆĞµĞ¹
    Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒÑ perceptual hashing (pHash + dHash).

    Args:
        message: Ğ’Ñ…Ğ¾Ğ´ÑÑ‰ĞµĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
        session: Ğ¡ĞµÑÑĞ¸Ñ Ğ‘Ğ”

    Returns:
        bool: True ĞµÑĞ»Ğ¸ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ», False ĞµÑĞ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½
    """
    chat_id = message.chat.id
    user_id = message.from_user.id

    try:
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· ScamMediaFilter
        result = await check_message_for_scam_media(
            message=message,
            bot=message.bot,
            session=session
        )

        # Ğ•ÑĞ»Ğ¸ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ½Ğµ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ» - Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ False
        if not result.filtered:
            return False

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ¤Ğ˜Ğ›Ğ¬Ğ¢Ğ  Ğ¡Ğ ĞĞ‘ĞĞ¢ĞĞ› - Ğ»Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        logger.warning(
            f"[COORDINATOR/SM] âš¡ Ğ¡ĞºĞ°Ğ¼-Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ğµ Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ¾: chat={chat_id}, "
            f"user={user_id}, action={result.action}, distance={result.distance}, "
            f"hash_id={result.hash_id}"
        )

        # Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ ÑƒĞ¶Ğµ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¾ Ğ² filter_manager.py
        # (ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ, Ğ¼ÑƒÑ‚, Ğ±Ğ°Ğ½ Ğ¸ Ğ¶ÑƒÑ€Ğ½Ğ°Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ)
        return True

    except Exception as e:
        # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ, Ğ½Ğ¾ Ğ½Ğµ Ğ¿Ğ°Ğ´Ğ°ĞµĞ¼
        logger.exception(
            f"[COORDINATOR/SM] ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸: {e}, "
            f"chat={chat_id}, user={user_id}"
        )
        # ĞŸÑ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€ Ğ½Ğµ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ»
        return False


# ============================================================
# ĞĞ‘Ğ ĞĞ‘ĞĞ¢ĞšĞ ANTISPAM
# ============================================================

async def _process_antispam(
    message: Message,
    session: AsyncSession
) -> bool:
    """
    ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· Antispam.

    Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ° Ğ¸Ğ· antispam_filter_handler.py Ñ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸ÑĞ¼Ğ¸.
    ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ° ÑƒĞ¶Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ° Ğ² ĞºĞ¾Ğ¾Ñ€Ğ´Ğ¸Ğ½Ğ°Ñ‚Ğ¾Ñ€Ğµ - Ğ·Ğ´ĞµÑÑŒ Ğ½Ğµ Ğ´ÑƒĞ±Ğ»Ğ¸Ñ€ÑƒĞµĞ¼.

    Args:
        message: Ğ’Ñ…Ğ¾Ğ´ÑÑ‰ĞµĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
        session: Ğ¡ĞµÑÑĞ¸Ñ Ğ‘Ğ”

    Returns:
        bool: True ĞµÑĞ»Ğ¸ ÑĞ¿Ğ°Ğ¼ Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½ Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½, False ĞµÑĞ»Ğ¸ Ğ½ĞµÑ‚
    """
    chat_id = message.chat.id
    user_id = message.from_user.id

    try:
        # Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½ÑƒÑ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ½Ğ° ÑĞ¿Ğ°Ğ¼
        decision: AntiSpamDecision = await check_message_for_spam(message, session)

        # Ğ•ÑĞ»Ğ¸ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ½Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ ÑĞ¿Ğ°Ğ¼Ğ¾Ğ¼ - Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ False
        if not decision.is_spam:
            logger.debug(f"[COORDINATOR/AS] Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ½Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ ÑĞ¿Ğ°Ğ¼Ğ¾Ğ¼")
            return False

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ¡ĞŸĞĞœ ĞĞ‘ĞĞĞ Ğ£Ğ–Ğ•Ğ - Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        logger.warning(
            f"[COORDINATOR/AS] âš ï¸ ĞĞ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½ ÑĞ¿Ğ°Ğ¼! ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ¾: {decision.triggered_rule_type}, "
            f"Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ: {decision.action}, ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: {decision.reason}"
        )

        # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ TTL Ğ´Ğ»Ñ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğ¹ (Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾-ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ)
        warning_ttl = await get_warning_ttl(session, chat_id)

        # Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ĞµÑĞ»Ğ¸ ÑÑ‚Ğ¾ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾ Ğ² Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğµ Ğ˜Ğ›Ğ˜ ĞµÑĞ»Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ DELETE
        should_delete = decision.delete_message or decision.action == ActionType.DELETE
        if should_delete:
            try:
                await message.delete()
                logger.info(f"[COORDINATOR/AS] ğŸ—‘ï¸ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾ (message_id={message.message_id})")
            except TelegramBadRequest as e:
                logger.error(f"[COORDINATOR/AS] ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ: {e}")
            except TelegramForbiddenError:
                logger.error("[COORDINATOR/AS] Ğ£ Ğ±Ğ¾Ñ‚Ğ° Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ½Ğ° ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹")

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # ĞŸĞ Ğ˜ĞœĞ•ĞĞ¯Ğ•Ğœ Ğ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ•
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        await _apply_antispam_action(message, session, decision, warning_ttl)

        # Ğ¡Ğ¿Ğ°Ğ¼ Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½ Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½
        return True

    except Exception as e:
        # Ğ›Ğ¾Ğ²Ğ¸Ğ¼ Ğ²ÑĞµ Ğ½ĞµĞ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ ÑƒĞ¿Ğ°Ğ» Ğ²ĞµÑÑŒ Ğ±Ğ¾Ñ‚
        logger.error(
            f"[COORDINATOR/AS] ĞĞµĞ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: {e}",
            exc_info=True
        )
        return False


async def _apply_antispam_action(
    message: Message,
    session: AsyncSession,
    decision: AntiSpamDecision,
    warning_ttl: int
) -> None:
    """
    ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ°Ğ½Ñ‚Ğ¸ÑĞ¿Ğ°Ğ¼Ğ° Ğº Ğ½Ğ°Ñ€ÑƒÑˆĞ¸Ñ‚ĞµĞ»Ñ.

    Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¸Ğ·Ğ²Ğ»ĞµÑ‡ĞµĞ½Ğ° Ğ¸Ğ· antispam_filter_handler.py.

    Args:
        message: Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ-Ğ½Ğ°Ñ€ÑƒÑˆĞ¸Ñ‚ĞµĞ»ÑŒ
        session: Ğ¡ĞµÑÑĞ¸Ñ Ğ‘Ğ”
        decision: Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ Ğ°Ğ½Ñ‚Ğ¸ÑĞ¿Ğ°Ğ¼Ğ°
        warning_ttl: TTL Ğ´Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğ¹
    """
    chat_id = message.chat.id
    user_id = message.from_user.id

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ğ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ•: DELETE - Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if decision.action == ActionType.DELETE:
        logger.info(f"[COORDINATOR/AS] Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ DELETE Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ {user_id}")
        # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ² Ğ¶ÑƒÑ€Ğ½Ğ°Ğ» Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹
        await send_journal_event(
            bot=message.bot,
            session=session,
            group_id=chat_id,
            message_text=(
                f"ğŸ—‘ï¸ <b>ĞĞ½Ñ‚Ğ¸ÑĞ¿Ğ°Ğ¼: Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ</b>\n\n"
                f"ğŸ‘¤ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: {message.from_user.mention_html()} "
                f"[<code>{user_id}</code>]\n"
                f"ğŸ“‹ ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ¾: {decision.triggered_rule_type.value if decision.triggered_rule_type else 'N/A'}\n"
                f"ğŸ’¬ ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: {decision.reason}\n"
                f"ğŸ—‘ï¸ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾: Ğ”Ğ°"
            ),
            # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸ ĞœÑƒÑ‚/Ğ‘Ğ°Ğ½/Ğ¡Ğ½ÑÑ‚ÑŒ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ
            reply_markup=create_journal_action_keyboard(
                user_id=user_id,
                chat_id=chat_id,
                restrict_minutes=decision.restrict_minutes
            )
        )

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ğ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ•: WARN - Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    elif decision.action == ActionType.WARN:
        try:
            # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚ĞµĞºÑÑ‚ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ñ
            warning_text = (
                f"âš ï¸ <b>ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ</b>\n\n"
                f"ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {message.from_user.mention_html()}, "
                f"Ğ²Ğ°ÑˆĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ½Ğ°Ñ€ÑƒÑˆĞ°ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ°:\n"
                f"<i>{decision.reason}</i>"
            )
            # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ
            sent_msg = await message.answer(warning_text, parse_mode="HTML")
            logger.info(f"[COORDINATOR/AS] ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ {user_id}")

            # ĞŸĞ»Ğ°Ğ½Ğ¸Ñ€ÑƒĞµĞ¼ Ğ°Ğ²Ñ‚Ğ¾-ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ ĞµÑĞ»Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ TTL
            if warning_ttl > 0:
                await schedule_message_deletion(sent_msg, warning_ttl)

            # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ² Ğ¶ÑƒÑ€Ğ½Ğ°Ğ» Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹
            await send_journal_event(
                bot=message.bot,
                session=session,
                group_id=chat_id,
                message_text=(
                    f"âš ï¸ <b>ĞĞ½Ñ‚Ğ¸ÑĞ¿Ğ°Ğ¼: ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ğµ</b>\n\n"
                    f"ğŸ‘¤ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: {message.from_user.mention_html()} "
                    f"[<code>{user_id}</code>]\n"
                    f"ğŸ“‹ ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ¾: {decision.triggered_rule_type.value if decision.triggered_rule_type else 'N/A'}\n"
                    f"ğŸ’¬ ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: {decision.reason}\n"
                    f"ğŸ—‘ï¸ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾: {'Ğ”Ğ°' if decision.delete_message else 'ĞĞµÑ‚'}"
                ),
                # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸ ĞœÑƒÑ‚/Ğ‘Ğ°Ğ½/Ğ¡Ğ½ÑÑ‚ÑŒ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ
                reply_markup=create_journal_action_keyboard(
                    user_id=user_id,
                    chat_id=chat_id,
                    restrict_minutes=decision.restrict_minutes
                )
            )
        except Exception as e:
            logger.error(f"[COORDINATOR/AS] ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ Ğ¿Ñ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ñ: {e}")

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ğ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ•: KICK - Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ¸Ğ· Ñ‡Ğ°Ñ‚Ğ°
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    elif decision.action == ActionType.KICK:
        try:
            # Ğ‘Ğ°Ğ½Ğ¸Ğ¼ Ğ¸ ÑÑ€Ğ°Ğ·Ñƒ Ñ€Ğ°Ğ·Ğ±Ğ°Ğ½Ğ¸Ğ²Ğ°ĞµĞ¼ (ÑÑ„Ñ„ĞµĞºÑ‚ ĞºĞ¸ĞºĞ°)
            await message.bot.ban_chat_member(chat_id, user_id)
            await message.bot.unban_chat_member(chat_id, user_id)
            logger.info(f"[COORDINATOR/AS] ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_id} Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½ Ğ¸Ğ· Ñ‡Ğ°Ñ‚Ğ°")

            # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ
            try:
                kick_text = (
                    f"ğŸ‘¢ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {message.from_user.mention_html()} "
                    f"Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½ Ğ¸Ğ· Ñ‡Ğ°Ñ‚Ğ°.\n"
                    f"<i>ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: {decision.reason}</i>"
                )
                sent_msg = await message.answer(kick_text, parse_mode="HTML")
                if warning_ttl > 0:
                    await schedule_message_deletion(sent_msg, warning_ttl)
            except Exception:
                pass

            # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ² Ğ¶ÑƒÑ€Ğ½Ğ°Ğ» Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹
            await send_journal_event(
                bot=message.bot,
                session=session,
                group_id=chat_id,
                message_text=(
                    f"ğŸ‘¢ <b>ĞĞ½Ñ‚Ğ¸ÑĞ¿Ğ°Ğ¼: Ğ˜ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ</b>\n\n"
                    f"ğŸ‘¤ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: {message.from_user.mention_html()} "
                    f"[<code>{user_id}</code>]\n"
                    f"ğŸ“‹ ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ¾: {decision.triggered_rule_type.value if decision.triggered_rule_type else 'N/A'}\n"
                    f"ğŸ’¬ ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: {decision.reason}\n"
                    f"ğŸ—‘ï¸ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾: {'Ğ”Ğ°' if decision.delete_message else 'ĞĞµÑ‚'}"
                ),
                # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸ ĞœÑƒÑ‚/Ğ‘Ğ°Ğ½/Ğ¡Ğ½ÑÑ‚ÑŒ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ
                reply_markup=create_journal_action_keyboard(
                    user_id=user_id,
                    chat_id=chat_id,
                    restrict_minutes=decision.restrict_minutes
                )
            )

        except TelegramBadRequest as e:
            logger.error(f"[COORDINATOR/AS] ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ĞºĞ¸ĞºĞ½ÑƒÑ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: {e}")
        except TelegramForbiddenError:
            logger.error("[COORDINATOR/AS] Ğ£ Ğ±Ğ¾Ñ‚Ğ° Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ½Ğ° Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²")

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ğ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ•: RESTRICT - Ğ¼ÑƒÑ‚
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    elif decision.action == ActionType.RESTRICT:
        try:
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¾Ğ±ÑŠĞµĞºÑ‚ Ñ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼Ğ¸ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸ (Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¼ÑƒÑ‚)
            permissions = ChatPermissions(
                can_send_messages=False,
                can_send_media_messages=False,
                can_send_polls=False,
                can_send_other_messages=False,
                can_add_web_page_previews=False,
                can_change_info=False,
                can_invite_users=False,
                can_pin_messages=False,
            )

            # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ Ğ²Ñ€ĞµĞ¼Ñ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ
            until_date = None
            if decision.restrict_minutes and decision.restrict_minutes > 0:
                until_date = timedelta(minutes=decision.restrict_minutes)

            # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ
            await message.bot.restrict_chat_member(
                chat_id,
                user_id,
                permissions=permissions,
                until_date=until_date
            )

            logger.info(
                f"[COORDINATOR/AS] ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_id} Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½ "
                f"({'Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ°' if not decision.restrict_minutes else f'{decision.restrict_minutes} Ğ¼Ğ¸Ğ½ÑƒÑ‚'})"
            )

            # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ
            try:
                if decision.restrict_minutes:
                    mute_text = (
                        f"ğŸ”‡ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {message.from_user.mention_html()} "
                        f"Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½ Ğ½Ğ° {decision.restrict_minutes} Ğ¼Ğ¸Ğ½ÑƒÑ‚.\n"
                        f"<i>ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: {decision.reason}</i>"
                    )
                else:
                    mute_text = (
                        f"ğŸ”‡ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {message.from_user.mention_html()} "
                        f"Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½ Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ°.\n"
                        f"<i>ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: {decision.reason}</i>"
                    )
                sent_msg = await message.answer(mute_text, parse_mode="HTML")
                if warning_ttl > 0:
                    await schedule_message_deletion(sent_msg, warning_ttl)
            except Exception:
                pass

            # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ² Ğ¶ÑƒÑ€Ğ½Ğ°Ğ» Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹
            # Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ ÑÑ‚Ñ€Ğ¾ĞºÑƒ Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ
            duration_str = f"{decision.restrict_minutes} Ğ¼Ğ¸Ğ½." if decision.restrict_minutes else "Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ°"
            await send_journal_event(
                bot=message.bot,
                session=session,
                group_id=chat_id,
                message_text=(
                    f"ğŸ”‡ <b>ĞĞ½Ñ‚Ğ¸ÑĞ¿Ğ°Ğ¼: ĞĞ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ (Ğ¼ÑƒÑ‚)</b>\n\n"
                    f"ğŸ‘¤ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: {message.from_user.mention_html()} "
                    f"[<code>{user_id}</code>]\n"
                    f"â±ï¸ Ğ”Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ: {duration_str}\n"
                    f"ğŸ“‹ ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ¾: {decision.triggered_rule_type.value if decision.triggered_rule_type else 'N/A'}\n"
                    f"ğŸ’¬ ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: {decision.reason}\n"
                    f"ğŸ—‘ï¸ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾: {'Ğ”Ğ°' if decision.delete_message else 'ĞĞµÑ‚'}"
                ),
                # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸ ĞœÑƒÑ‚/Ğ‘Ğ°Ğ½/Ğ¡Ğ½ÑÑ‚ÑŒ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ
                reply_markup=create_journal_action_keyboard(
                    user_id=user_id,
                    chat_id=chat_id,
                    restrict_minutes=decision.restrict_minutes
                )
            )

        except TelegramBadRequest as e:
            logger.error(f"[COORDINATOR/AS] ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: {e}")
        except TelegramForbiddenError:
            logger.error("[COORDINATOR/AS] Ğ£ Ğ±Ğ¾Ñ‚Ğ° Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ½Ğ° Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ğµ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²")

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ğ”Ğ•Ğ™Ğ¡Ğ¢Ğ’Ğ˜Ğ•: BAN - Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ°
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    elif decision.action == ActionType.BAN:
        try:
            # Ğ‘Ğ°Ğ½Ğ¸Ğ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ°
            await message.bot.ban_chat_member(chat_id, user_id)
            logger.info(f"[COORDINATOR/AS] ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {user_id} Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ°")

            # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ
            try:
                ban_text = (
                    f"ğŸš« ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ {message.from_user.mention_html()} "
                    f"Ğ·Ğ°Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ½Ğ°Ğ²ÑĞµĞ³Ğ´Ğ°.\n"
                    f"<i>ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: {decision.reason}</i>"
                )
                sent_msg = await message.answer(ban_text, parse_mode="HTML")
                if warning_ttl > 0:
                    await schedule_message_deletion(sent_msg, warning_ttl)
            except Exception:
                pass

            # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ² Ğ¶ÑƒÑ€Ğ½Ğ°Ğ» Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹ Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹
            await send_journal_event(
                bot=message.bot,
                session=session,
                group_id=chat_id,
                message_text=(
                    f"ğŸš« <b>ĞĞ½Ñ‚Ğ¸ÑĞ¿Ğ°Ğ¼: Ğ‘Ğ°Ğ½</b>\n\n"
                    f"ğŸ‘¤ ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ: {message.from_user.mention_html()} "
                    f"[<code>{user_id}</code>]\n"
                    f"ğŸ“‹ ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ¾: {decision.triggered_rule_type.value if decision.triggered_rule_type else 'N/A'}\n"
                    f"ğŸ’¬ ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°: {decision.reason}\n"
                    f"ğŸ—‘ï¸ Ğ¡Ğ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¾: {'Ğ”Ğ°' if decision.delete_message else 'ĞĞµÑ‚'}"
                ),
                # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ ĞºĞ»Ğ°Ğ²Ğ¸Ğ°Ñ‚ÑƒÑ€Ñƒ Ñ ĞºĞ½Ğ¾Ğ¿ĞºĞ°Ğ¼Ğ¸ ĞœÑƒÑ‚/Ğ‘Ğ°Ğ½/Ğ¡Ğ½ÑÑ‚ÑŒ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ
                reply_markup=create_journal_action_keyboard(
                    user_id=user_id,
                    chat_id=chat_id,
                    restrict_minutes=decision.restrict_minutes
                )
            )

        except TelegramBadRequest as e:
            logger.error(f"[COORDINATOR/AS] ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ±Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ: {e}")
        except TelegramForbiddenError:
            logger.error("[COORDINATOR/AS] Ğ£ Ğ±Ğ¾Ñ‚Ğ° Ğ½ĞµÑ‚ Ğ¿Ñ€Ğ°Ğ² Ğ½Ğ° Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºÑƒ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²")


# ============================================================
# ĞĞ‘Ğ ĞĞ‘ĞĞ¢ĞšĞ PROFILE MONITOR
# ============================================================

async def _process_profile_monitor(
    message: Message,
    session: AsyncSession
) -> bool:
    """
    ĞĞ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· Profile Monitor.

    ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ÑĞµÑ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¼ÑƒÑ‚
    Ğ¿Ğ¾ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼ ĞºÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸ÑĞ¼ (Ğ½ĞµÑ‚ Ñ„Ğ¾Ñ‚Ğ¾ + Ğ¼Ğ¾Ğ»Ğ¾Ğ´Ğ¾Ğ¹ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚, ÑĞ¼ĞµĞ½Ğ° Ğ¸Ğ¼ĞµĞ½Ğ¸ Ğ¸ Ñ‚.Ğ´.)

    Args:
        message: Ğ’Ñ…Ğ¾Ğ´ÑÑ‰ĞµĞµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ
        session: Ğ¡ĞµÑÑĞ¸Ñ Ğ‘Ğ”

    Returns:
        bool: True ĞµÑĞ»Ğ¸ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ ÑÑ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ» (Ğ°Ğ²Ñ‚Ğ¾Ğ¼ÑƒÑ‚), False ĞµÑĞ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑ‰ĞµĞ½
    """
    chat_id = message.chat.id
    user_id = message.from_user.id

    try:
        # Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ Ğ¸Ğ· monitor_handler
        result = await process_message_profile_check(
            message=message,
            session=session,
            bot=message.bot,
        )

        # Ğ•ÑĞ»Ğ¸ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ Ğ²Ñ‹ĞºĞ»ÑÑ‡ĞµĞ½ Ğ¸Ğ»Ğ¸ Ğ½ĞµÑ‚ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ°
        if not result:
            return False

        # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚
        action = result.get("action_taken")
        if action:
            logger.info(
                f"[COORDINATOR/PM] Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ: chat={chat_id}, user={user_id}, "
                f"action={action}, reason={result.get('reason')}"
            )
            return action == "auto_mute"

        return False

    except Exception as e:
        # Ğ›Ğ¾Ğ³Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾ÑˆĞ¸Ğ±ĞºÑƒ, Ğ½Ğ¾ Ğ½Ğµ Ğ¿Ğ°Ğ´Ğ°ĞµĞ¼
        logger.exception(
            f"[COORDINATOR/PM] ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸: {e}, "
            f"chat={chat_id}, user={user_id}"
        )
        return False
