# ============================================================
# IMPORT PATTERNS - –ò–ú–ü–û–†–¢ –ü–ê–¢–¢–ï–†–ù–û–í –ò–ó –¢–ï–ö–°–¢–ê
# ============================================================
# –≠—Ç–æ—Ç –º–æ–¥—É–ª—å —Å–æ–¥–µ—Ä–∂–∏—Ç —Ö–µ–Ω–¥–ª–µ—Ä—ã –¥–ª—è —É–º–Ω–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤:
# - start_import_patterns: –Ω–∞—á–∞–ª–æ –∏–º–ø–æ—Ä—Ç–∞ (cf:spi:)
# - process_import_text: –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞, –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ—Ä–∞–∑
# - show_import_weight_menu: –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –≤–µ—Å–∞ (cf:spiw:)
# - set_import_weight: —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–µ—Å–∞ (cf:spw:)
# - confirm_import_patterns: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∏–º–ø–æ—Ä—Ç–∞ (cf:spic:)
#
# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ settings_handler.py (–ü—Ä–∞–≤–∏–ª–æ 28)
# –í—ã–Ω–µ—Å–µ–Ω–æ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è —Å–æ–±–ª—é–¥–µ–Ω–∏—è SRP (–ü—Ä–∞–≤–∏–ª–æ 30)
# ============================================================

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º Router –∏ F –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
from aiogram import Router, F
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–∏–ø—ã –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback –∏ —Å–æ–æ–±—â–µ–Ω–∏–π
from aiogram.types import CallbackQuery, Message
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º FSM –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è–º–∏
from aiogram.fsm.context import FSMContext
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏—è Telegram API
from aiogram.exceptions import TelegramAPIError

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º SQLAlchemy –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
from sqlalchemy.ext.asyncio import AsyncSession

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è UI
from bot.keyboards.content_filter_keyboards import (
    # –ú–µ–Ω—é –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ (–¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞)
    create_scam_patterns_menu,
    # –ü—Ä–µ–≤—å—é –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    create_import_preview_menu,
    # –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã –≤–≤–æ–¥–∞
    create_cancel_pattern_input_menu,
    # –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –≤–µ—Å–∞
    create_import_weight_menu
)

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±—â–∏–µ –æ–±—ä–µ–∫—Ç—ã (–ª–æ–≥–≥–µ—Ä, filter_manager)
from bot.handlers.content_filter.shared import filter_manager, logger
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º FSM states –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
from bot.handlers.content_filter.common import AddPatternStates
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Å–µ—Ä–≤–∏—Å –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
from bot.services.content_filter import get_pattern_service

# –°–æ–∑–¥–∞—ë–º —Ä–æ—É—Ç–µ—Ä –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
import_patterns_router = Router(name='scam_import_patterns')


# ============================================================
# –ù–ê–ß–ê–õ–û –ò–ú–ü–û–†–¢–ê
# ============================================================

@import_patterns_router.callback_query(F.data.regexp(r"^cf:spi:-?\d+$"))
async def start_import_patterns(
    callback: CallbackQuery,
    state: FSMContext
) -> None:
    """
    –ù–∞—á–∏–Ω–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –∏–º–ø–æ—Ä—Ç–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∏–∑ —Ç–µ–∫—Å—Ç–∞.

    –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—Å—Ç–∞–≤–ª—è–µ—Ç —Å–∫–∞–º-—Å–æ–æ–±—â–µ–Ω–∏–µ, –±–æ—Ç –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –µ–≥–æ
    –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∫–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–∫ –ø–∞—Ç—Ç–µ—Ä–Ω—ã.

    Callback: cf:spi:{chat_id}

    Args:
        callback: CallbackQuery –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        state: FSMContext –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —à–∞–≥–∞–º–∏
    """
    # –ü–∞—Ä—Å–∏–º chat_id –∏–∑ callback_data
    parts = callback.data.split(":")
    # –¢—Ä–µ—Ç–∏–π —ç–ª–µ–º–µ–Ω—Ç - —ç—Ç–æ chat_id (–º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º –¥–ª—è –≥—Ä—É–ø–ø)
    chat_id = int(parts[2])

    # –ü–µ—Ä–µ–≤–æ–¥–∏–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    await state.set_state(AddPatternStates.waiting_for_import_text)

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    text = (
        f"üì• <b>–ò–º–ø–æ—Ä—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∏–∑ —Ç–µ–∫—Å—Ç–∞</b>\n\n"
        f"–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ —Å–∫–∞–º-—Å–æ–æ–±—â–µ–Ω–∏–µ —Ü–µ–ª–∏–∫–æ–º.\n"
        f"–Ø –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É—é –µ–≥–æ –∏ –∏–∑–≤–ª–µ–∫—É –∫–ª—é—á–µ–≤—ã–µ —Ñ—Ä–∞–∑—ã.\n\n"
        f"<i>–≠—Ç–∏ —Ñ—Ä–∞–∑—ã —Å—Ç–∞–Ω—É—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏ –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ø–æ—Ö–æ–∂–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.</i>"
    )

    # –°–æ–∑–¥–∞—ë–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π –æ—Ç–º–µ–Ω—ã
    keyboard = create_cancel_pattern_input_menu(chat_id)

    # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    try:
        await callback.message.edit_text(text, reply_markup=keyboard, parse_mode="HTML")
    except TelegramAPIError:
        # –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
        pass

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ FSM –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —Ö–µ–Ω–¥–ª–µ—Ä–∞—Ö
    await state.update_data(
        # ID —á–∞—Ç–∞ –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        chat_id=chat_id,
        # –î–µ—Ñ–æ–ª—Ç–Ω—ã–π –≤–µ—Å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
        import_weight=25,
        # ID —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        bot_message_id=callback.message.message_id,
        # ID —á–∞—Ç–∞ —Å –±–æ—Ç–æ–º (–¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è)
        bot_chat_id=callback.message.chat.id
    )

    # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å "—á–∞—Å–∏–∫–∏"
    await callback.answer()


# ============================================================
# –û–ë–†–ê–ë–û–¢–ö–ê –¢–ï–ö–°–¢–ê –î–õ–Ø –ò–ú–ü–û–†–¢–ê
# ============================================================

@import_patterns_router.message(AddPatternStates.waiting_for_import_text)
async def process_import_text(
    message: Message,
    state: FSMContext,
    session: AsyncSession
) -> None:
    """
    –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—ã.

    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —ç–≤—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è
    –∫–ª—é—á–µ–≤—ã—Ö —Ñ—Ä–∞–∑ –∏–∑ —Å–∫–∞–º-—Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–µ–≤—å—é
    –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≤—ã–±–æ—Ä–∞ –≤–µ—Å–∞.

    –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–¥–∞–ª—è–µ—Ç—Å—è –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã —á–∞—Ç–∞.

    Args:
        message: –°–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å–∫–∞–º-—Ç–µ–∫—Å—Ç–æ–º –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        state: FSMContext —Å –¥–∞–Ω–Ω—ã–º–∏ –æ —á–∞—Ç–µ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
        session: AsyncSession –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
    """
    # –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ FSM
    data = await state.get_data()
    # ID —á–∞—Ç–∞ –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã
    chat_id = data.get('chat_id')
    # –¢–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–µ—Å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 25)
    weight = data.get('import_weight', 25)
    # ID —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    bot_message_id = data.get('bot_message_id')
    # ID —á–∞—Ç–∞ —Å –±–æ—Ç–æ–º
    bot_chat_id = data.get('bot_chat_id')

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ chat_id —Å–æ—Ö—Ä–∞–Ω—ë–Ω
    if not chat_id:
        await message.answer("‚ùå –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω chat_id. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.")
        await state.clear()
        return

    # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã —á–∞—Ç–∞
    try:
        await message.delete()
    except TelegramAPIError:
        # –ï—Å–ª–∏ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å (–Ω–µ—Ç –ø—Ä–∞–≤) ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
        pass

    # –ü–æ–ª—É—á–∞–µ–º —Å–µ—Ä–≤–∏—Å –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç–µ–∫—Å—Ç–∞
    pattern_service = get_pattern_service()

    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã
    # –ú–µ—Ç–æ–¥ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∫–æ—Ä—Ç–µ–∂–µ–π (—Ñ—Ä–∞–∑–∞, –≤–µ—Å)
    phrases = pattern_service.extract_patterns_from_text(message.text)

    # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã
    if not phrases:
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        error_text = (
            "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞.\n"
            "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Å—Ç–∞–≤–∏—Ç—å –¥—Ä—É–≥–æ–π —Ç–µ–∫—Å—Ç."
        )
        # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π –æ—Ç–º–µ–Ω—ã
        keyboard = create_cancel_pattern_input_menu(chat_id)
        # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞
        try:
            await message.bot.edit_message_text(
                text=error_text,
                chat_id=bot_chat_id,
                message_id=bot_message_id,
                reply_markup=keyboard
            )
        except TelegramAPIError:
            # –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
            await message.answer(error_text, reply_markup=keyboard)
        return

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    await state.update_data(extracted_phrases=phrases)

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –ø—Ä–µ–≤—å—é –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    text = f"üîç <b>–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã</b>\n\n"

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–µ 10 –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    for i, (phrase, phrase_weight) in enumerate(phrases[:10], 1):
        # –ö–∞–∂–¥—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω —Å –µ–≥–æ –≤–µ—Å–æ–º
        text += f"{i}. <code>{phrase}</code> (+{phrase_weight})\n"

    # –ï—Å–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –±–æ–ª—å—à–µ 10 ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–æ–ª—å–∫–æ –µ—â—ë
    if len(phrases) > 10:
        text += f"\n<i>...–∏ –µ—â—ë {len(phrases) - 10} –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤</i>\n"

    # –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    text += f"\n<b>–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ:</b> {len(phrases)} –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤"

    # –°–æ–∑–¥–∞—ë–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏: –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å, –ò–∑–º–µ–Ω–∏—Ç—å –≤–µ—Å, –û—Ç–º–µ–Ω–∞
    keyboard = create_import_preview_menu(chat_id, len(phrases))

    # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç–∞ –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ
    try:
        await message.bot.edit_message_text(
            text=text,
            chat_id=bot_chat_id,
            message_id=bot_message_id,
            reply_markup=keyboard,
            parse_mode="HTML"
        )
    except TelegramAPIError:
        # –ï—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å ‚Äî –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await message.answer(text, reply_markup=keyboard, parse_mode="HTML")


# ============================================================
# –ú–ï–ù–Æ –í–´–ë–û–†–ê –í–ï–°–ê
# ============================================================

@import_patterns_router.callback_query(F.data.regexp(r"^cf:spiw:-?\d+$"))
async def show_import_weight_menu(
    callback: CallbackQuery,
    state: FSMContext
) -> None:
    """
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ –≤–µ—Å–∞ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤.

    –í–µ—Å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–∏–ª—å–Ω–æ –ø–∞—Ç—Ç–µ—Ä–Ω –≤–ª–∏—è–µ—Ç –Ω–∞ –æ–±—â–∏–π
    —Å–∫–æ—Ä —Å–∫–∞–º–∞ —Å–æ–æ–±—â–µ–Ω–∏—è:
    - 15 (—Å–ª–∞–±—ã–π) ‚Äî –Ω–µ–±–æ–ª—å—à–æ–π —Å–∏–≥–Ω–∞–ª
    - 25 (—Å—Ä–µ–¥–Ω–∏–π) ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–µ—Å
    - 40 (—Å–∏–ª—å–Ω—ã–π) ‚Äî —è–≤–Ω—ã–π –ø—Ä–∏–∑–Ω–∞–∫ —Å–∫–∞–º–∞

    Callback: cf:spiw:{chat_id}

    Args:
        callback: CallbackQuery –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        state: FSMContext —Å —Ç–µ–∫—É—â–∏–º –≤–µ—Å–æ–º
    """
    # –ü–∞—Ä—Å–∏–º chat_id –∏–∑ callback_data
    parts = callback.data.split(":")
    chat_id = int(parts[2])

    # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–µ—Å –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    data = await state.get_data()
    current_weight = data.get('import_weight', 25)

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –≤–µ—Å–æ–≤
    text = (
        f"‚öñÔ∏è <b>–í—ã–±–æ—Ä –≤–µ—Å–∞ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞</b>\n\n"
        f"–í–µ—Å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –Ω–∞—Å–∫–æ–ª—å–∫–æ —Å–∏–ª—å–Ω–æ –ø–∞—Ç—Ç–µ—Ä–Ω –≤–ª–∏—è–µ—Ç –Ω–∞ —Å–∫–æ—Ä —Å–∫–∞–º–∞.\n\n"
        f"üü¢ –°–ª–∞–±—ã–π (15) ‚Äî –Ω–µ–±–æ–ª—å—à–æ–π —Å–∏–≥–Ω–∞–ª\n"
        f"üü° –°—Ä–µ–¥–Ω–∏–π (25) ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π\n"
        f"üî¥ –°–∏–ª—å–Ω—ã–π (40) ‚Äî —è–≤–Ω—ã–π –ø—Ä–∏–∑–Ω–∞–∫ —Å–∫–∞–º–∞\n\n"
        f"<b>–¢–µ–∫—É—â–∏–π –≤–µ—Å:</b> {current_weight}"
    )

    # –°–æ–∑–¥–∞—ë–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–∞–º–∏ –≤—ã–±–æ—Ä–∞ –≤–µ—Å–∞
    # –ì–∞–ª–æ—á–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Ç–µ–∫—É—â–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–º –≤–µ—Å–µ
    keyboard = create_import_weight_menu(chat_id, current_weight)

    # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    try:
        await callback.message.edit_text(text, reply_markup=keyboard, parse_mode="HTML")
    except TelegramAPIError:
        pass

    # –û—Ç–≤–µ—á–∞–µ–º –Ω–∞ callback
    await callback.answer()


# ============================================================
# –£–°–¢–ê–ù–û–í–ö–ê –í–ï–°–ê
# ============================================================

@import_patterns_router.callback_query(F.data.regexp(r"^cf:spw:\d+:-?\d+$"))
async def set_import_weight(
    callback: CallbackQuery,
    state: FSMContext
) -> None:
    """
    –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤–µ—Å –¥–ª—è –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫ –ø—Ä–µ–≤—å—é.

    –ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –≤–µ—Å–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–µ–≤—å—é –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ —Å –Ω–æ–≤—ã–º –≤–µ—Å–æ–º.

    Callback: cf:spw:{weight}:{chat_id}

    Args:
        callback: CallbackQuery —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –≤–µ—Å–æ–º
        state: FSMContext –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–µ—Å–∞
    """
    # –ü–∞—Ä—Å–∏–º –¥–∞–Ω–Ω—ã–µ –∏–∑ callback_data
    parts = callback.data.split(":")
    # –¢—Ä–µ—Ç–∏–π —ç–ª–µ–º–µ–Ω—Ç ‚Äî –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–µ—Å
    weight = int(parts[2])
    # –ß–µ—Ç–≤—ë—Ä—Ç—ã–π —ç–ª–µ–º–µ–Ω—Ç ‚Äî chat_id
    chat_id = int(parts[3])

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–µ—Å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    await state.update_data(import_weight=weight)

    # –ü–æ–ª—É—á–∞–µ–º –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    data = await state.get_data()
    phrases = data.get('extracted_phrases', [])

    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–µ –ø—Ä–µ–≤—å—é —Å –Ω–æ–≤—ã–º –≤–µ—Å–æ–º
    text = f"üîç <b>–ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã</b>\n\n"

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –≤–µ—Å–æ–º
    for i, (phrase, phrase_weight) in enumerate(phrases[:10], 1):
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–µ—Å –≤–º–µ—Å—Ç–æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ
        text += f"{i}. <code>{phrase}</code> (+{weight})\n"

    # –ï—Å–ª–∏ –±–æ–ª—å—à–µ 10 –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    if len(phrases) > 10:
        text += f"\n<i>...–∏ –µ—â—ë {len(phrases) - 10} –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤</i>\n"

    # –ò—Ç–æ–≥–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –≤–µ—Å–æ–º
    text += f"\n<b>–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ:</b> {len(phrases)} –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤"
    text += f"\n<b>–í–µ—Å:</b> {weight} –±–∞–ª–ª–æ–≤"

    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é —Å –∫–Ω–æ–ø–∫–∞–º–∏
    keyboard = create_import_preview_menu(chat_id, len(phrases))

    # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    try:
        await callback.message.edit_text(text, reply_markup=keyboard, parse_mode="HTML")
    except TelegramAPIError:
        pass

    # –£–≤–µ–¥–æ–º–ª—è–µ–º –æ —Å–º–µ–Ω–µ –≤–µ—Å–∞
    await callback.answer(f"–í–µ—Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {weight}")


# ============================================================
# –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–ï –ò–ú–ü–û–†–¢–ê
# ============================================================

@import_patterns_router.callback_query(F.data.regexp(r"^cf:spic:-?\d+$"))
async def confirm_import_patterns(
    callback: CallbackQuery,
    state: FSMContext,
    session: AsyncSession
) -> None:
    """
    –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç –∏–º–ø–æ—Ä—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç –∏—Ö –≤ –ë–î.

    –î–æ–±–∞–≤–ª—è–µ—Ç –≤—Å–µ –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã –∫–∞–∫ –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –≤–µ—Å–æ–º.
    –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç: —Å–∫–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ, —Å–∫–æ–ª—å–∫–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤.

    Callback: cf:spic:{chat_id}

    Args:
        callback: CallbackQuery –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        state: FSMContext —Å –∏–∑–≤–ª–µ—á—ë–Ω–Ω—ã–º–∏ —Ñ—Ä–∞–∑–∞–º–∏ –∏ –≤–µ—Å–æ–º
        session: AsyncSession –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
    """
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    data = await state.get_data()
    # ID —á–∞—Ç–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    chat_id = data.get('chat_id')
    # –ò–∑–≤–ª–µ—á—ë–Ω–Ω—ã–µ —Ñ—Ä–∞–∑—ã (—Å–ø–∏—Å–æ–∫ –∫–æ—Ä—Ç–µ–∂–µ–π: —Ñ—Ä–∞–∑–∞, –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π_–≤–µ—Å)
    phrases = data.get('extracted_phrases', [])
    # –í—ã–±—Ä–∞–Ω–Ω—ã–π –≤–µ—Å (–∏–ª–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π 25)
    weight = data.get('import_weight', 25)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –µ—Å—Ç—å —Ñ—Ä–∞–∑—ã –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞
    if not phrases:
        await callback.answer("‚ùå –ù–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞")
        await state.clear()
        return

    # –ü–æ–ª—É—á–∞–µ–º —Å–µ—Ä–≤–∏—Å –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    pattern_service = get_pattern_service()

    # –°—á—ë—Ç—á–∏–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    added = 0       # –£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ
    skipped = 0     # –ü—Ä–æ–ø—É—â–µ–Ω–æ –∏–∑-–∑–∞ –æ—à–∏–±–æ–∫
    duplicates = 0  # –î—É–±–ª–∏–∫–∞—Ç—ã (—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç)

    # –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
    for phrase, phrase_weight in phrases:
        try:
            # add_pattern –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ç–µ–∂ (success: bool, message: str)
            success, message = await pattern_service.add_pattern(
                chat_id=chat_id,
                pattern=phrase,
                # –¢–∏–ø –ø–∞—Ç—Ç–µ—Ä–Ω–∞ ‚Äî phrase (–ø–æ–¥—Å—Ç—Ä–æ–∫–∞)
                pattern_type='phrase',
                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≤–µ—Å, –∏–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –µ—Å–ª–∏ –≤–µ—Å = 25
                weight=phrase_weight if weight == 25 else weight,
                # ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ—Ç–æ—Ä—ã–π –¥–æ–±–∞–≤–∏–ª –ø–∞—Ç—Ç–µ—Ä–Ω
                created_by=callback.from_user.id,
                session=session
            )
            if success:
                # –ü–∞—Ç—Ç–µ—Ä–Ω —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω
                added += 1
            else:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–∞–∑–∞
                if "—É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç" in message:
                    # –≠—Ç–æ –¥—É–±–ª–∏–∫–∞—Ç
                    duplicates += 1
                else:
                    # –î—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞
                    skipped += 1
                    logger.info(f"[IMPORT] –ü–∞—Ç—Ç–µ—Ä–Ω –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω: '{phrase}' - {message}")
        except Exception as e:
            # –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞
            logger.warning(f"[IMPORT] –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ '{phrase}': {e}")
            skipped += 1

    # –û—á–∏—â–∞–µ–º FSM —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    await state.clear()

    # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    patterns_count = await pattern_service.get_patterns_count(chat_id, session)

    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    result_lines = [f"‚úÖ <b>–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω</b>\n"]
    # –°–∫–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ
    result_lines.append(f"–î–æ–±–∞–≤–ª–µ–Ω–æ: {added}")
    # –°–∫–æ–ª—å–∫–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    if duplicates > 0:
        result_lines.append(f"–î—É–±–ª–∏–∫–∞—Ç—ã (–ø—Ä–æ–ø—É—â–µ–Ω—ã): {duplicates}")
    # –°–∫–æ–ª—å–∫–æ –æ—à–∏–±–æ–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å)
    if skipped > 0:
        result_lines.append(f"–û—à–∏–±–∫–∏: {skipped}")
    # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å –∏ –∏—Ç–æ–≥
    result_lines.append(f"\nüéØ <b>–ü–∞—Ç—Ç–µ—Ä–Ω—ã –∞–Ω—Ç–∏—Å–∫–∞–º–∞</b>")
    result_lines.append(f"–í—Å–µ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤: {patterns_count}")

    # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å—Ç—Ä–æ–∫–∏ –≤ —Ç–µ–∫—Å—Ç
    text = "\n".join(result_lines)

    # –ö–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –º–µ–Ω—é –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    keyboard = create_scam_patterns_menu(chat_id, patterns_count)

    # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    try:
        await callback.message.edit_text(text, reply_markup=keyboard, parse_mode="HTML")
    except TelegramAPIError:
        pass

    # –£–≤–µ–¥–æ–º–ª—è–µ–º –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ
    await callback.answer(f"–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ: {added}, –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: {duplicates}")
