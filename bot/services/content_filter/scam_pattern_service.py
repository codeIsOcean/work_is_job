# ============================================================
# SCAM PATTERN SERVICE - –°–ï–†–í–ò–° –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–ê–¢–¢–ï–†–ù–ê–ú–ò –°–ö–ê–ú–ê
# ============================================================
# –≠—Ç–æ—Ç –º–æ–¥—É–ª—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏
# –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏ —Å–∫–∞–º–∞, –∫–æ—Ç–æ—Ä—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ë–î (—Ç–∞–±–ª–∏—Ü–∞ scam_patterns).
#
# –ö–∞–∂–¥–∞—è –≥—Ä—É–ø–ø–∞ –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Å–≤–æ–∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è
# –¥–µ—Ç–µ–∫—Ç–æ—Ä–æ–º —Å–∫–∞–º–∞ (scam_detector.py) –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π.
#
# –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
# - add_pattern: –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
# - get_patterns: –ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≥—Ä—É–ø–ø—ã
# - delete_pattern: —É–¥–∞–ª–∏—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω
# - extract_patterns_from_text: –∞–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ—Ä–∞–∑
# - increment_trigger_count: —É–≤–µ–ª–∏—á–∏—Ç—å —Å—á—ë—Ç—á–∏–∫ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π
# ============================================================

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–∏–ø—ã –¥–ª—è –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π
from typing import Optional, List, Tuple, Dict, Any
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º datetime –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—Ä–µ–º–µ–Ω–µ–º
from datetime import datetime, timezone
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ª–æ–≥–≥–µ—Ä
import logging
# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ñ—Ä–∞–∑
import re

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º SQLAlchemy –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ë–î
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, delete, update, func, or_
from sqlalchemy.exc import IntegrityError

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥–µ–ª–∏ ScamPattern, ScamScoreThreshold –∏ –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã
from bot.database.models_content_filter import (
    ScamPattern,
    ScamScoreThreshold,
    CustomSpamSection,
    CustomSectionPattern
)

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–π –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
# –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∏ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
from bot.services.content_filter.text_normalizer import get_normalizer

# –°–æ–∑–¥–∞—ë–º –ª–æ–≥–≥–µ—Ä –¥–ª—è —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è
logger = logging.getLogger(__name__)


# ============================================================
# –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
# ============================================================

def _utcnow_naive() -> datetime:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ UTC –≤—Ä–µ–º—è –±–µ–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —á–∞—Å–æ–≤–æ–º –ø–æ—è—Å–µ.
    PostgreSQL —Ö—Ä–∞–Ω–∏—Ç timestamp without timezone.
    """
    return datetime.now(timezone.utc).replace(tzinfo=None)


def _normalize_pattern(text: str) -> str:
    """
    –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –ø–æ–∏—Å–∫–∞.

    –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ TextNormalizer —á—Ç–æ –∏ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π,
    —á—Ç–æ–±—ã –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∏ —Ç–µ–∫—Å—Ç–∞ –±—ã–ª–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ–π.

    –û–ø–µ—Ä–∞—Ü–∏–∏ (—á–µ—Ä–µ–∑ TextNormalizer):
    - –ü—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
    - –£–¥–∞–ª—è–µ—Ç –Ω–µ–≤–∏–¥–∏–º—ã–µ —Å–∏–º–≤–æ–ª—ã (zero-width)
    - –£–¥–∞–ª—è–µ—Ç —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –º–µ–∂–¥—É –±—É–∫–≤–∞–º–∏ (/, -, ., –∏ —Ç.–¥.)
    - –ó–∞–º–µ–Ω—è–µ—Ç l33tspeak –∏ –ª–∞—Ç–∏–Ω–∏—Ü—É –Ω–∞ –∫–∏—Ä–∏–ª–ª–∏—Ü—É

    Args:
        text: –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞

    Returns:
        –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
    """
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º TextNormalizer –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–µ–π —Ç–µ–∫—Å—Ç–∞
    normalizer = get_normalizer()
    normalized = normalizer.normalize(text)
    # –£–±–∏—Ä–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–∏—Å—å)
    normalized = re.sub(r'\s+', ' ', normalized)
    # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –ø–æ –∫—Ä–∞—è–º
    normalized = normalized.strip()
    return normalized


def _determine_pattern_type(text: str) -> str:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –ø–æ –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É.

    Args:
        text: –¢–µ–∫—Å—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞

    Returns:
        'word' –µ—Å–ª–∏ –æ–¥–Ω–æ —Å–ª–æ–≤–æ, 'phrase' –µ—Å–ª–∏ —Ñ—Ä–∞–∑–∞
    """
    # –£–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã –ø–æ –∫—Ä–∞—è–º
    stripped = text.strip()
    # –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–µ–ª—ã –≤–Ω—É—Ç—Ä–∏ ‚Äî —ç—Ç–æ —Ñ—Ä–∞–∑–∞
    if ' ' in stripped:
        return 'phrase'
    # –ò–Ω–∞—á–µ ‚Äî —Å–ª–æ–≤–æ
    return 'word'


def _calculate_weight(text: str) -> int:
    """
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –≤–µ—Å –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –µ–≥–æ –¥–ª–∏–Ω—ã –∏ —Ç–∏–ø–∞.

    –õ–æ–≥–∏–∫–∞:
    - –û–¥–Ω–æ –∫–æ—Ä–æ—Ç–∫–æ–µ —Å–ª–æ–≤–æ (< 5 —Å–∏–º–≤–æ–ª–æ–≤): 15 –±–∞–ª–ª–æ–≤
    - –û–¥–Ω–æ –¥–ª–∏–Ω–Ω–æ–µ —Å–ª–æ–≤–æ (>= 5 —Å–∏–º–≤–æ–ª–æ–≤): 20 –±–∞–ª–ª–æ–≤
    - –§—Ä–∞–∑–∞ –∏–∑ 2 —Å–ª–æ–≤: 25 –±–∞–ª–ª–æ–≤
    - –§—Ä–∞–∑–∞ –∏–∑ 3+ —Å–ª–æ–≤: 30 –±–∞–ª–ª–æ–≤

    Args:
        text: –¢–µ–∫—Å—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞

    Returns:
        –í–µ—Å –ø–∞—Ç—Ç–µ—Ä–Ω–∞ (10-50)
    """
    # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å–ª–æ–≤–∞
    words = text.strip().split()
    word_count = len(words)

    if word_count == 1:
        # –û–¥–Ω–æ —Å–ª–æ–≤–æ ‚Äî –≤–µ—Å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –¥–ª–∏–Ω—ã
        if len(words[0]) < 5:
            return 15  # –ö–æ—Ä–æ—Ç–∫–æ–µ —Å–ª–æ–≤–æ
        else:
            return 20  # –î–ª–∏–Ω–Ω–æ–µ —Å–ª–æ–≤–æ
    elif word_count == 2:
        return 25  # –§—Ä–∞–∑–∞ –∏–∑ 2 —Å–ª–æ–≤
    else:
        return 30  # –§—Ä–∞–∑–∞ –∏–∑ 3+ —Å–ª–æ–≤


# ============================================================
# –ö–õ–ê–°–° –°–ï–†–í–ò–°–ê –ü–ê–¢–¢–ï–†–ù–û–í
# ============================================================

class ScamPatternService:
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏ —Å–∫–∞–º–∞ –≤ –ë–î.

    –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç:
    - CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    - –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞ –∏ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ñ—Ä–∞–∑
    - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π
    - –≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤

    –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
        service = ScamPatternService()

        # –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω
        await service.add_pattern(
            chat_id=-1001234567890,
            pattern="–≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Ö–æ–¥",
            created_by=123456789,
            session=session
        )

        # –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≥—Ä—É–ø–ø—ã
        patterns = await service.get_patterns(chat_id, session)
    """

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –î–û–ë–ê–í–õ–ï–ù–ò–ï –ü–ê–¢–¢–ï–†–ù–ê
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def add_pattern(
        self,
        chat_id: int,
        pattern: str,
        created_by: int,
        session: AsyncSession,
        weight: Optional[int] = None,
        category: Optional[str] = None,
        pattern_type: Optional[str] = None
    ) -> Tuple[bool, str]:
        """
        –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω —Å–∫–∞–º–∞ –¥–ª—è –≥—Ä—É–ø–ø—ã.

        Args:
            chat_id: ID –≥—Ä—É–ø–ø—ã
            pattern: –¢–µ–∫—Å—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞ (—Å–ª–æ–≤–æ –∏–ª–∏ —Ñ—Ä–∞–∑–∞)
            created_by: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ—Ç–æ—Ä—ã–π –¥–æ–±–∞–≤–ª—è–µ—Ç
            session: –°–µ—Å—Å–∏—è –ë–î
            weight: –í–µ—Å –ø–∞—Ç—Ç–µ—Ä–Ω–∞ (–µ—Å–ª–∏ None ‚Äî —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
            category: –ö–∞—Ç–µ–≥–æ—Ä–∏—è (money, crypto, gambling, drugs, adult, other)
            pattern_type: –¢–∏–ø (word, phrase, regex), –µ—Å–ª–∏ None ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

        Returns:
            Tuple[bool, str]: (—É—Å–ø–µ—Ö, —Å–æ–æ–±—â–µ–Ω–∏–µ)
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–∞—Ç—Ç–µ—Ä–Ω –Ω–µ –ø—É—Å—Ç–æ–π
        if not pattern or not pattern.strip():
            return False, "–ü–∞—Ç—Ç–µ—Ä–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"

        # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω
        normalized = _normalize_pattern(pattern)

        # –ï—Å–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π (< 2 —Å–∏–º–≤–æ–ª–æ–≤)
        if len(normalized) < 2:
            return False, "–ü–∞—Ç—Ç–µ—Ä–Ω —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π (–º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞)"

        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç—ã
        # –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω —Å —Ç–∞–∫–∏–º –∂–µ normalized —Ç–µ–∫—Å—Ç–æ–º
        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        existing = await session.execute(
            select(ScamPattern).where(
                ScamPattern.chat_id == chat_id,
                ScamPattern.normalized == normalized
            )
        )
        # –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç (–∏–ª–∏ None)
        existing_pattern = existing.scalar_one_or_none()

        # –ï—Å–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É
        if existing_pattern:
            return False, f"–ü–∞—Ç—Ç–µ—Ä–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: '{existing_pattern.pattern}'"

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω
        if pattern_type is None:
            pattern_type = _determine_pattern_type(pattern)

        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≤–µ—Å –µ—Å–ª–∏ –Ω–µ –∑–∞–¥–∞–Ω
        if weight is None:
            weight = _calculate_weight(pattern)

        try:
            # –°–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞
            new_pattern = ScamPattern(
                chat_id=chat_id,
                pattern=pattern.strip(),
                normalized=normalized,
                pattern_type=pattern_type,
                weight=weight,
                category=category,
                is_active=True,
                triggers_count=0,
                created_by=created_by,
                created_at=_utcnow_naive()
            )

            # –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–µ—Å—Å–∏—é
            session.add(new_pattern)
            # –§–∏–∫—Å–∏—Ä—É–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
            await session.commit()

            # –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—Ö
            logger.info(
                f"[ScamPatternService] –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω '{pattern}' "
                f"–≤ —á–∞—Ç {chat_id} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {created_by}"
            )

            return True, f"–ü–∞—Ç—Ç–µ—Ä–Ω –¥–æ–±–∞–≤–ª–µ–Ω (–≤–µ—Å: {weight})"

        except IntegrityError:
            # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –ø—Ä–∏ –¥—É–±–ª–∏–∫–∞—Ç–µ
            await session.rollback()
            logger.warning(
                f"[ScamPatternService] –ü–∞—Ç—Ç–µ—Ä–Ω '{pattern}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —á–∞—Ç–µ {chat_id}"
            )
            return False, "–¢–∞–∫–æ–π –ø–∞—Ç—Ç–µ—Ä–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"

        except Exception as e:
            # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–µ
            await session.rollback()
            logger.error(f"[ScamPatternService] –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞: {e}")
            return False, f"–û—à–∏–±–∫–∞: {str(e)}"

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –ü–û–õ–£–ß–ï–ù–ò–ï –ü–ê–¢–¢–ï–†–ù–û–í
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def get_patterns(
        self,
        chat_id: int,
        session: AsyncSession,
        active_only: bool = True
    ) -> List[ScamPattern]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≥—Ä—É–ø–ø—ã.

        Args:
            chat_id: ID –≥—Ä—É–ø–ø—ã
            session: –°–µ—Å—Å–∏—è –ë–î
            active_only: –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é True)

        Returns:
            –°–ø–∏—Å–æ–∫ –æ–±—ä–µ–∫—Ç–æ–≤ ScamPattern
        """
        try:
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å
            query = select(ScamPattern).where(ScamPattern.chat_id == chat_id)

            # –ï—Å–ª–∏ –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ
            if active_only:
                query = query.where(ScamPattern.is_active == True)

            # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É)
            query = query.order_by(ScamPattern.created_at.desc())

            # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
            result = await session.execute(query)
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
            return list(result.scalars().all())

        except Exception as e:
            logger.error(f"[ScamPatternService] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤: {e}")
            return []

    async def get_patterns_count(
        self,
        chat_id: int,
        session: AsyncSession,
        active_only: bool = True
    ) -> int:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤ –≥—Ä—É–ø–ø–µ.

        Args:
            chat_id: ID –≥—Ä—É–ø–ø—ã
            session: –°–µ—Å—Å–∏—è –ë–î
            active_only: –°—á–∏—Ç–∞—Ç—å —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ

        Returns:
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
        """
        try:
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –ø–æ–¥—Å—á—ë—Ç–∞
            query = select(func.count(ScamPattern.id)).where(
                ScamPattern.chat_id == chat_id
            )

            if active_only:
                query = query.where(ScamPattern.is_active == True)

            # –í—ã–ø–æ–ª–Ω—è–µ–º
            result = await session.execute(query)
            return result.scalar() or 0

        except Exception as e:
            logger.error(f"[ScamPatternService] –û—à–∏–±–∫–∞ –ø–æ–¥—Å—á—ë—Ç–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤: {e}")
            return 0

    async def get_pattern_by_id(
        self,
        pattern_id: int,
        session: AsyncSession
    ) -> Optional[ScamPattern]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω –ø–æ –µ–≥–æ ID.

        Args:
            pattern_id: ID –ø–∞—Ç—Ç–µ—Ä–Ω–∞
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            ScamPattern –∏–ª–∏ None
        """
        try:
            query = select(ScamPattern).where(ScamPattern.id == pattern_id)
            result = await session.execute(query)
            return result.scalar_one_or_none()
        except Exception as e:
            logger.error(f"[ScamPatternService] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞ {pattern_id}: {e}")
            return None

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –£–î–ê–õ–ï–ù–ò–ï –ü–ê–¢–¢–ï–†–ù–ê
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def delete_pattern(
        self,
        pattern_id: int,
        session: AsyncSession
    ) -> bool:
        """
        –£–¥–∞–ª—è–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω –ø–æ ID.

        Args:
            pattern_id: ID –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            True –µ—Å–ª–∏ —É–¥–∞–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
        """
        try:
            # –í—ã–ø–æ–ª–Ω—è–µ–º —É–¥–∞–ª–µ–Ω–∏–µ
            query = delete(ScamPattern).where(ScamPattern.id == pattern_id)
            result = await session.execute(query)
            await session.commit()

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —á—Ç–æ-—Ç–æ —É–¥–∞–ª–∏–ª–∏
            if result.rowcount > 0:
                logger.info(f"[ScamPatternService] –£–¥–∞–ª—ë–Ω –ø–∞—Ç—Ç–µ—Ä–Ω ID={pattern_id}")
                return True
            else:
                logger.warning(f"[ScamPatternService] –ü–∞—Ç—Ç–µ—Ä–Ω ID={pattern_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")
                return False

        except Exception as e:
            await session.rollback()
            logger.error(f"[ScamPatternService] –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞: {e}")
            return False

    async def delete_all_patterns(
        self,
        chat_id: int,
        session: AsyncSession
    ) -> int:
        """
        –£–¥–∞–ª—è–µ—Ç –≤—Å–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≥—Ä—É–ø–ø—ã.

        Args:
            chat_id: ID –≥—Ä—É–ø–ø—ã
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
        """
        try:
            query = delete(ScamPattern).where(ScamPattern.chat_id == chat_id)
            result = await session.execute(query)
            await session.commit()

            deleted_count = result.rowcount
            logger.info(
                f"[ScamPatternService] –£–¥–∞–ª–µ–Ω–æ {deleted_count} –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –∏–∑ —á–∞—Ç–∞ {chat_id}"
            )
            return deleted_count

        except Exception as e:
            await session.rollback()
            logger.error(f"[ScamPatternService] –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤: {e}")
            return 0

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ê–ö–¢–ò–í–ù–û–°–¢–ò
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def toggle_pattern(
        self,
        pattern_id: int,
        session: AsyncSession
    ) -> bool:
        """
        –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω–∞ (–≤–∫–ª/–≤—ã–∫–ª).

        Args:
            pattern_id: ID –ø–∞—Ç—Ç–µ—Ä–Ω–∞
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            True –µ—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
        """
        try:
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω
            pattern = await self.get_pattern_by_id(pattern_id, session)
            if not pattern:
                return False

            # –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            new_status = not pattern.is_active

            # –û–±–Ω–æ–≤–ª—è–µ–º
            query = update(ScamPattern).where(
                ScamPattern.id == pattern_id
            ).values(is_active=new_status)

            await session.execute(query)
            await session.commit()

            logger.info(
                f"[ScamPatternService] –ü–∞—Ç—Ç–µ—Ä–Ω ID={pattern_id} "
                f"{'–≤–∫–ª—é—á—ë–Ω' if new_status else '–≤—ã–∫–ª—é—á–µ–Ω'}"
            )
            return True

        except Exception as e:
            await session.rollback()
            logger.error(f"[ScamPatternService] –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞: {e}")
            return False

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–¢–ê–¢–ò–°–¢–ò–ö–ò –°–†–ê–ë–ê–¢–´–í–ê–ù–ò–ô
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def increment_trigger_count(
        self,
        pattern_id: int,
        session: AsyncSession
    ) -> None:
        """
        –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω–∞.
        –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ –ø–∞—Ç—Ç–µ—Ä–Ω —Å—Ä–∞–±–æ—Ç–∞–ª –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è.

        Args:
            pattern_id: ID –ø–∞—Ç—Ç–µ—Ä–Ω–∞
            session: –°–µ—Å—Å–∏—è –ë–î
        """
        try:
            # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è
            query = update(ScamPattern).where(
                ScamPattern.id == pattern_id
            ).values(
                triggers_count=ScamPattern.triggers_count + 1,
                last_triggered_at=_utcnow_naive()
            )

            await session.execute(query)
            await session.commit()

        except Exception as e:
            await session.rollback()
            logger.error(f"[ScamPatternService] –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á—ë—Ç—á–∏–∫–∞: {e}")

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –ê–ù–ê–õ–ò–ó –¢–ï–ö–°–¢–ê –ò –ò–ó–í–õ–ï–ß–ï–ù–ò–ï –§–†–ê–ó
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    def extract_patterns_from_text(
        self,
        text: str,
        min_word_length: int = 3,
        min_phrase_words: int = 2,
        max_phrase_words: int = 5
    ) -> List[Tuple[str, int]]:
        """
        –ò–∑–≤–ª–µ–∫–∞–µ—Ç –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏–∑ —Å–∫–∞–º-—Ç–µ–∫—Å—Ç–∞.

        –ê–ª–≥–æ—Ä–∏—Ç–º (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ GitHub):
        1. –†–∞–∑–±–∏–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –Ω–∞ —Å—Ç—Ä–æ–∫–∏
        2. –ò–∑ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –∑–Ω–∞—á–∏–º—ã–µ —Å–ª–æ–≤–∞ (—Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Å—Ç–æ–ø-—Å–ª–æ–≤–∞)
        3. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ —Ä–∞–∑–Ω–æ–π –¥–ª–∏–Ω—ã (—Å–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ 2-5 —Å–ª–æ–≤)
        4. –§–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ –¥–ª–∏–Ω–µ –∏ –∑–Ω–∞—á–∏–º–æ—Å—Ç–∏
        5. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –≤–µ—Å –¥–ª—è –∫–∞–∂–¥–æ–π —Ñ—Ä–∞–∑—ã

        Args:
            text: –¢–µ–∫—Å—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (—Å–∫–∞–º-—Å–æ–æ–±—â–µ–Ω–∏–µ)
            min_word_length: –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–ª–æ–≤–∞
            min_phrase_words: –ú–∏–Ω–∏–º—É–º —Å–ª–æ–≤ –≤ —Ñ—Ä–∞–∑–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 2)
            max_phrase_words: –ú–∞–∫—Å–∏–º—É–º —Å–ª–æ–≤ –≤ —Ñ—Ä–∞–∑–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5)

        Returns:
            –°–ø–∏—Å–æ–∫ –∫–æ—Ä—Ç–µ–∂–µ–π (—Ñ—Ä–∞–∑–∞, –≤–µ—Å)
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–µ–∫—Å—Ç –Ω–µ –ø—É—Å—Ç–æ–π
        if not text or not text.strip():
            return []

        # –†–µ–∑—É–ª—å—Ç–∞—Ç ‚Äî —Å–ø–∏—Å–æ–∫ (—Ñ—Ä–∞–∑–∞, –≤–µ—Å)
        extracted: List[Tuple[str, int]] = []

        # –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (–ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ)
        seen: set = set()

        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        # –°—Ç–æ–ø-—Å–ª–æ–≤–∞ –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –∏–º–µ—é—Ç —Å–º—ã—Å–ª–∞ –∫–∞–∫ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
        # (–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞ GitHub)
        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        stop_words = {
            '–∏', '–≤', '–Ω–∞', '—Å', '–ø–æ', '–∏–∑', '–∑–∞', '–∫', '–æ—Ç', '–¥–æ', '—É',
            '–¥–ª—è', '–ø—Ä–∏', '–æ', '–æ–±', '–∞', '–Ω–æ', '–∏–ª–∏', '–∂–µ', '–±—ã', '–Ω–µ',
            '–¥–∞', '—Ç–æ', '–∫–∞–∫', '—Ç–∞–∫', '—ç—Ç–æ', '—á—Ç–æ', '–∫—Ç–æ', '–≥–¥–µ', '–∫–æ–≥–¥–∞',
            '–µ—Å–ª–∏', '—É–∂–µ', '–µ—â—ë', '–µ—â–µ', '–≤—Å–µ', '–≤—Å—ë', '–≤—ã', '–º—ã', '–æ–Ω–∏'
        }

        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        # –®–ê–ì 1: –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å—Ç—Ä–æ–∫–∏ (–∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç)
        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        lines = text.strip().split('\n')

        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        # –ü–æ–ª—É—á–∞–µ–º –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ç–æ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±—Ñ—É—Å–∫–∞—Ü–∏–∏
        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        normalizer = get_normalizer()

        for line in lines:
            # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            # –®–ê–ì 2: –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –ü–ï–†–ï–î –æ—á–∏—Å—Ç–∫–æ–π
            # –≠—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å –æ–±—Ñ—É—Å—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º:
            # "–®.–ò.–®.–õ.–û" ‚Üí "—à–∏—à–ª–æ", "Œ∫—É—Ä—å–µœÅ" ‚Üí "–∫—É—Ä—å–µ—Ä"
            # "üÖºüÖ¥üÖµ" ‚Üí "–º–µ—Ñ", "–ø–æ—Ä–æ—Ö—Ö" ‚Üí "–ø–æ—Ä–æ—Ö"
            # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            line_normalized = normalizer.normalize(line)

            # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            # –®–ê–ì 3: –û—á–∏—â–∞–µ–º —Å—Ç—Ä–æ–∫—É –æ—Ç —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤
            # –£–±–∏—Ä–∞–µ–º —ç–º–æ–¥–∑–∏, –æ—Å—Ç–∞–≤–ª—è–µ–º –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –¥–µ—Ñ–∏—Å, —Å–ª—ç—à
            # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            line_cleaned = re.sub(r'[^\w\s\-/]', ' ', line_normalized)
            # –£–±–∏—Ä–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã
            line_cleaned = re.sub(r'\s+', ' ', line_cleaned).strip()

            # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
            if not line_cleaned:
                continue

            # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å–ª–æ–≤–∞
            words = line_cleaned.split()

            # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            # –®–ê–ì 4: –§–∏–ª—å—Ç—Ä—É–µ–º —Å–ª–æ–≤–∞ –ø–æ –¥–ª–∏–Ω–µ –∏ —Å—Ç–æ–ø-—Å–ª–æ–≤–∞–º
            # –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–∏–º—ã–µ —Å–ª–æ–≤–∞
            # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            significant_words = [
                w for w in words
                if len(w) >= min_word_length and w.lower() not in stop_words
            ]

            # –ï—Å–ª–∏ –Ω–µ—Ç –∑–Ω–∞—á–∏–º—ã—Ö —Å–ª–æ–≤ ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫—É
            if not significant_words:
                continue

            # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            # –®–ê–ì 5: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ—Ä–∞–∑—ã —Ä–∞–∑–Ω–æ–π –¥–ª–∏–Ω—ã
            # –°–∫–æ–ª—å–∑—è—â–µ–µ –æ–∫–Ω–æ –æ—Ç min_phrase_words –¥–æ max_phrase_words
            # –≠—Ç–æ –∫–ª—é—á–µ–≤–∞—è –ª–æ–≥–∏–∫–∞ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞!
            # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            for phrase_len in range(min_phrase_words, min(max_phrase_words + 1, len(significant_words) + 1)):
                for i in range(len(significant_words) - phrase_len + 1):
                    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ñ—Ä–∞–∑—É –∏–∑ phrase_len –ø–æ–¥—Ä—è–¥ –∏–¥—É—â–∏—Ö —Å–ª–æ–≤
                    phrase_words = significant_words[i:i + phrase_len]
                    phrase = ' '.join(phrase_words)

                    # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
                    normalized = _normalize_pattern(phrase)

                    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ —É–∂–µ –≤–∏–¥–µ–ª–∏ —Ç–∞–∫—É—é —Ñ—Ä–∞–∑—É
                    if normalized in seen:
                        continue

                    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–µ (–º–µ–Ω—å—à–µ 5 —Å–∏–º–≤–æ–ª–æ–≤)
                    if len(normalized) < 5:
                        continue

                    # –î–æ–±–∞–≤–ª—è–µ–º –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                    seen.add(normalized)
                    weight = _calculate_weight(phrase)
                    extracted.append((phrase, weight))

        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        # –®–ê–ì 5: –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤–µ—Å—É (–æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É)
        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        extracted.sort(key=lambda x: x[1], reverse=True)

        # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (–º–∞–∫—Å–∏–º—É–º 20 —Ñ—Ä–∞–∑ –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ)
        return extracted[:20]

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –≠–ö–°–ü–û–†–¢ –ü–ê–¢–¢–ï–†–ù–û–í
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def export_patterns(
        self,
        chat_id: int,
        session: AsyncSession
    ) -> str:
        """
        –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≥—Ä—É–ø–ø—ã –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç.
        –ö–∞–∂–¥—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ.

        Args:
            chat_id: ID –≥—Ä—É–ø–ø—ã
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            –¢–µ–∫—Å—Ç —Å –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏ (–∫–∞–∂–¥—ã–π –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ)
        """
        patterns = await self.get_patterns(chat_id, session, active_only=False)

        if not patterns:
            return ""

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç: –∫–∞–∂–¥—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ
        lines = [p.pattern for p in patterns]
        return '\n'.join(lines)

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –ò–ú–ü–û–†–¢ –ü–ê–¢–¢–ï–†–ù–û–í –ò–ó –¢–ï–ö–°–¢–ê
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def import_patterns_from_text(
        self,
        chat_id: int,
        text: str,
        created_by: int,
        session: AsyncSession
    ) -> Tuple[int, int]:
        """
        –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞ (–∫–∞–∂–¥–∞—è —Å—Ç—Ä–æ–∫–∞ = –ø–∞—Ç—Ç–µ—Ä–Ω).

        Args:
            chat_id: ID –≥—Ä—É–ø–ø—ã
            text: –¢–µ–∫—Å—Ç —Å –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏ (–∫–∞–∂–¥—ã–π –Ω–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–µ)
            created_by: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ—Ç–æ—Ä—ã–π –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            Tuple[int, int]: (–¥–æ–±–∞–≤–ª–µ–Ω–æ, –ø—Ä–æ–ø—É—â–µ–Ω–æ)
        """
        if not text or not text.strip():
            return 0, 0

        # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å—Ç—Ä–æ–∫–∏
        lines = text.strip().split('\n')

        added = 0
        skipped = 0

        for line in lines:
            pattern = line.strip()
            if not pattern:
                continue

            # –ü—Ä–æ–±—É–µ–º –¥–æ–±–∞–≤–∏—Ç—å
            success, _ = await self.add_pattern(
                chat_id=chat_id,
                pattern=pattern,
                created_by=created_by,
                session=session
            )

            if success:
                added += 1
            else:
                skipped += 1

        logger.info(
            f"[ScamPatternService] –ò–º–ø–æ—Ä—Ç –≤ —á–∞—Ç {chat_id}: "
            f"–¥–æ–±–∞–≤–ª–µ–Ω–æ {added}, –ø—Ä–æ–ø—É—â–µ–Ω–æ {skipped}"
        )

        return added, skipped

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –ü–ï–†–ï–ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø –ü–ê–¢–¢–ï–†–ù–û–í
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def renormalize_all_patterns(
        self,
        chat_id: int,
        session: AsyncSession
    ) -> int:
        """
        –ü–µ—Ä–µ–Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –≤—Å–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≥—Ä—É–ø–ø—ã —Å –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–æ–π –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏.

        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–∏ _normalize_pattern().
        –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª–µ normalized –¥–ª—è –≤—Å–µ—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≥—Ä—É–ø–ø—ã.

        Args:
            chat_id: ID –≥—Ä—É–ø–ø—ã
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
        """
        try:
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≥—Ä—É–ø–ø—ã (–≤–∫–ª—é—á–∞—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ)
            patterns = await self.get_patterns(chat_id, session, active_only=False)

            if not patterns:
                return 0

            updated_count = 0

            for pattern in patterns:
                # –í—ã—á–∏—Å–ª—è–µ–º –Ω–æ–≤—É—é –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é
                new_normalized = _normalize_pattern(pattern.pattern)

                # –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å - –æ–±–Ω–æ–≤–ª—è–µ–º
                if new_normalized != pattern.normalized:
                    query = update(ScamPattern).where(
                        ScamPattern.id == pattern.id
                    ).values(normalized=new_normalized)

                    await session.execute(query)
                    updated_count += 1

                    logger.debug(
                        f"[ScamPatternService] –ü–µ—Ä–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω –ø–∞—Ç—Ç–µ—Ä–Ω #{pattern.id}: "
                        f"'{pattern.normalized}' -> '{new_normalized}'"
                    )

            # –ö–æ–º–º–∏—Ç–∏–º –≤—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            await session.commit()

            logger.info(
                f"[ScamPatternService] –ü–µ—Ä–µ–Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–æ {updated_count} –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ "
                f"–∏–∑ {len(patterns)} –≤ —á–∞—Ç–µ {chat_id}"
            )

            return updated_count

        except Exception as e:
            await session.rollback()
            logger.error(f"[ScamPatternService] –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏: {e}")
            return 0


# ============================================================
# –ì–õ–û–ë–ê–õ–¨–ù–´–ô –≠–ö–ó–ï–ú–ü–õ–Ø–† (–°–ò–ù–ì–õ–¢–û–ù)
# ============================================================

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
_pattern_service: Optional[ScamPatternService] = None


def get_pattern_service() -> ScamPatternService:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä ScamPatternService (—Å–∏–Ω–≥–ª—Ç–æ–Ω).

    Returns:
        –≠–∫–∑–µ–º–ø–ª—è—Ä ScamPatternService
    """
    global _pattern_service
    if _pattern_service is None:
        _pattern_service = ScamPatternService()
    return _pattern_service


# ============================================================
# –°–ï–†–í–ò–° –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–û–†–û–ì–ê–ú–ò –ë–ê–õ–õ–û–í –°–ö–ê–ú–ê
# ============================================================
# –ö–ª–∞—Å—Å –¥–ª—è CRUD –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ø–æ—Ä–æ–≥–∞–º–∏ –±–∞–ª–ª–æ–≤ (ScamScoreThreshold).
# –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–¥–∞–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤ —Å–∫–æ—Ä–∞.

class ScamThresholdService:
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Ä–æ–≥–∞–º–∏ –±–∞–ª–ª–æ–≤ –∞–Ω—Ç–∏—Å–∫–∞–º–∞.

    –ü–æ—Ä–æ–≥–∏ –ø–æ–∑–≤–æ–ª—è—é—Ç –≥—Ä–∞–¥–∏—Ä–æ–≤–∞—Ç—å –¥–µ–π—Å—Ç–≤–∏—è –ø–æ —Å–∫–æ—Ä—É:
    - 100-299 –±–∞–ª–ª–æ–≤ ‚Üí delete (–≤–æ–∑–º–æ–∂–Ω–æ –ª–æ–∂–Ω–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ)
    - 300-399 –±–∞–ª–ª–æ–≤ ‚Üí mute 1 —á–∞—Å (–ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ)
    - 400+ –±–∞–ª–ª–æ–≤ ‚Üí ban (—è–≤–Ω—ã–π —Å–∫–∞–º)
    """

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –ü–û–õ–£–ß–ï–ù–ò–ï –ü–û–†–û–ì–û–í
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def get_thresholds(
        self,
        chat_id: int,
        session: AsyncSession,
        enabled_only: bool = True
    ) -> List[ScamScoreThreshold]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –ø–æ—Ä–æ–≥–∏ –≥—Ä—É–ø–ø—ã.

        Args:
            chat_id: ID –≥—Ä—É–ø–ø—ã
            session: –°–µ—Å—Å–∏—è –ë–î
            enabled_only: –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ—Ä–æ–≥–∏

        Returns:
            –°–ø–∏—Å–æ–∫ –ø–æ—Ä–æ–≥–æ–≤ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
        """
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ—Ä–æ–≥–æ–≤ –≥—Ä—É–ø–ø—ã
        query = select(ScamScoreThreshold).where(
            ScamScoreThreshold.chat_id == chat_id
        )

        # –ï—Å–ª–∏ –Ω—É–∂–Ω—ã —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ - —Ñ–∏–ª—å—Ç—Ä—É–µ–º
        if enabled_only:
            query = query.where(ScamScoreThreshold.enabled == True)

        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É (–º–µ–Ω—å—à–µ = —Ä–∞–Ω—å—à–µ)
        query = query.order_by(ScamScoreThreshold.priority)

        # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
        result = await session.execute(query)
        return list(result.scalars().all())

    async def get_threshold_by_id(
        self,
        threshold_id: int,
        session: AsyncSession
    ) -> Optional[ScamScoreThreshold]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –ø–æ—Ä–æ–≥ –ø–æ ID.

        Args:
            threshold_id: ID –ø–æ—Ä–æ–≥–∞
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            –ü–æ—Ä–æ–≥ –∏–ª–∏ None –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
        """
        query = select(ScamScoreThreshold).where(
            ScamScoreThreshold.id == threshold_id
        )
        result = await session.execute(query)
        return result.scalar_one_or_none()

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –ü–û–ò–°–ö –ü–û–î–•–û–î–Ø–©–ï–ì–û –ü–û–†–û–ì–ê –ü–û –°–ö–û–†–£
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def get_action_for_score(
        self,
        chat_id: int,
        score: int,
        session: AsyncSession
    ) -> Optional[Tuple[str, Optional[int]]]:
        """
        –ù–∞—Ö–æ–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Å–∫–æ—Ä–∞.

        –ü—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ –≤—Å–µ–º –∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ—Ä–æ–≥–∞–º –≥—Ä—É–ø–ø—ã –∏ –∏—â–µ—Ç
        –ø–æ—Ä–æ–≥ –≥–¥–µ min_score <= score <= max_score.

        Args:
            chat_id: ID –≥—Ä—É–ø–ø—ã
            score: –°–∫–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            Tuple[action, mute_duration] –∏–ª–∏ None –µ—Å–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–æ—Ä–æ–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω
        """
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É
        thresholds = await self.get_thresholds(chat_id, session, enabled_only=True)

        # –ò—â–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–æ—Ä–æ–≥
        for threshold in thresholds:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∏–∂–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É
            if score < threshold.min_score:
                continue

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Ö–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω–∞)
            if threshold.max_score is not None and score > threshold.max_score:
                continue

            # –ù–∞—à–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–æ—Ä–æ–≥
            logger.debug(
                f"[ScamThresholdService] –°–∫–æ—Ä {score} –ø–æ–ø–∞–ª –≤ –ø–æ—Ä–æ–≥ "
                f"[{threshold.min_score}-{threshold.max_score or '‚àû'}]: {threshold.action}"
            )
            return (threshold.action, threshold.mute_duration)

        # –ù–µ –Ω–∞—à–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–æ—Ä–æ–≥
        return None

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –î–û–ë–ê–í–õ–ï–ù–ò–ï –ü–û–†–û–ì–ê
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def add_threshold(
        self,
        chat_id: int,
        min_score: int,
        action: str,
        session: AsyncSession,
        max_score: Optional[int] = None,
        mute_duration: Optional[int] = None,
        description: Optional[str] = None,
        priority: int = 0,
        created_by: Optional[int] = None
    ) -> Tuple[bool, Optional[int]]:
        """
        –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π –ø–æ—Ä–æ–≥ –±–∞–ª–ª–æ–≤.

        Args:
            chat_id: ID –≥—Ä—É–ø–ø—ã
            min_score: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å–∫–æ—Ä (–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ)
            action: –î–µ–π—Å—Ç–≤–∏–µ (delete/mute/kick/ban)
            session: –°–µ—Å—Å–∏—è –ë–î
            max_score: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Å–∫–æ—Ä (NULL = –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è)
            mute_duration: –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º—É—Ç–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö
            description: –û–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Ä–æ–≥–∞
            priority: –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–º–µ–Ω—å—à–µ = —Ä–∞–Ω—å—à–µ)
            created_by: ID –∞–¥–º–∏–Ω–∞

        Returns:
            Tuple[bool, Optional[int]]: (—É—Å–ø–µ—Ö, ID –Ω–æ–≤–æ–≥–æ –ø–æ—Ä–æ–≥–∞)
        """
        try:
            # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –ø–æ—Ä–æ–≥
            threshold = ScamScoreThreshold(
                chat_id=chat_id,
                min_score=min_score,
                max_score=max_score,
                action=action,
                mute_duration=mute_duration,
                description=description,
                priority=priority,
                enabled=True,
                created_by=created_by,
                created_at=_utcnow_naive(),
                updated_at=_utcnow_naive()
            )

            # –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–µ—Å—Å–∏—é
            session.add(threshold)
            await session.commit()
            await session.refresh(threshold)

            logger.info(
                f"[ScamThresholdService] –î–æ–±–∞–≤–ª–µ–Ω –ø–æ—Ä–æ–≥ [{min_score}-{max_score or '‚àû'}] "
                f"‚Üí {action} –¥–ª—è —á–∞—Ç–∞ {chat_id}"
            )

            return True, threshold.id

        except Exception as e:
            await session.rollback()
            logger.error(f"[ScamThresholdService] –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ—Ä–æ–≥–∞: {e}")
            return False, None

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–û–†–û–ì–ê
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def update_threshold(
        self,
        threshold_id: int,
        session: AsyncSession,
        min_score: Optional[int] = None,
        max_score: Optional[int] = None,
        action: Optional[str] = None,
        mute_duration: Optional[int] = None,
        description: Optional[str] = None,
        priority: Optional[int] = None,
        enabled: Optional[bool] = None
    ) -> bool:
        """
        –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø–æ—Ä–æ–≥.

        Args:
            threshold_id: ID –ø–æ—Ä–æ–≥–∞
            session: –°–µ—Å—Å–∏—è –ë–î
            (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã - –Ω–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, None = –Ω–µ –º–µ–Ω—è—Ç—å)

        Returns:
            True –µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
        """
        try:
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ª–æ–≤–∞—Ä—å —Å –Ω–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
            values = {'updated_at': _utcnow_naive()}

            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –ø–æ–ª—è
            if min_score is not None:
                values['min_score'] = min_score
            if max_score is not None:
                values['max_score'] = max_score
            if action is not None:
                values['action'] = action
            if mute_duration is not None:
                values['mute_duration'] = mute_duration
            if description is not None:
                values['description'] = description
            if priority is not None:
                values['priority'] = priority
            if enabled is not None:
                values['enabled'] = enabled

            # –í—ã–ø–æ–ª–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            query = update(ScamScoreThreshold).where(
                ScamScoreThreshold.id == threshold_id
            ).values(**values)

            result = await session.execute(query)
            await session.commit()

            if result.rowcount > 0:
                logger.info(f"[ScamThresholdService] –ü–æ—Ä–æ–≥ ID={threshold_id} –æ–±–Ω–æ–≤–ª—ë–Ω")
                return True

            return False

        except Exception as e:
            await session.rollback()
            logger.error(f"[ScamThresholdService] –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Ä–æ–≥–∞: {e}")
            return False

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –£–î–ê–õ–ï–ù–ò–ï –ü–û–†–û–ì–ê
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def delete_threshold(
        self,
        threshold_id: int,
        session: AsyncSession
    ) -> bool:
        """
        –£–¥–∞–ª—è–µ—Ç –ø–æ—Ä–æ–≥ –ø–æ ID.

        Args:
            threshold_id: ID –ø–æ—Ä–æ–≥–∞
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            True –µ—Å–ª–∏ —É–¥–∞–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
        """
        try:
            query = delete(ScamScoreThreshold).where(
                ScamScoreThreshold.id == threshold_id
            )
            result = await session.execute(query)
            await session.commit()

            if result.rowcount > 0:
                logger.info(f"[ScamThresholdService] –£–¥–∞–ª—ë–Ω –ø–æ—Ä–æ–≥ ID={threshold_id}")
                return True

            return False

        except Exception as e:
            await session.rollback()
            logger.error(f"[ScamThresholdService] –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Ä–æ–≥–∞: {e}")
            return False

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ê–ö–¢–ò–í–ù–û–°–¢–ò
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def toggle_threshold(
        self,
        threshold_id: int,
        session: AsyncSession
    ) -> bool:
        """
        –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ—Ä–æ–≥–∞ (–≤–∫–ª/–≤—ã–∫–ª).

        Args:
            threshold_id: ID –ø–æ—Ä–æ–≥–∞
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            True –µ—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
        """
        try:
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø–æ—Ä–æ–≥
            threshold = await self.get_threshold_by_id(threshold_id, session)
            if not threshold:
                return False

            # –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ñ–ª–∞–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            new_status = not threshold.enabled

            # –û–±–Ω–æ–≤–ª—è–µ–º
            query = update(ScamScoreThreshold).where(
                ScamScoreThreshold.id == threshold_id
            ).values(enabled=new_status, updated_at=_utcnow_naive())

            await session.execute(query)
            await session.commit()

            logger.info(
                f"[ScamThresholdService] –ü–æ—Ä–æ–≥ ID={threshold_id} "
                f"{'–≤–∫–ª—é—á—ë–Ω' if new_status else '–≤—ã–∫–ª—é—á–µ–Ω'}"
            )
            return True

        except Exception as e:
            await session.rollback()
            logger.error(f"[ScamThresholdService] –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–æ—Ä–æ–≥–∞: {e}")
            return False


# ============================================================
# –ì–õ–û–ë–ê–õ–¨–ù–´–ô –≠–ö–ó–ï–ú–ü–õ–Ø–† THRESHOLD SERVICE (–°–ò–ù–ì–õ–¢–û–ù)
# ============================================================

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –¥–ª—è –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
_threshold_service: Optional[ScamThresholdService] = None


def get_threshold_service() -> ScamThresholdService:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä ScamThresholdService (—Å–∏–Ω–≥–ª—Ç–æ–Ω).

    Returns:
        –≠–∫–∑–µ–º–ø–ª—è—Ä ScamThresholdService
    """
    global _threshold_service
    if _threshold_service is None:
        _threshold_service = ScamThresholdService()
    return _threshold_service


# ============================================================
# –°–ï–†–í–ò–° –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ö–ê–°–¢–û–ú–ù–´–ú–ò –†–ê–ó–î–ï–õ–ê–ú–ò –°–ü–ê–ú–ê
# ============================================================
# –ö–ª–∞—Å—Å –¥–ª—è CRUD –æ–ø–µ—Ä–∞—Ü–∏–π —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ —Ä–∞–∑–¥–µ–ª–∞–º–∏ (CustomSpamSection)
# –∏ –∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏ (CustomSectionPattern).
#
# –ö–∞—Å—Ç–æ–º–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã –ø–æ–∑–≤–æ–ª—è—é—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ
# –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Å–ø–∞–º–∞ (—Ç–∞–∫—Å–∏, –∂–∏–ª—å—ë, –Ω–∞—Ä–∫–æ—Ç–∏–∫–∏ –∏ —Ç.–¥.) —Å–æ —Å–≤–æ–∏–º–∏:
# - –ù–∞–±–æ—Ä–∞–º–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
# - –ü–æ—Ä–æ–≥–æ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
# - –î–µ–π—Å—Ç–≤–∏–µ–º –ø—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏
# - –ö–∞–Ω–∞–ª–æ–º –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏ (forward + delete)

class CustomSectionService:
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ —Ä–∞–∑–¥–µ–ª–∞–º–∏ —Å–ø–∞–º–∞.

    –ö–∞–∂–¥—ã–π —Ä–∞–∑–¥–µ–ª ‚Äî —ç—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Å–ø–∞–º–∞ —Å:
    - –£–Ω–∏–∫–∞–ª—å–Ω—ã–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º
    - –°–≤–æ–∏–º–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞–º–∏
    - –°–≤–æ–∏–º –ø–æ—Ä–æ–≥–æ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    - –°–≤–æ–∏–º –¥–µ–π—Å—Ç–≤–∏–µ–º (delete/mute/ban/forward_delete)
    - –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –∫–∞–Ω–∞–ª–æ–º –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏
    """

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –ü–û–õ–£–ß–ï–ù–ò–ï –†–ê–ó–î–ï–õ–û–í
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def get_sections(
        self,
        chat_id: int,
        session: AsyncSession,
        enabled_only: bool = True
    ) -> List[CustomSpamSection]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ —Ä–∞–∑–¥–µ–ª—ã –≥—Ä—É–ø–ø—ã.

        Args:
            chat_id: ID –≥—Ä—É–ø–ø—ã
            session: –°–µ—Å—Å–∏—è –ë–î
            enabled_only: –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã

        Returns:
            –°–ø–∏—Å–æ–∫ —Ä–∞–∑–¥–µ–ª–æ–≤ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
        """
        query = select(CustomSpamSection).where(
            CustomSpamSection.chat_id == chat_id
        )

        if enabled_only:
            query = query.where(CustomSpamSection.enabled == True)

        query = query.order_by(CustomSpamSection.name)

        result = await session.execute(query)
        return list(result.scalars().all())

    async def get_section_by_id(
        self,
        section_id: int,
        session: AsyncSession
    ) -> Optional[CustomSpamSection]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —Ä–∞–∑–¥–µ–ª –ø–æ ID.

        Args:
            section_id: ID —Ä–∞–∑–¥–µ–ª–∞
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            –†–∞–∑–¥–µ–ª –∏–ª–∏ None –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
        """
        query = select(CustomSpamSection).where(
            CustomSpamSection.id == section_id
        )
        result = await session.execute(query)
        return result.scalar_one_or_none()

    async def get_section_by_name(
        self,
        chat_id: int,
        name: str,
        session: AsyncSession
    ) -> Optional[CustomSpamSection]:
        """
        –ù–∞—Ö–æ–¥–∏—Ç —Ä–∞–∑–¥–µ–ª –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –≤ –≥—Ä—É–ø–ø–µ.

        Args:
            chat_id: ID –≥—Ä—É–ø–ø—ã
            name: –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            –†–∞–∑–¥–µ–ª –∏–ª–∏ None –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
        """
        query = select(CustomSpamSection).where(
            CustomSpamSection.chat_id == chat_id,
            CustomSpamSection.name == name
        )
        result = await session.execute(query)
        return result.scalar_one_or_none()

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –°–û–ó–î–ê–ù–ò–ï –†–ê–ó–î–ï–õ–ê
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def create_section(
        self,
        chat_id: int,
        name: str,
        session: AsyncSession,
        description: Optional[str] = None,
        threshold: int = 60,
        action: str = 'delete',
        mute_duration: Optional[int] = None,
        forward_channel_id: Optional[int] = None,
        created_by: Optional[int] = None
    ) -> Tuple[bool, Optional[int], Optional[str]]:
        """
        –°–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª —Å–ø–∞–º–∞.

        Args:
            chat_id: ID –≥—Ä—É–ø–ø—ã
            name: –ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞
            session: –°–µ—Å—Å–∏—è –ë–î
            description: –û–ø–∏—Å–∞–Ω–∏–µ
            threshold: –ü–æ—Ä–æ–≥ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 60)
            action: –î–µ–π—Å—Ç–≤–∏–µ (delete/mute/ban/forward_delete)
            mute_duration: –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º—É—Ç–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö
            forward_channel_id: ID –∫–∞–Ω–∞–ª–∞ –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏
            created_by: ID —Å–æ–∑–¥–∞—Ç–µ–ª—è

        Returns:
            Tuple[bool, Optional[int], Optional[str]]:
            (—É—Å–ø–µ—Ö, ID —Ä–∞–∑–¥–µ–ª–∞ –∏–ª–∏ None, —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∏–ª–∏ None)
        """
        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –ø—É—Å—Ç–æ–µ
            name = name.strip()
            if not name:
                return False, None, "–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞–∑–¥–µ–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–ª–∏–Ω—É –Ω–∞–∑–≤–∞–Ω–∏—è
            if len(name) > 100:
                return False, None, "–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–º–∞–∫—Å. 100 —Å–∏–º–≤–æ–ª–æ–≤)"

            # –°–æ–∑–¥–∞—ë–º —Ä–∞–∑–¥–µ–ª
            section = CustomSpamSection(
                chat_id=chat_id,
                name=name,
                description=description,
                enabled=True,
                threshold=threshold,
                action=action,
                mute_duration=mute_duration,
                forward_channel_id=forward_channel_id,
                log_violations=True,
                created_by=created_by,
                created_at=_utcnow_naive(),
                updated_at=_utcnow_naive()
            )

            session.add(section)
            await session.commit()
            await session.refresh(section)

            logger.info(
                f"[CustomSectionService] –°–æ–∑–¥–∞–Ω —Ä–∞–∑–¥–µ–ª '{name}' (ID={section.id}) "
                f"–¥–ª—è —á–∞—Ç–∞ {chat_id}"
            )

            return True, section.id, None

        except IntegrityError:
            await session.rollback()
            return False, None, f"–†–∞–∑–¥–µ–ª —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º '{name}' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"

        except Exception as e:
            await session.rollback()
            logger.error(f"[CustomSectionService] –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∞: {e}")
            return False, None, str(e)

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –û–ë–ù–û–í–õ–ï–ù–ò–ï –†–ê–ó–î–ï–õ–ê
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def update_section(
        self,
        section_id: int,
        session: AsyncSession,
        name: Optional[str] = None,
        description: Optional[str] = None,
        threshold: Optional[int] = None,
        action: Optional[str] = None,
        mute_duration: Optional[int] = None,
        forward_channel_id: Optional[int] = None,
        mute_text: Optional[str] = None,
        ban_text: Optional[str] = None,
        delete_delay: Optional[int] = None,
        notification_delete_delay: Optional[int] = None,
        log_violations: Optional[bool] = None,
        enabled: Optional[bool] = None,
        forward_on_delete: Optional[bool] = None,
        forward_on_mute: Optional[bool] = None,
        forward_on_ban: Optional[bool] = None,
        cas_enabled: Optional[bool] = None,
        add_to_spammer_db: Optional[bool] = None
    ) -> Tuple[bool, Optional[str]]:
        """
        –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ä–∞–∑–¥–µ–ª.

        Args:
            section_id: ID —Ä–∞–∑–¥–µ–ª–∞
            session: –°–µ—Å—Å–∏—è –ë–î
            (–æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã - –Ω–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, None = –Ω–µ –º–µ–Ω—è—Ç—å)

        Returns:
            Tuple[bool, Optional[str]]: (—É—Å–ø–µ—Ö, —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∏–ª–∏ None)
        """
        try:
            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–ª–æ–≤–∞—Ä—å —Å –Ω–æ–≤—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
            values = {'updated_at': _utcnow_naive()}

            if name is not None:
                name = name.strip()
                if not name:
                    return False, "–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"
                if len(name) > 100:
                    return False, "–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ"
                values['name'] = name

            if description is not None:
                values['description'] = description
            if threshold is not None:
                values['threshold'] = threshold
            if action is not None:
                values['action'] = action
            if mute_duration is not None:
                values['mute_duration'] = mute_duration
            if forward_channel_id is not None:
                values['forward_channel_id'] = forward_channel_id
            if mute_text is not None:
                values['mute_text'] = mute_text
            if ban_text is not None:
                values['ban_text'] = ban_text
            if delete_delay is not None:
                values['delete_delay'] = delete_delay
            if notification_delete_delay is not None:
                values['notification_delete_delay'] = notification_delete_delay
            if log_violations is not None:
                values['log_violations'] = log_violations
            if enabled is not None:
                values['enabled'] = enabled
            if forward_on_delete is not None:
                values['forward_on_delete'] = forward_on_delete
            if forward_on_mute is not None:
                values['forward_on_mute'] = forward_on_mute
            if forward_on_ban is not None:
                values['forward_on_ban'] = forward_on_ban
            if cas_enabled is not None:
                values['cas_enabled'] = cas_enabled
            if add_to_spammer_db is not None:
                values['add_to_spammer_db'] = add_to_spammer_db

            query = update(CustomSpamSection).where(
                CustomSpamSection.id == section_id
            ).values(**values)

            result = await session.execute(query)
            await session.commit()

            if result.rowcount > 0:
                logger.info(f"[CustomSectionService] –†–∞–∑–¥–µ–ª ID={section_id} –æ–±–Ω–æ–≤–ª—ë–Ω")
                return True, None

            return False, "–†–∞–∑–¥–µ–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"

        except IntegrityError:
            await session.rollback()
            return False, "–†–∞–∑–¥–µ–ª —Å —Ç–∞–∫–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"

        except Exception as e:
            await session.rollback()
            logger.error(f"[CustomSectionService] –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∞: {e}")
            return False, str(e)

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –£–î–ê–õ–ï–ù–ò–ï –†–ê–ó–î–ï–õ–ê
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def delete_section(
        self,
        section_id: int,
        session: AsyncSession
    ) -> bool:
        """
        –£–¥–∞–ª—è–µ—Ç —Ä–∞–∑–¥–µ–ª –∏ –≤—Å–µ –µ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω—ã (CASCADE).

        Args:
            section_id: ID —Ä–∞–∑–¥–µ–ª–∞
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            True –µ—Å–ª–∏ —É–¥–∞–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
        """
        try:
            query = delete(CustomSpamSection).where(
                CustomSpamSection.id == section_id
            )
            result = await session.execute(query)
            await session.commit()

            if result.rowcount > 0:
                logger.info(f"[CustomSectionService] –£–¥–∞–ª—ë–Ω —Ä–∞–∑–¥–µ–ª ID={section_id}")
                return True

            return False

        except Exception as e:
            await session.rollback()
            logger.error(f"[CustomSectionService] –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∞: {e}")
            return False

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –ê–ö–¢–ò–í–ù–û–°–¢–ò –†–ê–ó–î–ï–õ–ê
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def toggle_section(
        self,
        section_id: int,
        session: AsyncSession
    ) -> bool:
        """
        –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ä–∞–∑–¥–µ–ª–∞ (–≤–∫–ª/–≤—ã–∫–ª).

        Args:
            section_id: ID —Ä–∞–∑–¥–µ–ª–∞
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            True –µ—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
        """
        try:
            section = await self.get_section_by_id(section_id, session)
            if not section:
                return False

            new_status = not section.enabled

            query = update(CustomSpamSection).where(
                CustomSpamSection.id == section_id
            ).values(enabled=new_status, updated_at=_utcnow_naive())

            await session.execute(query)
            await session.commit()

            logger.info(
                f"[CustomSectionService] –†–∞–∑–¥–µ–ª ID={section_id} "
                f"{'–≤–∫–ª—é—á—ë–Ω' if new_status else '–≤—ã–∫–ª—é—á–µ–Ω'}"
            )
            return True

        except Exception as e:
            await session.rollback()
            logger.error(f"[CustomSectionService] –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–∞–∑–¥–µ–ª–∞: {e}")
            return False

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –ü–ê–¢–¢–ï–†–ù–´ –†–ê–ó–î–ï–õ–ê
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def get_section_patterns(
        self,
        section_id: int,
        session: AsyncSession,
        active_only: bool = True
    ) -> List[CustomSectionPattern]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ä–∞–∑–¥–µ–ª–∞.

        Args:
            section_id: ID —Ä–∞–∑–¥–µ–ª–∞
            session: –°–µ—Å—Å–∏—è –ë–î
            active_only: –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã

        Returns:
            –°–ø–∏—Å–æ–∫ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ –≤–µ—Å—É (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)
        """
        query = select(CustomSectionPattern).where(
            CustomSectionPattern.section_id == section_id
        )

        if active_only:
            query = query.where(CustomSectionPattern.is_active == True)

        query = query.order_by(CustomSectionPattern.weight.desc())

        result = await session.execute(query)
        return list(result.scalars().all())

    async def search_patterns(
        self,
        section_id: int,
        query_text: str,
        session: AsyncSession,
        limit: int = 20
    ) -> List[CustomSectionPattern]:
        """
        –ü–æ–∏—Å–∫ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ —Ä–∞–∑–¥–µ–ª–∞ –ø–æ —Ç–µ–∫—Å—Ç—É.

        –ò—â–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –≤ –ø–æ–ª—è—Ö pattern –∏ normalized.

        Args:
            section_id: ID —Ä–∞–∑–¥–µ–ª–∞
            query_text: –¢–µ–∫—Å—Ç –¥–ª—è –ø–æ–∏—Å–∫–∞
            session: –°–µ—Å—Å–∏—è –ë–î
            limit: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

        Returns:
            –°–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ ID
        """
        # –ò—â–µ–º –≤ pattern –∏–ª–∏ normalized (—Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ)
        search_query = select(CustomSectionPattern).where(
            CustomSectionPattern.section_id == section_id,
            or_(
                CustomSectionPattern.pattern.ilike(f'%{query_text}%'),
                CustomSectionPattern.normalized.ilike(f'%{query_text}%')
            )
        ).order_by(CustomSectionPattern.id).limit(limit)

        result = await session.execute(search_query)
        return list(result.scalars().all())

    async def add_section_pattern(
        self,
        section_id: int,
        pattern: str,
        session: AsyncSession,
        pattern_type: str = 'phrase',
        weight: int = 25,
        created_by: Optional[int] = None
    ) -> Tuple[bool, Optional[int], Optional[str]]:
        """
        –î–æ–±–∞–≤–ª—è–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω –≤ —Ä–∞–∑–¥–µ–ª.

        Args:
            section_id: ID —Ä–∞–∑–¥–µ–ª–∞
            pattern: –¢–µ–∫—Å—Ç –ø–∞—Ç—Ç–µ—Ä–Ω–∞
            session: –°–µ—Å—Å–∏—è –ë–î
            pattern_type: –¢–∏–ø (word/phrase/regex)
            weight: –í–µ—Å –ø–∞—Ç—Ç–µ—Ä–Ω–∞
            created_by: ID —Å–æ–∑–¥–∞—Ç–µ–ª—è

        Returns:
            Tuple[bool, Optional[int], Optional[str]]:
            (—É—Å–ø–µ—Ö, ID –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –∏–ª–∏ None, —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –∏–ª–∏ None)
        """
        try:
            pattern = pattern.strip()
            if not pattern:
                return False, None, "–ü–∞—Ç—Ç–µ—Ä–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"

            if len(pattern) > 500:
                return False, None, "–ü–∞—Ç—Ç–µ—Ä–Ω —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π (–º–∞–∫—Å. 500 —Å–∏–º–≤–æ–ª–æ–≤)"

            # –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω
            normalized = _normalize_pattern(pattern)

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –¥—É–±–ª–∏–∫–∞—Ç
            existing = await session.execute(
                select(CustomSectionPattern).where(
                    CustomSectionPattern.section_id == section_id,
                    CustomSectionPattern.normalized == normalized
                )
            )
            if existing.scalar_one_or_none():
                return False, None, f"–ü–∞—Ç—Ç–µ—Ä–Ω ¬´{pattern[:30]}...¬ª —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"

            section_pattern = CustomSectionPattern(
                section_id=section_id,
                pattern=pattern,
                normalized=normalized,
                pattern_type=pattern_type,
                weight=weight,
                is_active=True,
                triggers_count=0,
                created_by=created_by,
                created_at=_utcnow_naive()
            )

            session.add(section_pattern)
            await session.commit()
            await session.refresh(section_pattern)

            logger.info(
                f"[CustomSectionService] –î–æ–±–∞–≤–ª–µ–Ω –ø–∞—Ç—Ç–µ—Ä–Ω '{pattern[:30]}...' "
                f"(ID={section_pattern.id}) –≤ —Ä–∞–∑–¥–µ–ª {section_id}"
            )

            return True, section_pattern.id, None

        except IntegrityError:
            await session.rollback()
            return False, None, "–¢–∞–∫–æ–π –ø–∞—Ç—Ç–µ—Ä–Ω —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ä–∞–∑–¥–µ–ª–µ"

        except Exception as e:
            await session.rollback()
            logger.error(f"[CustomSectionService] –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞: {e}")
            return False, None, str(e)

    async def delete_section_pattern(
        self,
        pattern_id: int,
        session: AsyncSession
    ) -> bool:
        """
        –£–¥–∞–ª—è–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω —Ä–∞–∑–¥–µ–ª–∞ –ø–æ ID.

        Args:
            pattern_id: ID –ø–∞—Ç—Ç–µ—Ä–Ω–∞
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            True –µ—Å–ª–∏ —É–¥–∞–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
        """
        try:
            query = delete(CustomSectionPattern).where(
                CustomSectionPattern.id == pattern_id
            )
            result = await session.execute(query)
            await session.commit()

            if result.rowcount > 0:
                logger.info(f"[CustomSectionService] –£–¥–∞–ª—ë–Ω –ø–∞—Ç—Ç–µ—Ä–Ω ID={pattern_id}")
                return True

            return False

        except Exception as e:
            await session.rollback()
            logger.error(f"[CustomSectionService] –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞: {e}")
            return False

    async def delete_all_section_patterns(
        self,
        section_id: int,
        session: AsyncSession
    ) -> int:
        """
        –£–¥–∞–ª—è–µ—Ç –≤—Å–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã —Ä–∞–∑–¥–µ–ª–∞.

        Args:
            section_id: ID —Ä–∞–∑–¥–µ–ª–∞
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
        """
        try:
            query = delete(CustomSectionPattern).where(
                CustomSectionPattern.section_id == section_id
            )
            result = await session.execute(query)
            await session.commit()

            deleted_count = result.rowcount
            if deleted_count > 0:
                logger.info(
                    f"[CustomSectionService] –£–¥–∞–ª–µ–Ω–æ {deleted_count} –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ "
                    f"–∏–∑ —Ä–∞–∑–¥–µ–ª–∞ ID={section_id}"
                )

            return deleted_count

        except Exception as e:
            await session.rollback()
            logger.error(f"[CustomSectionService] –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤: {e}")
            return 0

    async def get_section_pattern_by_id(
        self,
        pattern_id: int,
        session: AsyncSession
    ) -> Optional[CustomSectionPattern]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –ø–∞—Ç—Ç–µ—Ä–Ω —Ä–∞–∑–¥–µ–ª–∞ –ø–æ ID.

        Args:
            pattern_id: ID –ø–∞—Ç—Ç–µ—Ä–Ω–∞
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            –ü–∞—Ç—Ç–µ—Ä–Ω –∏–ª–∏ None
        """
        query = select(CustomSectionPattern).where(
            CustomSectionPattern.id == pattern_id
        )
        result = await session.execute(query)
        return result.scalar_one_or_none()

    async def toggle_section_pattern(
        self,
        pattern_id: int,
        session: AsyncSession
    ) -> bool:
        """
        –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω–∞ —Ä–∞–∑–¥–µ–ª–∞.

        Args:
            pattern_id: ID –ø–∞—Ç—Ç–µ—Ä–Ω–∞
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            True –µ—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ
        """
        try:
            pattern = await self.get_section_pattern_by_id(pattern_id, session)
            if not pattern:
                return False

            new_status = not pattern.is_active

            query = update(CustomSectionPattern).where(
                CustomSectionPattern.id == pattern_id
            ).values(is_active=new_status)

            await session.execute(query)
            await session.commit()

            logger.info(
                f"[CustomSectionService] –ü–∞—Ç—Ç–µ—Ä–Ω ID={pattern_id} "
                f"{'–≤–∫–ª—é—á—ë–Ω' if new_status else '–≤—ã–∫–ª—é—á–µ–Ω'}"
            )
            return True

        except Exception as e:
            await session.rollback()
            logger.error(f"[CustomSectionService] –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞: {e}")
            return False

    async def update_pattern_weight(
        self,
        pattern_id: int,
        new_weight: int,
        session: AsyncSession
    ) -> Tuple[bool, Optional[str]]:
        """
        –û–±–Ω–æ–≤–ª—è–µ—Ç –≤–µ—Å –ø–∞—Ç—Ç–µ—Ä–Ω–∞ —Ä–∞–∑–¥–µ–ª–∞.

        Args:
            pattern_id: ID –ø–∞—Ç—Ç–µ—Ä–Ω–∞
            new_weight: –ù–æ–≤—ã–π –≤–µ—Å (1-1000)
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            Tuple[success, error_message]
        """
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤–µ—Å–∞
        if new_weight < 1:
            return False, "–í–µ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å >= 1"
        if new_weight > 1000:
            return False, "–í–µ—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å <= 1000"

        try:
            pattern = await self.get_section_pattern_by_id(pattern_id, session)
            if not pattern:
                return False, "–ü–∞—Ç—Ç–µ—Ä–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω"

            query = update(CustomSectionPattern).where(
                CustomSectionPattern.id == pattern_id
            ).values(weight=new_weight)

            await session.execute(query)
            await session.commit()

            logger.info(
                f"[CustomSectionService] –í–µ—Å –ø–∞—Ç—Ç–µ—Ä–Ω–∞ ID={pattern_id} "
                f"–∏–∑–º–µ–Ω—ë–Ω: {pattern.weight} ‚Üí {new_weight}"
            )
            return True, None

        except Exception as e:
            await session.rollback()
            logger.error(f"[CustomSectionService] –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–µ—Å–∞: {e}")
            return False, str(e)

    async def get_patterns_count(
        self,
        section_id: int,
        session: AsyncSession
    ) -> int:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤ —Ä–∞–∑–¥–µ–ª–µ.

        Args:
            section_id: ID —Ä–∞–∑–¥–µ–ª–∞
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
        """
        query = select(func.count()).select_from(CustomSectionPattern).where(
            CustomSectionPattern.section_id == section_id
        )
        result = await session.execute(query)
        return result.scalar() or 0

    async def increment_pattern_trigger(
        self,
        pattern_id: int,
        session: AsyncSession
    ) -> None:
        """
        –£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–π –ø–∞—Ç—Ç–µ—Ä–Ω–∞ —Ä–∞–∑–¥–µ–ª–∞.

        Args:
            pattern_id: ID –ø–∞—Ç—Ç–µ—Ä–Ω–∞
            session: –°–µ—Å—Å–∏—è –ë–î
        """
        try:
            query = update(CustomSectionPattern).where(
                CustomSectionPattern.id == pattern_id
            ).values(
                triggers_count=CustomSectionPattern.triggers_count + 1,
                last_triggered_at=_utcnow_naive()
            )

            await session.execute(query)
            await session.commit()

        except Exception as e:
            await session.rollback()
            logger.error(f"[CustomSectionService] –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á—ë—Ç—á–∏–∫–∞: {e}")

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –ü–û–†–û–ì–ò –ë–ê–õ–õ–û–í –†–ê–ó–î–ï–õ–ê
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def get_section_thresholds(
        self,
        section_id: int,
        session: AsyncSession,
        enabled_only: bool = True
    ) -> List:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –ø–æ—Ä–æ–≥–∏ –±–∞–ª–ª–æ–≤ —Ä–∞–∑–¥–µ–ª–∞.

        Args:
            section_id: ID —Ä–∞–∑–¥–µ–ª–∞
            session: –°–µ—Å—Å–∏—è –ë–î
            enabled_only: –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ—Ä–æ–≥–∏

        Returns:
            –°–ø–∏—Å–æ–∫ –ø–æ—Ä–æ–≥–æ–≤
        """
        from bot.database.models_content_filter import CustomSectionThreshold

        query = select(CustomSectionThreshold).where(
            CustomSectionThreshold.section_id == section_id
        )

        if enabled_only:
            query = query.where(CustomSectionThreshold.enabled == True)

        query = query.order_by(CustomSectionThreshold.min_score)

        result = await session.execute(query)
        return list(result.scalars().all())

    async def add_section_threshold(
        self,
        section_id: int,
        min_score: int,
        max_score: Optional[int],
        action: str,
        session: AsyncSession,
        mute_duration: Optional[int] = None,
        created_by: Optional[int] = None
    ) -> Tuple[bool, Optional[int]]:
        """
        –î–æ–±–∞–≤–ª—è–µ—Ç –ø–æ—Ä–æ–≥ –±–∞–ª–ª–æ–≤ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞.

        Args:
            section_id: ID —Ä–∞–∑–¥–µ–ª–∞
            min_score: –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª (–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ)
            max_score: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª (–≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ, None = ‚àû)
            action: –î–µ–π—Å—Ç–≤–∏–µ (delete/mute/ban)
            session: –°–µ—Å—Å–∏—è –ë–î
            mute_duration: –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º—É—Ç–∞ –≤ –º–∏–Ω—É—Ç–∞—Ö
            created_by: ID —Å–æ–∑–¥–∞—Ç–µ–ª—è

        Returns:
            (—É—Å–ø–µ—Ö, id_–ø–æ—Ä–æ–≥–∞)
        """
        from bot.database.models_content_filter import CustomSectionThreshold

        try:
            threshold = CustomSectionThreshold(
                section_id=section_id,
                min_score=min_score,
                max_score=max_score,
                action=action,
                mute_duration=mute_duration,
                created_by=created_by
            )
            session.add(threshold)
            await session.commit()
            await session.refresh(threshold)

            logger.info(
                f"[CustomSectionService] –ü–æ—Ä–æ–≥ –¥–æ–±–∞–≤–ª–µ–Ω: section={section_id}, "
                f"range={min_score}-{max_score}, action={action}"
            )
            return True, threshold.id

        except Exception as e:
            await session.rollback()
            logger.error(f"[CustomSectionService] –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ—Ä–æ–≥–∞: {e}")
            return False, None

    async def delete_section_threshold(
        self,
        threshold_id: int,
        session: AsyncSession
    ) -> bool:
        """–£–¥–∞–ª—è–µ—Ç –ø–æ—Ä–æ–≥ –±–∞–ª–ª–æ–≤."""
        from bot.database.models_content_filter import CustomSectionThreshold

        try:
            result = await session.execute(
                delete(CustomSectionThreshold).where(
                    CustomSectionThreshold.id == threshold_id
                )
            )
            await session.commit()
            return result.rowcount > 0

        except Exception as e:
            await session.rollback()
            logger.error(f"[CustomSectionService] –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Ä–æ–≥–∞: {e}")
            return False

    async def toggle_section_threshold(
        self,
        threshold_id: int,
        session: AsyncSession
    ) -> bool:
        """–ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ—Ä–æ–≥–∞."""
        from bot.database.models_content_filter import CustomSectionThreshold

        try:
            result = await session.execute(
                select(CustomSectionThreshold).where(
                    CustomSectionThreshold.id == threshold_id
                )
            )
            threshold = result.scalar_one_or_none()

            if not threshold:
                return False

            threshold.enabled = not threshold.enabled
            await session.commit()
            return True

        except Exception as e:
            await session.rollback()
            logger.error(f"[CustomSectionService] –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–æ—Ä–æ–≥–∞: {e}")
            return False

    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    # –ü–û–ò–°–ö –ü–û–î–•–û–î–Ø–©–ï–ì–û –ü–û–†–û–ì–ê –ü–û –°–ö–û–†–£ –†–ê–ó–î–ï–õ–ê
    # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async def get_action_for_section_score(
        self,
        section_id: int,
        score: int,
        session: AsyncSession
    ) -> Optional[Tuple[str, Optional[int]]]:
        """
        –ù–∞—Ö–æ–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Å–∫–æ—Ä–∞ –≤ –ø–æ—Ä–æ–≥–∞—Ö —Ä–∞–∑–¥–µ–ª–∞.

        –ü—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ –≤—Å–µ–º –∞–∫—Ç–∏–≤–Ω—ã–º –ø–æ—Ä–æ–≥–∞–º —Ä–∞–∑–¥–µ–ª–∞ –∏ –∏—â–µ—Ç
        –ø–æ—Ä–æ–≥ –≥–¥–µ min_score <= score <= max_score.

        –õ–æ–≥–∏–∫–∞:
        1. –ï—Å–ª–∏ score –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –¥–∏–∞–ø–∞–∑–æ–Ω –ø–æ—Ä–æ–≥–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ action
        2. –ï—Å–ª–∏ score –ü–†–ï–í–´–®–ê–ï–¢ –≤—Å–µ –ø–æ—Ä–æ–≥–∏ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –ü–û–°–õ–ï–î–ù–ò–ô (—Å–∞–º—ã–π —Å—Ç—Ä–æ–≥–∏–π) –ø–æ—Ä–æ–≥
        3. –ï—Å–ª–∏ score –ú–ï–ù–¨–®–ï –≤—Å–µ—Ö –ø–æ—Ä–æ–≥–æ–≤ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º None (action –∏–∑ —Ä–∞–∑–¥–µ–ª–∞)

        Args:
            section_id: ID —Ä–∞–∑–¥–µ–ª–∞
            score: –°–∫–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            Tuple[action, mute_duration] –∏–ª–∏ None –µ—Å–ª–∏ –ø–æ—Ä–æ–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω
        """
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ —Ä–∞–∑–¥–µ–ª–∞ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ min_score
        thresholds = await self.get_section_thresholds(section_id, session, enabled_only=True)

        if not thresholds:
            return None

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π (—Å–∞–º—ã–π —Å—Ç—Ä–æ–≥–∏–π) –ø–æ—Ä–æ–≥ –¥–ª—è —Å–ª—É—á–∞—è –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è
        last_threshold = thresholds[-1]

        # –ò—â–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–æ—Ä–æ–≥
        for threshold in thresholds:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∏–∂–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É
            if score < threshold.min_score:
                continue

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Ö–Ω—é—é –≥—Ä–∞–Ω–∏—Ü—É (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω–∞)
            if threshold.max_score is not None and score > threshold.max_score:
                continue

            # –ù–∞—à–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–æ—Ä–æ–≥
            logger.debug(
                f"[CustomSectionService] –°–∫–æ—Ä {score} –ø–æ–ø–∞–ª –≤ –ø–æ—Ä–æ–≥ —Ä–∞–∑–¥–µ–ª–∞ "
                f"[{threshold.min_score}-{threshold.max_score or '‚àû'}]: {threshold.action}"
            )
            return (threshold.action, threshold.mute_duration)

        # –ù–µ –Ω–∞—à–ª–∏ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–æ—Ä–æ–≥
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º: –µ—Å–ª–∏ score –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ—Ä–æ–≥ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
        if score >= last_threshold.min_score:
            logger.debug(
                f"[CustomSectionService] –°–∫–æ—Ä {score} –ø—Ä–µ–≤—ã—à–∞–µ—Ç –≤—Å–µ –ø–æ—Ä–æ–≥–∏, "
                f"–∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ—Ä–æ–≥ [{last_threshold.min_score}-"
                f"{last_threshold.max_score or '‚àû'}]: {last_threshold.action}"
            )
            return (last_threshold.action, last_threshold.mute_duration)

        # Score –º–µ–Ω—å—à–µ –≤—Å–µ—Ö –ø–æ—Ä–æ–≥–æ–≤ ‚Äî –≤–µ—Ä–Ω—ë–º None, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è action –∏–∑ —Ä–∞–∑–¥–µ–ª–∞
        return None


# ============================================================
# –ì–õ–û–ë–ê–õ–¨–ù–´–ô –≠–ö–ó–ï–ú–ü–õ–Ø–† SECTION SERVICE (–°–ò–ù–ì–õ–¢–û–ù)
# ============================================================

_section_service: Optional[CustomSectionService] = None


def get_section_service() -> CustomSectionService:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä CustomSectionService (—Å–∏–Ω–≥–ª—Ç–æ–Ω).

    Returns:
        –≠–∫–∑–µ–º–ø–ª—è—Ä CustomSectionService
    """
    global _section_service
    if _section_service is None:
        _section_service = CustomSectionService()
    return _section_service


# ============================================================
# –°–ï–†–í–ò–° –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ë–ê–ó–û–í–´–ú–ò –°–ò–ì–ù–ê–õ–ê–ú–ò (–£–ë–ò–†–ê–ï–ú –•–ê–†–î–ö–û–î)
# ============================================================
# –ü–æ–∑–≤–æ–ª—è–µ—Ç –≥—Ä—É–ø–ø–∞–º –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –±–∞–∑–æ–≤—ã–µ SCAM_SIGNALS:
# - –í–∫–ª—é—á–∞—Ç—å/–≤—ã–∫–ª—é—á–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã
# - –ú–µ–Ω—è—Ç—å –≤–µ—Å–∞ (scores) —Å–∏–≥–Ω–∞–ª–æ–≤
#
# –ë–∞–∑–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –≤ scam_detector.py:
# money_amount, income_period, easy_money, call_to_action, crypto,
# recruitment, remote_work, exclamations, urgency, scheme,
# training, investments, gambling, age_restriction, unique_offer

class BaseSignalService:
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è–º–∏ –±–∞–∑–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤.

    –ë–∞–∑–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã (SCAM_SIGNALS) —Ç–µ–ø–µ—Ä—å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ!
    –ö–∞–∂–¥–∞—è –≥—Ä—É–ø–ø–∞ –º–æ–∂–µ—Ç:
    - –û—Ç–∫–ª—é—á–∏—Ç—å –Ω–µ–Ω—É–∂–Ω—ã–µ —Å–∏–≥–Ω–∞–ª—ã
    - –ò–∑–º–µ–Ω–∏—Ç—å –≤–µ—Å–∞ –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    """

    def get_available_signals(self) -> Dict[str, Dict]:
        """
        –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –±–∞–∑–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ —Å –∏—Ö —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏.

        Returns:
            –°–ª–æ–≤–∞—Ä—å {signal_name: {score, description, pattern}}
        """
        from bot.services.content_filter.scam_detector import SCAM_SIGNALS
        return SCAM_SIGNALS.copy()

    async def get_overrides(
        self,
        chat_id: int,
        session: AsyncSession
    ) -> List:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –±–∞–∑–æ–≤—ã—Ö —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –≥—Ä—É–ø–ø—ã.

        Args:
            chat_id: ID –≥—Ä—É–ø–ø—ã
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            –°–ø–∏—Å–æ–∫ BaseSignalOverride –æ–±—ä–µ–∫—Ç–æ–≤
        """
        from bot.database.models_content_filter import BaseSignalOverride

        query = select(BaseSignalOverride).where(
            BaseSignalOverride.chat_id == chat_id
        ).order_by(BaseSignalOverride.signal_name)

        result = await session.execute(query)
        return list(result.scalars().all())

    async def get_override(
        self,
        chat_id: int,
        signal_name: str,
        session: AsyncSession
    ) -> Optional[Any]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–∏–≥–Ω–∞–ª–∞.

        Args:
            chat_id: ID –≥—Ä—É–ø–ø—ã
            signal_name: –ò–º—è —Å–∏–≥–Ω–∞–ª–∞
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            BaseSignalOverride –∏–ª–∏ None
        """
        from bot.database.models_content_filter import BaseSignalOverride

        result = await session.execute(
            select(BaseSignalOverride).where(
                BaseSignalOverride.chat_id == chat_id,
                BaseSignalOverride.signal_name == signal_name
            )
        )
        return result.scalar_one_or_none()

    async def set_override(
        self,
        chat_id: int,
        signal_name: str,
        session: AsyncSession,
        enabled: Optional[bool] = None,
        weight_override: Optional[int] = None,
        updated_by: Optional[int] = None
    ) -> bool:
        """
        –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è —Å–∏–≥–Ω–∞–ª–∞.

        –ï—Å–ª–∏ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–µ.
        –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç - –æ–±–Ω–æ–≤–ª—è–µ—Ç.

        Args:
            chat_id: ID –≥—Ä—É–ø–ø—ã
            signal_name: –ò–º—è —Å–∏–≥–Ω–∞–ª–∞
            session: –°–µ—Å—Å–∏—è –ë–î
            enabled: –í–∫–ª—é—á—ë–Ω –ª–∏ —Å–∏–≥–Ω–∞–ª (None = –Ω–µ –º–µ–Ω—è—Ç—å)
            weight_override: –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –≤–µ—Å (None = –Ω–µ –º–µ–Ω—è—Ç—å)
            updated_by: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ—Ç–æ—Ä—ã–π –¥–µ–ª–∞–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–µ

        Returns:
            True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ
        """
        from bot.database.models_content_filter import BaseSignalOverride

        try:
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–∏–≥–Ω–∞–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            available = self.get_available_signals()
            if signal_name not in available:
                logger.warning(
                    f"[BaseSignalService] –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–∏–≥–Ω–∞–ª: {signal_name}"
                )
                return False

            # –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ
            existing = await self.get_override(chat_id, signal_name, session)

            if existing:
                # –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ
                if enabled is not None:
                    existing.enabled = enabled
                if weight_override is not None:
                    existing.weight_override = weight_override
                existing.updated_at = _utcnow_naive()
                if updated_by:
                    existing.updated_by = updated_by
            else:
                # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ
                new_override = BaseSignalOverride(
                    chat_id=chat_id,
                    signal_name=signal_name,
                    enabled=enabled if enabled is not None else True,
                    weight_override=weight_override,
                    created_at=_utcnow_naive(),
                    updated_at=_utcnow_naive(),
                    updated_by=updated_by
                )
                session.add(new_override)

            await session.commit()
            return True

        except Exception as e:
            await session.rollback()
            logger.error(f"[BaseSignalService] –û—à–∏–±–∫–∞ set_override: {e}")
            return False

    async def toggle_signal(
        self,
        chat_id: int,
        signal_name: str,
        session: AsyncSession,
        updated_by: Optional[int] = None
    ) -> Tuple[bool, bool]:
        """
        –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–∏–≥–Ω–∞–ª–∞.

        Args:
            chat_id: ID –≥—Ä—É–ø–ø—ã
            signal_name: –ò–º—è —Å–∏–≥–Ω–∞–ª–∞
            session: –°–µ—Å—Å–∏—è –ë–î
            updated_by: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        Returns:
            (success, new_enabled_state)
        """
        from bot.database.models_content_filter import BaseSignalOverride

        try:
            existing = await self.get_override(chat_id, signal_name, session)

            if existing:
                existing.enabled = not existing.enabled
                existing.updated_at = _utcnow_naive()
                if updated_by:
                    existing.updated_by = updated_by
                await session.commit()
                return True, existing.enabled
            else:
                # –°–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å enabled=False
                # (—Ç.–∫. –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—Å–µ —Å–∏–≥–Ω–∞–ª—ã –≤–∫–ª—é—á–µ–Ω—ã)
                new_override = BaseSignalOverride(
                    chat_id=chat_id,
                    signal_name=signal_name,
                    enabled=False,  # –û—Ç–∫–ª—é—á–∞–µ–º
                    weight_override=None,
                    created_at=_utcnow_naive(),
                    updated_at=_utcnow_naive(),
                    updated_by=updated_by
                )
                session.add(new_override)
                await session.commit()
                return True, False

        except Exception as e:
            await session.rollback()
            logger.error(f"[BaseSignalService] –û—à–∏–±–∫–∞ toggle_signal: {e}")
            return False, True

    async def set_weight(
        self,
        chat_id: int,
        signal_name: str,
        weight: int,
        session: AsyncSession,
        updated_by: Optional[int] = None
    ) -> bool:
        """
        –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤–µ—Å –¥–ª—è —Å–∏–≥–Ω–∞–ª–∞.

        Args:
            chat_id: ID –≥—Ä—É–ø–ø—ã
            signal_name: –ò–º—è —Å–∏–≥–Ω–∞–ª–∞
            weight: –ù–æ–≤—ã–π –≤–µ—Å (1-100)
            session: –°–µ—Å—Å–∏—è –ë–î
            updated_by: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        Returns:
            True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ
        """
        if weight < 1 or weight > 100:
            return False

        return await self.set_override(
            chat_id=chat_id,
            signal_name=signal_name,
            session=session,
            weight_override=weight,
            updated_by=updated_by
        )

    async def reset_signal(
        self,
        chat_id: int,
        signal_name: str,
        session: AsyncSession
    ) -> bool:
        """
        –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞ –∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º –∑–Ω–∞—á–µ–Ω–∏—è–º.

        Args:
            chat_id: ID –≥—Ä—É–ø–ø—ã
            signal_name: –ò–º—è —Å–∏–≥–Ω–∞–ª–∞
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            True –µ—Å–ª–∏ —É—Å–ø–µ—à–Ω–æ
        """
        from bot.database.models_content_filter import BaseSignalOverride
        from sqlalchemy import delete

        try:
            result = await session.execute(
                delete(BaseSignalOverride).where(
                    BaseSignalOverride.chat_id == chat_id,
                    BaseSignalOverride.signal_name == signal_name
                )
            )
            await session.commit()
            return result.rowcount > 0

        except Exception as e:
            await session.rollback()
            logger.error(f"[BaseSignalService] –û—à–∏–±–∫–∞ reset_signal: {e}")
            return False

    async def reset_all_signals(
        self,
        chat_id: int,
        session: AsyncSession
    ) -> int:
        """
        –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≤—Å–µ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –≥—Ä—É–ø–ø—ã.

        Args:
            chat_id: ID –≥—Ä—É–ø–ø—ã
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π
        """
        from bot.database.models_content_filter import BaseSignalOverride
        from sqlalchemy import delete

        try:
            result = await session.execute(
                delete(BaseSignalOverride).where(
                    BaseSignalOverride.chat_id == chat_id
                )
            )
            await session.commit()
            return result.rowcount

        except Exception as e:
            await session.rollback()
            logger.error(f"[BaseSignalService] –û—à–∏–±–∫–∞ reset_all_signals: {e}")
            return 0

    async def get_effective_signals(
        self,
        chat_id: int,
        session: AsyncSession
    ) -> Dict[str, Dict]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ (—Å —É—á—ë—Ç–æ–º –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π) —Å–∏–≥–Ω–∞–ª—ã –¥–ª—è –≥—Ä—É–ø–ø—ã.

        Args:
            chat_id: ID –≥—Ä—É–ø–ø—ã
            session: –°–µ—Å—Å–∏—è –ë–î

        Returns:
            –°–ª–æ–≤–∞—Ä—å {signal_name: {score, description, enabled}}
        """
        base_signals = self.get_available_signals()
        overrides = await self.get_overrides(chat_id, session)

        # –°–æ–∑–¥–∞—ë–º —Å–ª–æ–≤–∞—Ä—å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–π –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
        override_map = {o.signal_name: o for o in overrides}

        result = {}
        for signal_name, signal_data in base_signals.items():
            override = override_map.get(signal_name)

            result[signal_name] = {
                'score': override.weight_override if (override and override.weight_override is not None) else signal_data['score'],
                'description': signal_data['description'],
                'enabled': override.enabled if override else True,
                'is_custom': bool(override and (override.weight_override is not None or not override.enabled))
            }

        return result


# ============================================================
# –ì–õ–û–ë–ê–õ–¨–ù–´–ô –≠–ö–ó–ï–ú–ü–õ–Ø–† BASE SIGNAL SERVICE (–°–ò–ù–ì–õ–¢–û–ù)
# ============================================================

_base_signal_service: Optional[BaseSignalService] = None


def get_base_signal_service() -> BaseSignalService:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä BaseSignalService (—Å–∏–Ω–≥–ª—Ç–æ–Ω).

    Returns:
        –≠–∫–∑–µ–º–ø–ª—è—Ä BaseSignalService
    """
    global _base_signal_service
    if _base_signal_service is None:
        _base_signal_service = BaseSignalService()
    return _base_signal_service
