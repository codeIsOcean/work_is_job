# bot/services/antiraid/mass_reaction_tracker.py
"""
Ğ¢Ñ€ĞµĞºĞµÑ€ Ğ¼Ğ°ÑÑĞ¾Ğ²Ñ‹Ñ… Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¹ Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ´ÑƒĞ»Ñ Anti-Raid v2.

v2 Ğ˜Ğ—ĞœĞ•ĞĞ•ĞĞ˜Ğ¯:
- ĞĞ¾Ğ²Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ´ĞµÑ‚ĞµĞºÑ†Ğ¸Ğ¸: ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ğ½Ğ° ÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ ĞĞ—ĞĞ«Ğ¥ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ ÑĞ·ĞµÑ€ Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ğ» Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¸
- ĞŸĞ°Ñ‚Ñ‚ĞµÑ€Ğ½ ÑĞ¿Ğ°Ğ¼Ğ¼ĞµÑ€Ğ°: Ğ¸Ğ´Ñ‘Ñ‚ Ğ²Ğ½Ğ¸Ğ· Ğ¿Ğ¾ Ñ‡Ğ°Ñ‚Ñƒ, ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ Ğ¿Ğ¾ 1 Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¸ Ğ½Ğ° Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ
- Ğ¦ĞµĞ»ÑŒ ÑĞ¿Ğ°Ğ¼Ğ¼ĞµÑ€Ğ°: Ğ°Ğ²Ñ‚Ğ¾Ñ€Ñ‹ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ÑÑ‚ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¸ Ğ·Ğ°Ñ…Ğ¾Ğ´ÑÑ‚ Ğ² ĞµĞ³Ğ¾ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ

Ğ’Ğ¼ĞµÑÑ‚Ğ¾ Ğ´Ğ²ÑƒÑ… Ğ¿Ğ¾Ñ€Ğ¾Ğ³Ğ¾Ğ² (threshold_user + threshold_msg) Ñ‚ĞµĞ¿ĞµÑ€ÑŒ Ğ¾Ğ´Ğ¸Ğ½:
- mass_reaction_threshold: Ğ¼Ğ°ĞºÑ. ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ ĞĞ—ĞĞ«Ğ¥ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ·Ğ° Ğ¾ĞºĞ½Ğ¾

Redis ĞºĞ»ÑÑ‡Ğ¸:
- ar:mr:{chat_id}:{user_id} â†’ Sorted Set (member=message_id, score=timestamp)

ĞŸĞ¾Ñ€Ğ¾Ğ³Ğ¸ Ğ±ĞµÑ€ÑƒÑ‚ÑÑ Ğ¸Ğ· AntiRaidSettings Ğ² Ğ‘Ğ” (Ğ±ĞµĞ· Ñ…Ğ°Ñ€Ğ´ĞºĞ¾Ğ´Ğ°!):
- mass_reaction_enabled: Ğ²ĞºĞ»ÑÑ‡Ñ‘Ğ½ Ğ»Ğ¸ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ
- mass_reaction_window: Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾ (ÑĞµĞºÑƒĞ½Ğ´Ñ‹)
- mass_reaction_threshold: Ğ¼Ğ°ĞºÑ. Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ·Ğ° Ğ¾ĞºĞ½Ğ¾
- mass_reaction_action: ban/kick/mute/warn
- mass_reaction_ban_duration: Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ±Ğ°Ğ½Ğ° Ğ² Ñ‡Ğ°ÑĞ°Ñ…
"""

# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ğ»Ğ¾Ğ³Ğ³ĞµÑ€ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
import logging
# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ time Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ timestamp
import time
# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ‚Ğ¸Ğ¿Ñ‹ Ğ´Ğ»Ñ Ğ°Ğ½Ğ½Ğ¾Ñ‚Ğ°Ñ†Ğ¸Ğ¹
from typing import Optional, NamedTuple, List

# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ AsyncSession Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ Ğ‘Ğ”
from sqlalchemy.ext.asyncio import AsyncSession

# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Redis ĞºĞ»Ğ¸ĞµĞ½Ñ‚
from redis.asyncio import Redis

# Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº
from bot.services.antiraid.settings_service import get_antiraid_settings


# Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ»Ğ¾Ğ³Ğ³ĞµÑ€ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¼Ğ¾Ğ´ÑƒĞ»Ñ
logger = logging.getLogger(__name__)


# ============================================================
# Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢ ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ˜ ĞĞ ĞœĞĞ¡Ğ¡ĞĞ’Ğ«Ğ• Ğ Ğ•ĞĞšĞ¦Ğ˜Ğ˜ v2
# ============================================================
class MassReactionCheckResult(NamedTuple):
    """
    Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ Ğ½Ğ° Ğ¼Ğ°ÑÑĞ¾Ğ²Ñ‹Ğµ Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¸ v2.

    Attributes:
        is_abuse: True ĞµÑĞ»Ğ¸ Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ Ğ·Ğ»Ğ¾ÑƒĞ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ»ĞµĞ½Ğ¸Ğµ
        unique_messages_count: ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ ĞĞ—ĞĞ«Ğ¥ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ñ Ñ€ĞµĞ°ĞºÑ†Ğ¸ÑĞ¼Ğ¸ Ğ¾Ñ‚ ÑĞ·ĞµÑ€Ğ°
        threshold: ĞŸĞ¾Ñ€Ğ¾Ğ³ ÑÑ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ (Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹)
        window_seconds: Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾ (ÑĞµĞºÑƒĞ½Ğ´Ñ‹)
        user_id: ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        message_ids: Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº message_id Ğ½Ğ° ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ ÑĞ·ĞµÑ€ ÑÑ‚Ğ°Ğ²Ğ¸Ğ» Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¸ (Ğ´Ğ»Ñ Ğ»Ğ¾Ğ³Ğ¾Ğ²)
    """
    # Ğ¤Ğ»Ğ°Ğ³: Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ Ğ»Ğ¸ Ğ·Ğ»Ğ¾ÑƒĞ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ»ĞµĞ½Ğ¸Ğµ
    is_abuse: bool
    # ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ ĞĞ—ĞĞ«Ğ¥ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ñ Ñ€ĞµĞ°ĞºÑ†Ğ¸ÑĞ¼Ğ¸ Ğ¾Ñ‚ ÑĞ·ĞµÑ€Ğ°
    unique_messages_count: int
    # ĞŸĞ¾Ñ€Ğ¾Ğ³ ÑÑ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ
    threshold: int
    # Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾
    window_seconds: int
    # ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    user_id: int
    # Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº message_id Ğ´Ğ»Ñ Ğ»Ğ¾Ğ³Ğ¾Ğ² (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ is_abuse=True)
    message_ids: List[int] = []


# ============================================================
# ĞšĞ›ĞĞ¡Ğ¡ Ğ¢Ğ Ğ•ĞšĞ•Ğ Ğ ĞœĞĞ¡Ğ¡ĞĞ’Ğ«Ğ¥ Ğ Ğ•ĞĞšĞ¦Ğ˜Ğ™ v2
# ============================================================
class MassReactionTracker:
    """
    Ğ¢Ñ€ĞµĞºĞµÑ€ Ğ¼Ğ°ÑÑĞ¾Ğ²Ñ‹Ñ… Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¹ v2.

    Ğ”ĞµÑ‚ĞµĞºÑ‚Ğ¸Ñ€ÑƒĞµÑ‚ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½ ÑĞ¿Ğ°Ğ¼Ğ¼ĞµÑ€Ğ°: ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ Ğ¿Ğ¾ 1 Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¸ Ğ½Ğ° Ğ ĞĞ—ĞĞ«Ğ• ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ,
    Ğ¸Ğ´Ñ Ğ²Ğ½Ğ¸Ğ· Ğ¿Ğ¾ Ñ‡Ğ°Ñ‚Ñƒ. Ğ¦ĞµĞ»ÑŒ â€” Ğ·Ğ°ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğ² Ğ·Ğ°Ğ¹Ñ‚Ğ¸ Ğ² Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ ÑĞ¿Ğ°Ğ¼Ğ¼ĞµÑ€Ğ°.

    ĞĞ»Ğ³Ğ¾Ñ€Ğ¸Ñ‚Ğ¼:
    1. ĞŸÑ€Ğ¸ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¸ Ğ·Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ message_id Ğ² Sorted Set ÑĞ·ĞµÑ€Ğ°
    2. Ğ¡Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ£ĞĞ˜ĞšĞĞ›Ğ¬ĞĞ«Ğ¥ message_id Ğ² Ğ¾ĞºĞ½Ğµ
    3. Ğ•ÑĞ»Ğ¸ >= threshold â€” is_abuse=True (Ğ½ÑƒĞ¶ĞµĞ½ Ğ±Ğ°Ğ½)
    """

    # ĞŸÑ€ĞµÑ„Ğ¸ĞºÑ Ğ´Ğ»Ñ ĞºĞ»ÑÑ‡ĞµĞ¹ Redis
    REDIS_PREFIX = "ar:mr"

    def __init__(
        self,
        redis: Redis,
        window_seconds: int = 60,
        threshold: int = 5
    ):
        """
        Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ñ‚Ñ€ĞµĞºĞµÑ€Ğ°.

        Args:
            redis: ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Redis
            window_seconds: Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´ÑÑ‡Ñ‘Ñ‚Ğ° (Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚ 60 ÑĞµĞº)
            threshold: ĞœĞ°ĞºÑ. Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ñ Ñ€ĞµĞ°ĞºÑ†Ğ¸ÑĞ¼Ğ¸ Ğ·Ğ° Ğ¾ĞºĞ½Ğ¾ (Ğ´ĞµÑ„Ğ¾Ğ»Ñ‚ 5)
        """
        # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ ÑÑÑ‹Ğ»ĞºÑƒ Ğ½Ğ° Redis
        self._redis = redis
        # Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾ Ğ² ÑĞµĞºÑƒĞ½Ğ´Ğ°Ñ…
        self._window_seconds = window_seconds
        # ĞŸĞ¾Ñ€Ğ¾Ğ³ ÑÑ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ â€” ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
        self._threshold = threshold

    def _get_user_key(self, chat_id: int, user_id: int) -> str:
        """
        Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµÑ‚ ĞºĞ»ÑÑ‡ Redis Ğ´Ğ»Ñ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¹ ÑĞ·ĞµÑ€Ğ°.

        Args:
            chat_id: ID Ñ‡Ğ°Ñ‚Ğ°
            user_id: ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ

        Returns:
            ĞšĞ»ÑÑ‡ Redis Ğ´Ğ»Ñ Sorted Set ÑĞ·ĞµÑ€Ğ°
        """
        return f"{self.REDIS_PREFIX}:{chat_id}:{user_id}"

    async def record_reaction(
        self,
        chat_id: int,
        user_id: int,
        message_id: int
    ) -> int:
        """
        Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ Ñ€ĞµĞ°ĞºÑ†Ğ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¸ Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹.

        Args:
            chat_id: ID Ñ‡Ğ°Ñ‚Ğ°
            user_id: ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
            message_id: ID ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ½Ğ° ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğµ Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ñ€ĞµĞ°ĞºÑ†Ğ¸Ñ

        Returns:
            ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ ĞĞ—ĞĞ«Ğ¥ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ñ Ñ€ĞµĞ°ĞºÑ†Ğ¸ÑĞ¼Ğ¸ Ğ·Ğ° Ğ¾ĞºĞ½Ğ¾
        """
        now = time.time()
        cutoff = now - self._window_seconds
        key = self._get_user_key(chat_id, user_id)

        try:
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # Ğ¨ĞĞ“ 1: Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ message_id Ğ² Sorted Set
            # member = message_id, score = timestamp
            # Ğ•ÑĞ»Ğ¸ ÑĞ·ĞµÑ€ ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¹ Ğ½Ğ° Ğ¾Ğ´Ğ½Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ â€”
            # Ğ·Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ timestamp (zadd Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ÑĞµÑ‚ score)
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            await self._redis.zadd(key, {str(message_id): now})

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # Ğ¨ĞĞ“ 2: Ğ£Ğ´Ğ°Ğ»ÑĞµĞ¼ ÑÑ‚Ğ°Ñ€Ñ‹Ğµ Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ (Ğ·Ğ° Ğ¿Ñ€ĞµĞ´ĞµĞ»Ğ°Ğ¼Ğ¸ Ğ¾ĞºĞ½Ğ°)
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            await self._redis.zremrangebyscore(key, "-inf", cutoff)

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # Ğ¨ĞĞ“ 3: Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ TTL Ğ½Ğ° ĞºĞ»ÑÑ‡ (Ğ°Ğ²Ñ‚Ğ¾Ğ¾Ñ‡Ğ¸ÑÑ‚ĞºĞ°)
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            await self._redis.expire(key, self._window_seconds + 60)

            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # Ğ¨ĞĞ“ 4: Ğ¡Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ£ĞĞ˜ĞšĞĞ›Ğ¬ĞĞ«Ğ¥ message_id Ğ² Ğ¾ĞºĞ½Ğµ
            # zcount Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ² Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğµ score
            # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            count = await self._redis.zcount(key, cutoff, "+inf")

            return count

        except Exception as e:
            logger.error(
                f"[MassReactionTracker] ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¸: {e}, "
                f"chat_id={chat_id}, user_id={user_id}, message_id={message_id}"
            )
            return 0

    async def get_recent_message_ids(
        self,
        chat_id: int,
        user_id: int,
        limit: int = 20
    ) -> List[int]:
        """
        ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ ÑĞ¿Ğ¸ÑĞ¾Ğº message_id Ğ½Ğ° ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ ÑĞ·ĞµÑ€ ÑÑ‚Ğ°Ğ²Ğ¸Ğ» Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¸ (Ğ´Ğ»Ñ Ğ»Ğ¾Ğ³Ğ¾Ğ²).

        Args:
            chat_id: ID Ñ‡Ğ°Ñ‚Ğ°
            user_id: ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
            limit: ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾

        Returns:
            Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº message_id
        """
        now = time.time()
        cutoff = now - self._window_seconds
        key = self._get_user_key(chat_id, user_id)

        try:
            # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ²ÑĞµ message_id Ğ² Ğ¾ĞºĞ½Ğµ (Ğ¾Ñ‚ ÑÑ‚Ğ°Ñ€Ñ‹Ñ… Ğº Ğ½Ğ¾Ğ²Ñ‹Ğ¼)
            members = await self._redis.zrangebyscore(
                key, cutoff, "+inf", start=0, num=limit
            )

            # ĞŸÑ€ĞµĞ¾Ğ±Ñ€Ğ°Ğ·ÑƒĞµĞ¼ Ğ² ÑĞ¿Ğ¸ÑĞ¾Ğº int
            message_ids = []
            for member in members:
                try:
                    message_ids.append(int(member))
                except ValueError:
                    pass

            return message_ids

        except Exception as e:
            logger.error(f"[MassReactionTracker] ĞÑˆĞ¸Ğ±ĞºĞ° get_recent_message_ids: {e}")
            return []

    async def record_and_check(
        self,
        chat_id: int,
        user_id: int,
        message_id: int
    ) -> MassReactionCheckResult:
        """
        Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ Ñ€ĞµĞ°ĞºÑ†Ğ¸Ñ Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ½Ğ° Ğ·Ğ»Ğ¾ÑƒĞ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ»ĞµĞ½Ğ¸Ğµ.

        Ğ­Ñ‚Ğ¾ Ğ“Ğ›ĞĞ’ĞĞĞ¯ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.

        Args:
            chat_id: ID Ñ‡Ğ°Ñ‚Ğ°
            user_id: ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
            message_id: ID ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ Ğ½Ğ° ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğµ Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ° Ñ€ĞµĞ°ĞºÑ†Ğ¸Ñ

        Returns:
            MassReactionCheckResult Ñ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ¼ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸
        """
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ñ€ĞµĞ°ĞºÑ†Ğ¸Ñ Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        unique_count = await self.record_reaction(
            chat_id=chat_id,
            user_id=user_id,
            message_id=message_id
        )

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¿Ñ€ĞµĞ²Ñ‹ÑˆĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ñ€Ğ¾Ğ³Ğ°
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        is_abuse = unique_count >= self._threshold

        # Ğ•ÑĞ»Ğ¸ Ğ¾Ğ±Ğ½Ğ°Ñ€ÑƒĞ¶ĞµĞ½Ğ¾ Ğ·Ğ»Ğ¾ÑƒĞ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ»ĞµĞ½Ğ¸Ğµ â€” Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº message_id Ğ´Ğ»Ñ Ğ»Ğ¾Ğ³Ğ¾Ğ²
        message_ids: List[int] = []
        if is_abuse:
            message_ids = await self.get_recent_message_ids(chat_id, user_id)

            logger.warning(
                f"[MassReactionTracker] ğŸš¨ MASS REACTION ABUSE DETECTED! "
                f"user_id={user_id}, chat_id={chat_id}, "
                f"unique_messages={unique_count} >= {self._threshold}, "
                f"window={self._window_seconds}s"
            )
        else:
            logger.debug(
                f"[MassReactionTracker] Ğ ĞµĞ°ĞºÑ†Ğ¸Ñ Ğ·Ğ°Ğ¿Ğ¸ÑĞ°Ğ½Ğ°: "
                f"user_id={user_id}, unique_messages={unique_count}/{self._threshold}"
            )

        return MassReactionCheckResult(
            is_abuse=is_abuse,
            unique_messages_count=unique_count,
            threshold=self._threshold,
            window_seconds=self._window_seconds,
            user_id=user_id,
            message_ids=message_ids
        )

    async def clear_user(self, chat_id: int, user_id: int) -> None:
        """
        ĞÑ‡Ğ¸Ñ‰Ğ°ĞµÑ‚ ÑÑ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº Ñ€ĞµĞ°ĞºÑ†Ğ¸Ğ¹ Ğ´Ğ»Ñ ÑĞ·ĞµÑ€Ğ°.

        Args:
            chat_id: ID Ñ‡Ğ°Ñ‚Ğ°
            user_id: ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        """
        key = self._get_user_key(chat_id, user_id)
        await self._redis.delete(key)
        logger.debug(f"[MassReactionTracker] Ğ¡Ñ‡Ñ‘Ñ‚Ñ‡Ğ¸Ğº Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½: user_id={user_id}")


# ============================================================
# Ğ¤ĞĞ‘Ğ Ğ˜Ğ§ĞĞĞ¯ Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ¯
# ============================================================
def create_mass_reaction_tracker(
    redis: Redis,
    window_seconds: int = 60,
    threshold: int = 5
) -> MassReactionTracker:
    """
    Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ ÑĞºĞ·ĞµĞ¼Ğ¿Ğ»ÑÑ€ MassReactionTracker.

    Args:
        redis: ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Redis
        window_seconds: Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾ (ÑĞµĞºÑƒĞ½Ğ´Ñ‹)
        threshold: ĞŸĞ¾Ñ€Ğ¾Ğ³ â€” Ğ¼Ğ°ĞºÑ. Ñ€Ğ°Ğ·Ğ½Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ Ğ·Ğ° Ğ¾ĞºĞ½Ğ¾

    Returns:
        ĞĞ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ñ‹Ğ¹ MassReactionTracker
    """
    return MassReactionTracker(
        redis=redis,
        window_seconds=window_seconds,
        threshold=threshold
    )


# ============================================================
# Ğ“Ğ›ĞĞ’ĞĞĞ¯ Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ¯ ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ˜ (Ğ¡ ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞĞœĞ˜ Ğ˜Ğ— Ğ‘Ğ”)
# ============================================================
async def check_mass_reaction(
    redis: Redis,
    session: AsyncSession,
    chat_id: int,
    user_id: int,
    message_id: int
) -> Optional[MassReactionCheckResult]:
    """
    Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ Ñ€ĞµĞ°ĞºÑ†Ğ¸Ñ Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ½Ğ° Ğ·Ğ»Ğ¾ÑƒĞ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ»ĞµĞ½Ğ¸Ğµ Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ğ¼Ğ¸ Ğ¸Ğ· Ğ‘Ğ”.

    Ğ­Ñ‚Ğ¾ Ğ³Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ° Ğ¸Ğ· Ñ…ĞµĞ½Ğ´Ğ»ĞµÑ€Ğ¾Ğ².
    ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¸Ğ· Ğ‘Ğ” Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ñ‚Ñ€ĞµĞºĞµÑ€.

    Ğ’ĞĞ–ĞĞ: emoji Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğµ Ğ½ÑƒĞ¶ĞµĞ½ â€” ÑÑ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ message_id.

    Args:
        redis: ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğº Redis
        session: Ğ¡ĞµÑÑĞ¸Ñ SQLAlchemy
        chat_id: ID Ñ‡Ğ°Ñ‚Ğ°
        user_id: ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
        message_id: ID ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ

    Returns:
        MassReactionCheckResult ĞµÑĞ»Ğ¸ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ Ğ²ĞºĞ»ÑÑ‡Ñ‘Ğ½, Ğ¸Ğ½Ğ°Ñ‡Ğµ None
    """
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ³Ñ€ÑƒĞ¿Ğ¿Ñ‹
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    settings = await get_antiraid_settings(session, chat_id)

    # Ğ•ÑĞ»Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº Ğ½ĞµÑ‚ Ğ¸Ğ»Ğ¸ Ğ¼Ğ¾Ğ´ÑƒĞ»ÑŒ Ğ²Ñ‹ĞºĞ»ÑÑ‡ĞµĞ½ â€” Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼
    if settings is None or not settings.mass_reaction_enabled:
        return None

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ñ‚Ñ€ĞµĞºĞµÑ€ Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ğ¼Ğ¸ Ğ¸Ğ· Ğ‘Ğ”
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    tracker = create_mass_reaction_tracker(
        redis=redis,
        window_seconds=settings.mass_reaction_window,
        threshold=settings.mass_reaction_threshold
    )

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ğ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    result = await tracker.record_and_check(
        chat_id=chat_id,
        user_id=user_id,
        message_id=message_id
    )

    return result
