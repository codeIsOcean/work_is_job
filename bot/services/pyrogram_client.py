"""
================================================================================
PYROGRAM CLIENT - –°–ï–†–í–ò–° –î–õ–Ø –ü–û–õ–£–ß–ï–ù–ò–Ø –†–ê–°–®–ò–†–ï–ù–ù–û–ô –ò–ù–§–û–†–ú–ê–¶–ò–ò –û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–•
================================================================================

–≠—Ç–æ—Ç –º–æ–¥—É–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Pyrogram (MTProto API) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏,
–∫–æ—Ç–æ—Ä–∞—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Bot API:

1. –¢–û–ß–ù–ê–Ø –î–ê–¢–ê –°–û–ó–î–ê–ù–ò–Ø –ê–ö–ö–ê–£–ù–¢–ê
   - Bot API –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞
   - –ß–µ—Ä–µ–∑ MTProto –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Ç–æ—á–Ω—É—é –¥–∞—Ç—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

2. –î–ê–¢–´ –ó–ê–ì–†–£–ó–ö–ò –§–û–¢–û –ü–†–û–§–ò–õ–Ø
   - Bot API –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∞—Ç—ã –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
   - –ß–µ—Ä–µ–∑ MTProto –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –¥–∞—Ç—É –∫–∞–∂–¥–æ–≥–æ —Ñ–æ—Ç–æ –≤ –ø—Ä–æ—Ñ–∏–ª–µ

3. –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø
   - –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
   - –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–æ—Ñ–∏–ª—è

–í–ê–ñ–ù–û: Pyrogram —Ç—Ä–µ–±—É–µ—Ç API_ID –∏ API_HASH –∏–∑ https://my.telegram.org
"""

import logging
from typing import Optional, List, Dict, Any
from datetime import datetime, timezone, timedelta
from pyrogram import Client
from pyrogram.errors import FloodWait, PeerIdInvalid, UserIdInvalid
import asyncio

# –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞
from bot.config import PYROGRAM_API_ID, PYROGRAM_API_HASH, PYROGRAM_SESSION_NAME, BOT_TOKEN

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–≥–µ—Ä–∞ –¥–ª—è —ç—Ç–æ–≥–æ –º–æ–¥—É–ª—è
logger = logging.getLogger(__name__)


class PyrogramService:
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Pyrogram (MTProto API)

    –≠—Ç–æ—Ç –∫–ª–∞—Å—Å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–µ—Ç–æ–¥—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
    –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö Telegram —á–µ—Ä–µ–∑ MTProto API.
    """

    # TTL –∫—ç—à–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (60 —Å–µ–∫—É–Ω–¥ - –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è)
    CACHE_TTL_SECONDS = 60

    def __init__(self):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Pyrogram –∫–ª–∏–µ–Ω—Ç–∞

        –í–ê–ñ–ù–û: Pyrogram —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ MTProto API, –∞ –Ω–µ —á–µ—Ä–µ–∑ Bot API.
        –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –±–æ–ª—å—à–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.
        """
        self.client: Optional[Client] = None  # –ö–ª–∏–µ–Ω—Ç Pyrogram (–±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ)
        self._initialized = False  # –§–ª–∞–≥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ (—á—Ç–æ–±—ã –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥–≤–∞–∂–¥—ã)
        # –ö—ç—à –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ get_profile_photos_dates
        # –§–æ—Ä–º–∞—Ç: {user_id: {'data': [...], 'timestamp': datetime}}
        self._photo_cache: Dict[int, Dict[str, Any]] = {}

    async def initialize(self):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ –∑–∞–ø—É—Å–∫ Pyrogram –∫–ª–∏–µ–Ω—Ç–∞

        –≠—Ç–æ—Ç –º–µ—Ç–æ–¥:
        1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ API_ID –∏ API_HASH
        2. –°–æ–∑–¥–∞—ë—Ç –∫–ª–∏–µ–Ω—Ç Pyrogram
        3. –ó–∞–ø—É—Å–∫–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç (–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Telegram)

        –í–ê–ñ–ù–û: –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω –û–î–ò–ù –†–ê–ó –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ –∫–ª–∏–µ–Ω—Ç —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
        if self._initialized:
            logger.warning("‚ö†Ô∏è Pyrogram –∫–ª–∏–µ–Ω—Ç —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
            return

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        if not PYROGRAM_API_ID or not PYROGRAM_API_HASH:
            logger.warning("‚ö†Ô∏è PYROGRAM_API_ID –∏–ª–∏ PYROGRAM_API_HASH –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã")
            logger.warning("‚ö†Ô∏è –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ç–æ –∏ —Ç–æ—á–Ω–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ –±—É–¥—É—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã")
            logger.warning("‚ö†Ô∏è –ü–æ–ª—É—á–∏—Ç—å API_ID –∏ API_HASH –º–æ–∂–Ω–æ –Ω–∞ https://my.telegram.org")
            return

        try:
            # –°–æ–∑–¥–∞—ë–º –∫–ª–∏–µ–Ω—Ç Pyrogram
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º bot_token –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∫–∞–∫ –±–æ—Ç (–Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω)
            # –í–ê–ñ–ù–û: in_memory=True - —Å–µ—Å—Å–∏—è —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏, –Ω–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è —Ñ–∞–π–ª (—Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É "database is locked")
            self.client = Client(
                name=PYROGRAM_SESSION_NAME,  # –ò–º—è —Å–µ—Å—Å–∏–∏ (—Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏)
                api_id=int(PYROGRAM_API_ID),  # API ID –∏–∑ my.telegram.org
                api_hash=PYROGRAM_API_HASH,  # API Hash –∏–∑ my.telegram.org
                bot_token=BOT_TOKEN,  # –¢–æ–∫–µ–Ω –±–æ—Ç–∞ (–¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∫–∞–∫ –±–æ—Ç)
                workdir=".",  # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞ —Å–µ—Å—Å–∏–∏
                in_memory=True,  # –°–µ—Å—Å–∏—è –≤ –ø–∞–º—è—Ç–∏ - –Ω–µ —Å–æ–∑–¥–∞—ë—Ç —Ñ–∞–π–ª, –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ö
            )

            # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–ª–∏–µ–Ω—Ç (–ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ Telegram)
            await self.client.start()

            # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            self._initialized = True

            logger.info("‚úÖ Pyrogram –∫–ª–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏ –∑–∞–ø—É—â–µ–Ω")
            logger.info("‚úÖ –î–æ—Å—Ç—É–ø–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏: –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è, —Ç–æ—á–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç –∞–∫–∫–∞—É–Ω—Ç–∞")

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Pyrogram –∫–ª–∏–µ–Ω—Ç–∞: {e}")
            logger.error("‚ùå –§—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–æ—Ç–æ –∏ —Ç–æ—á–Ω–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ –±—É–¥—É—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã")
            self.client = None

    async def stop(self):
        """
        –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Pyrogram –∫–ª–∏–µ–Ω—Ç–∞

        –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ
        –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.
        """
        if self.client and self._initialized:
            try:
                await self.client.stop()  # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–ª–∏–µ–Ω—Ç
                self._initialized = False  # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                logger.info("‚úÖ Pyrogram –∫–ª–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ Pyrogram –∫–ª–∏–µ–Ω—Ç–∞: {e}")

    def is_available(self) -> bool:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –¥–æ—Å—Ç—É–ø–µ–Ω –ª–∏ Pyrogram –∫–ª–∏–µ–Ω—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã

        Returns:
            bool: True –µ—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ
        """
        # –û–¢–õ–ê–î–ö–ê: –õ–æ–≥–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
        logger.debug(f"üîç [PYROGRAM] is_available() –ø—Ä–æ–≤–µ—Ä–∫–∞: client={self.client is not None}, initialized={self._initialized}")
        result = self.client is not None and self._initialized
        logger.debug(f"üîç [PYROGRAM] is_available() —Ä–µ–∑—É–ª—å—Ç–∞—Ç: {result}")
        return result

    def _is_cache_valid(self, user_id: int) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –≤–∞–ª–∏–¥–µ–Ω –ª–∏ –∫—ç—à –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if user_id not in self._photo_cache:
            return False
        cache_entry = self._photo_cache[user_id]
        age = (datetime.now(timezone.utc) - cache_entry['timestamp']).total_seconds()
        return age < self.CACHE_TTL_SECONDS

    def _cleanup_cache(self):
        """–£–¥–∞–ª—è–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∑–∞–ø–∏—Å–∏ –∏–∑ –∫—ç—à–∞"""
        now = datetime.now(timezone.utc)
        expired_keys = [
            user_id for user_id, entry in self._photo_cache.items()
            if (now - entry['timestamp']).total_seconds() >= self.CACHE_TTL_SECONDS
        ]
        for key in expired_keys:
            del self._photo_cache[key]

    def invalidate_cache(self, user_id: int):
        """–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –∫—ç—à –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        if user_id in self._photo_cache:
            del self._photo_cache[user_id]
            logger.debug(f"üóëÔ∏è –ö—ç—à —Ñ–æ—Ç–æ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞–Ω –¥–ª—è user_id={user_id}")

    async def get_profile_photos_dates(self, user_id: int) -> List[Dict[str, Any]]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –¥–∞—Ç—ã –∑–∞–≥—Ä—É–∑–∫–∏ –í–°–ï–• —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–∞–µ—Ç –í–°–ï —Ñ–æ—Ç–æ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∏—Ö –¥–∞—Ç—ã –∑–∞–≥—Ä—É–∑–∫–∏.
        –≠—Ç–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ —á–µ—Ä–µ–∑ Bot API –∏ –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ MTProto.

        –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫—ç—à–∏—Ä—É—é—Ç—Å—è –Ω–∞ 60 —Å–µ–∫—É–Ω–¥ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è
        –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Telegram API –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è.

        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram

        Returns:
            –°–ø–∏—Å–æ–∫ —Å–ª–æ–≤–∞—Ä–µ–π —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–∞–∂–¥–æ–º —Ñ–æ—Ç–æ:
            [
                {
                    'date': datetime,  # –î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
                    'age_days': int,   # –°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –Ω–∞–∑–∞–¥ –±—ã–ª–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ
                    'file_id': str     # ID —Ñ–∞–π–ª–∞ —Ñ–æ—Ç–æ
                },
                ...
            ]

        –õ–û–ì–ò–ö–ê:
        1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—ç—à - –µ—Å–ª–∏ –µ—Å—Ç—å —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Ö
        2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
        3. –ü–æ–ª—É—á–∞–µ–º –í–°–ï —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è —á–µ—Ä–µ–∑ get_chat_photos()
        4. –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–æ—Ç–æ –∏–∑–≤–ª–µ–∫–∞–µ–º –¥–∞—Ç—É –∑–∞–≥—Ä—É–∑–∫–∏
        5. –í—ã—á–∏—Å–ª—è–µ–º –≤–æ–∑—Ä–∞—Å—Ç —Ñ–æ—Ç–æ –≤ –¥–Ω—è—Ö
        6. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–∏—Å–æ–∫
        """
        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        # –ü–†–û–í–ï–†–ö–ê –ö–≠–®–ê
        # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        if self._is_cache_valid(user_id):
            logger.debug(f"üì∏ [CACHE HIT] –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–æ—Ç–æ –¥–ª—è user_id={user_id}")
            return self._photo_cache[user_id]['data']

        # –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —á–∏—Å—Ç–∏–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –∑–∞–ø–∏—Å–∏
        if len(self._photo_cache) > 100:
            self._cleanup_cache()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ª–∏ –∫–ª–∏–µ–Ω—Ç
        if not self.is_available():
            logger.warning("‚ö†Ô∏è Pyrogram –∫–ª–∏–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–µ –º–æ–≥—É –ø–æ–ª—É—á–∏—Ç—å –¥–∞—Ç—ã —Ñ–æ—Ç–æ")
            return []

        try:
            # –ü–æ–ª—É—á–∞–µ–º –í–°–ï —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            # limit=0 –æ–∑–Ω–∞—á–∞–µ—Ç "–ø–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ñ–æ—Ç–æ"
            photos = []
            async for photo in self.client.get_chat_photos(user_id):
                # photo.date - —ç—Ç–æ datetime –æ–±—ä–µ–∫—Ç —Å –¥–∞—Ç–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
                photo_date = photo.date

                # –í–ê–ñ–ù–û: Pyrogram –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç datetime –ë–ï–ó timezone (naive)
                # –î–æ–±–∞–≤–ª—è–µ–º UTC timezone, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
                if photo_date.tzinfo is None:
                    photo_date = photo_date.replace(tzinfo=timezone.utc)

                # –í—ã—á–∏—Å–ª—è–µ–º –≤–æ–∑—Ä–∞—Å—Ç —Ñ–æ—Ç–æ –≤ –¥–Ω—è—Ö
                # datetime.now(timezone.utc) - —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ UTC
                # (—Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è - –¥–∞—Ç–∞ —Ñ–æ—Ç–æ).days - —Ä–∞–∑–Ω–∏—Ü–∞ –≤ –¥–Ω—è—Ö
                age_days = (datetime.now(timezone.utc) - photo_date).days

                # –ó–∞—â–∏—Ç–∞ –æ—Ç –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π (–æ—à–∏–±–∫–∏ —Ç–∞–π–º–∑–æ–Ω—ã/—Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏)
                if age_days < 0:
                    logger.warning(
                        f"‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç —Ñ–æ—Ç–æ (age_days={age_days}) –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}, "
                        f"photo_date={photo_date.isoformat()}. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º 0."
                    )
                    age_days = 0

                # –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–æ—Ç–æ –≤ —Å–ø–∏—Å–æ–∫
                photos.append({
                    'date': photo_date,  # –î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
                    'age_days': age_days,  # –í–æ–∑—Ä–∞—Å—Ç —Ñ–æ—Ç–æ –≤ –¥–Ω—è—Ö
                    'file_id': photo.file_id  # ID —Ñ–∞–π–ª–∞ —Ñ–æ—Ç–æ
                })

            # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            # –°–û–•–†–ê–ù–ï–ù–ò–ï –í –ö–≠–®
            # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            self._photo_cache[user_id] = {
                'data': photos,
                'timestamp': datetime.now(timezone.utc)
            }

            logger.info(f"üì∏ [API] –ü–æ–ª—É—á–µ–Ω–æ {len(photos)} —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")

            # –í—ã–≤–æ–¥–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–∞–∂–¥–æ–º —Ñ–æ—Ç–æ –≤ –ª–æ–≥
            for i, photo_info in enumerate(photos, 1):
                logger.info(f"   üì∏ –§–æ—Ç–æ #{i}: –∑–∞–≥—Ä—É–∂–µ–Ω–æ {photo_info['date'].strftime('%Y-%m-%d')} ({photo_info['age_days']} –¥–Ω–µ–π –Ω–∞–∑–∞–¥)")

            return photos

        except (UserIdInvalid, PeerIdInvalid) as e:
            # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ Telegram –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID
            logger.warning(f"‚ö†Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID: {e}")
            return []

        except FloodWait as e:
            # Telegram –ø—Ä–æ—Å–∏—Ç –ø–æ–¥–æ–∂–¥–∞—Ç—å –∏–∑-–∑–∞ –ª–∏–º–∏—Ç–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
            logger.warning(f"‚ö†Ô∏è FloodWait: –Ω—É–∂–Ω–æ –ø–æ–¥–æ–∂–¥–∞—Ç—å {e.value} —Å–µ–∫—É–Ω–¥")
            # –ñ–¥—ë–º —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
            await asyncio.sleep(e.value)
            # –ü–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å (–∫—ç—à —É–∂–µ –ø—Ä–æ–≤–µ—Ä–∏–ª–∏ –≤—ã—à–µ, —Ç–∞–∫ —á—Ç–æ —ç—Ç–æ —Ä–µ–∞–ª—å–Ω—ã–π retry)
            return await self.get_profile_photos_dates(user_id)

        except PeerIdInvalid:
            # –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            logger.warning(f"‚ö†Ô∏è –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_id}")
            return []

        except Exception as e:
            # –õ—é–±–∞—è –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è {user_id}: {e}")
            return []

    async def check_all_photos_young(self, user_id: int, max_age_days: int = 15) -> Dict[str, Any]:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –í–°–ï –ª–∏ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è –º–æ–ª–æ–∂–µ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞

        –õ–û–ì–ò–ö–ê (–ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é):
        - –ï—Å–ª–∏ –í–°–ï —Ñ–æ—Ç–æ –º–æ–ª–æ–∂–µ 15 –¥–Ω–µ–π ‚Üí –ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–û (–≤–µ—Ä–Ω—ë—Ç True)
        - –ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –û–î–ù–û —Ñ–æ—Ç–æ —Å—Ç–∞—Ä—à–µ 15 –¥–Ω–µ–π ‚Üí –ù–ï –ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–û (–≤–µ—Ä–Ω—ë—Ç False)
        - –ï—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ—Ç –≤–æ–æ–±—â–µ ‚Üí –ù–ï –ü–û–î–û–ó–†–ò–¢–ï–õ–¨–ù–û (–≤–µ—Ä–Ω—ë—Ç False)

        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            max_age_days: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç —Ñ–æ—Ç–æ –≤ –¥–Ω—è—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 15)

        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏:
            {
                'all_photos_young': bool,  # True –µ—Å–ª–∏ –í–°–ï —Ñ–æ—Ç–æ –º–æ–ª–æ–∂–µ max_age_days
                'photos_count': int,       # –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–æ—Ç–æ –≤ –ø—Ä–æ—Ñ–∏–ª–µ
                'youngest_photo_days': int,  # –í–æ–∑—Ä–∞—Å—Ç —Å–∞–º–æ–≥–æ –Ω–æ–≤–æ–≥–æ —Ñ–æ—Ç–æ
                'oldest_photo_days': int,    # –í–æ–∑—Ä–∞—Å—Ç —Å–∞–º–æ–≥–æ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ç–æ
                'risk_score': int,         # –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞ (100 –µ—Å–ª–∏ –≤—Å–µ —Ñ–æ—Ç–æ –º–æ–ª–æ–¥—ã–µ, 0 –µ—Å–ª–∏ –Ω–µ—Ç)
                'reason': str              # –ü—Ä–∏—á–∏–Ω–∞ (–¥–ª—è –ª–æ–≥–æ–≤)
            }
        """
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—ã –≤—Å–µ—Ö —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è
        photos = await self.get_profile_photos_dates(user_id)

        # –ï—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ—Ç –≤–æ–æ–±—â–µ - –Ω–µ —Å—á–∏—Ç–∞–µ–º —ç—Ç–æ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–º
        if not photos:
            return {
                'all_photos_young': False,  # –ù–ï –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ
                'photos_count': 0,
                'youngest_photo_days': None,
                'oldest_photo_days': None,
                'risk_score': 0,  # 0 –±–∞–ª–ª–æ–≤ —Ä–∏—Å–∫–∞
                'reason': '–ù–µ—Ç —Ñ–æ—Ç–æ –≤ –ø—Ä–æ—Ñ–∏–ª–µ'
            }

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –≤–æ–∑—Ä–∞—Å—Ç –∫–∞–∂–¥–æ–≥–æ —Ñ–æ—Ç–æ (–≤ –¥–Ω—è—Ö)
        photo_ages = [p['age_days'] for p in photos]

        # –ù–∞—Ö–æ–¥–∏–º —Å–∞–º–æ–µ –Ω–æ–≤–æ–µ (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç) –∏ —Å–∞–º–æ–µ —Å—Ç–∞—Ä–æ–µ (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç) —Ñ–æ—Ç–æ
        youngest_photo_days = min(photo_ages)  # –°–∞–º–æ–µ –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ
        oldest_photo_days = max(photo_ages)    # –°–∞–º–æ–µ —Å—Ç–∞—Ä–æ–µ —Ñ–æ—Ç–æ

        # –ì–õ–ê–í–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –í–°–ï –ª–∏ —Ñ–æ—Ç–æ –º–æ–ª–æ–∂–µ max_age_days?
        # –ï—Å–ª–∏ –°–ê–ú–û–ï –°–¢–ê–†–û–ï —Ñ–æ—Ç–æ –º–æ–ª–æ–∂–µ max_age_days, –∑–Ω–∞—á–∏—Ç –í–°–ï —Ñ–æ—Ç–æ –º–æ–ª–æ–¥—ã–µ
        all_photos_young = oldest_photo_days <= max_age_days

        # –í—ã—á–∏—Å–ª—è–µ–º –æ—Ü–µ–Ω–∫—É —Ä–∏—Å–∫–∞
        if all_photos_young:
            risk_score = 100  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫ - –í–°–ï —Ñ–æ—Ç–æ –º–æ–ª–æ–¥—ã–µ
            reason = f"–í–°–ï {len(photos)} —Ñ–æ—Ç–æ –º–æ–ª–æ–∂–µ {max_age_days} –¥–Ω–µ–π (—Å–∞–º–æ–µ —Å—Ç–∞—Ä–æ–µ: {oldest_photo_days} –¥–Ω–µ–π)"
        else:
            risk_score = 0  # –ù–µ—Ç —Ä–∏—Å–∫–∞ - –µ—Å—Ç—å —Å—Ç–∞—Ä—ã–µ —Ñ–æ—Ç–æ
            reason = f"–ï—Å—Ç—å —Å—Ç–∞—Ä—ã–µ —Ñ–æ—Ç–æ (—Å–∞–º–æ–µ —Å—Ç–∞—Ä–æ–µ: {oldest_photo_days} –¥–Ω–µ–π, –ø–æ—Ä–æ–≥: {max_age_days} –¥–Ω–µ–π)"

        logger.info(f"   üì∏ –ü–†–û–í–ï–†–ö–ê –§–û–¢–û:")
        logger.info(f"   üì∏ –í—Å–µ–≥–æ —Ñ–æ—Ç–æ: {len(photos)}")
        logger.info(f"   üì∏ –°–∞–º–æ–µ –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ: {youngest_photo_days} –¥–Ω–µ–π –Ω–∞–∑–∞–¥")
        logger.info(f"   üì∏ –°–∞–º–æ–µ —Å—Ç–∞—Ä–æ–µ —Ñ–æ—Ç–æ: {oldest_photo_days} –¥–Ω–µ–π –Ω–∞–∑–∞–¥")
        logger.info(f"   üì∏ –í—Å–µ —Ñ–æ—Ç–æ –º–æ–ª–æ–¥—ã–µ (<{max_age_days} –¥–Ω–µ–π): {all_photos_young}")
        logger.info(f"   üì∏ –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞: {risk_score}/100")
        logger.info(f"   üì∏ –ü—Ä–∏—á–∏–Ω–∞: {reason}")

        return {
            'all_photos_young': all_photos_young,
            'photos_count': len(photos),
            'youngest_photo_days': youngest_photo_days,
            'oldest_photo_days': oldest_photo_days,
            'risk_score': risk_score,
            'reason': reason
        }

    async def get_account_age(self, user_id: int) -> Dict[str, Any]:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –¢–û–ß–ù–´–ô –≤–æ–∑—Ä–∞—Å—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ MTProto

        –í–ê–ñ–ù–û: –≠—Ç–æ –ù–ï –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –ø–æ ID, –∞ –¢–û–ß–ù–ê–Ø –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞.
        –î–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ MTProto API (Pyrogram).

        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤–æ–∑—Ä–∞—Å—Ç–µ –∞–∫–∫–∞—É–Ω—Ç–∞:
            {
                'account_age_days': int,  # –í–æ–∑—Ä–∞—Å—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ –¥–Ω—è—Ö
                'creation_date': datetime,  # –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞
                'is_young': bool,  # True –µ—Å–ª–∏ –∞–∫–∫–∞—É–Ω—Ç –º–æ–ª–æ–∂–µ 30 –¥–Ω–µ–π
                'risk_score': int,  # –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞ (100 –µ—Å–ª–∏ –º–æ–ª–æ–¥–æ–π, 0 –µ—Å–ª–∏ —Å—Ç–∞—Ä—ã–π)
                'reason': str  # –ü—Ä–∏—á–∏–Ω–∞ (–¥–ª—è –ª–æ–≥–æ–≤)
            }
        """
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ª–∏ –∫–ª–∏–µ–Ω—Ç
        if not self.is_available():
            logger.warning("‚ö†Ô∏è Pyrogram –∫–ª–∏–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –Ω–µ –º–æ–≥—É –ø–æ–ª—É—á–∏—Ç—å —Ç–æ—á–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç –∞–∫–∫–∞—É–Ω—Ç–∞")
            return {
                'account_age_days': None,
                'creation_date': None,
                'is_young': False,
                'risk_score': 0,
                'reason': 'Pyrogram –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'
            }

        try:
            # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ —á–µ—Ä–µ–∑ MTProto
            user = await self.client.get_users(user_id)

            # –í–ê–ñ–ù–û: Telegram –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø—Ä—è–º—É—é –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞
            # –ù–æ –º—ã –º–æ–∂–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–∞—Ç—É –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ –¥—Ä—É–≥—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            # –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—É—é –æ—Ü–µ–Ω–∫—É —á–µ—Ä–µ–∑ –ø–µ—Ä–≤–æ–µ —Ñ–æ—Ç–æ
            photos = await self.get_profile_photos_dates(user_id)

            if photos:
                # –ë–µ—Ä—ë–º —Å–∞–º–æ–µ —Å—Ç–∞—Ä–æ–µ —Ñ–æ—Ç–æ –∫–∞–∫ –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω—É—é –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è
                # (–∞–∫–∫–∞—É–Ω—Ç –ù–ï –ú–û–ñ–ï–¢ –±—ã—Ç—å –º–æ–ª–æ–∂–µ —Å–∞–º–æ–≥–æ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ç–æ)
                oldest_photo = max(photos, key=lambda p: p['age_days'])
                creation_date = oldest_photo['date']
                account_age_days = oldest_photo['age_days']
            else:
                # –í–ê–ñ–ù–û: Telegram API –ù–ï –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ—á–Ω—É—é –¥–∞—Ç—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏!
                # –ï—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ô —Ä–∞—Å—á—ë—Ç –ø–æ USER ID
                # –ò–°–ü–†–ê–í–õ–ï–ù–û: –ó–∞–º–µ–Ω—ë–Ω —É—Å—Ç–∞—Ä–µ–≤—à–∏–π —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –º–∞–ø–ø–∏–Ω–≥ –Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç
                from bot.services.account_age_estimator import account_age_estimator
                from bot.services.redis_conn import redis as redis_client
                account_age_days = await account_age_estimator.get_dynamic_age_days(redis_client, user_id)
                # –í—ã—á–∏—Å–ª—è–µ–º –ø—Ä–∏–º–µ—Ä–Ω—É—é –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–∑—Ä–∞—Å—Ç–∞
                creation_date = datetime.now(timezone.utc) - timedelta(days=account_age_days)

            # –ì–õ–ê–í–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ê–∫–∫–∞—É–Ω—Ç –º–æ–ª–æ–∂–µ 30 –¥–Ω–µ–π?
            is_young = account_age_days <= 30

            # –í—ã—á–∏—Å–ª—è–µ–º –æ—Ü–µ–Ω–∫—É —Ä–∏—Å–∫–∞
            if is_young:
                risk_score = 100  # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∏—Å–∫ - –º–æ–ª–æ–¥–æ–π –∞–∫–∫–∞—É–Ω—Ç
                reason = f"–ú–æ–ª–æ–¥–æ–π –∞–∫–∫–∞—É–Ω—Ç: {account_age_days} –¥–Ω–µ–π (–ø–æ—Ä–æ–≥: ‚â§30)"
            else:
                risk_score = 0  # –ù–µ—Ç —Ä–∏—Å–∫–∞ - —Å—Ç–∞—Ä—ã–π –∞–∫–∫–∞—É–Ω—Ç
                reason = f"–°—Ç–∞—Ä—ã–π –∞–∫–∫–∞—É–Ω—Ç: {account_age_days} –¥–Ω–µ–π"

            logger.info(f"   üìÖ –ü–†–û–í–ï–†–ö–ê –í–û–ó–†–ê–°–¢–ê –ê–ö–ö–ê–£–ù–¢–ê:")
            logger.info(f"   üìÖ –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: {creation_date.strftime('%Y-%m-%d')}")
            logger.info(f"   üìÖ –í–æ–∑—Ä–∞—Å—Ç: {account_age_days} –¥–Ω–µ–π")
            logger.info(f"   üìÖ –ú–æ–ª–æ–¥–æ–π –∞–∫–∫–∞—É–Ω—Ç (<30 –¥–Ω–µ–π): {is_young}")
            logger.info(f"   üìÖ –û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–∞: {risk_score}/100")

            return {
                'account_age_days': account_age_days,
                'creation_date': creation_date,
                'is_young': is_young,
                'risk_score': risk_score,
                'reason': reason
            }

        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≤–æ–∑—Ä–∞—Å—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ –¥–ª—è {user_id}: {e}")
            return {
                'account_age_days': None,
                'creation_date': None,
                'is_young': False,
                'risk_score': 0,
                'reason': f'–û—à–∏–±–∫–∞: {str(e)}'
            }


# ==============================================================================
# –ì–õ–û–ë–ê–õ–¨–ù–´–ô –≠–ö–ó–ï–ú–ü–õ–Ø–† –°–ï–†–í–ò–°–ê
# ==============================================================================
# –°–æ–∑–¥–∞—ë–º –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä —Å–µ—Ä–≤–∏—Å–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤–æ –≤—Å—ë–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
# –≠—Ç–æ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä –±—É–¥–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞ –≤ bot.py
pyrogram_service = PyrogramService()
