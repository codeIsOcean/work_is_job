"""
–ú–æ–¥—É–ª—å –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ Telegram –ø–æ user_id

–£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø:
- Cubic spline –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –≤–º–µ—Å—Ç–æ –ª–∏–Ω–µ–π–Ω–æ–π (–±–æ–ª–µ–µ —Ç–æ—á–Ω–∞—è –¥–ª—è –Ω–µ–ª–∏–Ω–µ–π–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞)
- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏ (–±–æ–ª—å—à–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
- –†–∞—Å—á—ë—Ç –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ (¬±N –¥–Ω–µ–π –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å)
- –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ —Ä–∏—Å–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç–∏
"""

from bisect import bisect_left
from datetime import datetime, timezone, timedelta
import json
import logging
from typing import List, Tuple, Optional, Dict
import os

logger = logging.getLogger(__name__)

# –ü–æ–ø—ã—Ç–∫–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å scipy –¥–ª—è cubic spline
try:
    from scipy.interpolate import CubicSpline
    SCIPY_AVAILABLE = True
    logger.info("scipy –¥–æ—Å—Ç—É–ø–Ω–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º cubic spline –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—é")
except ImportError:
    SCIPY_AVAILABLE = False
    logger.warning("scipy –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–∏–Ω–µ–π–Ω—É—é –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—é (—É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install scipy)")

class AccountAgeEstimator:
    """–ö–ª–∞—Å—Å –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ –ø–æ user_id —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π cubic spline –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏"""

    def __init__(self, mapping_file: str = "bot/services/telegram_id_mapping.json"):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å —Ñ–∞–π–ª–æ–º –º–∞–ø–ø–∏–Ω–≥–∞

        Args:
            mapping_file: –ü—É—Ç—å –∫ JSON —Ñ–∞–π–ª—É —Å —ç—Ç–∞–ª–æ–Ω–Ω—ã–º–∏ —Ç–æ—á–∫–∞–º–∏ [user_id, unix_timestamp]
        """
        self.mapping_file = mapping_file
        self.mapping: List[Tuple[int, int]] = []
        self.spline = None  # Cubic spline interpolator (–µ—Å–ª–∏ scipy –¥–æ—Å—Ç—É–ø–µ–Ω)
        self.load_mapping()
        self._build_spline()
    
    def load_mapping(self) -> None:
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –º–∞–ø–ø–∏–Ω–≥ –∏–∑ JSON —Ñ–∞–π–ª–∞"""
        try:
            if not os.path.exists(self.mapping_file):
                logger.warning(f"–§–∞–π–ª –º–∞–ø–ø–∏–Ω–≥–∞ {self.mapping_file} –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞—é –±–∞–∑–æ–≤—ã–π –º–∞–ø–ø–∏–Ω–≥.")
                self.create_default_mapping()
                return
            
            with open(self.mapping_file, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ user_id –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é
            self.mapping = sorted([(int(x[0]), int(x[1])) for x in data], key=lambda x: x[0])
            logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω –º–∞–ø–ø–∏–Ω–≥ —Å {len(self.mapping)} —Ç–æ—á–∫–∞–º–∏")
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–ø–ø–∏–Ω–≥–∞: {e}")
            self.create_default_mapping()
    
    def create_default_mapping(self) -> None:
        """
        –°–æ–∑–¥–∞–µ—Ç –£–õ–£–ß–®–ï–ù–ù–´–ô –º–∞–ø–ø–∏–Ω–≥ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö Telegram

        –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã—Ö —Ç–æ—á–µ–∫:
        - –ü—É–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ —Ä–æ—Å—Ç–µ Telegram
        - –ò–∑–≤–µ—Å—Ç–Ω—ã–µ user_id –∏–∑ –ø—É–±–ª–∏—á–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        - –î–∞–Ω–Ω—ã–µ –æ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å —Å—Ç–∞—Ä—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
        """
        # –†–ê–°–®–ò–†–ï–ù–ù–´–ï –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏ (–±–æ–ª—å—à–µ —Ç–æ—á–µ–∫ = –≤—ã—à–µ —Ç–æ—á–Ω–æ—Å—Ç—å)
        default_mapping = [
            # 2013-2014: –ù–∞—á–∞–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥
            [1, 1381363200],           # 10 –æ–∫—Ç—è–±—Ä—è 2013 - –∑–∞–ø—É—Å–∫ Telegram
            [1000000, 1389312000],     # 10 —è–Ω–≤–∞—Ä—è 2014 - 1M –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

            # 2015: –ü–µ—Ä–∏–æ–¥ —Ä–æ—Å—Ç–∞
            [50000000, 1433116800],    # 1 –∏—é–Ω—è 2015 - 50M
            [100000000, 1455321600],   # 13 —Ñ–µ–≤—Ä–∞–ª—è 2016 - 100M –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

            # 2016-2017: –£—Å–∫–æ—Ä–µ–Ω–Ω—ã–π —Ä–æ—Å—Ç
            [300000000, 1469923200],   # 31 –∏—é–ª—è 2016 - ~300M
            [500000000, 1506816000],   # 1 –æ–∫—Ç—è–±—Ä—è 2017 - ~500M

            # 2018-2019: –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–æ—Å—Ç–∞
            [700000000, 1531526400],   # 14 –∏—é–ª—è 2018 - ~700M
            [900000000, 1577836800],   # 1 —è–Ω–≤–∞—Ä—è 2020 - ~900M

            # 2020-2021: –ü–∞–Ω–¥–µ–º–∏—è - –≤–∑—Ä—ã–≤–Ω–æ–π —Ä–æ—Å—Ç
            [1000000000, 1611187200],  # 21 —è–Ω–≤–∞—Ä—è 2021 - 1B
            [1500000000, 1627776000],  # 1 –∞–≤–≥—É—Å—Ç–∞ 2021 - ~1.5B

            # 2022: –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞
            [2000000000, 1642464000],  # 18 —è–Ω–≤–∞—Ä—è 2022 - 2B
            [2500000000, 1661990400],  # 1 —Å–µ–Ω—Ç—è–±—Ä—è 2022 - ~2.5B

            # 2023: –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ —Ä–æ—Å—Ç–∞
            [3000000000, 1677628800],  # 1 –º–∞—Ä—Ç–∞ 2023 - ~3B
            [3500000000, 1693526400],  # 1 —Å–µ–Ω—Ç—è–±—Ä—è 2023 - ~3.5B

            # 2024: –¢–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥ (–û–ë–ù–û–í–õ–ï–ù–û: —É–±—Ä–∞–Ω—ã –ø—Ä–æ–≥–Ω–æ–∑—ã –∏–∑ –±—É–¥—É—â–µ–≥–æ!)
            [4000000000, 1704067200],  # 1 —è–Ω–≤–∞—Ä—è 2024 - 4B
            [4500000000, 1717200000],  # 1 –∏—é–Ω—è 2024 - ~4.5B
            [5000000000, 1727740800],  # 1 –æ–∫—Ç—è–±—Ä—è 2024 - ~5B
            [5500000000, 1730419200],  # 1 –Ω–æ—è–±—Ä—è 2024 - ~5.5B
            [6000000000, 1732147200],  # 21 –Ω–æ—è–±—Ä—è 2024 - ~6B
            [6500000000, 1733443200],  # 6 –¥–µ–∫–∞–±—Ä—è 2024 - ~6.5B

            # –î–ª—è –ù–û–í–´–• –∞–∫–∫–∞—É–Ω—Ç–æ–≤ (7B+): –¥–∞–Ω–Ω—ã–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –Ω–∞–±–ª—é–¥–µ–Ω–∏–π
            # –í–ê–ñ–ù–û: –ú–∞–ø–ø–∏–Ω–≥ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ë–ï–ó —Ñ–æ—Ç–æ!
            # –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ - Pyrogram –¥–∞—Å—Ç –¢–û–ß–ù–£–Æ –¥–∞—Ç—É
            [7000000000, 1730419200],  # 1 –Ω–æ—è–±—Ä—è 2024 - ~7B
            [7500000000, 1731283200],  # 11 –Ω–æ—è–±—Ä—è 2024 - ~7.5B
            [8000000000, 1731628800],  # 15 –Ω–æ—è–±—Ä—è 2024 - ~8B
            [8400000000, 1731542400],  # 13 –Ω–æ—è–±—Ä—è 2024 - ~8.4B (—Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ!)
            [8500000000, 1731974400],  # 19 –Ω–æ—è–±—Ä—è 2024 - ~8.5B
            [9000000000, 1732492800],  # 25 –Ω–æ—è–±—Ä—è 2024 - ~9B
        ]

        self.mapping = [(int(x[0]), int(x[1])) for x in default_mapping]

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–∞–∑–æ–≤—ã–π –º–∞–ø–ø–∏–Ω–≥
        try:
            os.makedirs(os.path.dirname(self.mapping_file), exist_ok=True)
            with open(self.mapping_file, 'w', encoding='utf-8') as f:
                json.dump(default_mapping, f, indent=2)
            logger.info(f"–°–æ–∑–¥–∞–Ω —É–ª—É—á—à–µ–Ω–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ —Å {len(default_mapping)} —Ç–æ—á–∫–∞–º–∏ –≤ {self.mapping_file}")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–∞–∑–æ–≤–æ–≥–æ –º–∞–ø–ø–∏–Ω–≥–∞: {e}")

    def _build_spline(self) -> None:
        """
        –°—Ç—Ä–æ–∏—Ç cubic spline –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ç–æ—Ä –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤–æ–∑—Ä–∞—Å—Ç–∞

        Cubic spline –ª—É—á—à–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –Ω–µ–ª–∏–Ω–µ–π–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞ Telegram, —á–µ–º –ª–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è
        """
        if not SCIPY_AVAILABLE or len(self.mapping) < 4:
            logger.info("Cubic spline –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (scipy –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ—á–µ–∫)")
            return

        try:
            ids = [float(p[0]) for p in self.mapping]
            timestamps = [float(p[1]) for p in self.mapping]

            # –°–æ–∑–¥–∞—ë–º cubic spline —Å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –≥—Ä–∞–Ω–∏—á–Ω—ã–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏
            self.spline = CubicSpline(ids, timestamps, bc_type='natural')
            logger.info(f"Cubic spline –ø–æ—Å—Ç—Ä–æ–µ–Ω —É—Å–ø–µ—à–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ {len(ids)} —Ç–æ—á–µ–∫")

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è cubic spline: {e}")
            self.spline = None

    def add_calibration_point(self, user_id: int, creation_timestamp: int) -> bool:
        """
        –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—É—é –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—É—é —Ç–æ—á–∫—É –≤ –º–∞–ø–ø–∏–Ω–≥ –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ —Ñ–∞–π–ª.

        –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ–≥–¥–∞ Pyrogram –ø–æ–ª—É—á–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—É—é –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞.
        –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ JSON —Ñ–∞–π–ª –∏ –ù–ï —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –±–æ—Ç–∞.

        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
            creation_timestamp: Unix timestamp —Ä–µ–∞–ª—å–Ω–æ–π –¥–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è

        Returns:
            True –µ—Å–ª–∏ —Ç–æ—á–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞, False –µ—Å–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –æ—à–∏–±–∫–∞
        """
        try:
            # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–æ—á–∫–∞ –µ—â—ë –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–∏–∑–±–µ–≥–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
            # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            existing_ids = {p[0] for p in self.mapping}
            if user_id in existing_ids:
                logger.debug(f"–¢–æ—á–∫–∞ user_id={user_id} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –º–∞–ø–ø–∏–Ω–≥–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
                return False

            # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é —Ç–æ—á–∫—É –≤ –ø–∞–º—è—Ç—å
            # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            new_point = (int(user_id), int(creation_timestamp))
            self.mapping.append(new_point)

            # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ user_id –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏
            self.mapping = sorted(self.mapping, key=lambda x: x[0])

            # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª (–¥–∞–Ω–Ω—ã–µ –ù–ï —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ)
            # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            self._save_mapping_to_file()

            # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            # –ü–µ—Ä–µ—Å—Ç—Ä–∞–∏–≤–∞–µ–º spline —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
            # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            self._build_spline()

            # –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
            creation_date = datetime.fromtimestamp(creation_timestamp, tz=timezone.utc)
            logger.info(
                f"üìä MAPPING_UPDATED: –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–æ—á–∫–∞ user_id={user_id}, "
                f"date={creation_date.strftime('%Y-%m-%d')}, "
                f"–≤—Å–µ–≥–æ —Ç–æ—á–µ–∫: {len(self.mapping)}"
            )

            return True

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω–æ–π —Ç–æ—á–∫–∏: {e}")
            return False

    def _save_mapping_to_file(self) -> None:
        """
        –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—É—â–∏–π –º–∞–ø–ø–∏–Ω–≥ –≤ JSON —Ñ–∞–π–ª.

        –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–π —Ç–æ—á–∫–∏.
        """
        try:
            # –°–æ–∑–¥–∞—ë–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            os.makedirs(os.path.dirname(self.mapping_file), exist_ok=True)

            # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è JSON
            mapping_data = [[p[0], p[1]] for p in self.mapping]

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å –∫—Ä–∞—Å–∏–≤—ã–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
            with open(self.mapping_file, 'w', encoding='utf-8') as f:
                json.dump(mapping_data, f, indent=2)

            logger.debug(f"–ú–∞–ø–ø–∏–Ω–≥ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ {self.mapping_file} ({len(self.mapping)} —Ç–æ—á–µ–∫)")

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞–ø–ø–∏–Ω–≥–∞ –≤ —Ñ–∞–π–ª: {e}")

    def estimate_creation_timestamp(self, user_id: int) -> int:
        """
        –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è (unix timestamp) –ø–æ user_id

        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç cubic spline –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—é (–µ—Å–ª–∏ scipy –¥–æ—Å—Ç—É–ø–µ–Ω) –∏–ª–∏ –ª–∏–Ω–µ–π–Ω—É—é –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—é

        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram

        Returns:
            Unix timestamp –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ–π –¥–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è
        """
        if not self.mapping:
            raise ValueError("–ú–∞–ø–ø–∏–Ω–≥ –ø—É—Å—Ç")

        # –ì—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏
        if user_id <= self.mapping[0][0]:
            return self.mapping[0][1]
        if user_id >= self.mapping[-1][0]:
            return self.mapping[-1][1]

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º cubic spline –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
        if self.spline is not None:
            try:
                est_ts = float(self.spline(user_id))
                return int(est_ts)
            except Exception as e:
                logger.warning(f"–û—à–∏–±–∫–∞ cubic spline –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏: {e}. Fallback –Ω–∞ –ª–∏–Ω–µ–π–Ω—É—é.")

        # Fallback: –ª–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è
        ids = [p[0] for p in self.mapping]
        pos = bisect_left(ids, user_id)

        id_lo, ts_lo = self.mapping[pos-1]
        id_hi, ts_hi = self.mapping[pos]

        # –ï—Å–ª–∏ –ø–æ–ø–∞–ª–∏ —Ç–æ—á–Ω–æ –≤ –æ–±—Ä–∞–∑–µ—Ü
        if user_id == id_lo:
            return ts_lo
        if user_id == id_hi:
            return ts_hi

        # –õ–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è
        frac = (user_id - id_lo) / (id_hi - id_lo)
        est_ts = int(ts_lo + frac * (ts_hi - ts_lo))
        return est_ts
    
    def estimate_creation_datetime(self, user_id: int) -> datetime:
        """
        –û—Ü–µ–Ω–∫–∞ –¥–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
            
        Returns:
            datetime –æ–±—ä–µ–∫—Ç –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ–π –¥–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è
        """
        ts = self.estimate_creation_timestamp(user_id)
        return datetime.fromtimestamp(ts, tz=timezone.utc)
    
    def get_account_age_days(self, user_id: int) -> int:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ –¥–Ω—è—Ö (—á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—é User ID)

        –í–ê–ñ–ù–û: –≠—Ç–æ –ü–†–ò–ë–õ–ò–ó–ò–¢–ï–õ–¨–ù–ê–Ø –æ—Ü–µ–Ω–∫–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ë–ï–ó —Ñ–æ—Ç–æ!
        –î–ª—è —Ç–æ—á–Ω–æ–≥–æ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è Pyrogram (–¥–∞—Ç–∞ –ø–µ—Ä–≤–æ–≥–æ —Ñ–æ—Ç–æ = —Ä–µ–∞–ª—å–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç).

        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram

        Returns:
            –í–æ–∑—Ä–∞—Å—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ –¥–Ω—è—Ö
        """
        creation_date = self.estimate_creation_datetime(user_id)
        now = datetime.now(timezone.utc)

        # –ó–ê–©–ò–¢–ê: –ï—Å–ª–∏ –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤ –±—É–¥—É—â–µ–º - –∑–Ω–∞—á–∏—Ç –æ—à–∏–±–∫–∞ –≤ –º–∞–ø–ø–∏–Ω–≥–µ
        # –°—á–∏—Ç–∞–µ–º –∞–∫–∫–∞—É–Ω—Ç –°–¢–ê–†–´–ú (—á—Ç–æ–±—ã –Ω–µ –º—É—Ç–∏—Ç—å –ø–æ –æ—à–∏–±–∫–µ)
        if creation_date > now:
            logger.warning(
                f"‚ö†Ô∏è User {user_id}: –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤ –ë–£–î–£–©–ï–ú ({creation_date.strftime('%Y-%m-%d')}), "
                f"–º–∞–ø–ø–∏–Ω–≥ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω! –°—á–∏—Ç–∞–µ–º –∞–∫–∫–∞—É–Ω—Ç –°–¢–ê–†–´–ú (–≤–æ–∑—Ä–∞—Å—Ç = 365 –¥–Ω–µ–π) –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏."
            )
            return 365

        age_delta = now - creation_date
        return age_delta.days

    def estimate_confidence_interval(self, user_id: int) -> Tuple[int, int]:
        """
        –û—Ü–µ–Ω–∏–≤–∞–µ—Ç –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª (¬±–¥–Ω–∏ –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç–∏) –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –≤–æ–∑—Ä–∞—Å—Ç–∞

        –ü–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç:
        1. –†–∞—Å—Å—Ç–æ—è–Ω–∏—è –¥–æ –±–ª–∏–∂–∞–π—à–∏—Ö –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã—Ö —Ç–æ—á–µ–∫
        2. –ü–ª–æ—Ç–Ω–æ—Å—Ç–∏ —Ç–æ—á–µ–∫ –≤ –¥–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
        3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è spline vs –ª–∏–Ω–µ–π–Ω–æ–π –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏

        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram

        Returns:
            Tuple[min_error_days, max_error_days] - –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤ –¥–Ω—è—Ö
        """
        if not self.mapping:
            return (30, 30)  # –ë–æ–ª—å—à–∞—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö

        # –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–∏–µ –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏
        ids = [p[0] for p in self.mapping]
        pos = bisect_left(ids, user_id)

        # –ì—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏ - –±–æ–ª—å—à–∞—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å
        if pos == 0 or pos >= len(self.mapping):
            return (14, 14)  # ¬±14 –¥–Ω–µ–π –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö

        # –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –±–ª–∏–∂–∞–π—à–∏—Ö —Ç–æ—á–µ–∫
        id_lo = self.mapping[pos-1][0]
        id_hi = self.mapping[pos][0]
        distance_to_nearest = min(abs(user_id - id_lo), abs(user_id - id_hi))
        range_width = id_hi - id_lo

        # –ë–∞–∑–æ–≤–∞—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —à–∏—Ä–∏–Ω—ã –¥–∏–∞–ø–∞–∑–æ–Ω–∞
        # –ß–µ–º —à–∏—Ä–µ –¥–∏–∞–ø–∞–∑–æ–Ω –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏ - —Ç–µ–º –±–æ–ª—å—à–µ –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å
        if range_width < 100_000_000:  # –ü–ª–æ—Ç–Ω—ã–µ —Ç–æ—á–∫–∏
            base_error = 2
        elif range_width < 500_000_000:  # –°—Ä–µ–¥–Ω—è—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å
            base_error = 5
        elif range_width < 1_000_000_000:  # –†–µ–¥–∫–∏–µ —Ç–æ—á–∫–∏
            base_error = 10
        else:  # –û—á–µ–Ω—å —Ä–µ–¥–∫–∏–µ —Ç–æ—á–∫–∏
            base_error = 15

        # –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º spline - –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å –º–µ–Ω—å—à–µ
        if self.spline is not None:
            base_error = int(base_error * 0.7)  # Spline –Ω–∞ 30% —Ç–æ—á–Ω–µ–µ

        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å –µ—Å–ª–∏ –¥–∞–ª–µ–∫–æ –æ—Ç –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã—Ö —Ç–æ—á–µ–∫
        relative_distance = distance_to_nearest / range_width
        if relative_distance > 0.4:  # –î–∞–ª–µ–∫–æ –æ—Ç –æ–±–µ–∏—Ö —Ç–æ—á–µ–∫
            base_error = int(base_error * 1.5)

        return (base_error, base_error)
    
    def calculate_age_risk_score(self, user_id: int) -> Tuple[int, str, str]:
        """
        –í—ã—á–∏—Å–ª—è–µ—Ç —Ä–∏—Å–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
            
        Returns:
            Tuple[score, label, description]
            - score: 0-100 (–±–∞–ª–ª —Ä–∏—Å–∫–∞)
            - label: –∫–æ—Ä–æ—Ç–∫–∏–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
            - description: –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        """
        age_days = self.get_account_age_days(user_id)
        creation_date = self.estimate_creation_datetime(user_id)
        
        if age_days < 1:
            return 90, "very_new", f"–û—á–µ–Ω—å –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç ({age_days} –¥–Ω–µ–π)"
        elif age_days < 7:
            return 80, "new", f"–ù–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç ({age_days} –¥–Ω–µ–π)"
        elif age_days < 30:
            return 60, "young", f"–ú–æ–ª–æ–¥–æ–π –∞–∫–∫–∞—É–Ω—Ç ({age_days} –¥–Ω–µ–π)"
        elif age_days < 180:
            return 30, "mature", f"–ó—Ä–µ–ª—ã–π –∞–∫–∫–∞—É–Ω—Ç ({age_days} –¥–Ω–µ–π)"
        else:
            return 0, "old", f"–°—Ç–∞—Ä—ã–π –∞–∫–∫–∞—É–Ω—Ç ({age_days} –¥–Ω–µ–π)"
    
    def get_detailed_age_info(self, user_id: int) -> dict:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –£–õ–£–ß–®–ï–ù–ù–£–Æ –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–æ–∑—Ä–∞—Å—Ç–µ –∞–∫–∫–∞—É–Ω—Ç–∞

        –í–∫–ª—é—á–∞–µ—Ç:
        - –û—Ü–µ–Ω–∫—É –≤–æ–∑—Ä–∞—Å—Ç–∞
        - –î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã (–ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å)
        - –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ —Ä–∏—Å–∫–∞

        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram

        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
        """
        creation_date = self.estimate_creation_datetime(user_id)
        age_days = self.get_account_age_days(user_id)
        score, label, description = self.calculate_age_risk_score(user_id)

        # –î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª (–ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å)
        error_min, error_max = self.estimate_confidence_interval(user_id)

        # –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ: –µ—Å–ª–∏ –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å –±–æ–ª—å—à–∞—è –∏ –≤–æ–∑—Ä–∞—Å—Ç –±–ª–∏–∑–æ–∫ –∫ –ø–æ—Ä–æ–≥—É (30 –¥–Ω–µ–π),
        # —Ç–æ —Å–Ω–∏–∂–∞–µ–º —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å (–Ω–µ –º—É—Ç–∏–º –µ—Å–ª–∏ –Ω–µ—É–≤–µ—Ä–µ–Ω—ã)
        adjusted_risk_score = score
        confidence = "–≤—ã—Å–æ–∫–∞—è"

        if error_max >= 10:  # –ë–æ–ª—å—à–∞—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å (‚â•10 –¥–Ω–µ–π)
            confidence = "—Å—Ä–µ–¥–Ω—è—è"
            # –ï—Å–ª–∏ –≤–æ–∑—Ä–∞—Å—Ç 20-40 –¥–Ω–µ–π (–≤–±–ª–∏–∑–∏ –ø–æ—Ä–æ–≥–∞ 30) –∏ –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å –±–æ–ª—å—à–∞—è - —Å–Ω–∏–∂–∞–µ–º —Ä–∏—Å–∫
            if 20 <= age_days <= 40:
                adjusted_risk_score = int(score * 0.8)  # –°–Ω–∏–∂–∞–µ–º –Ω–∞ 20%
                confidence = "–Ω–∏–∑–∫–∞—è"

        return {
            "user_id": user_id,
            "estimated_creation_date": creation_date,
            "age_days": age_days,
            "risk_score": score,
            "adjusted_risk_score": adjusted_risk_score,  # –ù–û–í–û–ï: –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –±–∞–ª–ª
            "risk_label": label,
            "risk_description": description,
            "creation_date_str": creation_date.strftime('%Y-%m-%d %H:%M:%S UTC'),
            "age_str": f"{age_days} –¥–Ω–µ–π",
            "confidence_interval_days": f"¬±{error_max}",  # –ù–û–í–û–ï: –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å
            "confidence_level": confidence,  # –ù–û–í–û–ï: —É—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
            "interpolation_method": "cubic_spline" if self.spline else "linear"  # –ù–û–í–û–ï: –º–µ—Ç–æ–¥
        }

    # =========================================================================
    # –î–ò–ù–ê–ú–ò–ß–ï–°–ö–ò–ô –†–ê–°–ß–Å–¢ –í–û–ó–†–ê–°–¢–ê (–£–õ–£–ß–®–ï–ù–ù–´–ô –ú–ï–¢–û–î)
    # =========================================================================
    # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Ñ–æ—Ä–º—É–ª—É: age_days = (max_seen_id - user_id) / DAILY_GROWTH
    # –•—Ä–∞–Ω–∏—Ç max_seen_id –≤ –ë–î (–Ω–∞–¥—ë–∂–Ω–æ) + Redis (–±—ã—Å—Ç—Ä–æ)
    # =========================================================================

    # –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞: –ø—Ä–∏–º–µ—Ä–Ω—ã–π –ø—Ä–∏—Ä–æ—Å—Ç user_id –≤ –¥–µ–Ω—å (~2.5 –º–∏–ª–ª–∏–æ–Ω–∞)
    DAILY_GROWTH = 2_500_000

    # –ö–ª—é—á –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ ID –≤ Redis (–∫—ç—à)
    REDIS_MAX_ID_KEY = "telegram:max_seen_user_id"

    # Fallback –∑–Ω–∞—á–µ–Ω–∏–µ –µ—Å–ª–∏ –ë–î –∏ Redis –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã (–¥–µ–∫–∞–±—Ä—å 2025)
    _fallback_max_id = 8_600_000_000

    async def update_max_seen_id(self, user_id: int, redis_client=None) -> bool:
        """
        –û–±–Ω–æ–≤–ª—è–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–∑–≤–µ—Å—Ç–Ω—ã–π user_id –≤ –ë–î –∏ Redis.

        –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î (–Ω–∞–¥—ë–∂–Ω–æ) + Redis (–±—ã—Å—Ç—Ä—ã–π –∫—ç—à).
        –í—ã–∑—ã–≤–∞—Ç—å –ø—Ä–∏ –∫–∞–∂–¥–æ–º –Ω–æ–≤–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (join_request, —Å–æ–æ–±—â–µ–Ω–∏–µ).

        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ—Ç–æ—Ä—ã–π —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø–æ—è–≤–∏–ª—Å—è
            redis_client: –ö–ª–∏–µ–Ω—Ç Redis (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è –∫—ç—à–∞)

        Returns:
            True –µ—Å–ª–∏ ID –æ–±–Ω–æ–≤–ª—ë–Ω, False –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π ID –º–µ–Ω—å—à–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ
        """
        try:
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –º–∞–∫—Å–∏–º—É–º
            current_max = await self.get_max_seen_id(redis_client)

            # –ï—Å–ª–∏ –Ω–æ–≤—ã–π ID –±–æ–ª—å—à–µ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º
            if user_id > current_max:
                # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                # 1. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î (–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
                # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                try:
                    from bot.database.session import get_session
                    from bot.database.models_global_settings import BotGlobalSettings, GlobalSettingKeys
                    from sqlalchemy import select

                    async with get_session() as session:
                        # Upsert: –æ–±–Ω–æ–≤–ª—è–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º
                        result = await session.execute(
                            select(BotGlobalSettings).where(
                                BotGlobalSettings.key == GlobalSettingKeys.MAX_SEEN_USER_ID
                            )
                        )
                        setting = result.scalar_one_or_none()

                        if setting:
                            setting.value = str(user_id)
                        else:
                            setting = BotGlobalSettings(
                                key=GlobalSettingKeys.MAX_SEEN_USER_ID,
                                value=str(user_id)
                            )
                            session.add(setting)

                        await session.commit()

                except Exception as db_error:
                    logger.warning(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è max_seen_id –≤ –ë–î: {db_error}")

                # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                # 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Redis (–∫—ç—à –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏)
                # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                if redis_client:
                    try:
                        await redis_client.set(self.REDIS_MAX_ID_KEY, str(user_id))
                    except Exception as redis_error:
                        logger.warning(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è max_seen_id –≤ Redis: {redis_error}")

                # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                # 3. –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π fallback
                # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                old_max = self._fallback_max_id
                self._fallback_max_id = user_id

                # –õ–æ–≥–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
                if user_id - old_max > 1_000_000:
                    logger.info(
                        f"üìä MAX_ID –æ–±–Ω–æ–≤–ª—ë–Ω: {old_max:,} ‚Üí {user_id:,} "
                        f"(+{user_id - old_max:,})"
                    )

                return True

            return False

        except Exception as e:
            logger.warning(f"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è max_seen_id: {e}")
            return False

    async def get_max_seen_id(self, redis_client=None) -> int:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–∑–≤–µ—Å—Ç–Ω—ã–π user_id.

        –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: Redis (–∫—ç—à) ‚Üí –ë–î ‚Üí fallback

        Args:
            redis_client: –ö–ª–∏–µ–Ω—Ç Redis (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

        Returns:
            –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π user_id
        """
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # 1. –ü—Ä–æ–±—É–µ–º Redis (–±—ã—Å—Ç—Ä—ã–π –∫—ç—à)
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        if redis_client:
            try:
                cached = await redis_client.get(self.REDIS_MAX_ID_KEY)
                if cached:
                    value = int(cached)
                    # –û–±–Ω–æ–≤–ª—è–µ–º fallback
                    if value > self._fallback_max_id:
                        self._fallback_max_id = value
                    return value
            except Exception as e:
                logger.debug(f"Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è max_seen_id: {e}")

        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # 2. –ü—Ä–æ–±—É–µ–º –ë–î (–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã)
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        try:
            from bot.database.session import get_session
            from bot.database.models_global_settings import BotGlobalSettings, GlobalSettingKeys
            from sqlalchemy import select

            async with get_session() as session:
                result = await session.execute(
                    select(BotGlobalSettings.value).where(
                        BotGlobalSettings.key == GlobalSettingKeys.MAX_SEEN_USER_ID
                    )
                )
                db_value = result.scalar_one_or_none()

                if db_value:
                    value = int(db_value)
                    # –û–±–Ω–æ–≤–ª—è–µ–º fallback
                    if value > self._fallback_max_id:
                        self._fallback_max_id = value
                    # –û–±–Ω–æ–≤–ª—è–µ–º Redis –∫—ç—à –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
                    if redis_client:
                        try:
                            await redis_client.set(self.REDIS_MAX_ID_KEY, str(value))
                        except:
                            pass
                    return value

        except Exception as e:
            logger.debug(f"–ë–î –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è max_seen_id: {e}")

        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # 3. –í–æ–∑–≤—Ä–∞—â–∞–µ–º fallback
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        return self._fallback_max_id

    async def get_dynamic_age_days(self, redis_client, user_id: int) -> int:
        """
        –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç –≤–æ–∑—Ä–∞—Å—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ –¥–Ω—è—Ö.

        –§–æ—Ä–º—É–ª–∞: age_days = (max_seen_id - user_id) / DAILY_GROWTH

        –í–ê–ñ–ù–û: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç max_seen_id –µ—Å–ª–∏ –≤–∏–¥–∏—Ç –±–æÃÅ–ª—å—à–∏–π user_id!
        –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–∏—Å—Ç–µ–º–µ —Å–∞–º–æ–æ–±—É—á–∞—Ç—å—Å—è –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

        Args:
            redis_client: –ö–ª–∏–µ–Ω—Ç Redis
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

        Returns:
            –ü—Ä–∏–º–µ—Ä–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ –¥–Ω—è—Ö
        """
        # –ü–æ–ª—É—á–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –∏–∑–≤–µ—Å—Ç–Ω—ã–π ID
        max_id = await self.get_max_seen_id(redis_client)

        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # –ê–í–¢–û–û–ë–ù–û–í–õ–ï–ù–ò–ï: –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π user_id –±–æ–ª—å—à–µ max_id ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º!
        # –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Å–∏—Å—Ç–µ–º–µ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫ —Ä–æ—Å—Ç—É Telegram
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        if user_id > max_id:
            await self.update_max_seen_id(user_id, redis_client)
            # –ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —ç—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—á–∏—Ç–∞–µ—Ç—Å—è "—Å–∞–º—ã–º –Ω–æ–≤—ã–º" (0 –¥–Ω–µ–π)
            return 0

        # –í—ã—á–∏—Å–ª—è–µ–º —Ä–∞–∑–Ω–∏—Ü—É –º–µ–∂–¥—É –º–∞–∫—Å–∏–º—É–º–æ–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã–º ID
        id_difference = max_id - user_id

        # –í—ã—á–∏—Å–ª—è–µ–º –≤–æ–∑—Ä–∞—Å—Ç: —Ä–∞–∑–Ω–∏—Ü–∞ / –ø—Ä–∏—Ä–æ—Å—Ç –≤ –¥–µ–Ω—å
        age_days = id_difference // self.DAILY_GROWTH

        return age_days

    async def is_young_account_dynamic(
        self,
        redis_client,
        user_id: int,
        threshold_days: int = 30
    ) -> tuple:
        """
        –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∞–∫–∫–∞—É–Ω—Ç –º–æ–ª–æ–¥—ã–º (–¥–ª—è –º—É—Ç–∞).

        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ max_seen_id.

        Args:
            redis_client: –ö–ª–∏–µ–Ω—Ç Redis
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            threshold_days: –ü–æ—Ä–æ–≥ –≤ –¥–Ω—è—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 30)

        Returns:
            Tuple[is_young: bool, age_days: int, reason: str]
        """
        # –ü–æ–ª—É—á–∞–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π –≤–æ–∑—Ä–∞—Å—Ç
        age_days = await self.get_dynamic_age_days(redis_client, user_id)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä–æ–≥
        is_young = age_days <= threshold_days

        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–∏—á–∏–Ω—É –¥–ª—è –ª–æ–≥–æ–≤
        if is_young:
            reason = f"–ú–æ–ª–æ–¥–æ–π –∞–∫–∫–∞—É–Ω—Ç: ~{age_days} –¥–Ω–µ–π (–ø–æ—Ä–æ–≥: ‚â§{threshold_days})"
        else:
            reason = f"–°—Ç–∞—Ä—ã–π –∞–∫–∫–∞—É–Ω—Ç: ~{age_days} –¥–Ω–µ–π"

        return is_young, age_days, reason


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö
account_age_estimator = AccountAgeEstimator()
