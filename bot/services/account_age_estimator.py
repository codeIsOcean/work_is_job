"""
–ú–æ–¥—É–ª—å –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ Telegram –ø–æ user_id

–£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø:
- Cubic spline –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –≤–º–µ—Å—Ç–æ –ª–∏–Ω–µ–π–Ω–æ–π (–±–æ–ª–µ–µ —Ç–æ—á–Ω–∞—è –¥–ª—è –Ω–µ–ª–∏–Ω–µ–π–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞)
- –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏ (–±–æ–ª—å—à–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
- –†–∞—Å—á—ë—Ç –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã—Ö –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ (¬±N –¥–Ω–µ–π –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å)
- –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ —Ä–∏—Å–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ—Å—Ç–∏
"""

from bisect import bisect_left
from datetime import datetime, timezone, timedelta
import json
import logging
from typing import List, Tuple, Optional, Dict
import os

logger = logging.getLogger(__name__)

# –ü–æ–ø—ã—Ç–∫–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å scipy –¥–ª—è cubic spline
try:
    from scipy.interpolate import CubicSpline
    SCIPY_AVAILABLE = True
    logger.info("scipy –¥–æ—Å—Ç—É–ø–Ω–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º cubic spline –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—é")
except ImportError:
    SCIPY_AVAILABLE = False
    logger.warning("scipy –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–∏–Ω–µ–π–Ω—É—é –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—é (—É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install scipy)")

class AccountAgeEstimator:
    """–ö–ª–∞—Å—Å –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ –ø–æ user_id —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π cubic spline –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏"""

    def __init__(self, mapping_file: str = "bot/services/telegram_id_mapping.json"):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å —Ñ–∞–π–ª–æ–º –º–∞–ø–ø–∏–Ω–≥–∞

        Args:
            mapping_file: –ü—É—Ç—å –∫ JSON —Ñ–∞–π–ª—É —Å —ç—Ç–∞–ª–æ–Ω–Ω—ã–º–∏ —Ç–æ—á–∫–∞–º–∏ [user_id, unix_timestamp]
        """
        self.mapping_file = mapping_file
        self.mapping: List[Tuple[int, int]] = []
        self.spline = None  # Cubic spline interpolator (–µ—Å–ª–∏ scipy –¥–æ—Å—Ç—É–ø–µ–Ω)
        self.load_mapping()
        self._build_spline()
    
    def load_mapping(self) -> None:
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –º–∞–ø–ø–∏–Ω–≥ –∏–∑ JSON —Ñ–∞–π–ª–∞"""
        try:
            if not os.path.exists(self.mapping_file):
                logger.warning(f"–§–∞–π–ª –º–∞–ø–ø–∏–Ω–≥–∞ {self.mapping_file} –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞—é –±–∞–∑–æ–≤—ã–π –º–∞–ø–ø–∏–Ω–≥.")
                self.create_default_mapping()
                return
            
            with open(self.mapping_file, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            # –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ user_id –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é
            self.mapping = sorted([(int(x[0]), int(x[1])) for x in data], key=lambda x: x[0])
            logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω –º–∞–ø–ø–∏–Ω–≥ —Å {len(self.mapping)} —Ç–æ—á–∫–∞–º–∏")
            
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–ø–ø–∏–Ω–≥–∞: {e}")
            self.create_default_mapping()
    
    def create_default_mapping(self) -> None:
        """
        –°–æ–∑–¥–∞–µ—Ç –£–õ–£–ß–®–ï–ù–ù–´–ô –º–∞–ø–ø–∏–Ω–≥ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö Telegram

        –ò—Å—Ç–æ—á–Ω–∏–∫–∏ –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã—Ö —Ç–æ—á–µ–∫:
        - –ü—É–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ —Ä–æ—Å—Ç–µ Telegram
        - –ò–∑–≤–µ—Å—Ç–Ω—ã–µ user_id –∏–∑ –ø—É–±–ª–∏—á–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
        - –î–∞–Ω–Ω—ã–µ –æ –º–∏–≥—Ä–∞—Ü–∏–∏ —Å —Å—Ç–∞—Ä—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤
        """
        # –†–ê–°–®–ò–†–ï–ù–ù–´–ï –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏ (–±–æ–ª—å—à–µ —Ç–æ—á–µ–∫ = –≤—ã—à–µ —Ç–æ—á–Ω–æ—Å—Ç—å)
        default_mapping = [
            # 2013-2014: –ù–∞—á–∞–ª—å–Ω—ã–π –ø–µ—Ä–∏–æ–¥
            [1, 1381363200],           # 10 –æ–∫—Ç—è–±—Ä—è 2013 - –∑–∞–ø—É—Å–∫ Telegram
            [1000000, 1389312000],     # 10 —è–Ω–≤–∞—Ä—è 2014 - 1M –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

            # 2015: –ü–µ—Ä–∏–æ–¥ —Ä–æ—Å—Ç–∞
            [50000000, 1433116800],    # 1 –∏—é–Ω—è 2015 - 50M
            [100000000, 1455321600],   # 13 —Ñ–µ–≤—Ä–∞–ª—è 2016 - 100M –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

            # 2016-2017: –£—Å–∫–æ—Ä–µ–Ω–Ω—ã–π —Ä–æ—Å—Ç
            [300000000, 1469923200],   # 31 –∏—é–ª—è 2016 - ~300M
            [500000000, 1506816000],   # 1 –æ–∫—Ç—è–±—Ä—è 2017 - ~500M

            # 2018-2019: –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–æ—Å—Ç–∞
            [700000000, 1531526400],   # 14 –∏—é–ª—è 2018 - ~700M
            [900000000, 1577836800],   # 1 —è–Ω–≤–∞—Ä—è 2020 - ~900M

            # 2020-2021: –ü–∞–Ω–¥–µ–º–∏—è - –≤–∑—Ä—ã–≤–Ω–æ–π —Ä–æ—Å—Ç
            [1000000000, 1611187200],  # 21 —è–Ω–≤–∞—Ä—è 2021 - 1B
            [1500000000, 1627776000],  # 1 –∞–≤–≥—É—Å—Ç–∞ 2021 - ~1.5B

            # 2022: –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞
            [2000000000, 1642464000],  # 18 —è–Ω–≤–∞—Ä—è 2022 - 2B
            [2500000000, 1661990400],  # 1 —Å–µ–Ω—Ç—è–±—Ä—è 2022 - ~2.5B

            # 2023: –ó–∞–º–µ–¥–ª–µ–Ω–∏–µ —Ä–æ—Å—Ç–∞
            [3000000000, 1677628800],  # 1 –º–∞—Ä—Ç–∞ 2023 - ~3B
            [3500000000, 1693526400],  # 1 —Å–µ–Ω—Ç—è–±—Ä—è 2023 - ~3.5B

            # 2024: –¢–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥ (–û–ë–ù–û–í–õ–ï–ù–û: —É–±—Ä–∞–Ω—ã –ø—Ä–æ–≥–Ω–æ–∑—ã –∏–∑ –±—É–¥—É—â–µ–≥–æ!)
            [4000000000, 1704067200],  # 1 —è–Ω–≤–∞—Ä—è 2024 - 4B
            [4500000000, 1717200000],  # 1 –∏—é–Ω—è 2024 - ~4.5B
            [5000000000, 1727740800],  # 1 –æ–∫—Ç—è–±—Ä—è 2024 - ~5B
            [5500000000, 1730419200],  # 1 –Ω–æ—è–±—Ä—è 2024 - ~5.5B
            [6000000000, 1732147200],  # 21 –Ω–æ—è–±—Ä—è 2024 - ~6B
            [6500000000, 1733443200],  # 6 –¥–µ–∫–∞–±—Ä—è 2024 - ~6.5B

            # –î–ª—è –ù–û–í–´–• –∞–∫–∫–∞—É–Ω—Ç–æ–≤ (7B+): –∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ - —Å—á–∏—Ç–∞–µ–º –û–ß–ï–ù–¨ –Ω–æ–≤—ã–º–∏
            # ID > 7B - –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–Ω–∏ (–¥–µ–∫–∞–±—Ä—å 2024)
            [7000000000, 1733011200],  # 1 –¥–µ–∫–∞–±—Ä—è 2024 - ~7B
            [8000000000, 1733270400],  # 4 –¥–µ–∫–∞–±—Ä—è 2024 - ~8B (–ù–û–í–´–ï –∞–∫–∫–∞—É–Ω—Ç—ã!)
            [9000000000, 1733356800],  # 5 –¥–µ–∫–∞–±—Ä—è 2024 - ~9B (–û–ß–ï–ù–¨ –Ω–æ–≤—ã–µ!)
        ]

        self.mapping = [(int(x[0]), int(x[1])) for x in default_mapping]

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –±–∞–∑–æ–≤—ã–π –º–∞–ø–ø–∏–Ω–≥
        try:
            os.makedirs(os.path.dirname(self.mapping_file), exist_ok=True)
            with open(self.mapping_file, 'w', encoding='utf-8') as f:
                json.dump(default_mapping, f, indent=2)
            logger.info(f"–°–æ–∑–¥–∞–Ω —É–ª—É—á—à–µ–Ω–Ω—ã–π –º–∞–ø–ø–∏–Ω–≥ —Å {len(default_mapping)} —Ç–æ—á–∫–∞–º–∏ –≤ {self.mapping_file}")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–∞–∑–æ–≤–æ–≥–æ –º–∞–ø–ø–∏–Ω–≥–∞: {e}")

    def _build_spline(self) -> None:
        """
        –°—Ç—Ä–æ–∏—Ç cubic spline –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ç–æ—Ä –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤–æ–∑—Ä–∞—Å—Ç–∞

        Cubic spline –ª—É—á—à–µ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –Ω–µ–ª–∏–Ω–µ–π–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞ Telegram, —á–µ–º –ª–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è
        """
        if not SCIPY_AVAILABLE or len(self.mapping) < 4:
            logger.info("Cubic spline –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (scipy –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ—á–µ–∫)")
            return

        try:
            ids = [float(p[0]) for p in self.mapping]
            timestamps = [float(p[1]) for p in self.mapping]

            # –°–æ–∑–¥–∞—ë–º cubic spline —Å –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –≥—Ä–∞–Ω–∏—á–Ω—ã–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏
            self.spline = CubicSpline(ids, timestamps, bc_type='natural')
            logger.info(f"Cubic spline –ø–æ—Å—Ç—Ä–æ–µ–Ω —É—Å–ø–µ—à–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ {len(ids)} —Ç–æ—á–µ–∫")

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è cubic spline: {e}")
            self.spline = None

    def estimate_creation_timestamp(self, user_id: int) -> int:
        """
        –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ —Å–æ–∑–¥–∞–Ω–∏—è (unix timestamp) –ø–æ user_id

        –ò—Å–ø–æ–ª—å–∑—É–µ—Ç cubic spline –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—é (–µ—Å–ª–∏ scipy –¥–æ—Å—Ç—É–ø–µ–Ω) –∏–ª–∏ –ª–∏–Ω–µ–π–Ω—É—é –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—é

        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram

        Returns:
            Unix timestamp –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ–π –¥–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è
        """
        if not self.mapping:
            raise ValueError("–ú–∞–ø–ø–∏–Ω–≥ –ø—É—Å—Ç")

        # –ì—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏
        if user_id <= self.mapping[0][0]:
            return self.mapping[0][1]
        if user_id >= self.mapping[-1][0]:
            return self.mapping[-1][1]

        # –ò—Å–ø–æ–ª—å–∑—É–µ–º cubic spline –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
        if self.spline is not None:
            try:
                est_ts = float(self.spline(user_id))
                return int(est_ts)
            except Exception as e:
                logger.warning(f"–û—à–∏–±–∫–∞ cubic spline –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏: {e}. Fallback –Ω–∞ –ª–∏–Ω–µ–π–Ω—É—é.")

        # Fallback: –ª–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è
        ids = [p[0] for p in self.mapping]
        pos = bisect_left(ids, user_id)

        id_lo, ts_lo = self.mapping[pos-1]
        id_hi, ts_hi = self.mapping[pos]

        # –ï—Å–ª–∏ –ø–æ–ø–∞–ª–∏ —Ç–æ—á–Ω–æ –≤ –æ–±—Ä–∞–∑–µ—Ü
        if user_id == id_lo:
            return ts_lo
        if user_id == id_hi:
            return ts_hi

        # –õ–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è
        frac = (user_id - id_lo) / (id_hi - id_lo)
        est_ts = int(ts_lo + frac * (ts_hi - ts_lo))
        return est_ts
    
    def estimate_creation_datetime(self, user_id: int) -> datetime:
        """
        –û—Ü–µ–Ω–∫–∞ –¥–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–∞
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
            
        Returns:
            datetime –æ–±—ä–µ–∫—Ç –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ–π –¥–∞—Ç—ã —Å–æ–∑–¥–∞–Ω–∏—è
        """
        ts = self.estimate_creation_timestamp(user_id)
        return datetime.fromtimestamp(ts, tz=timezone.utc)
    
    def get_account_age_days(self, user_id: int) -> int:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ –¥–Ω—è—Ö

        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram

        Returns:
            –í–æ–∑—Ä–∞—Å—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ –¥–Ω—è—Ö
        """
        # –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–ê–Ø –ó–ê–©–ò–¢–ê: ID > 8 –º–∏–ª–ª–∏–∞—Ä–¥–æ–≤ = –û–ß–ï–ù–¨ –Ω–æ–≤—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã (–¥–µ–∫–∞–±—Ä—å 2024)
        # –°—á–∏—Ç–∞–µ–º –∏—Ö –º–æ–ª–æ–¥—ã–º–∏ –ù–ï–ó–ê–í–ò–°–ò–ú–û –æ—Ç –º–∞–ø–ø–∏–Ω–≥–∞ (—Ç.–∫. –º–∞–ø–ø–∏–Ω–≥ –º–æ–∂–µ—Ç –æ—Ç—Å—Ç–∞–≤–∞—Ç—å)
        if user_id >= 8_000_000_000:
            # –û—Ü–µ–Ω–∫–∞: –∫–∞–∂–¥—ã–µ 500M –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π = ~1 –¥–µ–Ω—å –≤ –ø–µ—Ä–∏–æ–¥ –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–æ—Å—Ç–∞
            # ID 8B = 2 –¥–µ–∫–∞–±—Ä—è, ID 8.5B = 3 –¥–µ–∫–∞–±—Ä—è, ID 9B = 4 –¥–µ–∫–∞–±—Ä—è –∏ —Ç.–¥.
            days_offset = (user_id - 8_000_000_000) / 500_000_000  # ~500M –≤ –¥–µ–Ω—å
            estimated_age_days = int(2 + days_offset)  # –ë–∞–∑–æ–≤—ã–π –≤–æ–∑—Ä–∞—Å—Ç 2 –¥–Ω—è + offset
            logger.info(
                f"üÜï User {user_id}: ID > 8B - –û–ß–ï–ù–¨ –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç! "
                f"–û—Ü–µ–Ω–æ—á–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç: {estimated_age_days} –¥–Ω–µ–π (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –º–∞–ø–ø–∏–Ω–≥–∞)"
            )
            return estimated_age_days

        creation_date = self.estimate_creation_datetime(user_id)
        now = datetime.now(timezone.utc)

        # –ó–ê–©–ò–¢–ê: –ï—Å–ª–∏ –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤ –±—É–¥—É—â–µ–º - –∑–Ω–∞—á–∏—Ç –æ—à–∏–±–∫–∞ –≤ –º–∞–ø–ø–∏–Ω–≥–µ
        # –î–ª—è ID < 8B —Å—á–∏—Ç–∞–µ–º —Å—Ç–∞—Ä—ã–º (—á—Ç–æ–±—ã –Ω–µ –º—É—Ç–∏—Ç—å –ø–æ –æ—à–∏–±–∫–µ)
        # –î–ª—è ID >= 8B —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ –≤—ã—à–µ
        if creation_date > now:
            logger.warning(
                f"‚ö†Ô∏è User {user_id}: –¥–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤ –ë–£–î–£–©–ï–ú ({creation_date.strftime('%Y-%m-%d')}), "
                f"–º–∞–ø–ø–∏–Ω–≥ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω! –°—á–∏—Ç–∞–µ–º –∞–∫–∫–∞—É–Ω—Ç –°–¢–ê–†–´–ú (–≤–æ–∑—Ä–∞—Å—Ç = 365 –¥–Ω–µ–π) –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏."
            )
            return 365

        age_delta = now - creation_date
        return age_delta.days

    def estimate_confidence_interval(self, user_id: int) -> Tuple[int, int]:
        """
        –û—Ü–µ–Ω–∏–≤–∞–µ—Ç –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª (¬±–¥–Ω–∏ –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç–∏) –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –≤–æ–∑—Ä–∞—Å—Ç–∞

        –ü–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç:
        1. –†–∞—Å—Å—Ç–æ—è–Ω–∏—è –¥–æ –±–ª–∏–∂–∞–π—à–∏—Ö –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã—Ö —Ç–æ—á–µ–∫
        2. –ü–ª–æ—Ç–Ω–æ—Å—Ç–∏ —Ç–æ—á–µ–∫ –≤ –¥–∞–Ω–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
        3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è spline vs –ª–∏–Ω–µ–π–Ω–æ–π –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏–∏

        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram

        Returns:
            Tuple[min_error_days, max_error_days] - –¥–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤ –¥–Ω—è—Ö
        """
        if not self.mapping:
            return (30, 30)  # –ë–æ–ª—å—à–∞—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö

        # –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–∏–µ –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏
        ids = [p[0] for p in self.mapping]
        pos = bisect_left(ids, user_id)

        # –ì—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏ - –±–æ–ª—å—à–∞—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å
        if pos == 0 or pos >= len(self.mapping):
            return (14, 14)  # ¬±14 –¥–Ω–µ–π –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö

        # –†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –±–ª–∏–∂–∞–π—à–∏—Ö —Ç–æ—á–µ–∫
        id_lo = self.mapping[pos-1][0]
        id_hi = self.mapping[pos][0]
        distance_to_nearest = min(abs(user_id - id_lo), abs(user_id - id_hi))
        range_width = id_hi - id_lo

        # –ë–∞–∑–æ–≤–∞—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —à–∏—Ä–∏–Ω—ã –¥–∏–∞–ø–∞–∑–æ–Ω–∞
        # –ß–µ–º —à–∏—Ä–µ –¥–∏–∞–ø–∞–∑–æ–Ω –º–µ–∂–¥—É —Ç–æ—á–∫–∞–º–∏ - —Ç–µ–º –±–æ–ª—å—à–µ –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å
        if range_width < 100_000_000:  # –ü–ª–æ—Ç–Ω—ã–µ —Ç–æ—á–∫–∏
            base_error = 2
        elif range_width < 500_000_000:  # –°—Ä–µ–¥–Ω—è—è –ø–ª–æ—Ç–Ω–æ—Å—Ç—å
            base_error = 5
        elif range_width < 1_000_000_000:  # –†–µ–¥–∫–∏–µ —Ç–æ—á–∫–∏
            base_error = 10
        else:  # –û—á–µ–Ω—å —Ä–µ–¥–∫–∏–µ —Ç–æ—á–∫–∏
            base_error = 15

        # –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º spline - –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å –º–µ–Ω—å—à–µ
        if self.spline is not None:
            base_error = int(base_error * 0.7)  # Spline –Ω–∞ 30% —Ç–æ—á–Ω–µ–µ

        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å –µ—Å–ª–∏ –¥–∞–ª–µ–∫–æ –æ—Ç –∫–∞–ª–∏–±—Ä–æ–≤–æ—á–Ω—ã—Ö —Ç–æ—á–µ–∫
        relative_distance = distance_to_nearest / range_width
        if relative_distance > 0.4:  # –î–∞–ª–µ–∫–æ –æ—Ç –æ–±–µ–∏—Ö —Ç–æ—á–µ–∫
            base_error = int(base_error * 1.5)

        return (base_error, base_error)
    
    def calculate_age_risk_score(self, user_id: int) -> Tuple[int, str, str]:
        """
        –í—ã—á–∏—Å–ª—è–µ—Ç —Ä–∏—Å–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–∑—Ä–∞—Å—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞
        
        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram
            
        Returns:
            Tuple[score, label, description]
            - score: 0-100 (–±–∞–ª–ª —Ä–∏—Å–∫–∞)
            - label: –∫–æ—Ä–æ—Ç–∫–∏–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä
            - description: –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
        """
        age_days = self.get_account_age_days(user_id)
        creation_date = self.estimate_creation_datetime(user_id)
        
        if age_days < 1:
            return 90, "very_new", f"–û—á–µ–Ω—å –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç ({age_days} –¥–Ω–µ–π)"
        elif age_days < 7:
            return 80, "new", f"–ù–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç ({age_days} –¥–Ω–µ–π)"
        elif age_days < 30:
            return 60, "young", f"–ú–æ–ª–æ–¥–æ–π –∞–∫–∫–∞—É–Ω—Ç ({age_days} –¥–Ω–µ–π)"
        elif age_days < 180:
            return 30, "mature", f"–ó—Ä–µ–ª—ã–π –∞–∫–∫–∞—É–Ω—Ç ({age_days} –¥–Ω–µ–π)"
        else:
            return 0, "old", f"–°—Ç–∞—Ä—ã–π –∞–∫–∫–∞—É–Ω—Ç ({age_days} –¥–Ω–µ–π)"
    
    def get_detailed_age_info(self, user_id: int) -> dict:
        """
        –ü–æ–ª—É—á–∞–µ—Ç –£–õ–£–ß–®–ï–ù–ù–£–Æ –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–æ–∑—Ä–∞—Å—Ç–µ –∞–∫–∫–∞—É–Ω—Ç–∞

        –í–∫–ª—é—á–∞–µ—Ç:
        - –û—Ü–µ–Ω–∫—É –≤–æ–∑—Ä–∞—Å—Ç–∞
        - –î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã (–ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å)
        - –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–ª–æ–≤ —Ä–∏—Å–∫–∞

        Args:
            user_id: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram

        Returns:
            –°–ª–æ–≤–∞—Ä—å —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
        """
        creation_date = self.estimate_creation_datetime(user_id)
        age_days = self.get_account_age_days(user_id)
        score, label, description = self.calculate_age_risk_score(user_id)

        # –î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª (–ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å)
        error_min, error_max = self.estimate_confidence_interval(user_id)

        # –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ —Å–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ: –µ—Å–ª–∏ –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å –±–æ–ª—å—à–∞—è –∏ –≤–æ–∑—Ä–∞—Å—Ç –±–ª–∏–∑–æ–∫ –∫ –ø–æ—Ä–æ–≥—É (30 –¥–Ω–µ–π),
        # —Ç–æ —Å–Ω–∏–∂–∞–µ–º —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å (–Ω–µ –º—É—Ç–∏–º –µ—Å–ª–∏ –Ω–µ—É–≤–µ—Ä–µ–Ω—ã)
        adjusted_risk_score = score
        confidence = "–≤—ã—Å–æ–∫–∞—è"

        if error_max >= 10:  # –ë–æ–ª—å—à–∞—è –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å (‚â•10 –¥–Ω–µ–π)
            confidence = "—Å—Ä–µ–¥–Ω—è—è"
            # –ï—Å–ª–∏ –≤–æ–∑—Ä–∞—Å—Ç 20-40 –¥–Ω–µ–π (–≤–±–ª–∏–∑–∏ –ø–æ—Ä–æ–≥–∞ 30) –∏ –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å –±–æ–ª—å—à–∞—è - —Å–Ω–∏–∂–∞–µ–º —Ä–∏—Å–∫
            if 20 <= age_days <= 40:
                adjusted_risk_score = int(score * 0.8)  # –°–Ω–∏–∂–∞–µ–º –Ω–∞ 20%
                confidence = "–Ω–∏–∑–∫–∞—è"

        return {
            "user_id": user_id,
            "estimated_creation_date": creation_date,
            "age_days": age_days,
            "risk_score": score,
            "adjusted_risk_score": adjusted_risk_score,  # –ù–û–í–û–ï: –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –±–∞–ª–ª
            "risk_label": label,
            "risk_description": description,
            "creation_date_str": creation_date.strftime('%Y-%m-%d %H:%M:%S UTC'),
            "age_str": f"{age_days} –¥–Ω–µ–π",
            "confidence_interval_days": f"¬±{error_max}",  # –ù–û–í–û–ï: –ø–æ–≥—Ä–µ—à–Ω–æ—Å—Ç—å
            "confidence_level": confidence,  # –ù–û–í–û–ï: —É—Ä–æ–≤–µ–Ω—å —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
            "interpolation_method": "cubic_spline" if self.spline else "linear"  # –ù–û–í–û–ï: –º–µ—Ç–æ–¥
        }

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª—è—Ö
account_age_estimator = AccountAgeEstimator()
