# üèóÔ∏è –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Multi-Tenant –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –¥–ª—è Telegram –±–æ—Ç–∞

## üìã –ü—Ä–æ–±–ª–µ–º—ã —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### 1. **–í—Å–µ –≥—Ä—É–ø–ø—ã –≤–∏–¥–Ω—ã –≥–ª–∞–≤–Ω–æ–º—É –∞–¥–º–∏–Ω—É**
- –°–µ–π—á–∞—Å –Ω–µ—Ç —Ä–∞–∑–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- –ì—Ä—É–ø–ø—ã –Ω–µ —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –ø–æ —Ä–µ–∞–ª—å–Ω—ã–º –ø—Ä–∞–≤–∞–º

### 2. **–ì—Ä—É–ø–ø—ã –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –±–æ—Ç–∞**
- –ù–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Å–æ–±—ã—Ç–∏—è `my_chat_member` –∫–æ–≥–¥–∞ –±–æ—Ç —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ –≥—Ä—É–ø–ø—ã
- –ì—Ä—É–ø–ø—ã –æ—Å—Ç–∞—é—Ç—Å—è –≤ –ë–î –¥–∞–∂–µ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –±–æ—Ç–∞

### 3. **–ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ —á–µ—Ä–µ–∑ Telegram API**
- –¢–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ —Ç–∞–±–ª–∏—Ü—É `UserGroup`
- –ù–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º –°–ï–ô–ß–ê–°

---

## üéØ –ö–∞–∫ –¥–µ–ª–∞–µ—Ç—Å—è –≤ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –±–æ—Ç–∞—Ö (Rose, ChatKeeper, GroupHelp)

### –ü—Ä–∏–Ω—Ü–∏–ø—ã:
1. **–ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –≥—Ä—É–ø–ø—ã** - –≥–¥–µ –æ–Ω —Ä–µ–∞–ª—å–Ω–æ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
2. **–ü—Ä–∞–≤–∞ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏** —á–µ—Ä–µ–∑ Telegram API
3. **–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –±–æ—Ç–∞** - –≥—Ä—É–ø–ø–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è/—É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ —Å–ø–∏—Å–∫–∞
4. **–ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –±–æ—Ç –µ—â–µ –≤ –≥—Ä—É–ø–ø–µ** –ø–µ—Ä–µ–¥ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–∫

---

## üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è: –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### –®–ê–ì 1: –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è –±–æ—Ç–∞ –∏–∑ –≥—Ä—É–ø–ø—ã

**–§–∞–π–ª**: `bot/handlers/bot_activity_handlers/group_events.py`

**–ö–æ–¥ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏ `bot_added_to_group`:**

```python
@group_events_router.my_chat_member(ChatMemberUpdatedFilter(member_status_changed=IS_MEMBER >> IS_NOT_MEMBER))
async def bot_removed_from_group(event: types.ChatMemberUpdated, session: AsyncSession):
    """
    –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è –±–æ—Ç–∞ –∏–∑ –≥—Ä—É–ø–ø—ã.
    –£–¥–∞–ª—è–µ—Ç –≥—Ä—É–ø–ø—É –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏–ª–∏ –ø–æ–º–µ—á–∞–µ—Ç –∫–∞–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω—É—é.
    """
    chat = event.chat
    user = event.from_user
    
    logger.info(f"üóëÔ∏è –ë–æ—Ç —É–¥–∞–ª–µ–Ω –∏–∑ –≥—Ä—É–ø–ø—ã {chat.title} (ID: {chat.id}) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {user.full_name}")
    
    try:
        # 1. –ù–∞—Ö–æ–¥–∏–º –≥—Ä—É–ø–ø—É –≤ –ë–î
        result = await session.execute(select(Group).where(Group.chat_id == chat.id))
        group = result.scalar_one_or_none()
        
        if not group:
            logger.warning(f"–ì—Ä—É–ø–ø–∞ {chat.id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –ë–î")
            return
        
        # 2. –£–î–ê–õ–Ø–ï–ú –≤—Å–µ —Å–≤—è–∑–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —ç—Ç–æ–π –≥—Ä—É–ø–ø–æ–π –∏–∑ UserGroup
        # –≠—Ç–æ –≤–∞–∂–Ω–æ: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–æ–ª—å—à–µ –Ω–µ –¥–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å —ç—Ç—É –≥—Ä—É–ø–ø—É
        await session.execute(
            delete(UserGroup).where(UserGroup.group_id == chat.id)
        )
        logger.info(f"–£–¥–∞–ª–µ–Ω—ã –≤—Å–µ —Å–≤—è–∑–∏ UserGroup –¥–ª—è –≥—Ä—É–ø–ø—ã {chat.id}")
        
        # 3. –£–î–ê–õ–Ø–ï–ú –≥—Ä—É–ø–ø—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã Group
        await session.delete(group)
        logger.info(f"–ì—Ä—É–ø–ø–∞ {chat.id} —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –ë–î")
        
        # 4. –û—á–∏—â–∞–µ–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Redis
        from bot.services.redis_conn import redis
        await redis.delete(f"visual_captcha_enabled:{chat.id}")
        await redis.delete(f"group:{chat.id}:mute_new_members")
        await redis.delete(f"group_link:private_{chat.id}")
        logger.info(f"–û—á–∏—â–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ Redis –¥–ª—è –≥—Ä—É–ø–ø—ã {chat.id}")
        
        await session.commit()
        logger.info(f"‚úÖ –ì—Ä—É–ø–ø–∞ {chat.title} –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω–∞ –∏–∑ —Å–∏—Å—Ç–µ–º—ã")
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≥—Ä—É–ø–ø—ã: {e}")
        await session.rollback()
```

**–í–ê–ñ–ù–û**: –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç:
```python
from sqlalchemy import delete
```

---

### –®–ê–ì 2: –£–ª—É—á—à–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é `get_admin_groups` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –ø—Ä–∞–≤

**–§–∞–π–ª**: `bot/services/groups_settings_in_private_logic.py`

**–ó–ê–ú–ï–ù–ò–¢–¨ —Ç–µ–∫—É—â—É—é —Ñ—É–Ω–∫—Ü–∏—é `get_admin_groups` –Ω–∞ —ç—Ç—É:**

```python
async def get_admin_groups(user_id: int, session: AsyncSession, bot: Bot = None) -> List[Group]:
    """
    –ü–æ–ª—É—á–∞–µ—Ç –≥—Ä—É–ø–ø—ã –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.
    –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø—Ä–∞–≤–∞ —á–µ—Ä–µ–∑ Telegram API –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏!
    """
    try:
        # 1. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –≥—Ä—É–ø–ø—ã –∏–∑ UserGroup
        user_groups_query = select(UserGroup).where(UserGroup.user_id == user_id)
        user_groups_result = await session.execute(user_groups_query)
        user_groups = user_groups_result.scalars().all()
        
        logger.info(f"–ù–∞–π–¥–µ–Ω–æ {len(user_groups)} –∑–∞–ø–∏—Å–µ–π UserGroup –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        
        if not user_groups:
            return []
        
        # 2. –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥—Ä—É–ø–ø–∞—Ö
        group_ids = [ug.group_id for ug in user_groups]
        groups_query = select(Group).where(Group.chat_id.in_(group_ids))
        groups_result = await session.execute(groups_query)
        groups = groups_result.scalars().all()
        
        if not bot:
            # –ï—Å–ª–∏ –±–æ—Ç –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å–µ –≥—Ä—É–ø–ø—ã (—Å—Ç–∞—Ä–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ)
            logger.warning("‚ö†Ô∏è –ë–æ—Ç –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –≤ get_admin_groups, –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤—Å–µ –≥—Ä—É–ø–ø—ã –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤")
            return list(groups)
        
        # 3. –ü–†–û–í–ï–†–Ø–ï–ú —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ —á–µ—Ä–µ–∑ Telegram API –∏ —á—Ç–æ –±–æ—Ç –µ—â–µ –≤ –≥—Ä—É–ø–ø–µ
        valid_groups = []
        
        for group in groups:
            try:
                # 3.1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –±–æ—Ç –µ—â–µ –≤ –≥—Ä—É–ø–ø–µ
                try:
                    member = await bot.get_chat_member(group.chat_id, bot.id)
                    if member.status not in ["member", "administrator", "creator"]:
                        # –ë–æ—Ç –Ω–µ –≤ –≥—Ä—É–ø–ø–µ - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                        logger.info(f"‚õî –ë–æ—Ç –Ω–µ –≤ –≥—Ä—É–ø–ø–µ {group.chat_id}, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º")
                        continue
                except Exception as e:
                    # –ë–æ—Ç –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é - –≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–µ–Ω –∏–∑ –≥—Ä—É–ø–ø—ã
                    logger.warning(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø–µ {group.chat_id}: {e}")
                    # –£–î–ê–õ–Ø–ï–ú –≥—Ä—É–ø–ø—É –∏–∑ UserGroup
                    await session.execute(
                        delete(UserGroup).where(
                            UserGroup.user_id == user_id,
                            UserGroup.group_id == group.chat_id
                        )
                    )
                    continue
                
                # 3.2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –°–ï–ô–ß–ê–° —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–æ–º
                try:
                    user_member = await bot.get_chat_member(group.chat_id, user_id)
                    if user_member.status not in ["administrator", "creator"]:
                        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–æ–ª—å—à–µ –Ω–µ –∞–¥–º–∏–Ω - —É–¥–∞–ª—è–µ–º –∏–∑ UserGroup
                        logger.info(f"‚õî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –±–æ–ª—å—à–µ –Ω–µ –∞–¥–º–∏–Ω –≤ –≥—Ä—É–ø–ø–µ {group.chat_id}")
                        await session.execute(
                            delete(UserGroup).where(
                                UserGroup.user_id == user_id,
                                UserGroup.group_id == group.chat_id
                            )
                        )
                        continue
                    
                    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω - –≥—Ä—É–ø–ø–∞ –≤–∞–ª–∏–¥–Ω–∞
                    valid_groups.append(group)
                    logger.info(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {user_id} –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∞ –≤ –≥—Ä—É–ø–ø–µ {group.title}")
                    
                except Exception as e:
                    logger.warning(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –ø—Ä–∞–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –≤ –≥—Ä—É–ø–ø–µ {group.chat_id}: {e}")
                    # –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≥—Ä—É–ø–ø—É
                    continue
                    
            except Exception as e:
                logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≥—Ä—É–ø–ø—ã {group.chat_id}: {e}")
                continue
        
        await session.commit()
        
        logger.info(f"–ù–∞–π–¥–µ–Ω–æ {len(valid_groups)} –≤–∞–ª–∏–¥–Ω—ã—Ö –≥—Ä—É–ø–ø –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}")
        return valid_groups
        
    except Exception as e:
        logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –≥—Ä—É–ø–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}: {e}")
        await session.rollback()
        return []
```

**–í–ê–ñ–ù–û**: –ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã:
```python
from typing import List
from sqlalchemy import delete
from aiogram import Bot
```

---

### –®–ê–ì 3: –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–∑–æ–≤—ã `get_admin_groups` - –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å `bot`

**–§–∞–π–ª**: `bot/handlers/group_settings_handler/groups_settings_in_private_handler.py`

**–ù–ê–ô–¢–ò –≤—Å–µ –º–µ—Å—Ç–∞ –≥–¥–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è:**
```python
user_groups = await get_admin_groups(user_id, session)
```

**–ó–ê–ú–ï–ù–ò–¢–¨ –Ω–∞:**
```python
user_groups = await get_admin_groups(user_id, session, bot=message.bot)  # –∏–ª–∏ callback.bot, –∏–ª–∏ event.bot
```

**–ü—Ä–∏–º–µ—Ä—ã –≤ —Ñ–∞–π–ª–µ:**
1. –í —Ñ—É–Ω–∫—Ü–∏–∏ `show_groups_list` (—Å—Ç—Ä–æ–∫–∞ ~45):
   ```python
   # –ë–´–õ–û:
   user_groups = await get_admin_groups(user_id, session)
   
   # –î–û–õ–ñ–ù–û –ë–´–¢–¨:
   user_groups = await get_admin_groups(user_id, session, bot=message.bot)
   ```

2. –í —Ñ—É–Ω–∫—Ü–∏–∏ `refresh_groups_list` (—Å—Ç—Ä–æ–∫–∞ ~377):
   ```python
   # –ë–´–õ–û:
   user_groups = await get_admin_groups(user_id, session)
   
   # –î–û–õ–ñ–ù–û –ë–´–¢–¨:
   user_groups = await get_admin_groups(user_id, session, bot=callback.bot)
   ```

---

### –®–ê–ì 4: –û–±–Ω–æ–≤–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –∞–¥–º–∏–Ω–æ–≤ - –æ–±–Ω–æ–≤–ª—è—Ç—å UserGroup –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏

**–§–∞–π–ª**: `bot/services/bot_added_handler_logic.py`

**–ù–ê–ô–¢–ò —Ñ—É–Ω–∫—Ü–∏—é `sync_group_and_admins`** –∏ —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –æ–Ω–∞:
1. –£–¥–∞–ª—è–µ—Ç –∞–¥–º–∏–Ω–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±–æ–ª—å—à–µ –Ω–µ –∞–¥–º–∏–Ω—ã
2. –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã—Ö –∞–¥–º–∏–Ω–æ–≤
3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø–µ

**–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É (–ø—Ä–∏–º–µ—Ä):**

```python
async def sync_group_and_admins(chat_id: int, title: str, bot_id: int, bot: Bot):
    """
    –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç —Å–ø–∏—Å–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –≥—Ä—É–ø–ø—ã.
    –£–î–ê–õ–Ø–ï–¢ –∞–¥–º–∏–Ω–æ–≤ –∫–æ—Ç–æ—Ä—ã–µ –±–æ–ª—å—à–µ –Ω–µ –∞–¥–º–∏–Ω—ã.
    –î–û–ë–ê–í–õ–Ø–ï–¢ –Ω–æ–≤—ã—Ö –∞–¥–º–∏–Ω–æ–≤.
    """
    async with AsyncSession(engine) as session:
        try:
            # 1. –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏—Ö –∞–¥–º–∏–Ω–æ–≤ –∏–∑ Telegram
            admins = await bot.get_chat_administrators(chat_id)
            admin_ids = {admin.user.id for admin in admins}
            
            # 2. –ü–æ–ª—É—á–∞–µ–º –∞–¥–º–∏–Ω–æ–≤ –∏–∑ –ë–î
            result = await session.execute(
                select(UserGroup).where(UserGroup.group_id == chat_id)
            )
            db_admin_relations = result.scalars().all()
            db_admin_ids = {rel.user_id for rel in db_admin_relations}
            
            # 3. –£–î–ê–õ–Ø–ï–ú –∞–¥–º–∏–Ω–æ–≤ –∫–æ—Ç–æ—Ä—ã–µ –±–æ–ª—å—à–µ –Ω–µ –∞–¥–º–∏–Ω—ã
            admins_to_remove = db_admin_ids - admin_ids
            if admins_to_remove:
                await session.execute(
                    delete(UserGroup).where(
                        UserGroup.group_id == chat_id,
                        UserGroup.user_id.in_(admins_to_remove)
                    )
                )
                logger.info(f"–£–¥–∞–ª–µ–Ω—ã {len(admins_to_remove)} –∞–¥–º–∏–Ω–æ–≤ –∏–∑ –≥—Ä—É–ø–ø—ã {chat_id}")
            
            # 4. –î–û–ë–ê–í–õ–Ø–ï–ú –Ω–æ–≤—ã—Ö –∞–¥–º–∏–Ω–æ–≤
            admins_to_add = admin_ids - db_admin_ids
            for admin_id in admins_to_add:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∑–∞–ø–∏—Å—å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                existing = await session.execute(
                    select(UserGroup).where(
                        UserGroup.group_id == chat_id,
                        UserGroup.user_id == admin_id
                    )
                )
                if not existing.scalar_one_or_none():
                    session.add(UserGroup(
                        user_id=admin_id,
                        group_id=chat_id
                    ))
                    logger.info(f"–î–æ–±–∞–≤–ª–µ–Ω –Ω–æ–≤—ã–π –∞–¥–º–∏–Ω {admin_id} –≤ –≥—Ä—É–ø–ø—É {chat_id}")
            
            await session.commit()
            logger.info(f"‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∞–¥–º–∏–Ω–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –¥–ª—è –≥—Ä—É–ø–ø—ã {chat_id}")
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–æ–≤: {e}")
            await session.rollback()
```

---

### –®–ê–ì 5: –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é –ø—Ä–æ–≤–µ—Ä–∫—É –≥—Ä—É–ø–ø

**–§–∞–π–ª**: –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π `bot/services/group_sync_service.py`

```python
"""
–°–µ—Ä–≤–∏—Å –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≥—Ä—É–ø–ø –∏ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤.
–ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∫ —Ñ–æ–Ω–æ–≤–∞—è –∑–∞–¥–∞—á–∞.
"""
import asyncio
import logging
from aiogram import Bot
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, delete
from bot.database.session import engine
from bot.database.models import Group, UserGroup

logger = logging.getLogger(__name__)


async def sync_all_groups_periodically(bot: Bot, interval_minutes: int = 60):
    """
    –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤—Å–µ –≥—Ä—É–ø–ø—ã –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∞.
    –£–¥–∞–ª—è–µ—Ç –≥—Ä—É–ø–ø—ã –≥–¥–µ –±–æ—Ç –±–æ–ª—å—à–µ –Ω–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç.
    """
    while True:
        try:
            await asyncio.sleep(interval_minutes * 60)  # –ò–Ω—Ç–µ—Ä–≤–∞–ª –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
            
            async with AsyncSession(engine) as session:
                # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –≥—Ä—É–ø–ø—ã
                result = await session.execute(select(Group))
                groups = result.scalars().all()
                
                logger.info(f"üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è {len(groups)} –≥—Ä—É–ø–ø...")
                
                for group in groups:
                    try:
                        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –±–æ—Ç –≤ –≥—Ä—É–ø–ø–µ
                        member = await bot.get_chat_member(group.chat_id, bot.id)
                        if member.status not in ["member", "administrator", "creator"]:
                            # –ë–æ—Ç —É–¥–∞–ª–µ–Ω - —É–¥–∞–ª—è–µ–º –≥—Ä—É–ø–ø—É
                            logger.info(f"üóëÔ∏è –ë–æ—Ç —É–¥–∞–ª–µ–Ω –∏–∑ –≥—Ä—É–ø–ø—ã {group.chat_id}, —É–¥–∞–ª—è–µ–º –≥—Ä—É–ø–ø—É")
                            await session.execute(
                                delete(UserGroup).where(UserGroup.group_id == group.chat_id)
                            )
                            await session.delete(group)
                            await session.commit()
                            continue
                        
                        # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∞–¥–º–∏–Ω–æ–≤
                        await sync_group_admins(session, group.chat_id, bot)
                        
                    except Exception as e:
                        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≥—Ä—É–ø–ø—ã {group.chat_id}: {e}")
                        continue
                
                logger.info("‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
                
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –≤ –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: {e}")


async def sync_group_admins(session: AsyncSession, chat_id: int, bot: Bot):
    """–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –∞–¥–º–∏–Ω–æ–≤ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø—ã"""
    try:
        admins = await bot.get_chat_administrators(chat_id)
        admin_ids = {admin.user.id for admin in admins}
        
        result = await session.execute(
            select(UserGroup).where(UserGroup.group_id == chat_id)
        )
        db_relations = result.scalars().all()
        db_admin_ids = {rel.user_id for rel in db_relations}
        
        # –£–¥–∞–ª—è–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö
        to_remove = db_admin_ids - admin_ids
        if to_remove:
            await session.execute(
                delete(UserGroup).where(
                    UserGroup.group_id == chat_id,
                    UserGroup.user_id.in_(to_remove)
                )
            )
        
        # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã—Ö
        to_add = admin_ids - db_admin_ids
        for admin_id in to_add:
            existing = await session.execute(
                select(UserGroup).where(
                    UserGroup.group_id == chat_id,
                    UserGroup.user_id == admin_id
                )
            )
            if not existing.scalar_one_or_none():
                session.add(UserGroup(user_id=admin_id, group_id=chat_id))
        
        await session.commit()
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∞–¥–º–∏–Ω–æ–≤ –≥—Ä—É–ø–ø—ã {chat_id}: {e}")
        await session.rollback()
```

**–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—É—Å–∫ –≤ `bot/bot.py`:**

```python
# –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è bot –∏ dp
async def main():
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
    
    if USE_WEBHOOK:
        # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
        from bot.services.group_sync_service import sync_all_groups_periodically
        asyncio.create_task(sync_all_groups_periodically(bot, interval_minutes=60))
        
        await run_webhook(bot=bot, dp=dp)
    else:
        # –î–ª—è polling —Ç–æ–∂–µ –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å
        from bot.services.group_sync_service import sync_all_groups_periodically
        asyncio.create_task(sync_all_groups_periodically(bot, interval_minutes=60))
        
        await dp.start_polling(bot)
```

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- [ ] **–®–ê–ì 1**: –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `bot_removed_from_group`
- [ ] **–®–ê–ì 2**: –û–±–Ω–æ–≤–∏—Ç—å `get_admin_groups` —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ø—Ä–∞–≤ —á–µ—Ä–µ–∑ API
- [ ] **–®–ê–ì 3**: –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –≤—ã–∑–æ–≤—ã `get_admin_groups` - –¥–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä `bot`
- [ ] **–®–ê–ì 4**: –£–ª—É—á—à–∏—Ç—å `sync_group_and_admins` - —É–¥–∞–ª—è—Ç—å —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –∞–¥–º–∏–Ω–æ–≤
- [ ] **–®–ê–ì 5**: –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

---

## üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ö–∞–∂–¥—ã–π –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –≥—Ä—É–ø–ø—ã
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A –¥–æ–±–∞–≤–ª—è–µ—Ç –±–æ—Ç–∞ –≤ —Å–≤–æ—é –≥—Ä—É–ø–ø—É
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B –¥–æ–±–∞–≤–ª—è–µ—Ç –±–æ—Ç–∞ –≤ —Å–≤–æ—é –≥—Ä—É–ø–ø—É
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ - –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ—é –≥—Ä—É–ø–ø—É ‚úÖ
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ - –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ—é –≥—Ä—É–ø–ø—É ‚úÖ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –£–¥–∞–ª–µ–Ω–∏–µ –±–æ—Ç–∞ —É–¥–∞–ª—è–µ—Ç –≥—Ä—É–ø–ø—É
1. –î–æ–±–∞–≤–∏—Ç—å –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É
2. –£–¥–∞–ª–∏—Ç—å –±–æ—Ç–∞ –∏–∑ –≥—Ä—É–ø–ø—ã
3. –û—Ç–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ - –≥—Ä—É–ø–ø–∞ –Ω–µ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ —Å–ø–∏—Å–∫–µ ‚úÖ

### –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∞
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω –≤ –≥—Ä—É–ø–ø–µ - –≤–∏–¥–∏—Ç –≥—Ä—É–ø–ø—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö
2. –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –∞–¥–º–∏–Ω–æ–≤
3. –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≥—Ä—É–ø–ø - –≥—Ä—É–ø–ø–∞ –¥–æ–ª–∂–Ω–∞ –∏—Å—á–µ–∑–Ω—É—Ç—å ‚úÖ

---

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ú–æ–∂–Ω–æ –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ –Ω–∞ 5-10 –º–∏–Ω—É—Ç –≤ Redis
2. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω—ã –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å—Å—è
3. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫**: –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —á–µ—Ä–µ–∑ API –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ try-except

---

## üéì –ü—Ä–∏–Ω—Ü–∏–ø—ã –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

1. **Multi-Tenant**: –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω, –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
2. **Real-time –ø—Ä–æ–≤–µ—Ä–∫–∞**: –ü—Ä–∞–≤–∞ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è —á–µ—Ä–µ–∑ Telegram API, –Ω–µ —Ç–æ–ª—å–∫–æ –∏–∑ –ë–î
3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞**: –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è
4. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**: –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

---

## üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. `bot/handlers/bot_activity_handlers/group_events.py` - –¥–æ–±–∞–≤–ª–µ–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è
2. `bot/services/groups_settings_in_private_logic.py` - –æ–±–Ω–æ–≤–ª–µ–Ω `get_admin_groups`
3. `bot/handlers/group_settings_handler/groups_settings_in_private_handler.py` - –æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤—ã–∑–æ–≤—ã
4. `bot/services/bot_added_handler_logic.py` - —É–ª—É—á—à–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
5. `bot/services/group_sync_service.py` - –Ω–æ–≤—ã–π —Ñ–∞–π–ª –¥–ª—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
6. `bot/bot.py` - –∑–∞–ø—É—Å–∫ —Ñ–æ–Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

---

**–ì–æ—Ç–æ–≤–æ! –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –ø–æ –ø–æ—Ä—è–¥–∫—É, —Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞.**

