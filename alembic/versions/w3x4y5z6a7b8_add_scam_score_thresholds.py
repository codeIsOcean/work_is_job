"""Добавляет таблицу порогов баллов для градации действий антискама

Revision ID: w3x4y5z6a7b8
Revises: cfb9bceb5c04
Create Date: 2025-12-23

Добавляет:
1. Таблица scam_score_thresholds - пороги баллов для разных действий
   Позволяет задавать разные действия для разных диапазонов баллов:
   - 100-299 баллов → delete
   - 300-399 баллов → mute 1 час
   - 400+ баллов → ban

   Если ни один порог не сработал - используется scam_action из ContentFilterSettings
"""
# Импортируем op для операций с БД (создание таблиц, колонок)
from alembic import op
# Импортируем sa для определения типов данных колонок
import sqlalchemy as sa


# ─────────────────────────────────────────────────────────
# МЕТАДАННЫЕ МИГРАЦИИ
# ─────────────────────────────────────────────────────────
# Уникальный идентификатор этой миграции
revision = 'w3x4y5z6a7b8'
# Предыдущая миграция от которой зависит эта
down_revision = 'cfb9bceb5c04'
# Метки веток (не используем)
branch_labels = None
# Зависимости от других миграций (не используем)
depends_on = None


def upgrade() -> None:
    """
    Применяет миграцию: создаёт таблицу порогов баллов.

    Эта функция вызывается при alembic upgrade head.
    """

    # ─────────────────────────────────────────────────────────
    # СОЗДАЁМ ТАБЛИЦУ ПОРОГОВ БАЛЛОВ СКАМА
    # ─────────────────────────────────────────────────────────
    # Эта таблица хранит пороги баллов для градации действий
    # Позволяет админам настраивать разные действия для разных скоров:
    # - Низкий скор (100-299) → delete (возможно ложное срабатывание)
    # - Средний скор (300-399) → mute (подозрительно)
    # - Высокий скор (400+) → ban (явный скам)
    op.create_table(
        # Имя таблицы в БД
        'scam_score_thresholds',

        # ─────────────────────────────────────────────────────
        # PRIMARY KEY: Автоинкрементный ID
        # ─────────────────────────────────────────────────────
        sa.Column('id', sa.Integer(), primary_key=True, autoincrement=True),

        # ─────────────────────────────────────────────────────
        # FOREIGN KEY: ID группы
        # ─────────────────────────────────────────────────────
        # Привязка порога к конкретной группе
        # ondelete=CASCADE - при удалении группы удаляются и пороги
        sa.Column('chat_id', sa.BigInteger(),
                  sa.ForeignKey('groups.chat_id', ondelete='CASCADE'),
                  nullable=False, index=True),

        # ─────────────────────────────────────────────────────
        # ДИАПАЗОН БАЛЛОВ
        # ─────────────────────────────────────────────────────
        # Минимальный порог баллов (включительно)
        # Пример: min_score=100 означает score >= 100
        sa.Column('min_score', sa.Integer(), nullable=False),

        # Максимальный порог баллов (включительно)
        # NULL = без верхнего ограничения (100+)
        # Пример: max_score=299 означает score <= 299
        sa.Column('max_score', sa.Integer(), nullable=True),

        # ─────────────────────────────────────────────────────
        # ДЕЙСТВИЕ ПРИ СРАБАТЫВАНИИ
        # ─────────────────────────────────────────────────────
        # Что делать если score попадает в этот диапазон
        # delete/mute/kick/ban
        sa.Column('action', sa.String(20), nullable=False, server_default='delete'),

        # Длительность мута в минутах (только для action='mute')
        # NULL = использовать default из ContentFilterSettings
        sa.Column('mute_duration', sa.Integer(), nullable=True),

        # ─────────────────────────────────────────────────────
        # АКТИВНОСТЬ И ПРИОРИТЕТ
        # ─────────────────────────────────────────────────────
        # True = порог активен, False = отключён
        sa.Column('enabled', sa.Boolean(), nullable=False, server_default='true'),

        # Приоритет проверки (меньше = раньше)
        sa.Column('priority', sa.Integer(), nullable=False, server_default='0'),

        # ─────────────────────────────────────────────────────
        # МЕТАДАННЫЕ
        # ─────────────────────────────────────────────────────
        # Описание порога для UI
        sa.Column('description', sa.String(200), nullable=True),

        # Когда порог был создан
        sa.Column('created_at', sa.DateTime(), server_default=sa.func.now()),

        # Когда порог был последний раз обновлён
        sa.Column('updated_at', sa.DateTime(), server_default=sa.func.now(),
                  onupdate=sa.func.now()),

        # ID админа который создал порог
        sa.Column('created_by', sa.BigInteger(), nullable=True),
    )

    # Создаём индекс для поиска активных порогов группы
    op.create_index(
        'ix_scam_thresholds_chat_enabled',  # Имя индекса
        'scam_score_thresholds',             # Таблица
        ['chat_id', 'enabled']               # Колонки
    )


def downgrade() -> None:
    """
    Откатывает миграцию: удаляет таблицу.

    Эта функция вызывается при alembic downgrade.
    """

    # ─────────────────────────────────────────────────────────
    # УДАЛЯЕМ ИНДЕКС
    # ─────────────────────────────────────────────────────────
    op.drop_index('ix_scam_thresholds_chat_enabled', table_name='scam_score_thresholds')

    # ─────────────────────────────────────────────────────────
    # УДАЛЯЕМ ТАБЛИЦУ
    # ─────────────────────────────────────────────────────────
    op.drop_table('scam_score_thresholds')
