"""Добавляет таблицу категорий сигналов скама и колонку flood_warn_text

Revision ID: l2m3n4o5p6q7
Revises: k1l2m3n4o5p6
Create Date: 2025-12-10

Добавляет:
1. Таблица scam_signal_categories - категории ключевых слов для детекции скама
   Позволяет админам создавать свои категории сигналов (наркотики, контакты и т.д.)
   вместо хардкода в коде

2. Колонка flood_warn_text в content_filter_settings - кастомный текст
   при предупреждении за флуд (аналогично flood_mute_text и flood_ban_text)
"""
# Импортируем op для операций с БД (создание таблиц, колонок)
from alembic import op
# Импортируем sa для определения типов данных колонок
import sqlalchemy as sa


# ─────────────────────────────────────────────────────────
# МЕТАДАННЫЕ МИГРАЦИИ
# ─────────────────────────────────────────────────────────
# Уникальный идентификатор этой миграции
revision = 'l2m3n4o5p6q7'
# Предыдущая миграция от которой зависит эта
down_revision = 'k1l2m3n4o5p6'
# Метки веток (не используем)
branch_labels = None
# Зависимости от других миграций (не используем)
depends_on = None


def upgrade() -> None:
    """
    Применяет миграцию: создаёт таблицу и добавляет колонку.

    Эта функция вызывается при alembic upgrade head.
    """

    # ─────────────────────────────────────────────────────────
    # 1. СОЗДАЁМ ТАБЛИЦУ КАТЕГОРИЙ СИГНАЛОВ СКАМА
    # ─────────────────────────────────────────────────────────
    # Эта таблица хранит категории ключевых слов для детекции скама
    # Каждая категория имеет:
    # - Название (например: "Наркотики", "Контакты")
    # - Список ключевых слов
    # - Вес (баллы при срабатывании)
    # - Флаг активности
    op.create_table(
        # Имя таблицы в БД
        'scam_signal_categories',

        # ─────────────────────────────────────────────────────
        # PRIMARY KEY: Автоинкрементный ID
        # ─────────────────────────────────────────────────────
        sa.Column('id', sa.Integer(), primary_key=True, autoincrement=True),

        # ─────────────────────────────────────────────────────
        # FOREIGN KEY: ID группы
        # ─────────────────────────────────────────────────────
        # Привязка категории к конкретной группе
        # ondelete=CASCADE - при удалении группы удаляются и категории
        sa.Column('chat_id', sa.BigInteger(),
                  sa.ForeignKey('groups.chat_id', ondelete='CASCADE'),
                  nullable=False, index=True),

        # ─────────────────────────────────────────────────────
        # НАЗВАНИЕ КАТЕГОРИИ
        # ─────────────────────────────────────────────────────
        # Отображаемое имя категории (например: "Наркотики", "Контакты")
        # Максимум 100 символов
        sa.Column('category_name', sa.String(100), nullable=False),

        # ─────────────────────────────────────────────────────
        # КЛЮЧЕВЫЕ СЛОВА
        # ─────────────────────────────────────────────────────
        # Список ключевых слов через запятую
        # Пример: "drugs,cocaine,weed,hashish"
        # Используем Text для неограниченной длины
        sa.Column('keywords', sa.Text(), nullable=False, server_default=''),

        # ─────────────────────────────────────────────────────
        # ВЕС КАТЕГОРИИ
        # ─────────────────────────────────────────────────────
        # Сколько баллов добавить к скору при срабатывании
        # Если в тексте найдено хотя бы одно слово из категории
        # По умолчанию 25 баллов
        sa.Column('weight', sa.Integer(), nullable=False, server_default='25'),

        # ─────────────────────────────────────────────────────
        # ФЛАГ АКТИВНОСТИ
        # ─────────────────────────────────────────────────────
        # True = категория активна и проверяется
        # False = категория временно отключена
        sa.Column('enabled', sa.Boolean(), nullable=False, server_default='true'),

        # ─────────────────────────────────────────────────────
        # ВРЕМЕННЫЕ МЕТКИ
        # ─────────────────────────────────────────────────────
        # Когда категория была создана
        sa.Column('created_at', sa.DateTime(), server_default=sa.func.now()),
        # Когда категория была последний раз обновлена
        sa.Column('updated_at', sa.DateTime(), server_default=sa.func.now(),
                  onupdate=sa.func.now()),

        # ─────────────────────────────────────────────────────
        # АУДИТ
        # ─────────────────────────────────────────────────────
        # ID админа который создал категорию
        sa.Column('created_by', sa.BigInteger(), nullable=True),
    )

    # ПРИМЕЧАНИЕ: Индекс на chat_id уже создаётся автоматически через index=True
    # в определении колонки выше, поэтому явный create_index не нужен

    # ─────────────────────────────────────────────────────────
    # 2. ДОБАВЛЯЕМ КОЛОНКУ flood_warn_text
    # ─────────────────────────────────────────────────────────
    # Кастомный текст уведомления при предупреждении за флуд
    # Поддерживает плейсхолдер %user% для имени нарушителя
    # NULL = использовать дефолтный текст
    op.add_column('content_filter_settings', sa.Column(
        'flood_warn_text',      # Имя колонки
        sa.String(500),         # Тип: строка до 500 символов
        nullable=True           # Может быть NULL (дефолтный текст)
    ))


def downgrade() -> None:
    """
    Откатывает миграцию: удаляет таблицу и колонку.

    Эта функция вызывается при alembic downgrade.
    """

    # ─────────────────────────────────────────────────────────
    # УДАЛЯЕМ КОЛОНКУ flood_warn_text
    # ─────────────────────────────────────────────────────────
    op.drop_column('content_filter_settings', 'flood_warn_text')

    # ─────────────────────────────────────────────────────────
    # УДАЛЯЕМ ТАБЛИЦУ КАТЕГОРИЙ
    # ─────────────────────────────────────────────────────────
    # Индекс удалится автоматически вместе с таблицей
    op.drop_table('scam_signal_categories')
