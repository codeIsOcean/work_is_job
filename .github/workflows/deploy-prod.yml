name: Deploy Production Bot

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'

jobs:
  deploy-prod:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.PROD_SERVER_HOST }}" >> ~/.ssh/known_hosts

      - name: Sync project to production server
        run: |
          rsync -az --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "__pycache__" \
            --exclude "*.pyc" \
            --exclude ".env*" \
            --exclude "docker-compose.prod.yml" \
            --exclude "docs" \
            --exclude "*.md" \
            --exclude ".gitignore" \
            --exclude ".DS_Store" \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }}:/opt/jobs_inDubai_prod/
          # –§–ò–ö–°: –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ nginx –∫–æ–Ω—Ñ–∏–≥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω
          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é nginx –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
          ssh -o StrictHostKeyChecking=no ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} "mkdir -p /opt/jobs_inDubai_prod/nginx" || true
          # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º nginx –∫–æ–Ω—Ñ–∏–≥
          rsync -az \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./nginx/nginx.prod.conf ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }}:/opt/jobs_inDubai_prod/nginx/nginx.prod.conf || true
          rm -f ~/.ssh/id_rsa

      - name: Deploy on production server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            set -e
            cd /opt/jobs_inDubai_prod

            if [ ! -f .env.prod ]; then
              echo ".env.prod is missing. Create it from env.prod.example before deploying."
              exit 1
            fi

            if docker compose version >/dev/null 2>&1; then
              COMPOSE="docker compose"
            else
              COMPOSE="docker-compose"
            fi

            # –§–ò–ö–°: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ nginx –∫–æ–Ω—Ñ–∏–≥–∞
            if [ ! -f nginx/nginx.prod.conf ]; then
              echo "WARNING: nginx/nginx.prod.conf is missing!"
              echo "Creating nginx directory if needed..."
              mkdir -p nginx
              echo "Attempting to create default nginx config..."
              # –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—ã–π nginx –∫–æ–Ω—Ñ–∏–≥, –µ—Å–ª–∏ —Ñ–∞–π–ª –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç
              cat > nginx/nginx.prod.conf << 'EOF'
events {
    worker_connections 1024;
}

http {
    upstream bot_backend {
        server bot_prod:8080;
    }

    server {
        listen 80;
        server_name _;

        location / {
            proxy_pass http://bot_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
EOF
              echo "Default nginx config created. Please update it if needed."
            fi
            
            # –ö–†–ò–¢–ò–ß–ù–û: –£–¥–∞–ª—è–µ–º –¢–û–õ–¨–ö–û prod –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –ù–ï —Ç—Ä–æ–≥–∞–µ–º april bot
            echo "üîÑ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ prod –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            
            # –§–ò–ö–°: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —á–µ—Ä–µ–∑ docker-compose
            $COMPOSE -f docker-compose.prod.yml down --remove-orphans || true
            
            # –§–ò–ö–°: –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–æ –∏–º–µ–Ω–∏ (—Ç–æ–ª—å–∫–æ prod, –Ω–µ —Ç—Ä–æ–≥–∞–µ–º april)
            echo "üóëÔ∏è –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã: postgres_prod, redis_prod, bot_prod, nginx_prod"
            for container in postgres_prod redis_prod bot_prod nginx_prod; do
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∏ —É–¥–∞–ª—è–µ–º –µ–≥–æ
              if docker ps -a --format '{{.Names}}' | grep -q "^${container}$"; then
                echo "  –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: $container"
                docker stop $container 2>/dev/null || true
                docker rm -f $container 2>/dev/null || true
              fi
            done
            
            # –§–ò–ö–°: –£–¥–∞–ª—è–µ–º —Å–µ—Ç—å, –µ—Å–ª–∏ –æ–Ω–∞ –æ—Å—Ç–∞–ª–∞—Å—å (—Ç–æ–ª—å–∫–æ prod —Å–µ—Ç—å)
            echo "üóëÔ∏è –£–¥–∞–ª—è–µ–º prod —Å–µ—Ç—å..."
            docker network rm jobs_indubai_prod_prod_network 2>/dev/null || true
            
            # –§–ò–ö–°: –£–¥–∞–ª—è–µ–º –≤—Å–µ "–º–µ—Ä—Ç–≤—ã–µ" –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–≤–∫–ª—é—á–∞—è —Ç–µ, —á—Ç–æ –æ—Å—Ç–∞–ª–∏—Å—å –ø–æ—Å–ª–µ –æ—à–∏–±–æ–∫)
            echo "üóëÔ∏è –£–¥–∞–ª—è–µ–º –≤—Å–µ –º–µ—Ä—Ç–≤—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            docker container prune -f || true
            
            # –§–ò–ö–°: –ñ–¥–µ–º –ø–æ–ª–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            echo "‚è≥ –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            sleep 5
            
            # –§–ò–ö–°: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ prod –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É–¥–∞–ª–µ–Ω—ã
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ prod –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —É–¥–∞–ª–µ–Ω—ã..."
            for container in postgres_prod redis_prod bot_prod nginx_prod; do
              if docker ps -a --format '{{.Names}}' | grep -q "^${container}$"; then
                echo "  ‚ö†Ô∏è –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä $container –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª—è–µ–º..."
                docker rm -f $container 2>/dev/null || true
              fi
            done
            
            # –§–ò–ö–°: –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –±—ã—Ç—å —Å–≤—è–∑–∞–Ω—ã —Å prod (—Ç–æ–ª—å–∫–æ –Ω–∞—à–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã)
            echo "üóëÔ∏è –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å prod..."
            for container_id in $(docker ps -a --filter "name=prod" --format "{{.ID}}" 2>/dev/null || true); do
              container_name=$(docker ps -a --filter "id=$container_id" --format "{{.Names}}" 2>/dev/null || true)
              # –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞—à–∏ prod –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã, –Ω–µ —Ç—Ä–æ–≥–∞–µ–º april bot
              if echo "$container_name" | grep -qE "^(postgres_prod|redis_prod|bot_prod|nginx_prod)$"; then
                echo "  –£–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: $container_name ($container_id)"
                docker rm -f $container_id 2>/dev/null || true
              fi
            done
            
            # –§–ò–ö–°: –ñ–¥–µ–º –µ—â–µ –Ω–µ–º–Ω–æ–≥–æ –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
            sleep 3
            echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–Ω–æ–≤–æ
            $COMPOSE -f docker-compose.prod.yml up -d --build
            
            # –§–ò–ö–°: –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            sleep 5
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            $COMPOSE -f docker-compose.prod.yml ps

