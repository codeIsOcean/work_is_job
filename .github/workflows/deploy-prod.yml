name: Deploy Production Bot

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'

jobs:
  deploy-prod:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.PROD_SERVER_HOST }}" >> ~/.ssh/known_hosts

      - name: Sync project to production server
        run: |
          rsync -az --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "__pycache__" \
            --exclude "*.pyc" \
            --exclude ".env*" \
            --exclude "docker-compose.prod.yml" \
            --exclude "docs" \
            --exclude "*.md" \
            --exclude ".gitignore" \
            --exclude ".DS_Store" \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }}:/opt/jobs_inDubai_prod/
          # Ð¤Ð˜ÐšÐ¡: Ð£Ð±ÐµÐ¶Ð´Ð°ÐµÐ¼ÑÑ, Ñ‡Ñ‚Ð¾ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½
          echo "ðŸ”§ Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ..."
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
          if [ ! -f ./nginx/nginx.prod.conf ]; then
            echo "âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» ./nginx/nginx.prod.conf Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚!"
            exit 1
          fi
          if [ -d ./nginx/nginx.prod.conf ]; then
            echo "âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ./nginx/nginx.prod.conf ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÐµÐ¹!"
            exit 1
          fi
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ nginx Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ, ÐµÑÐ»Ð¸ ÐµÑ‘ Ð½ÐµÑ‚
          ssh -o StrictHostKeyChecking=no ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} "mkdir -p /opt/jobs_inDubai_prod/nginx" || true
          # ÐšÐ Ð˜Ð¢Ð˜Ð§ÐÐž: ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑƒÐ´Ð°Ð»ÑÐµÐ¼ nginx.prod.conf Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ (Ð¸ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ, Ð¸ Ñ„Ð°Ð¹Ð»)
          echo "ðŸ—‘ï¸ Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ nginx.prod.conf Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} "
            rm -rf /opt/jobs_inDubai_prod/nginx/nginx.prod.conf 2>/dev/null || true
            # Ð£Ð±ÐµÐ¶Ð´Ð°ÐµÐ¼ÑÑ, Ñ‡Ñ‚Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¾
            if [ -e /opt/jobs_inDubai_prod/nginx/nginx.prod.conf ]; then
              echo 'âš ï¸ ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ: nginx.prod.conf Ð²ÑÐµ ÐµÑ‰Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚, Ð¿Ñ‹Ñ‚Ð°ÐµÐ¼ÑÑ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ ÐµÑ‰Ðµ Ñ€Ð°Ð·...'
              rm -rf /opt/jobs_inDubai_prod/nginx/nginx.prod.conf 2>/dev/null || true
            fi
          " || true
          # Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ (Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ --delete Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð»Ð¸ÑˆÐ½Ð¸Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²)
          echo "ðŸ“¤ Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³..."
          rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./nginx/nginx.prod.conf ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }}:/opt/jobs_inDubai_prod/nginx/nginx.prod.conf
          # ÐšÐ Ð˜Ð¢Ð˜Ð§ÐÐž: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ (Ð‘Ð•Ð— || true, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÐºÑ€Ð¸Ð¿Ñ‚ ÑƒÐ¿Ð°Ð» Ð¿Ñ€Ð¸ Ð¾ÑˆÐ¸Ð±ÐºÐµ)
          echo "âœ… ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ Ð¿Ð¾ÑÐ»Ðµ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸..."
          ssh -o StrictHostKeyChecking=no ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }} "
            if [ -d /opt/jobs_inDubai_prod/nginx/nginx.prod.conf ]; then
              echo 'âŒ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐÐ¯ ÐžÐ¨Ð˜Ð‘ÐšÐ: nginx.prod.conf ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÐµÐ¹!'
              echo 'Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¸ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð» Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ...'
              rm -rf /opt/jobs_inDubai_prod/nginx/nginx.prod.conf
              # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³
              cat > /opt/jobs_inDubai_prod/nginx/nginx.prod.conf << 'NGINXEOF'
events {
    worker_connections 1024;
}

http {
    upstream bot_backend {
        server bot_prod:8080;
    }

    server {
        listen 80;
        server_name _;

        location / {
            proxy_pass http://bot_backend;
            proxy_set_header Host \$host;
            proxy_set_header X-Real-IP \$remote_addr;
            proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto \$scheme;
        }
    }
}
NGINXEOF
            fi
            if [ ! -f /opt/jobs_inDubai_prod/nginx/nginx.prod.conf ]; then
              echo 'âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: nginx.prod.conf Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð½ ÐºÐ°Ðº Ñ„Ð°Ð¹Ð»!'
              exit 1
            fi
            echo 'âœ… nginx.prod.conf ÑÐ¾Ð·Ð´Ð°Ð½ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð¾ ÐºÐ°Ðº Ñ„Ð°Ð¹Ð»'
            ls -la /opt/jobs_inDubai_prod/nginx/nginx.prod.conf
          "
          rm -f ~/.ssh/id_rsa

      - name: Deploy on production server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            set -e
            cd /opt/jobs_inDubai_prod

            if [ ! -f .env.prod ]; then
              echo ".env.prod is missing. Create it from env.prod.example before deploying."
              exit 1
            fi

            if docker compose version >/dev/null 2>&1; then
              COMPOSE="docker compose"
            else
              COMPOSE="docker-compose"
            fi

            # ÐšÐ Ð˜Ð¢Ð˜Ð§ÐÐž: ÐŸÐ Ð˜ÐÐ£Ð”Ð˜Ð¢Ð•Ð›Ð¬ÐÐž Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ nginx.prod.conf ÐŸÐ•Ð Ð•Ð” Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼ docker compose
            echo "ðŸ”§ ÐšÐ Ð˜Ð¢Ð˜Ð§ÐÐž: Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ nginx.prod.conf Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ..."
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ nginx, ÐµÑÐ»Ð¸ ÐµÑ‘ Ð½ÐµÑ‚
            mkdir -p nginx
            
            # ÐŸÐ Ð˜ÐÐ£Ð”Ð˜Ð¢Ð•Ð›Ð¬ÐÐž ÑƒÐ´Ð°Ð»ÑÐµÐ¼ nginx.prod.conf (Ð¸ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ, Ð¸ Ñ„Ð°Ð¹Ð»)
            echo "ðŸ—‘ï¸ Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ nginx.prod.conf (Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¸Ð»Ð¸ Ñ„Ð°Ð¹Ð»)..."
            rm -rf nginx/nginx.prod.conf 2>/dev/null || true
            sleep 1  # Ð”Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼Ñ Ð½Ð° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¾
            if [ -e nginx/nginx.prod.conf ]; then
              echo "âš ï¸ nginx.prod.conf Ð²ÑÐµ ÐµÑ‰Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚, Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑƒÐ´Ð°Ð»ÑÐµÐ¼..."
              rm -rf nginx/nginx.prod.conf 2>/dev/null || true
              sleep 1
            fi
            
            # Ð•ÑÐ»Ð¸ Ñ„Ð°Ð¹Ð» Ð²ÑÐµ ÐµÑ‰Ðµ Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³
            if [ ! -f nginx/nginx.prod.conf ]; then
              echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ nginx.prod.conf..."
              cat > nginx/nginx.prod.conf << 'NGINXCONF'
events {
    worker_connections 1024;
}

http {
    upstream bot_backend {
        server bot_prod:8080;
    }

    server {
        listen 80;
        server_name _;

        location / {
            proxy_pass http://bot_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
NGINXCONF
            fi
            
            # Ð¤Ð˜ÐÐÐ›Ð¬ÐÐÐ¯ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°: ÑƒÐ±ÐµÐ¶Ð´Ð°ÐµÐ¼ÑÑ, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾ Ñ„Ð°Ð¹Ð», Ð° Ð½Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ
            if [ -d nginx/nginx.prod.conf ]; then
              echo "âŒ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐÐ¯ ÐžÐ¨Ð˜Ð‘ÐšÐ: nginx.prod.conf Ð²ÑÐµ ÐµÑ‰Ðµ ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÐµÐ¹!"
              echo "Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¸ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð»..."
              rm -rf nginx/nginx.prod.conf
              cat > nginx/nginx.prod.conf << 'NGINXCONF2'
events {
    worker_connections 1024;
}

http {
    upstream bot_backend {
        server bot_prod:8080;
    }

    server {
        listen 80;
        server_name _;

        location / {
            proxy_pass http://bot_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
NGINXCONF2
            fi
            
            if [ ! -f nginx/nginx.prod.conf ]; then
              echo "âŒ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐÐ¯ ÐžÐ¨Ð˜Ð‘ÐšÐ: ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ nginx.prod.conf ÐºÐ°Ðº Ñ„Ð°Ð¹Ð»!"
              exit 1
            fi
            
            # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ñ„Ð°Ð¹Ð»Ðµ
            echo "âœ… nginx.prod.conf Ð³Ð¾Ñ‚Ð¾Ð²:"
            ls -la nginx/nginx.prod.conf
            file nginx/nginx.prod.conf
            echo ""

            # ÐšÐ Ð˜Ð¢Ð˜Ð§ÐÐž: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ ÐŸÐ•Ð Ð•Ð” Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼ docker compose
            echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼..."
            
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ nginx, ÐµÑÐ»Ð¸ ÐµÑ‘ Ð½ÐµÑ‚
            mkdir -p nginx
            
            # ÐšÐ Ð˜Ð¢Ð˜Ð§ÐÐž: Ð•ÑÐ»Ð¸ nginx/nginx.prod.conf ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ ÐºÐ°Ðº Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ - ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÐµÑ‘
            if [ -d nginx/nginx.prod.conf ]; then
              echo "âš ï¸ nginx/nginx.prod.conf ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ ÐºÐ°Ðº Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ, ÑƒÐ´Ð°Ð»ÑÐµÐ¼..."
              rm -rf nginx/nginx.prod.conf
            fi
            
            # ÐšÐ Ð˜Ð¢Ð˜Ð§ÐÐž: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ nginx.prod.conf - ÑÑ‚Ð¾ Ñ„Ð°Ð¹Ð», Ð° Ð½Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ñ
            if [ -d nginx/nginx.prod.conf ]; then
              echo "âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: nginx/nginx.prod.conf Ð²ÑÐµ ÐµÑ‰Ðµ ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÐµÐ¹ Ð¿Ð¾ÑÐ»Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ!"
              exit 1
            fi
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð°
            if [ ! -f nginx/nginx.prod.conf ]; then
              echo "WARNING: nginx/nginx.prod.conf is missing!"
              echo "Creating default nginx config..."
              # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ð¹ nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³, ÐµÑÐ»Ð¸ Ñ„Ð°Ð¹Ð» Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚
              cat > nginx/nginx.prod.conf << 'EOF'
events {
    worker_connections 1024;
}

http {
    upstream bot_backend {
        server bot_prod:8080;
    }

    server {
        listen 80;
        server_name _;

        location / {
            proxy_pass http://bot_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
EOF
              echo "Default nginx config created. Please update it if needed."
            fi
            
            # ÐšÐ Ð˜Ð¢Ð˜Ð§ÐÐž: Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¢ÐžÐ›Ð¬ÐšÐž prod ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹, ÐÐ• Ñ‚Ñ€Ð¾Ð³Ð°ÐµÐ¼ april bot
            echo "ðŸ”„ ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¸ ÑƒÐ´Ð°Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ prod ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹..."
            
            # ÐšÐ Ð˜Ð¢Ð˜Ð§ÐÐž: Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð¿Ð¾ Ð¸Ð¼ÐµÐ½Ð¸ ÐŸÐ•Ð Ð•Ð” docker compose down
            echo "ðŸ—‘ï¸ ÐŸÐ Ð˜ÐÐ£Ð”Ð˜Ð¢Ð•Ð›Ð¬ÐÐž ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ ÐŸÐ•Ð Ð•Ð” docker compose down..."
            for container in postgres_prod redis_prod bot_prod nginx_prod; do
              echo "  Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€: $container"
              docker stop $container 2>/dev/null || true
              docker rm -f $container 2>/dev/null || true
            done
            sleep 2  # Ð”Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼Ñ Docker Ð¾ÑÐ²Ð¾Ð±Ð¾Ð´Ð¸Ñ‚ÑŒ Ð¸Ð¼ÐµÐ½Ð°
            
            # Ð¤Ð˜ÐšÐ¡: ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¾ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¸ ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ñ‡ÐµÑ€ÐµÐ· docker-compose
            $COMPOSE -f docker-compose.prod.yml down --remove-orphans || true
            sleep 2  # Ð”Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼Ñ Ð½Ð° Ð¿Ð¾Ð»Ð½Ð¾Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ
            
            # Ð¤Ð˜ÐšÐ¡: ÐŸÐ Ð˜ÐÐ£Ð”Ð˜Ð¢Ð•Ð›Ð¬ÐÐž ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð¿Ð¾ Ð¸Ð¼ÐµÐ½Ð¸ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ prod, Ð½Ðµ Ñ‚Ñ€Ð¾Ð³Ð°ÐµÐ¼ april)
            echo "ðŸ—‘ï¸ ÐŸÐ Ð˜ÐÐ£Ð”Ð˜Ð¢Ð•Ð›Ð¬ÐÐž ÑƒÐ´Ð°Ð»ÑÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹: postgres_prod, redis_prod, bot_prod, nginx_prod"
            for container in postgres_prod redis_prod bot_prod nginx_prod; do
              # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð‘Ð•Ð— Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ - ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚, ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¿Ñ€Ð¾Ð¸Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÑ‚ÑÑ
              echo "  Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€: $container (Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾)"
              docker stop $container 2>/dev/null || true
              docker rm -f $container 2>/dev/null || true
              # Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾ ID, ÐµÑÐ»Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð²ÑÐµ ÐµÑ‰Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
              container_id=$(docker ps -a --filter "name=^${container}$" --format "{{.ID}}" 2>/dev/null | head -n1)
              if [ -n "$container_id" ]; then
                echo "  ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ $container Ð½Ð°Ð¹Ð´ÐµÐ½ Ð¿Ð¾ ID: $container_id, ÑƒÐ´Ð°Ð»ÑÐµÐ¼..."
                docker rm -f $container_id 2>/dev/null || true
              fi
            done
            
            # Ð¤Ð˜ÐšÐ¡: Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÐµÑ‚ÑŒ, ÐµÑÐ»Ð¸ Ð¾Ð½Ð° Ð¾ÑÑ‚Ð°Ð»Ð°ÑÑŒ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ prod ÑÐµÑ‚ÑŒ)
            echo "ðŸ—‘ï¸ Ð£Ð´Ð°Ð»ÑÐµÐ¼ prod ÑÐµÑ‚ÑŒ..."
            docker network rm jobs_indubai_prod_prod_network 2>/dev/null || true
            
            # Ð¤Ð˜ÐšÐ¡: Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²ÑÐµ "Ð¼ÐµÑ€Ñ‚Ð²Ñ‹Ðµ" ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ (Ð²ÐºÐ»ÑŽÑ‡Ð°Ñ Ñ‚Ðµ, Ñ‡Ñ‚Ð¾ Ð¾ÑÑ‚Ð°Ð»Ð¸ÑÑŒ Ð¿Ð¾ÑÐ»Ðµ Ð¾ÑˆÐ¸Ð±Ð¾Ðº)
            echo "ðŸ—‘ï¸ Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²ÑÐµ Ð¼ÐµÑ€Ñ‚Ð²Ñ‹Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹..."
            docker container prune -f || true
            
            # Ð¤Ð˜ÐšÐ¡: Ð–Ð´ÐµÐ¼ Ð¿Ð¾Ð»Ð½Ð¾Ð³Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
            echo "â³ Ð–Ð´ÐµÐ¼ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
            sleep 5
            
            # Ð¤Ð˜ÐšÐ¡: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð²ÑÐµ prod ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹
            echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð²ÑÐµ prod ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ ÑƒÐ´Ð°Ð»ÐµÐ½Ñ‹..."
            for container in postgres_prod redis_prod bot_prod nginx_prod; do
              if docker ps -a --format '{{.Names}}' | grep -q "^${container}$"; then
                echo "  âš ï¸ ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ $container Ð²ÑÐµ ÐµÑ‰Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚, Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑƒÐ´Ð°Ð»ÑÐµÐ¼..."
                docker rm -f $container 2>/dev/null || true
              fi
            done
            
            # Ð¤Ð˜ÐšÐ¡: Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²ÑÐµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð¼Ð¾Ð³ÑƒÑ‚ Ð±Ñ‹Ñ‚ÑŒ ÑÐ²ÑÐ·Ð°Ð½Ñ‹ Ñ prod (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð°ÑˆÐ¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹)
            echo "ðŸ—‘ï¸ Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²ÑÐµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹, ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ Ñ prod..."
            for container_id in $(docker ps -a --filter "name=prod" --format "{{.ID}}" 2>/dev/null || true); do
              container_name=$(docker ps -a --filter "id=$container_id" --format "{{.Names}}" 2>/dev/null || true)
              # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð°ÑˆÐ¸ prod ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹, Ð½Ðµ Ñ‚Ñ€Ð¾Ð³Ð°ÐµÐ¼ april bot
              if echo "$container_name" | grep -qE "^(postgres_prod|redis_prod|bot_prod|nginx_prod)$"; then
                echo "  Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€: $container_name ($container_id)"
                docker rm -f $container_id 2>/dev/null || true
              fi
            done
            
            # Ð¤Ð˜ÐšÐ¡: Ð–Ð´ÐµÐ¼ ÐµÑ‰Ðµ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼
            sleep 3
            
            # Ð¤Ð˜ÐšÐ¡: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ volumes, ÐµÑÐ»Ð¸ Ð¸Ñ… Ð½ÐµÑ‚
            echo "ðŸ“¦ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ volumes..."
            docker volume ls | grep -q "jobs_indubai_prod_postgres_prod_data" || docker volume create jobs_indubai_prod_postgres_prod_data || true
            docker volume ls | grep -q "jobs_indubai_prod_redis_prod_data" || docker volume create jobs_indubai_prod_redis_prod_data || true
            echo "âœ… Volumes Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹"
            
            echo "âœ… ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°, Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹..."
            
            # ÐšÐ Ð˜Ð¢Ð˜Ð§ÐÐž: Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð° Ð¿ÐµÑ€ÐµÐ´ Ð·Ð°Ð¿ÑƒÑÐºÐ¾Ð¼
            echo "ðŸ” Ð¤Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð°..."
            if [ -d nginx/nginx.prod.conf ]; then
              echo "âŒ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐÐ¯ ÐžÐ¨Ð˜Ð‘ÐšÐ: nginx/nginx.prod.conf ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÐµÐ¹! Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¸ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ñ„Ð°Ð¹Ð»..."
              rm -rf nginx/nginx.prod.conf
              # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³
              cat > nginx/nginx.prod.conf << 'EOF'
events {
    worker_connections 1024;
}

http {
    upstream bot_backend {
        server bot_prod:8080;
    }

    server {
        listen 80;
        server_name _;

        location / {
            proxy_pass http://bot_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}
EOF
            fi
            if [ ! -f nginx/nginx.prod.conf ]; then
              echo "âŒ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐÐ¯ ÐžÐ¨Ð˜Ð‘ÐšÐ: nginx/nginx.prod.conf Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ ÐºÐ°Ðº Ñ„Ð°Ð¹Ð»!"
              exit 1
            fi
            echo "âœ… nginx ÐºÐ¾Ð½Ñ„Ð¸Ð³ Ð³Ð¾Ñ‚Ð¾Ð²"
            
            # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð·Ð°Ð½Ð¾Ð²Ð¾
            echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹..."
            $COMPOSE -f docker-compose.prod.yml up -d --build
            
            # Ð¤Ð˜ÐšÐ¡: Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
            echo "â³ Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð² (10 ÑÐµÐºÑƒÐ½Ð´)..."
            sleep 10
            
            # Ð¤Ð˜ÐšÐ¡: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¾Ð³Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð², ÐµÑÐ»Ð¸ Ð¾Ð½Ð¸ Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð»Ð¸ÑÑŒ
            echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²..."
            for container in postgres_prod redis_prod; do
              status=$(docker ps -a --filter "name=$container" --format "{{.Status}}" 2>/dev/null || echo "not found")
              echo "  ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ $container: $status"
              if echo "$status" | grep -q "Exited"; then
                echo "  âš ï¸ ÐšÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ $container Ð·Ð°Ð²ÐµÑ€ÑˆÐ¸Ð»ÑÑ! Ð›Ð¾Ð³Ð¸:"
                docker logs --tail 50 $container 2>&1 || true
              fi
            done
            
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ
            echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð²ÑÐµÑ… ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²:"
            $COMPOSE -f docker-compose.prod.yml ps
            
            # Ð¤Ð˜ÐšÐ¡: ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÑŽÑ‚
            echo "ðŸ” Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²:"
            docker ps --filter "name=prod" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" || true
            
            # Ð¤Ð˜ÐšÐ¡: Ð•ÑÐ»Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹ Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ñ‹, Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¾ÑˆÐ¸Ð±ÐºÐ¸
            if ! docker ps --filter "name=postgres_prod" --format "{{.Names}}" | grep -q "postgres_prod"; then
              echo "âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: postgres_prod Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!"
              docker logs postgres_prod --tail 100 2>&1 || true
              exit 1
            fi
            
            if ! docker ps --filter "name=redis_prod" --format "{{.Names}}" | grep -q "redis_prod"; then
              echo "âŒ ÐžÐ¨Ð˜Ð‘ÐšÐ: redis_prod Ð½Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!"
              docker logs redis_prod --tail 100 2>&1 || true
              exit 1
            fi

