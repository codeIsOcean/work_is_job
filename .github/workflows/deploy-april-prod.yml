name: Deploy to PRODUCTION (April Bot)

# ============================================================
# –†–£–ß–ù–û–ô –î–ï–ü–õ–û–ô –ù–ê –ü–†–û–î–ê–ö–®–ù (april_test_bot)
# ============================================================
# –≠—Ç–æ—Ç workflow –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ GitHub UI
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: GitHub ‚Üí Actions ‚Üí Deploy to PRODUCTION ‚Üí Run workflow
# ============================================================

on:
  workflow_dispatch:
    inputs:
      sync_users:
        description: '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –±–æ—Ç–∞'
        required: true
        default: true
        type: boolean
      confirm_deploy:
        description: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é –¥–µ–ø–ª–æ–π –Ω–∞ –ü–†–û–î–ê–ö–®–ù'
        required: true
        default: false
        type: boolean

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    # –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    if: ${{ github.event.inputs.confirm_deploy == 'true' }}
    environment: april-production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check deployment time (warning)
        run: |
          HOUR=$(date -u +%H)
          # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –µ—Å–ª–∏ –¥–µ–ø–ª–æ–π –Ω–µ –Ω–æ—á—å—é (UTC 22:00-05:00 = Dubai 02:00-09:00)
          if [ "$HOUR" -gt 5 ] && [ "$HOUR" -lt 22 ]; then
            echo "::warning::–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–µ–ø–ª–æ–∏—Ç—å –Ω–æ—á—å—é (02:00-09:00 –ø–æ Dubai) –¥–ª—è –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ downtime"
          fi

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.PROD_SERVER_HOST }}" >> ~/.ssh/known_hosts

      - name: Sync project to april_test_bot
        run: |
          rsync -az --delete \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "__pycache__" \
            --exclude "*.pyc" \
            --exclude ".env*" \
            --exclude "docker-compose.yml" \
            --exclude "docker-compose.prod.yml" \
            --exclude "docker-compose.test.yml" \
            --exclude "docs" \
            --exclude "*.md" \
            --exclude ".gitignore" \
            --exclude ".DS_Store" \
            --exclude "tests" \
            --exclude "scripts" \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }}:/root/testBotApril/
          rm -f ~/.ssh/id_rsa

      - name: Deploy april_test_bot (PRODUCTION)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            set -e
            cd /root/testBotApril

            echo "=============================================="
            echo "  –î–ï–ü–õ–û–ô –ù–ê –ü–†–û–î–ê–ö–®–ù (april_test_bot)"
            echo "=============================================="

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ .env —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if [ ! -f .env ]; then
              echo "ERROR: .env is missing!"
              exit 1
            fi

            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º docker compose –∫–æ–º–∞–Ω–¥—É
            if docker compose version >/dev/null 2>&1; then
              COMPOSE="docker compose"
            else
              COMPOSE="docker-compose"
            fi

            # –°–æ–∑–¥–∞—ë–º –±—ç–∫–∞–ø –ë–î –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º
            echo "üì¶ –°–æ–∑–¥–∞—ë–º –±—ç–∫–∞–ø –ë–î..."
            mkdir -p /root/backups
            docker exec april_test_db pg_dump -U april_test_bot -d april_test_db > /root/backups/april_pre_deploy_$(date +%Y%m%d_%H%M%S).sql || echo "Warning: backup failed"

            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            $COMPOSE down --remove-orphans || true

            # –°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º
            echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã..."
            $COMPOSE up -d --build

            # –ñ–¥—ë–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
            echo "‚è≥ –ñ–¥—ë–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –ë–î..."
            sleep 10

            # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏
            echo "üìä –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∏–≥—Ä–∞—Ü–∏–∏..."
            docker exec april_test_bot alembic upgrade head || echo "Warning: migrations may have failed"

            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
            echo ""
            echo "=============================================="
            echo "  –°–¢–ê–¢–£–° –ö–û–ù–¢–ï–ô–ù–ï–†–û–í"
            echo "=============================================="
            $COMPOSE ps
            docker ps --filter "name=april" --format "table {{.Names}}\t{{.Status}}"

      - name: Sync users (if enabled)
        if: ${{ github.event.inputs.sync_users == 'true' }}
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            echo "=============================================="
            echo "  –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô prod ‚Üí april"
            echo "=============================================="

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—â–µ–Ω—ã
            if ! docker ps | grep -q postgres_prod; then
              echo "‚ö†Ô∏è postgres_prod –Ω–µ –∑–∞–ø—É—â–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é"
              exit 0
            fi

            if ! docker ps | grep -q april_test_db; then
              echo "‚ùå april_test_db –Ω–µ –∑–∞–ø—É—â–µ–Ω!"
              exit 1
            fi

            # –°—á–∏—Ç–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –î–û
            USERS_BEFORE=$(docker exec april_test_db psql -U april_test_bot -d april_test_db -t -c "SELECT COUNT(*) FROM users;" | tr -d ' ')
            echo "üìä –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ april –î–û: $USERS_BEFORE"

            # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º
            docker exec postgres_prod psql -U postgres -d bot_prod -t -A -c "
            SELECT 'INSERT INTO users (user_id, username, full_name, first_name, last_name, language_code, is_bot, is_premium, added_to_attachment_menu, can_join_groups, can_read_all_group_messages, supports_inline_queries, can_connect_to_business, has_main_web_app, created_at, updated_at) VALUES ('
                || user_id || ', '
                || COALESCE('''' || REPLACE(username, '''', '''''') || '''', 'NULL') || ', '
                || COALESCE('''' || REPLACE(full_name, '''', '''''') || '''', 'NULL') || ', '
                || COALESCE('''' || REPLACE(first_name, '''', '''''') || '''', 'NULL') || ', '
                || COALESCE('''' || REPLACE(last_name, '''', '''''') || '''', 'NULL') || ', '
                || COALESCE('''' || language_code || '''', 'NULL') || ', '
                || is_bot || ', '
                || is_premium || ', '
                || added_to_attachment_menu || ', '
                || can_join_groups || ', '
                || can_read_all_group_messages || ', '
                || supports_inline_queries || ', '
                || can_connect_to_business || ', '
                || has_main_web_app || ', '''
                || created_at || ''', '''
                || updated_at || ''') ON CONFLICT (user_id) DO NOTHING;'
            FROM users;
            " | docker exec -i april_test_db psql -U april_test_bot -d april_test_db > /dev/null 2>&1

            # –°—á–∏—Ç–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ü–û–°–õ–ï
            USERS_AFTER=$(docker exec april_test_db psql -U april_test_bot -d april_test_db -t -c "SELECT COUNT(*) FROM users;" | tr -d ' ')
            ADDED=$((USERS_AFTER - USERS_BEFORE))

            echo ""
            echo "=============================================="
            echo "  –†–ï–ó–£–õ–¨–¢–ê–¢ –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–ò"
            echo "=============================================="
            echo "‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –Ω–æ–≤—ã—Ö: $ADDED"
            echo "üìä –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: $USERS_AFTER"
            echo "=============================================="

      - name: Verify deployment
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          script: |
            echo ""
            echo "=============================================="
            echo "  –ü–†–û–í–ï–†–ö–ê –î–ï–ü–õ–û–Ø"
            echo "=============================================="

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—â–µ–Ω
            if docker ps | grep -q april_test_bot; then
              echo "‚úÖ april_test_bot –∑–∞–ø—É—â–µ–Ω"
            else
              echo "‚ùå april_test_bot –ù–ï –∑–∞–ø—É—â–µ–Ω!"
              exit 1
            fi

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏
            ERRORS=$(docker logs april_test_bot --tail 50 2>&1 | grep -i "error\|exception\|failed" | head -5 || true)
            if [ -n "$ERRORS" ]; then
              echo "‚ö†Ô∏è –ù–∞–π–¥–µ–Ω—ã –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö:"
              echo "$ERRORS"
            else
              echo "‚úÖ –û—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
            fi

            echo ""
            echo "üéâ –î–ï–ü–õ–û–ô –ù–ê –ü–†–û–î–ê–ö–®–ù –ó–ê–í–ï–†–®–Å–ù!"
            echo "=============================================="

  # Job –∫–æ—Ç–æ—Ä—ã–π —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –µ—Å–ª–∏ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω –¥–µ–ø–ª–æ–π
  deployment-cancelled:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.confirm_deploy != 'true' }}
    steps:
      - name: Deployment not confirmed
        run: |
          echo "‚ùå –î–µ–ø–ª–æ–π –æ—Ç–º–µ–Ω—ë–Ω: –Ω–µ –±—ã–ª–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"
          echo "–î–ª—è –¥–µ–ø–ª–æ—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é –¥–µ–ø–ª–æ–π –Ω–∞ –ü–†–û–î–ê–ö–®–ù' = true"
          exit 1
