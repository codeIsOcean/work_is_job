name: Tests

on:
  push:
    branches: [main]
  pull_request:

jobs:
  run-tests:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U testuser -d testdb"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt
          # install local package for tests if needed
          if [ -f setup.py ] || [ -f pyproject.toml ]; then pip install -e .; fi

      - name: Set environment variables
        run: |
          echo "POSTGRES_HOST=127.0.0.1" >> $GITHUB_ENV
          echo "POSTGRES_PORT=5432" >> $GITHUB_ENV
          echo "POSTGRES_DB=testdb" >> $GITHUB_ENV
          echo "POSTGRES_USER=testuser" >> $GITHUB_ENV
          echo "POSTGRES_PASSWORD=testpass" >> $GITHUB_ENV
          echo "REDIS_HOST=127.0.0.1" >> $GITHUB_ENV
          echo "REDIS_PORT=6379" >> $GITHUB_ENV
          echo "REDIS_DB=0" >> $GITHUB_ENV
          echo "MODE=polling" >> $GITHUB_ENV
          echo "BOT_TOKEN=000000:TEST" >> $GITHUB_ENV

      - name: Lint with ruff
        run: |
          # Проверяем только критичные ошибки, которые могут вызвать падение бота:
          # F821 - undefined name (например, отсутствие импорта)
          # Игнорируем некритичные предупреждения о стиле (F401, F541, E402 и т.д.)
          ruff check . --select F821 --ignore F401,F541,E402,E722,F841,F811

      - name: Run tests
        env:
          DATABASE_URL: "postgresql+asyncpg://testuser:testpass@127.0.0.1:5432/testdb"
          REDIS_URL: "redis://127.0.0.1:6379/0"
          ENV: "development"
          MODE: "polling"
          BOT_TOKEN: "000000:TEST"
        run: |
          mkdir -p reports
          pytest tests/ -q --junitxml=reports/junit.xml

      - name: Build docker image
        run: docker build -t work_is_job:ci -f Dockerfile.test .

      - name: Upload test report
        uses: actions/upload-artifact@v4
        with:
          name: junit-report
          path: reports/junit.xml

